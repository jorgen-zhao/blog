---
title: æ¶ˆæ¯é˜Ÿåˆ—çš„åˆ†å¸ƒå¼äº‹åŠ¡ä¸Sagaæ¨¡å¼-æ„å»ºå¯é å¾®æœåŠ¡æ¶æ„çš„æ ¸å¿ƒç­–ç•¥
date: 2026-02-04
tags:
  - åˆ†å¸ƒå¼äº‹åŠ¡
  - Sagaæ¨¡å¼
  - å¾®æœåŠ¡æ¶æ„
---

## å‰è¨€

åœ¨å¾®æœåŠ¡æ¶æ„çš„ä¸–ç•Œé‡Œï¼Œæˆ‘ä»¬å¸¸å¸¸é¢ä¸´ä¸€ä¸ªæ£˜æ‰‹çš„é—®é¢˜ï¼šå¦‚ä½•ä¿è¯è·¨å¤šä¸ªæœåŠ¡çš„æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼ŸğŸ¤” è¿™å°±æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜ã€‚ä½œä¸ºä¸€ååœ¨åˆ†å¸ƒå¼ç³»ç»Ÿæ‘¸çˆ¬æ»šæ‰“å¤šå¹´çš„å·¥ç¨‹å¸ˆï¼Œæˆ‘äº²èº«ç»å†è¿‡å› ä¸ºåˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†ä¸å½“è€Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´çš„"æƒ¨æ¡ˆ"~~(å·®ç‚¹è¢«äº§å“ç»ç†è¿½æ€åˆ°å¤©æ¶¯æµ·è§’)~~ã€‚

ä»Šå¤©ï¼Œæˆ‘æƒ³å’Œå¤§å®¶æ·±å…¥æ¢è®¨ä¸€ç§ä¼˜é›…çš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆâ€”â€”Sagaæ¨¡å¼ï¼Œä»¥åŠæ¶ˆæ¯é˜Ÿåˆ—å¦‚ä½•åœ¨è¿™ä¸ªæ¨¡å¼ä¸­æ‰®æ¼”å…³é”®è§’è‰²ã€‚å¦‚æœä½ æ­£åœ¨æ„å»ºå¾®æœåŠ¡æ¶æ„ï¼Œæˆ–è€…å¯¹åˆ†å¸ƒå¼äº‹åŠ¡æ„Ÿå…´è¶£ï¼Œé‚£ä¹ˆè¿™ç¯‡æ–‡ç« æˆ–è®¸èƒ½ç»™ä½ å¸¦æ¥ä¸€äº›å¯å‘ã€‚ğŸ˜‰

## åˆ†å¸ƒå¼äº‹åŠ¡çš„æŒ‘æˆ˜

åœ¨å•ä½“åº”ç”¨æ—¶ä»£ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾ä½¿ç”¨æ•°æ®åº“çš„ACIDç‰¹æ€§æ¥ä¿è¯äº‹åŠ¡çš„ä¸€è‡´æ€§ã€‚ç„¶è€Œï¼Œéšç€å¾®æœåŠ¡æ¶æ„çš„å…´èµ·ï¼Œæ•°æ®è¢«åˆ†æ•£åˆ°ä¸åŒçš„æœåŠ¡ä¸­ï¼Œä¼ ç»Ÿçš„ACIDäº‹åŠ¡æ¨¡å‹å·²ç»æ— æ³•æ»¡è¶³éœ€æ±‚ã€‚

### ä¼ ç»ŸACIDäº‹åŠ¡çš„å±€é™æ€§

ä¼ ç»ŸACIDäº‹åŠ¡åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­é¢ä¸´ä»¥ä¸‹æŒ‘æˆ˜ï¼š

1. **æ€§èƒ½é—®é¢˜**ï¼šåˆ†å¸ƒå¼äº‹åŠ¡éœ€è¦è·¨ç½‘ç»œè¿›è¡Œåè°ƒï¼Œå¢åŠ äº†å»¶è¿Ÿã€‚
2. **å¯ç”¨æ€§é™ä½**ï¼šåˆ†å¸ƒå¼äº‹åŠ¡éœ€è¦æ‰€æœ‰å‚ä¸æ–¹éƒ½å¯ç”¨ï¼Œå¦åˆ™æ•´ä¸ªäº‹åŠ¡ä¼šå¤±è´¥ã€‚
3. **æ‰©å±•æ€§å—é™**ï¼šéšç€æœåŠ¡æ•°é‡çš„å¢åŠ ï¼Œäº‹åŠ¡åè°ƒçš„å¤æ‚åº¦å‘ˆæŒ‡æ•°çº§å¢é•¿ã€‚
4. **éš”ç¦»çº§åˆ«éš¾ä»¥ä¿è¯**ï¼šåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œå®ç°å¼ºéš”ç¦»çº§åˆ«éå¸¸å›°éš¾ã€‚

### åˆ†å¸ƒå¼äº‹åŠ¡çš„CAPç†è®ºå›°å¢ƒ

æ ¹æ®CAPç†è®ºï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬æ— æ³•åŒæ—¶æ»¡è¶³ä¸€è‡´æ€§(Consistency)ã€å¯ç”¨æ€§(Availability)å’Œåˆ†åŒºå®¹é”™æ€§(Partition tolerance)ã€‚è¿™è¿«ä½¿æˆ‘ä»¬åšå‡ºæƒè¡¡ï¼š

- **CPç³»ç»Ÿ**ï¼šä¼˜å…ˆä¿è¯ä¸€è‡´æ€§å’Œåˆ†åŒºå®¹é”™æ€§ï¼Œä½†å¯èƒ½åœ¨ç½‘ç»œåˆ†åŒºæ—¶é™ä½å¯ç”¨æ€§ã€‚
- **APç³»ç»Ÿ**ï¼šä¼˜å…ˆä¿è¯å¯ç”¨æ€§å’Œåˆ†åŒºå®¹é”™æ€§ï¼Œä½†å¯èƒ½åœ¨ç½‘ç»œåˆ†åŒºæ—¶ç‰ºç‰²ä¸€è‡´æ€§ã€‚

Sagaæ¨¡å¼æä¾›äº†ä¸€ç§åœ¨APç³»ç»Ÿä¸­ä¿è¯æœ€ç»ˆä¸€è‡´æ€§çš„æ–¹æ³•ï¼ŒåŒæ—¶é€šè¿‡è¡¥å¿æœºåˆ¶æ¥å¤„ç†å¤±è´¥æƒ…å†µã€‚

## Sagaæ¨¡å¼æ¦‚è¿°

Sagaæ¨¡å¼æ˜¯ä¸€ç§é•¿äº‹åŠ¡çš„è§£å†³æ–¹æ¡ˆï¼Œå®ƒå°†ä¸€ä¸ªå¤§å‹äº‹åŠ¡åˆ†è§£ä¸ºä¸€ç³»åˆ—è¾ƒå°çš„ã€ç‹¬ç«‹çš„å­äº‹åŠ¡ã€‚æ¯ä¸ªå­äº‹åŠ¡éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„è¡¥å¿äº‹åŠ¡ï¼Œç”¨äºåœ¨å­äº‹åŠ¡å¤±è´¥æ—¶å›æ»šä¹‹å‰å·²å®Œæˆçš„æ“ä½œã€‚

### Sagaæ¨¡å¼çš„åŸºæœ¬åŸç†

Sagaæ¨¡å¼çš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š

1. å°†é•¿äº‹åŠ¡åˆ†è§£ä¸ºä¸€ç³»åˆ—å­äº‹åŠ¡ã€‚
2. æŒ‰é¡ºåºæ‰§è¡Œè¿™äº›å­äº‹åŠ¡ã€‚
3. å¦‚æœæ‰€æœ‰å­äº‹åŠ¡éƒ½æˆåŠŸï¼Œåˆ™é•¿äº‹åŠ¡å®Œæˆã€‚
4. å¦‚æœæŸä¸ªå­äº‹åŠ¡å¤±è´¥ï¼Œåˆ™æŒ‰ç›¸åé¡ºåºæ‰§è¡Œå·²å®Œæˆçš„å­äº‹åŠ¡çš„è¡¥å¿äº‹åŠ¡ã€‚

### Sagaæ¨¡å¼çš„ä¸¤ç§å®ç°æ–¹å¼

Sagaæ¨¡å¼ä¸»è¦æœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼š

1. **ç¼–æ’å¼(Choreography)**ï¼šæ¯ä¸ªæœåŠ¡åœ¨å®Œæˆè‡ªå·±çš„å·¥ä½œåï¼Œé€šè¿‡äº‹ä»¶è§¦å‘ä¸‹ä¸€ä¸ªæœåŠ¡çš„å·¥ä½œã€‚æœåŠ¡ä¹‹é—´æ¾è€¦åˆï¼Œä½†åè°ƒé€»è¾‘åˆ†æ•£åœ¨å„ä¸ªæœåŠ¡ä¸­ã€‚
2. **ååŒå¼(Orchestration)**ï¼šæœ‰ä¸€ä¸ªä¸­å¤®åè°ƒå™¨è´Ÿè´£å†³å®šä¸‹ä¸€æ­¥æ‰§è¡Œå“ªä¸ªæœåŠ¡ã€‚åè°ƒå™¨é›†ä¸­ç®¡ç†æ•´ä¸ªäº‹åŠ¡æµç¨‹ï¼Œä½†å¯èƒ½æˆä¸ºå•ç‚¹æ•…éšœã€‚

## æ¶ˆæ¯é˜Ÿåˆ—åœ¨Sagaæ¨¡å¼ä¸­çš„ä½œç”¨

æ¶ˆæ¯é˜Ÿåˆ—åœ¨Sagaæ¨¡å¼ä¸­æ‰®æ¼”ç€è‡³å…³é‡è¦çš„è§’è‰²ï¼Œå®ƒä¸ºæœåŠ¡é—´çš„é€šä¿¡æä¾›äº†å¯é çš„åŸºç¡€è®¾æ–½ã€‚

### äº‹ä»¶é©±åŠ¨æ¶æ„

æ¶ˆæ¯é˜Ÿåˆ—æ”¯æŒäº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œä½¿å¾—æœåŠ¡é—´å¯ä»¥é€šè¿‡å¼‚æ­¥æ¶ˆæ¯è¿›è¡Œé€šä¿¡ã€‚åœ¨Sagaæ¨¡å¼ä¸­ï¼Œå½“ä¸€ä¸ªå­äº‹åŠ¡å®Œæˆæ—¶ï¼Œå®ƒä¼šå‘å¸ƒä¸€ä¸ªäº‹ä»¶ï¼Œè§¦å‘ä¸‹ä¸€ä¸ªå­äº‹åŠ¡çš„æ‰§è¡Œã€‚

```mermaid
graph LR
    A[æœåŠ¡A] -->|å®Œæˆäº‹ä»¶| B[æ¶ˆæ¯é˜Ÿåˆ—]
    B -->|è§¦å‘| C[æœåŠ¡B]
    C -->|å®Œæˆäº‹ä»¶| B
    B -->|è§¦å‘| D[æœåŠ¡C]
    D -->|å®Œæˆäº‹ä»¶| B
    B -->|è§¦å‘| E[æœåŠ¡D]
```

### å¯é çš„äº‹ä»¶ä¼ é€’

æ¶ˆæ¯é˜Ÿåˆ—æä¾›äº†å¯é çš„äº‹ä»¶ä¼ é€’æœºåˆ¶ï¼Œç¡®ä¿äº‹ä»¶ä¸ä¼šä¸¢å¤±ï¼š

1. **æŒä¹…åŒ–**ï¼šæ¶ˆæ¯å¯ä»¥è¢«æŒä¹…åŒ–å­˜å‚¨ï¼Œå³ä½¿æ¶ˆè´¹è€…æš‚æ—¶ä¸å¯ç”¨ï¼Œæ¶ˆæ¯ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚
2. **é‡è¯•æœºåˆ¶**ï¼šæ¶ˆæ¯å¤„ç†å¤±è´¥æ—¶ï¼Œå¯ä»¥è‡ªåŠ¨é‡è¯•ï¼Œç›´åˆ°æˆåŠŸæˆ–è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ã€‚
3. **æ­»ä¿¡é˜Ÿåˆ—**ï¼šå¯¹äºå¤šæ¬¡é‡è¯•ä»å¤±è´¥çš„æ¶ˆæ¯ï¼Œå¯ä»¥å°†å…¶è½¬ç§»åˆ°æ­»ä¿¡é˜Ÿåˆ—ï¼Œä¾›åç»­äººå·¥å¤„ç†ã€‚

### äº‹åŠ¡æ€§æ¶ˆæ¯

è®¸å¤šæ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿæä¾›äº†äº‹åŠ¡æ€§æ¶ˆæ¯åŠŸèƒ½ï¼Œç¡®ä¿æ¶ˆæ¯çš„å‘é€å’Œæ¥æ”¶æ˜¯åŸå­æ€§çš„ã€‚è¿™å¯¹äºä¿è¯Sagaæ¨¡å¼çš„æ­£ç¡®æ€§è‡³å…³é‡è¦ã€‚

## å®ç°ä¸€ä¸ªåŸºäºæ¶ˆæ¯é˜Ÿåˆ—çš„Sagaæ¨¡å¼

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå…·ä½“çš„ä¾‹å­æ¥å±•ç¤ºå¦‚ä½•ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å®ç°Sagaæ¨¡å¼ã€‚å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç”µå•†ç³»ç»Ÿï¼ŒåŒ…å«è®¢å•ã€åº“å­˜å’Œæ”¯ä»˜ä¸‰ä¸ªæœåŠ¡ã€‚

### ä¸šåŠ¡åœºæ™¯

ç”¨æˆ·ä¸‹å•åï¼Œéœ€è¦æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
1. åˆ›å»ºè®¢å•
2. æ‰£å‡åº“å­˜
3. å¤„ç†æ”¯ä»˜

å¦‚æœä»»ä½•ä¸€ä¸ªæ­¥éª¤å¤±è´¥ï¼Œéœ€è¦å›æ»šä¹‹å‰å·²å®Œæˆçš„æ“ä½œã€‚

### å®ç°æ­¥éª¤

#### 1. å®šä¹‰äº‹ä»¶

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ç³»åˆ—äº‹ä»¶æ¥è¡¨ç¤ºä¸šåŠ¡æµç¨‹ä¸­çš„çŠ¶æ€å˜åŒ–ï¼š

```java
// è®¢å•ç›¸å…³äº‹ä»¶
public class OrderCreatedEvent {
    private String orderId;
    private String userId;
    private List<OrderItem> items;
    // å…¶ä»–å­—æ®µå’Œgetter/setter
}

public class OrderCancelledEvent {
    private String orderId;
    // å…¶ä»–å­—æ®µå’Œgetter/setter
}

// åº“å­˜ç›¸å…³äº‹ä»¶
public class InventoryReservedEvent {
    private String orderId;
    private List<InventoryReservation> reservations;
    // å…¶ä»–å­—æ®µå’Œgetter/setter
}

public class InventoryReservationFailedEvent {
    private String orderId;
    private String reason;
    // å…¶ä»–å­—æ®µå’Œgetter/setter
}

// æ”¯ä»˜ç›¸å…³äº‹ä»¶
public class PaymentProcessedEvent {
    private String orderId;
    private String paymentId;
    // å…¶ä»–å­—æ®µå’Œgetter/setter
}

public class PaymentFailedEvent {
    private String orderId;
    private String reason;
    // å…¶ä»–å­—æ®µå’Œgetter/setter
}
```

#### 2. è®¢å•æœåŠ¡å®ç°

è®¢å•æœåŠ¡è´Ÿè´£åˆ›å»ºè®¢å•ï¼Œå¹¶åœ¨è®¢å•åˆ›å»ºæˆåŠŸåå‘å¸ƒäº‹ä»¶ï¼š

```java
@Service
public class OrderService {
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private KafkaTemplate<String, Object> kafkaTemplate;
    
    @Transactional
    public Order createOrder(OrderRequest request) {
        // åˆ›å»ºè®¢å•
        Order order = new Order();
        // è®¾ç½®è®¢å•å±æ€§
        order = orderRepository.save(order);
        
        // å‘å¸ƒè®¢å•åˆ›å»ºäº‹ä»¶
        OrderCreatedEvent event = new OrderCreatedEvent();
        // è®¾ç½®äº‹ä»¶å±æ€§
        kafkaTemplate.send("order-events", event);
        
        return order;
    }
    
    @EventListener
    @Transactional
    public void handleOrderCreatedEvent(OrderCreatedEvent event) {
        // è®¢å•å·²åˆ›å»ºï¼Œå¯ä»¥æ‰§è¡Œåç»­æ“ä½œ
    }
    
    @EventListener
    @Transactional
    public void handlePaymentFailedEvent(PaymentFailedEvent event) {
        // æ”¯ä»˜å¤±è´¥ï¼Œå–æ¶ˆè®¢å•
        Order order = orderRepository.findById(event.getOrderId()).orElseThrow();
        order.setStatus(OrderStatus.CANCELLED);
        orderRepository.save(order);
        
        // å‘å¸ƒè®¢å•å–æ¶ˆäº‹ä»¶
        OrderCancelledEvent cancelEvent = new OrderCancelledEvent();
        // è®¾ç½®äº‹ä»¶å±æ€§
        kafkaTemplate.send("order-events", cancelEvent);
    }
}
```

#### 3. åº“å­˜æœåŠ¡å®ç°

åº“å­˜æœåŠ¡è´Ÿè´£å¤„ç†åº“å­˜é¢„ç•™å’Œé‡Šæ”¾ï¼š

```java
@Service
public class InventoryService {
    
    @Autowired
    private InventoryRepository inventoryRepository;
    
    @Autowired
    private KafkaTemplate<String, Object> kafkaTemplate;
    
    @EventListener
    @Transactional
    public void handleOrderCreatedEvent(OrderCreatedEvent event) {
        // å°è¯•é¢„ç•™åº“å­˜
        try {
            List<InventoryReservation> reservations = reserveInventory(event.getItems());
            
            // å‘å¸ƒåº“å­˜é¢„ç•™æˆåŠŸäº‹ä»¶
            InventoryReservedEvent reserveEvent = new InventoryReservedEvent();
            // è®¾ç½®äº‹ä»¶å±æ€§
            kafkaTemplate.send("inventory-events", reserveEvent);
            
        } catch (InventoryException e) {
            // åº“å­˜é¢„ç•™å¤±è´¥ï¼Œå‘å¸ƒå¤±è´¥äº‹ä»¶
            InventoryReservationFailedEvent failEvent = new InventoryReservationFailedEvent();
            // è®¾ç½®äº‹ä»¶å±æ€§
            kafkaTemplate.send("inventory-events", failEvent);
        }
    }
    
    @EventListener
    @Transactional
    public void handleOrderCancelledEvent(OrderCancelledEvent event) {
        // é‡Šæ”¾åº“å­˜
        releaseInventory(event.getOrderId());
    }
    
    private List<InventoryReservation> reserveInventory(List<OrderItem> items) {
        // å®ç°åº“å­˜é¢„ç•™é€»è¾‘
    }
    
    private void releaseInventory(String orderId) {
        // å®ç°åº“å­˜é‡Šæ”¾é€»è¾‘
    }
}
```

#### 4. æ”¯ä»˜æœåŠ¡å®ç°

æ”¯ä»˜æœåŠ¡è´Ÿè´£å¤„ç†æ”¯ä»˜æµç¨‹ï¼š

```java
@Service
public class PaymentService {
    
    @Autowired
    private PaymentRepository paymentRepository;
    
    @Autowired
    private KafkaTemplate<String, Object> kafkaTemplate;
    
    @EventListener
    @Transactional
    public void handleInventoryReservedEvent(InventoryReservedEvent event) {
        // åº“å­˜å·²é¢„ç•™ï¼Œå¼€å§‹å¤„ç†æ”¯ä»˜
        try {
            Payment payment = processPayment(event.getOrderId());
            
            // å‘å¸ƒæ”¯ä»˜æˆåŠŸäº‹ä»¶
            PaymentProcessedEvent successEvent = new PaymentProcessedEvent();
            // è®¾ç½®äº‹ä»¶å±æ€§
            kafkaTemplate.send("payment-events", successEvent);
            
        } catch (PaymentException e) {
            // æ”¯ä»˜å¤±è´¥ï¼Œå‘å¸ƒå¤±è´¥äº‹ä»¶
            PaymentFailedEvent failEvent = new PaymentFailedEvent();
            // è®¾ç½®äº‹ä»¶å±æ€§
            kafkaTemplate.send("payment-events", failEvent);
        }
    }
    
    private Payment processPayment(String orderId) {
        // å®ç°æ”¯ä»˜å¤„ç†é€»è¾‘
    }
}
```

### åè°ƒæ¨¡å¼çš„é€‰æ‹©

ä¸Šè¿°ç¤ºä¾‹é‡‡ç”¨çš„æ˜¯ç¼–æ’å¼(Choreography)Sagaæ¨¡å¼ï¼Œæ¯ä¸ªæœåŠ¡ç›‘å¬å…¶ä»–æœåŠ¡å‘å¸ƒçš„äº‹ä»¶å¹¶åšå‡ºç›¸åº”ååº”ã€‚è¿™ç§æ–¹å¼çš„å¥½å¤„æ˜¯æœåŠ¡é—´æ¾è€¦åˆï¼Œä½†åè°ƒé€»è¾‘åˆ†æ•£åœ¨å„ä¸ªæœåŠ¡ä¸­ã€‚

å¯¹äºæ›´å¤æ‚çš„ä¸šåŠ¡æµç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘é‡‡ç”¨ååŒå¼(Orchestration)Sagaæ¨¡å¼ï¼Œå¼•å…¥ä¸€ä¸ªä¸“é—¨çš„åè°ƒæœåŠ¡ï¼š

```java
@Service
public class SagaOrchestrator {
    
    @Autowired
    private KafkaTemplate<String, Object> kafkaTemplate;
    
    @Autowired
    private OrderService orderService;
    
    @Autowired
    private InventoryService inventoryService;
    
    @Autowired
    private PaymentService paymentService;
    
    public void startOrderSaga(OrderRequest request) {
        // åˆ›å»ºè®¢å•
        Order order = orderService.createOrder(request);
        
        // ç­‰å¾…è®¢å•åˆ›å»ºå®Œæˆ
        // ...
        
        // è§¦å‘åº“å­˜é¢„ç•™
        kafkaTemplate.send("order-events", new OrderCreatedEvent());
        
        // ç­‰å¾…åº“å­˜é¢„ç•™å®Œæˆ
        // ...
        
        // è§¦å‘æ”¯ä»˜å¤„ç†
        kafkaTemplate.send("inventory-events", new InventoryReservedEvent());
        
        // ç­‰å¾…æ”¯ä»˜å¤„ç†å®Œæˆ
        // ...
    }
}
```

## Sagaæ¨¡å¼çš„æœ€ä½³å®è·µ

åœ¨å®ç°Sagaæ¨¡å¼æ—¶ï¼Œä»¥ä¸‹æœ€ä½³å®è·µå¯ä»¥å¸®åŠ©ä½ æ„å»ºæ›´å¯é ã€æ›´æ˜“ç»´æŠ¤çš„ç³»ç»Ÿï¼š

### 1. ä¿æŒå¹‚ç­‰æ€§

ç”±äºæ¶ˆæ¯å¯èƒ½ä¼šè¢«é‡è¯•ï¼Œæ¯ä¸ªäº‹ä»¶å¤„ç†å™¨åº”è¯¥æ˜¯å¹‚ç­‰çš„ï¼Œå³å¤šæ¬¡å¤„ç†åŒä¸€äº‹ä»¶ä¸ä¼šå¯¼è‡´å‰¯ä½œç”¨ã€‚

```java
@EventListener
@Transactional
public void handleOrderCreatedEvent(OrderCreatedEvent event) {
    // æ£€æŸ¥è®¢å•æ˜¯å¦å·²å¤„ç†
    if (orderRepository.isOrderProcessed(event.getOrderId())) {
        return;
    }
    
    // å¤„ç†è®¢å•åˆ›å»ºé€»è¾‘
    // ...
}
```

### 2. å®ç°è¶…æ—¶å’Œé‡è¯•æœºåˆ¶

ä¸ºæ¯ä¸ªå­äº‹åŠ¡è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼Œå¹¶å®ç°é‡è¯•æœºåˆ¶ï¼Œä»¥æé«˜ç³»ç»Ÿçš„å¯é æ€§ã€‚

```java
@Retryable(value = {Exception.class}, maxAttempts = 3, backoff = @Backoff(delay = 1000))
@EventListener
@Transactional
public void handleOrderCreatedEvent(OrderCreatedEvent event) {
    // å¤„ç†è®¢å•åˆ›å»ºé€»è¾‘
    // ...
}
```

### 3. ä½¿ç”¨è¡¥å¿äº‹åŠ¡

å¯¹äºæ¯ä¸ªå­äº‹åŠ¡ï¼Œå®ç°ç›¸åº”çš„è¡¥å¿äº‹åŠ¡ï¼Œä»¥ä¾¿åœ¨äº‹åŠ¡å¤±è´¥æ—¶è¿›è¡Œå›æ»šã€‚

```java
@EventListener
@Transactional
public void handlePaymentFailedEvent(PaymentFailedEvent event) {
    // æ”¯ä»˜å¤±è´¥ï¼Œå–æ¶ˆè®¢å•
    Order order = orderRepository.findById(event.getOrderId()).orElseThrow();
    order.setStatus(OrderStatus.CANCELLED);
    orderRepository.save(order);
    
    // å‘å¸ƒè®¢å•å–æ¶ˆäº‹ä»¶
    OrderCancelledEvent cancelEvent = new OrderCancelledEvent();
    kafkaTemplate.send("order-events", cancelEvent);
}
```

### 4. ç›‘æ§å’Œè¿½è¸ª

å®ç°å®Œå–„çš„ç›‘æ§å’Œè¿½è¸ªæœºåˆ¶ï¼Œä»¥ä¾¿åŠæ—¶å‘ç°å’Œè§£å†³é—®é¢˜ã€‚

```java
@EventListener
@Transactional
public void handleOrderCreatedEvent(OrderCreatedEvent event) {
    // è®°å½•å¼€å§‹å¤„ç†äº‹ä»¶
    metrics.counter("order.created").increment();
    
    try {
        // å¤„ç†è®¢å•åˆ›å»ºé€»è¾‘
        // ...
        
        // è®°å½•å¤„ç†æˆåŠŸ
        metrics.counter("order.created.success").increment();
        
    } catch (Exception e) {
        // è®°å½•å¤„ç†å¤±è´¥
        metrics.counter("order.created.failed").increment();
        throw e;
    }
}
```

## Sagaæ¨¡å¼çš„ä¼˜ç¼ºç‚¹åˆ†æ

### ä¼˜ç‚¹

1. **æœ€ç»ˆä¸€è‡´æ€§**ï¼šSagaæ¨¡å¼å…è®¸ç³»ç»Ÿåœ¨æœ€ç»ˆè¾¾åˆ°ä¸€è‡´çŠ¶æ€ï¼Œè€Œä¸éœ€è¦æ‰€æœ‰æ“ä½œåŒæ—¶å®Œæˆã€‚
2. **é«˜å¯ç”¨æ€§**ï¼šç”±äºä¸éœ€è¦æ‰€æœ‰å‚ä¸æ–¹åŒæ—¶å¯ç”¨ï¼ŒSagaæ¨¡å¼å…·æœ‰æ›´é«˜çš„å¯ç”¨æ€§ã€‚
3. **å¯æ‰©å±•æ€§**ï¼šSagaæ¨¡å¼å¯ä»¥è½»æ¾æ‰©å±•åˆ°æ›´å¤šçš„æœåŠ¡å’Œæ›´å¤æ‚çš„ä¸šåŠ¡æµç¨‹ã€‚
4. **ä¸šåŠ¡å‹å¥½**ï¼šSagaæ¨¡å¼ä¸ä¸šåŠ¡æµç¨‹ç´§å¯†å¯¹åº”ï¼Œæ˜“äºç†è§£å’Œå®ç°ã€‚

### ç¼ºç‚¹

1. **ä¸´æ—¶ä¸ä¸€è‡´**ï¼šåœ¨Sagaæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿå¯èƒ½å¤„äºä¸´æ—¶ä¸ä¸€è‡´çš„çŠ¶æ€ã€‚
2. **è¡¥å¿å¤æ‚æ€§**ï¼šå®ç°è¡¥å¿äº‹åŠ¡å¯èƒ½æ¯”è¾ƒå¤æ‚ï¼Œç‰¹åˆ«æ˜¯åœ¨æœ‰çŠ¶æ€å˜åŒ–çš„æƒ…å†µä¸‹ã€‚
3. **äº‹åŠ¡éš”ç¦»é—®é¢˜**ï¼šSagaæ¨¡å¼æ— æ³•æä¾›ä¼ ç»ŸACIDäº‹åŠ¡çš„éš”ç¦»çº§åˆ«ã€‚
4. **è°ƒè¯•å›°éš¾**ï¼šç”±äºäº‹ä»¶é©±åŠ¨çš„å¼‚æ­¥ç‰¹æ€§ï¼Œè°ƒè¯•Sagaæ¨¡å¼çš„äº‹åŠ¡æµç¨‹å¯èƒ½æ¯”è¾ƒå›°éš¾ã€‚

## ç»“è®º

Sagaæ¨¡å¼ä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿæä¾›äº†ä¸€ç§ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥åœ¨ä¿è¯æœ€ç»ˆä¸€è‡´æ€§çš„åŒæ—¶ï¼Œæ„å»ºé«˜å¯ç”¨ã€å¯æ‰©å±•çš„ç³»ç»Ÿã€‚æ¶ˆæ¯é˜Ÿåˆ—ä½œä¸ºSagaæ¨¡å¼çš„æ ¸å¿ƒç»„ä»¶ï¼Œé€šè¿‡å¯é çš„äº‹ä»¶ä¼ é€’æœºåˆ¶ï¼Œä¸ºæœåŠ¡é—´çš„é€šä¿¡æä¾›äº†åšå®çš„åŸºç¡€ã€‚

åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®ä¸šåŠ¡éœ€æ±‚å’Œç³»ç»Ÿç‰¹ç‚¹ï¼Œé€‰æ‹©åˆé€‚çš„Sagaå®ç°æ–¹å¼ï¼ˆç¼–æ’å¼æˆ–ååŒå¼ï¼‰ï¼Œå¹¶éµå¾ªæœ€ä½³å®è·µæ¥æ„å»ºå¯é çš„Sagaæ¨¡å¼å®ç°ã€‚

è™½ç„¶Sagaæ¨¡å¼ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œå®ƒåœ¨æŸäº›åœºæ™¯ä¸‹å¯èƒ½ä¸å¦‚ä¼ ç»Ÿçš„ACIDäº‹åŠ¡ï¼Œä½†å®ƒä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ç®¡ç†å¤æ‚ä¸šåŠ¡æµç¨‹çš„æœ‰æ•ˆæ–¹æ³•ã€‚åœ¨å¾®æœåŠ¡æ¶æ„æ—¥ç›Šæ™®åŠçš„ä»Šå¤©ï¼ŒæŒæ¡Sagaæ¨¡å¼å¯¹äºæ„å»ºå¯é çš„åˆ†å¸ƒå¼ç³»ç»Ÿè‡³å…³é‡è¦ã€‚

> "åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæ²¡æœ‰é“¶å¼¹ã€‚Sagaæ¨¡å¼ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§åœ¨ä¸€è‡´æ€§ã€å¯ç”¨æ€§å’Œæ€§èƒ½ä¹‹é—´å–å¾—å¹³è¡¡çš„ä¼˜é›…æ–¹æ¡ˆã€‚"

å¦‚æœä½ æ­£åœ¨æ„å»ºå¾®æœåŠ¡æ¶æ„ï¼Œæˆ–è€…é¢ä¸´åˆ†å¸ƒå¼äº‹åŠ¡çš„æŒ‘æˆ˜ï¼Œä¸å¦¨å°è¯•ä½¿ç”¨Sagaæ¨¡å¼ï¼Œå®ƒå¯èƒ½ä¼šç»™ä½ å¸¦æ¥æ„æƒ³ä¸åˆ°çš„æƒŠå–œã€‚ğŸ˜Š

---

**ç›¸å…³é˜…è¯»ï¼š**

- [æ¶ˆæ¯é˜Ÿåˆ—çš„å¯é æ€§ä¿è¯-å¦‚ä½•ç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤±-ä¸é‡å¤](https://jorgen-zhao.github.io/blog/message_queue/69)
- [æ¶ˆæ¯é˜Ÿåˆ—çš„äº‹åŠ¡æ¶ˆæ¯ä¸å¯é æ€§ä¿è¯](https://jorgen-zhao.github.io/blog/message_queue/65)
- [æ¶ˆæ¯é˜Ÿåˆ—ä¸å¾®æœåŠ¡æ¶æ„çš„é›†æˆ-æ„å»ºåˆ†å¸ƒå¼ç³»ç»Ÿçš„é€šä¿¡åŸºçŸ³](https://jorgen-zhao.github.io/blog/message_queue/222)