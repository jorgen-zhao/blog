---
title: flinkæ¨¡æ¿å·¥ç¨‹
date: 2024-01-18 23:45:31
permalink: /pages/999f0b/
categories:
  - å¼€å‘æ—¥å¿—
tags:
  - æ¨¡æ¿å·¥ç¨‹
  - Apache Flink
author: 
  name: Jorgen
  link: https://github.com/jorgen-zhao
---


**"Less code, more efficiency!"** â€” ä»£ç å°‘ä¸€ç‚¹ï¼Œå¼€å‘å¿«ä¸€ç‚¹ï¼ğŸ”¥

<!-- more -->

## ğŸŒŸ èƒŒæ™¯

Flink Job å¼€å‘å¤ªç¹çï¼Ÿé…ç½®é‡å¤ï¼ŸğŸ‘€  
æ¯æ¬¡éƒ½è¦å†™ä¸€å¤§å † **connector** ç›¸å…³ä»£ç ï¼ŸğŸ˜©  
æƒ³è¦æ›´ç®€å•é«˜æ•ˆåœ°æ„å»º **JetStream Flink Job**ï¼ŸğŸ”¥

æ²¡é—®é¢˜ï¼æˆ‘ä»¬æ¥è§£å†³è¿™äº›ç—›ç‚¹ï¼ğŸ’¡

> **FlinkContext** â€”â€” è®© Flink Job å¼€å‘æ›´è½»æ¾ï¼


### â“ é‡åˆ°çš„é—®é¢˜

- **å¤§é‡é‡å¤ä»£ç **ï¼šæ¯ä¸ª Flink Job éƒ½éœ€è¦å†™ç›¸åŒçš„ **source/sink** è¿æ¥ä»£ç ã€‚
- **å¤æ‚çš„å‚æ•°ç®¡ç†**ï¼šè¿è¡Œæ¨¡å¼ã€æ£€æŸ¥ç‚¹ã€é‡å¯ç­–ç•¥â€¦â€¦å‚æ•°å¤ªå¤šï¼Œéš¾ç®¡ç†ï¼
- **ä¸åŒæ•°æ®æºé€‚é…**ï¼šNATS JetStreamã€Redisâ€¦â€¦å¦‚ä½•è½»æ¾åˆ‡æ¢ï¼Ÿ

### ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼šFlinkContext

æˆ‘ä»¬å°è£…äº†ä¸€ä¸ª **FlinkContext**ï¼Œå®ƒè§£å†³äº†ï¼š

âœ… **å‡å°‘é‡å¤ä»£ç **ï¼šæ‰€æœ‰ **Flink Job** é€šç”¨çš„éƒ¨åˆ†éƒ½å°è£…å¥½äº†ã€‚  

âœ… **å¼€ç®±å³ç”¨**ï¼šä»…éœ€å…³æ³¨ **operatorï¼ˆç®—å­é€»è¾‘ï¼‰**ï¼Œå…¶ä»–äº¤ç»™ FlinkContextã€‚  

âœ… **æ”¯æŒå¤šç§æ•°æ®æº**ï¼šJetStreamã€NATSã€Redisï¼Œè½»æ¾å¯¹æ¥ï¼  

## ğŸ— FlinkContext è®¾è®¡

FlinkContext ä¸»è¦å°è£…äº†ä»¥ä¸‹å‡ ä¸ªå…³é”®æ¨¡å—ï¼š

### ğŸ›  **æ ¸å¿ƒåŠŸèƒ½**
| **é…ç½®é¡¹** | **é‡Šä¹‰** | **é»˜è®¤å€¼** | **è¯´æ˜** |
| --- | --- | --- | --- |
| `setRuntimeMode` | è¿è¡Œæ¨¡å¼ | `RuntimeExecutionMode.STREAMING` | æµå¼æ‰§è¡Œæ¨¡å¼ |
| `enableCheckpointing` | æ£€æŸ¥ç‚¹æ‰§è¡Œå‘¨æœŸ | 2000ms | æ£€æŸ¥ç‚¹æ¯2ç§’æ‰§è¡Œä¸€æ¬¡ |
| `addDefaultKryoSerializer` | é»˜è®¤åºåˆ—åŒ–å™¨ | `ProtobufSerializer.class` | é»˜è®¤ä½¿ç”¨protobufåºåˆ—åŒ–å™¨ |
| `setRestartStrategy` | é‡å¯ç­–ç•¥[Task æ•…éšœæ¢å¤](https://nightlies.apache.org/flink/flink-docs-release-1.17/zh/docs/ops/state/task_failure_recovery/) | -- | 1. æ¯ä¸ªæ—¶é—´é—´éš”çš„æœ€å¤§æ•…éšœæ¬¡æ•°ï¼›2. æµ‹é‡æ•…éšœç‡çš„æ—¶é—´é—´éš”ï¼›3. å»¶æ—¶ |

### ğŸ¯ **å¦‚ä½•ä½¿ç”¨ï¼Ÿ**
```java
public static void main(String[] args) throws Exception {
    FlinkContext context = new FlinkContext<>() {
        @Override
        public DataStream operator(DataStream<?> dataStream) {
            return dataStream
                    .map(item -> ConversionManager.protoConversion((MessageProxy) item))
                    .filter(Objects::nonNull)
                    .map((MapFunction<EventModel, DeviceEvent>) value -> 
                        new DeviceEvent(value.getProxy().getRobotId(), value.getEvent().getTimestamp().getSeconds()))
                    .returns(TypeInformation.of(DeviceEvent.class))
                    .name("source-job");
        }
    };
    context.start();
}
```

ğŸ‰ **è¿™æ ·ï¼Œæˆ‘ä»¬çš„ Flink Job å°±å®Œæˆäº†ï¼**

---

## ğŸ”Œ **Source & Sink å°è£…**
### ğŸ“¥ Sourceï¼ˆæ•°æ®æºï¼‰
```java
public class SourceHolder {
    private static final Map<String, SourceBase<?>> holder = new HashMap<>();
    static { holder.put(ConnectorConstants.SOURCE_JETSTREAM, new JetStreamSourceBase<>()); }
    public static SourceBase<?> getSource(String key) { return holder.get(key); }
}
```

### ğŸ“¤ Sinkï¼ˆæ•°æ®æ±‡ï¼‰
```java
public class SinkHolder {
    private static final Map<String, SinkBase<?>> holder = new HashMap<>();
    static {
        holder.put(ConnectorConstants.SINK_JETSTREAM, new JetStreamSinkBase());
        holder.put(ConnectorConstants.SINK_NATS, new NatsSinkBase());
        holder.put(ConnectorConstants.SINK_REDIS, new RedisSinkBase());
    }
    public static SinkBase<?> getSink(String key) { return holder.get(key); }
}
```

---

## âš™ **ç¯å¢ƒå˜é‡ & é…ç½®ç®¡ç†**
| **å˜é‡å** | **å«ä¹‰** | **æ˜¯å¦å¿…å¡«** | **å‚è€ƒå€¼** |
| --- | --- | --- | --- |
| SOURCE_URL | natsä½œä¸ºæ•°æ®æºçš„è¿æ¥åœ°å€ | natsä½œä¸ºæ•°æ®æºæ—¶ï¼Œå¿…å¡« | nats://localhost:4222 |
| SINK_URL | natsä½œä¸ºæ•°æ®æ±‡çš„è¿æ¥åœ°å€ | natsä½œä¸ºæ•°æ®æ±‡æ—¶ï¼Œå¿…å¡« | nats://localhost:4222 |
| SOURCE_CREDENTIAL | natsä½œä¸ºæ•°æ®æºçš„è¿æ¥å‡­è¯ | natsä½œä¸ºæ•°æ®æºæ—¶ï¼Œå¿…å¡« | /path/file |
| SINK_CREDENTIAL | natsä½œä¸ºæ•°æ®æ±‡çš„è¿æ¥å‡­è¯ | natsä½œä¸ºæ•°æ®æ±‡æ—¶ï¼Œå¿…å¡« | /path/file |
| REDIS_HOST | redisè¿æ¥åœ°å€ | redisä½œä¸ºæ•°æ®æ±‡æ—¶ï¼Œå¿…å¡« | redis.sz |
| REDIS_PORT | redisè¿æ¥ç«¯å£ | redisä½œä¸ºæ•°æ®æ±‡æ—¶ï¼Œå¿…å¡« | 6379 |
| REDIS_PASSWORD | redisè¿æ¥å¯†ç  | redisä½œä¸ºæ•°æ®æ±‡æ—¶ï¼Œå¿…å¡« | 85269262 |
| REDIS_DATABASE | redisè¿æ¥æ•°æ®åº“ï¼ˆä¸å¡«åˆ™é»˜è®¤0ï¼‰ | éå¿…å¡« | 0 |
| **SOURCE_TYPE** | **æ•°æ®æºçš„ç±»å‹ï¼šæ”¯æŒJetStream** | **å¿…å¡«** | **JETSTREAM** |
| **SINK_TYPES** | **æ•°æ®æ±‡çš„ç±»å‹ï¼šæ”¯æŒJetStream nats Redisã€‚å¤šä¸ªé€—å·åˆ†éš”** | **å¿…å¡«** | **NATS,REDIS** |
| SOURCE_STREAMS | natsä½œä¸ºæ•°æ®æºæ—¶ï¼Œéœ€è¦å¤„ç†çš„streamåç§°ã€‚å¤šä¸ªé€—å·åˆ†éš” | natsä½œä¸ºæ•°æ®æºæ—¶ï¼Œå¿…å¡« | out-FR00015,out-FR00011 |
| SOURCE_CONSUMER | natsä½œä¸ºæ•°æ®æºæ—¶çš„æ¶ˆè´¹è€…åç§° | natsä½œä¸ºæ•°æ®æºæ—¶ï¼Œå¿…å¡« | TPL |
| SOURCE_DELIVERY_POLICY | natsä½œä¸ºæ•°æ®æºæ—¶çš„æ¶ˆè´¹ç­–ç•¥ï¼šæ”¯æŒEARLIEST, LAST, LATEST, FROM_TIME, FROM_STREAM_SEQUENCE | natsä½œä¸ºæ•°æ®æºæ—¶ï¼Œå¿…å¡« | LAST |
| SOURCE_FILTER_SUBJECT | natsä½œä¸ºæ•°æ®æºæ—¶ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹çš„ä¸»é¢˜ã€‚å…¨æ¶ˆè´¹ï¼š> | natsä½œä¸ºæ•°æ®æºæ—¶ï¼Œå¿…å¡« | > |
| SINK_SUBJECT | natsä½œä¸ºæ•°æ®æ±‡æ—¶ï¼Œæ±‡å…¥çš„ä¸»é¢˜ | natsä½œä¸ºæ•°æ®æ±‡æ—¶ï¼Œå¿…å¡« | flink.tpl |
| FLINK_JOB_NAME | Flink Jobåç§° | å¿…å¡« | FLINK_TPL_JOB |

### ğŸ›  **æ”¯æŒä¸¤ç§æ–¹å¼é…ç½®**
1. **ç¯å¢ƒå˜é‡**ï¼ˆé€‚ç”¨äº**éƒ¨ç½²**ï¼‰
2. **ç³»ç»Ÿå˜é‡**ï¼ˆé€‚ç”¨äº**æœ¬åœ°è°ƒè¯•**ï¼‰

### ğŸ“ **ç¯å¢ƒå˜é‡ç¤ºä¾‹**
```yaml
environment:
  - SOURCE_URL=nats://localhost:4222
  - SINK_URL=nats://localhost:4222
  - SOURCE_CREDENTIAL=/path/file
  - SINK_CREDENTIAL=/path/file
  - SOURCE_TYPE=JETSTREAM
  - SINK_TYPES=NATS,REDIS
```

### ğŸ“„ **ç³»ç»Ÿå˜é‡ç¤ºä¾‹ï¼ˆflink.propertiesï¼‰**
```properties
SOURCE_TYPE=JETSTREAM
SINK_TYPES=NATS,REDIS
FLINK_JOB_NAME=FLINK_TPL_JOB
SOURCE_STREAMS=out-FR00015
SINK_SUBJECT=flink.tpl
```

ğŸš€ **ä¼˜å…ˆçº§**ï¼šç¯å¢ƒå˜é‡ > ç³»ç»Ÿå˜é‡  
ğŸ“Œ **Tips**ï¼šå¦‚æœç¯å¢ƒå˜é‡æœªè®¾ç½®ï¼Œåˆ™ä¼šä½¿ç”¨ **flink.properties** ä¸­çš„é…ç½®ã€‚

---

## ğŸ¤– **ç­–ç•¥æ¨¡å¼ä¼˜åŒ–äº‹ä»¶è§£æ**
åœ¨æ•°æ®å¤„ç†æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šæœ‰ä¸åŒçš„ **eventSource**ï¼Œå¦‚ä½•æ›´ä¼˜é›…åœ°è§£æï¼ŸğŸ¤”

> ç­–ç•¥æ¨¡å¼ ğŸ†ï¼š**é¿å…å¤§é‡ if-elseï¼Œè§£è€¦ä»£ç **ï¼

### âœ¨ **å®ç°æ–¹å¼**
1. **å®šä¹‰è§£ææ¥å£**
```java
public interface EventParser {
    void parse(EventModel event);
}
```
2. **å®ç°ä¸åŒ Event è§£æç±»**
```java
public class DeviceEventParser implements EventParser {
    public void parse(EventModel event) {
        // è®¾å¤‡äº‹ä»¶è§£æé€»è¾‘
    }
}
```
3. **ç®¡ç†ä¸åŒçš„è§£æç­–ç•¥**
```java
public class EventParserHolder {
    private static final Map<String, EventParser> parsers = new HashMap<>();
    static { parsers.put("DEVICE_EVENT", new DeviceEventParser()); }
    public static EventParser getParser(String type) { return parsers.get(type); }
}
```
4. **ä½¿ç”¨ç­–ç•¥æ¨¡å¼è§£æäº‹ä»¶**
```java
EventParser parser = EventParserHolder.getParser(eventType);
if (parser != null) { parser.parse(event); }
```

ğŸ¯ **è¿™æ ·ï¼Œæ–°å¢ Event è§£ææ—¶ï¼Œåªéœ€æ·»åŠ ä¸€ä¸ªæ–°çš„å®ç°ç±»ï¼Œæ— éœ€æ”¹åŠ¨ç°æœ‰ä»£ç ï¼**

---

```java
System.out.println("Enjoy your Flink coding journey! ğŸš€");
```


> **è®©ä½ çš„ Flink ä»»åŠ¡è·‘èµ·æ¥ï¼Œå°±è¿™ä¹ˆç®€å•ï¼** ğŸƒğŸ’¨

## ğŸ“Œ éƒ¨ç½²æ–¹å¼

Flink æä¾›äº†ä¸¤ç§ä¸»è¦çš„éƒ¨ç½²æ¨¡å¼ï¼Œæˆ‘ä»¬åˆ†åˆ«çœ‹çœ‹å¦‚ä½•é«˜æ•ˆéƒ¨ç½²å®ƒä»¬ğŸ‘‡

---

### ğŸŒŸ Session Modeï¼ˆä¼šè¯æ¨¡å¼ï¼‰

**ğŸ‘‰ å®˜æ–¹æ–‡æ¡£**ï¼š[Flink Standalone Docker - Session Mode](https://nightlies.apache.org/flink/flink-docs-release-1.15/docs/deployment/resource-providers/standalone/docker/#session-mode-1)

#### **ğŸ’¼ CI/CD ä¸€é”®éƒ¨ç½²**

1. **CI:** ä½¿ç”¨ `Earthfile`ï¼Œåœ¨ CI ç¯å¢ƒä¸‹æ‰“åŒ… JAR ğŸ
2. **CD:** è¯»å–æ‰“åŒ…äº§ç‰©ï¼Œä½¿ç”¨ Flink Client æäº¤ Job ğŸš€

#### **ğŸ› ï¸ æœ¬åœ°è°ƒæµ‹ - Web UI æäº¤ Job**

##### **1ï¸âƒ£ å…ˆæ„å»º JAR**

> **åœ¨ IDEA ä¸­æ‰§è¡Œ Gradle æ„å»º** ğŸ‘‡

```sh
./gradlew clean build
```

ğŸ”¹ **äº§ç‰©ä½ç½®**ï¼š`build/libs/xxx-all.jar`

##### **2ï¸âƒ£ æäº¤ Job**

1. è®¿é—® **Flink Web UI**ï¼ˆé»˜è®¤ `http://localhost:8081`ï¼‰
2. **å·¦ä¾§èœå•** â `Submit New Job`
3. **ä¸Šä¼  JAR**ï¼Œå¡«å†™è¿è¡Œå‚æ•° â `Submit`
4. **å·¦ä¾§èœå•** â `Running Jobs` æŸ¥çœ‹è¿è¡ŒçŠ¶æ€ âœ…

---

### ğŸš€ Application Modeï¼ˆåº”ç”¨æ¨¡å¼ï¼‰

**ğŸ‘‰ å®˜æ–¹æ–‡æ¡£**ï¼š[Flink Standalone Docker - Application Mode](https://nightlies.apache.org/flink/flink-docs-release-1.15/docs/deployment/resource-providers/standalone/docker/#application-mode-1)

#### **ğŸ’¼ CI/CD éƒ¨ç½²æ–¹æ¡ˆ**

1. **CI**ï¼ˆæ‰“åŒ…é˜¶æ®µï¼‰
   - **EarthFile** âœ… å¤ç”¨ç°æœ‰ Quarkus æ‰“åŒ…æµç¨‹
   - **Dockerfile** âœ… å¤ç”¨ï¼Œæ³¨æ„ **ENTRYPOINT**
   - **docker-entrypoint** âœ… å¤ç”¨ï¼Œä½œä¸º Flink Job å¯åŠ¨ç±»

2. **CD**ï¼ˆéƒ¨ç½²é˜¶æ®µï¼‰
   - `docker-compose.yml` æŒ‡å®šæ­£ç¡®çš„ **é•œåƒ tag** å’Œ **JAR æ–‡ä»¶åç§°**
   - æŒ‡å®š Job è¿è¡Œç¯å¢ƒï¼ˆ`-env.active xxx`ï¼‰
   - `services - jobmanager - command` é…ç½®å¯åŠ¨å‘½ä»¤

ğŸ“ **JetStream å¤„ç†é€»è¾‘**
> å¦‚æœ `consumer` ä¸å­˜åœ¨ï¼ŒFlink ä¼šè‡ªåŠ¨åˆ›å»ºï¼Œæ— éœ€æ‰‹åŠ¨ç®¡ç† `savepoint` ğŸ¯


## ğŸ”§ ç»Ÿä¸€è½¯ä»¶ç‰ˆæœ¬

> **ç»Ÿä¸€ Flink ç‰ˆæœ¬ï¼Œç¡®ä¿ç¯å¢ƒä¸€è‡´ï¼ğŸ“Œ**

| ç»„ä»¶            | ç‰ˆæœ¬    | ä¾èµ–å£°æ˜ |
|----------------|--------|----------------------------------|
| **Flink**     | 1.15.2 | `flink-streaming-java:1.15.2`  |
| **JNATS**     | 2.16.9 | `io.nats:jnats:2.16.9`        |
| **Protobuf**  | 3.21.9 | `com.google.protobuf:protobuf-java:3.21.9` |
| **Java**      | 11     | `JavaVersion.VERSION_11`       |

---

## ğŸ¯ æ€»ç»“

ğŸ’¡ **æ— è®ºæ˜¯ Session Mode è¿˜æ˜¯ Application Modeï¼Œæµç¨‹éƒ½å¾ˆç®€å•ï¼**

âœ… **CI/CD æ— ç¼é›†æˆ**

âœ… **æœ¬åœ°è°ƒè¯• & Web UI æäº¤ Job**

âœ… **ç»Ÿä¸€ç‰ˆæœ¬ç®¡ç†ï¼Œç¡®ä¿ç¨³å®šè¿è¡Œ**

**é™„å½•å‚è€ƒ**

| **é“¾æ¥** | **å¤‡æ³¨** |
| --- | --- |
| [Flink WebUI è¯¦è§£](https://www.jianshu.com/p/70fbf632887e) | ä½œè€…å¾ˆè¯¦ç»†çš„è¯´æ˜äº†webUIçš„ç›¸å…³æ“ä½œï¼Œä»‹ç»äº†å¸¸ç”¨æ“ä½œï¼Œä¸€äº›å‚æ•°é…ç½®å«ä¹‰ï¼Œå¯¹äºæ–°æ‰‹ä¸Šæ‰‹éå¸¸å‹å¥½ã€‚ |
| [Checkpointing](https://nightlies.apache.org/flink/flink-docs-release-1.17/zh/docs/dev/datastream/fault-tolerance/checkpointing/) | ä¸»è¦å…³æ³¨é…ç½®éƒ¨åˆ† |
| [ç”Ÿæˆ Watermark](https://nightlies.apache.org/flink/flink-docs-release-1.17/zh/docs/dev/datastream/event-time/generating_watermarks/) | æ°´ä½çº¿çš„ç”Ÿæˆç­–ç•¥ï¼Œä½¿ç”¨åŠŸèƒ½ä¹‹å‰å»ºè®®é˜…è¯»ä¸€ä¸‹å®˜æ–¹æ–‡æ¡£çš„æè¿°ï¼Œä¾¿äºç†è§£çš„æ›´åŠ æ·±åˆ»ã€‚ |
| [çª—](https://nightlies.apache.org/flink/flink-docs-release-1.17/zh/docs/dev/datastream/operators/windows/) | å¾ˆè¯¦ç»†çš„æè¿°äº†çª—å£åŒ…æ‹¬ç”Ÿå‘½å‘¨æœŸï¼Œä¸åŒçš„çª—å£å«ä¹‰ä»¥åŠä¾§é‡ï¼Œå¦‚ä½•è§¦å‘ä»¥åŠç¨‹åºç¼–å†™ç­‰ã€‚ |
| [Savepoints](https://nightlies.apache.org/flink/flink-docs-release-1.17/zh/docs/ops/state/savepoints/) | è¯¦ç»†ä»‹ç»äº†savepointï¼Œä»¥åŠå¦‚ä½•è§¦å‘ä½¿ç”¨ã€‚åŒæ—¶åŒ…å«äº†ä½¿ç”¨savepointçš„å¸¸è§é—®é¢˜ï¼Œç½—åˆ—åœ¨ä¸‹é¢ï¼Œå¾ˆå…·æœ‰å‚è€ƒæ„ä¹‰ |
| [æ¦‚è§ˆ](https://nightlies.apache.org/flink/flink-docs-release-1.17/zh/docs/dev/datastream/overview/) | dataStreamAPIå¿«é€Ÿå…¥é—¨ï¼Œå¦‚ä½•å¿«é€Ÿå¼€å‘ä¸€ä¸ªFlink Job
æœ¬ä»“åº“çš„æ„ä¹‰ä¹Ÿæƒ³å®ç°è¯¥ç›®çš„ï¼Œå°†è¯¥æ–‡ç« åŒæ ·é™„å½•åœ¨æ­¤ï¼Œæ–¹ä¾¿æ£€ç´¢ |
| docker-composeç¼–æ’
[github.dev](https://github.dev/pinpoint-apm/pinpoint-docker/tree/master/pinpoint-flink) | ç†è§£dockerFile docker-entrypoint docker-composeå‡ ä¸ªæ–‡ä»¶ç›¸äº’å…³ç³» |
| [juejin.cn](https://juejin.cn/post/7128942475657347109#heading-2) | å®Œæ•´çš„ä»‹ç»äº†Flinkçš„å„ç§éƒ¨ç½²æ–¹å¼ï¼ŒåŒæ—¶å„ç§éƒ¨ç½²æ–¹å¼çš„æ¶æ„å›¾ä¹ŸåŒæ ·å‡ºå…·ï¼Œå¾ˆå…·æœ‰å‚è€ƒæ€§ |
| 1. [What's the difference between flink application cluster and job cluster](https://stackoverflow.com/questions/75604809/whats-the-difference-between-flink-application-cluster-and-job-cluster#:~:text=A%20Flink%20Application%20Cluster%20is,executes%20a%20single%20Flink%20Job.)
2. [Developing job for Flink](https://stackoverflow.com/questions/70636512/developing-job-for-flink) | SOä¸Šæ¦‚å¿µè¾¨æä»¥åŠå¦‚ä½•éƒ¨ç½²Flink Jobï¼Œé«˜èµå›ç­” |

