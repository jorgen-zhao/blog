---
title: æ•°æ®åˆ†æ
date: 2025-03-08 23:17:49
permalink: /pages/8dd040/
categories:
  - å¼€å‘æ—¥å¿—
tags:
  - Apache Flink
  - ClickHouse
  - æ•°æ®åˆ†æ
author: 
  name: Jorgen
  link: https://github.com/jorgen-zhao
---

ğŸš€ Flink + ClickHouseï¼šç‰©è”ç½‘å®æ—¶æ•°æ®å¤„ç†çš„é»„é‡‘æ­æ¡£

<!-- more -->

## ğŸŒŸ èƒŒæ™¯ä»‹ç»

åœ¨ç‰©è”ç½‘ï¼ˆIoTï¼‰é¢†åŸŸï¼Œè®¾å¤‡æ•°æ®æºæºä¸æ–­åœ°äº§ç”Ÿï¼Œæ•°æ®é‡å¤§ã€æ—¶æ•ˆæ€§é«˜ï¼Œå¦‚ä½•é«˜æ•ˆå¤„ç†ã€å­˜å‚¨å¹¶å¿«é€ŸæŸ¥è¯¢ï¼Œæˆäº†æ¯ä¸ªæŠ€æœ¯å›¢é˜Ÿå¿…é¡»é¢å¯¹çš„é—®é¢˜ã€‚ğŸ’¡

åœ¨è¿™ç‰‡æ•°æ®çš„æµ·æ´‹é‡Œï¼Œæˆ‘ä»¬æ‰¾åˆ°äº† Flink + ClickHouse è¿™å¯¹é»„é‡‘æ­æ¡£ï¼š

- **Apache Flink**ï¼šæµå¤„ç†ç¥å™¨ï¼Œèƒ½å®æ—¶è®¡ç®—ã€å¤„ç†å¤æ‚äº‹ä»¶ã€‚
- **ClickHouse**ï¼šé«˜æ€§èƒ½åˆ—å¼æ•°æ®åº“ï¼Œé€‚åˆé«˜ååã€å®æ—¶æŸ¥è¯¢ã€‚

Flink è´Ÿè´£æ•°æ®æµå¼å¤„ç†ï¼ŒClickHouse è´Ÿè´£é«˜æ•ˆå­˜å‚¨å’ŒæŸ¥è¯¢ã€‚ä¸¤è€…ç»“åˆï¼Œèƒ½è®© IoT æ•°æ®å¤„ç†æ›´ä¸æ»‘ã€æ›´é«˜æ•ˆï¼ğŸ¯

---

## ğŸ” Flink & ClickHouse å„è‡ªçš„ç‰¹ç‚¹

### ğŸŒŠ Apache Flinkï¼šå®æ—¶æµå¤„ç†å¼•æ“

Flink æ˜¯ä¸€æ¬¾åˆ†å¸ƒå¼æµå¤„ç†æ¡†æ¶ï¼Œä¸“æ³¨äºä½å»¶è¿Ÿã€é«˜ååçš„æµå¼è®¡ç®—ã€‚å®ƒçš„ä¸»è¦ç‰¹ç‚¹åŒ…æ‹¬ï¼š

âœ… **Exactly-once è¯­ä¹‰**ï¼šä¿è¯æ•°æ®ä¸ä¼šé‡å¤å¤„ç†ï¼Œä¹Ÿä¸ä¼šä¸¢å¤±ã€‚

âœ… **äº‹ä»¶æ—¶é—´ï¼ˆEvent Timeï¼‰æ”¯æŒ**ï¼šå¯ä»¥åŸºäºäº‹ä»¶çš„å‘ç”Ÿæ—¶é—´è€Œä¸æ˜¯ç³»ç»Ÿæ—¶é—´è¿›è¡Œè®¡ç®—ã€‚

âœ… **å¼ºå¤§çš„çª—å£æœºåˆ¶**ï¼šæ”¯æŒæ»šåŠ¨çª—å£ã€æ»‘åŠ¨çª—å£ã€ä¼šè¯çª—å£ç­‰ï¼Œé€‚ç”¨äºå„ç§åœºæ™¯ã€‚

âœ… **çŠ¶æ€ç®¡ç†**ï¼šé«˜æ•ˆçš„çŠ¶æ€å­˜å‚¨å’Œæ¢å¤ï¼Œé€‚åˆå¤„ç†æœ‰çŠ¶æ€çš„æµè®¡ç®—ã€‚

âœ… **ä¸°å¯Œçš„è¿æ¥å™¨**ï¼šæ”¯æŒ Kafkaã€MySQLã€ClickHouseã€Elasticsearch ç­‰å¤šç§æ•°æ®æºå’Œç›®æ ‡ã€‚

ç›¸æ¯”äº **Spark Streaming**ï¼ŒFlink å¤„ç†çœŸæ­£çš„æµæ•°æ®ï¼Œè€Œ Spark Streaming é‡‡ç”¨å¾®æ‰¹ï¼ˆMicro-Batchï¼‰æ¨¡å¼ï¼Œå»¶è¿Ÿè¾ƒé«˜ã€‚

---

### ğŸ† ClickHouseï¼šé«˜æ€§èƒ½åˆ—å¼æ•°æ®åº“

ClickHouse æ˜¯ä¸€æ¬¾ä¸“ä¸º**OLAP**ï¼ˆåœ¨çº¿åˆ†æå¤„ç†ï¼‰ä¼˜åŒ–çš„åˆ—å¼å­˜å‚¨æ•°æ®åº“ï¼Œå…·å¤‡ä»¥ä¸‹ä¼˜åŠ¿ï¼š

âœ… **åˆ—å¼å­˜å‚¨**ï¼šæ•°æ®æŒ‰åˆ—å­˜å‚¨ï¼ŒæŸ¥è¯¢æ—¶åªè¯»å–ç›¸å…³åˆ—ï¼Œå¤§å¹…å‡å°‘ IOã€‚

âœ… **æè‡´å‹ç¼©**ï¼šæ”¯æŒå¤šç§é«˜æ•ˆå‹ç¼©ç®—æ³•ï¼Œæ•°æ®å ç”¨æ›´å°‘å­˜å‚¨ç©ºé—´ã€‚

âœ… **MergeTree å¼•æ“**ï¼šæ”¯æŒè‡ªåŠ¨æ•°æ®åˆå¹¶ã€åˆ†åŒºã€ç´¢å¼•ä¼˜åŒ–ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡ã€‚

âœ… **é«˜å¹¶å‘æŸ¥è¯¢**ï¼šé€‚åˆå¤§è§„æ¨¡æ•°æ®åˆ†æï¼ŒæŸ¥è¯¢é€Ÿåº¦è¿œè¶…ä¼ ç»Ÿå…³ç³»å‹æ•°æ®åº“ã€‚

âœ… **åˆ†å¸ƒå¼æ¶æ„**ï¼šå¯ä»¥æ¨ªå‘æ‰©å±•ï¼Œé€‚ç”¨äº PB çº§æ•°æ®å­˜å‚¨å’ŒæŸ¥è¯¢ã€‚

ä¸ **Elasticsearch** ç›¸æ¯”ï¼ŒClickHouse åœ¨ç»“æ„åŒ–æ•°æ®åˆ†æä¸Šæ›´å¿«ï¼Œé€‚ç”¨äº BI å’ŒæŠ¥è¡¨æŸ¥è¯¢ï¼Œè€Œ Elasticsearch æ›´æ“…é•¿å…¨æ–‡æœç´¢å’Œéç»“æ„åŒ–æ•°æ®åˆ†æã€‚

---

## ğŸ’¡ ä¸ºä»€ä¹ˆåœ¨ç‰©è”ç½‘é¢†åŸŸé€‚ç”¨ï¼Ÿ

1. **æ•°æ®é‡å¤§**ï¼šæˆåƒä¸Šä¸‡å°è®¾å¤‡ï¼Œæ¯ç§’æˆç™¾ä¸Šåƒæ¡æ•°æ®ï¼Œä¼ ç»Ÿæ¶æ„æ‰›ä¸ä½ã€‚
2. **æ•°æ®æ—¶æ•ˆæ€§è¦æ±‚é«˜**ï¼šè®¾å¤‡çŠ¶æ€ã€å¼‚å¸¸æŠ¥è­¦ã€ä¼ æ„Ÿå™¨æ•°æ®ï¼Œå¿…é¡»å®æ—¶å¤„ç†ï¼Œä¸èƒ½ç­‰ï¼â³
3. **æ•°æ®æŸ¥è¯¢éœ€æ±‚å¤æ‚**ï¼šæ—¢è¦æ”¯æŒå®æ—¶æµå¼è®¡ç®—ï¼ˆFlinkï¼‰ï¼Œä¹Ÿè¦æ”¯æŒå†å²æ•°æ®åˆ†æï¼ˆClickHouseï¼‰ã€‚

Flink å¤„ç†å®æ—¶æ•°æ®æµï¼ŒClickHouse è¿›è¡Œ OLAP åˆ†æï¼Œå®Œç¾é€‚é… IoT ä¸šåŠ¡éœ€æ±‚ï¼ğŸ¯

---

## âš™ï¸ å®ç°ç»†èŠ‚

æˆ‘ä»¬æ¥æ‹†è§£ä¸€ä¸ªå…¸å‹çš„æ•°æ®å¤„ç†æµç¨‹ï¼š

1. **æ•°æ®æº**ï¼ˆIoT è®¾å¤‡ï¼‰ğŸ‘‰ MQTT / Kafka é‡‡é›†æ•°æ®
2. **Flink å¤„ç†**ï¼š
   - æ•°æ®æ¸…æ´—ï¼ˆå»é‡ã€æ ¼å¼åŒ–ã€å¼‚å¸¸å¤„ç†ï¼‰
   - è®¡ç®—èšåˆï¼ˆè®¾å¤‡çŠ¶æ€ã€æµé‡ç»Ÿè®¡ã€å‘Šè­¦æ£€æµ‹ï¼‰
3. **å†™å…¥ ClickHouse**ï¼š
   - é‡‡ç”¨ **`MergeTree`** è¡¨å¼•æ“ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡
   - åˆ©ç”¨ **`Materialized View`** é¢„è®¡ç®—ï¼Œæé«˜å“åº”é€Ÿåº¦
4. **æ•°æ®æŸ¥è¯¢ & å¯è§†åŒ–**ï¼š
   - Grafana / Superset ç›´æ¥æŸ¥è¯¢ ClickHouseï¼Œå®æ—¶å±•ç¤ºè®¾å¤‡çŠ¶æ€ğŸ“Š

æ¶æ„ç¤ºæ„å›¾ï¼š
```plaintext
   +-------------+      +----------+      +-------------+      +------------+
   |  IoT è®¾å¤‡   | ---> |    MQ    | ---> |   Flink     | ---> | ClickHouse |
   +-------------+      +----------+      +-------------+      +------------+
```

ğŸ“Š **å®æµ‹æ•°æ®**ï¼š
- **50å°æœºå™¨äºº**ï¼Œæ¯ç§’**60æ¡**æ•°æ®ä¸ŠæŠ¥
- **å­˜é‡æ•°æ®**çº¦**2GB**ï¼Œå¤§çº¦**4äº¿**æ¡
- æ¯æ¡æ¶ˆæ¯**0.5KB**ï¼Œ10åˆ†é’Ÿåèƒ½è¿½ä¸Šæ¶ˆè´¹é€Ÿåº¦
- **ClickHouse å¼€å¯å‹ç¼©åï¼Œç£ç›˜ä½¿ç”¨æ¯”æ¶ˆæ¯é˜Ÿåˆ—å‡å°‘ 3/4**
- **ClickHouse ç»“åˆ S3**ï¼Œå¯è¿›ä¸€æ­¥ä¼˜åŒ–å­˜å‚¨ï¼Œå‡å°‘ç£ç›˜å ç”¨ï¼Œé™ä½æˆæœ¬ ğŸ’°

---

## âš ï¸ Flink + ClickHouse ç»“åˆçš„æ³¨æ„äº‹é¡¹

âœ… **æ‰¹é‡å†™å…¥ ClickHouse**ï¼šé¿å…å•æ¡æ’å…¥ï¼Œä½¿ç”¨ `max_insert_block_size` è°ƒä¼˜ã€‚

âœ… **æ•°æ®åˆ†åŒºç­–ç•¥**ï¼šåˆç†é€‰æ‹©åˆ†åŒºé”®ï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½ã€‚

âœ… **æ•°æ®èšåˆ**ï¼šä½¿ç”¨ ClickHouse `Materialized View` é¢„è®¡ç®—ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡ã€‚

âœ… **Flink Checkpoint**ï¼šç¡®ä¿æ•°æ®å¤„ç†çš„å¯é æ€§ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±ã€‚

âœ… **ClickHouse è¿æ¥æ± **ï¼šä¼˜åŒ– `jdbc:clickhouse` è¿æ¥æ± ï¼Œæé«˜ååé‡ã€‚

---

## âœï¸ ç¤ºä¾‹ä»£ç 

### 1ï¸âƒ£ Flink æ¶ˆè´¹ Kafka å¹¶å†™å…¥ ClickHouse

```java
StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();

Properties props = new Properties();
props.setProperty("bootstrap.servers", "kafka-broker:9092");
props.setProperty("group.id", "flink-iot-group");

FlinkKafkaConsumer<String> consumer = new FlinkKafkaConsumer<>(
        "iot_topic",
        new SimpleStringSchema(),
        props);

DataStream<String> stream = env.addSource(consumer);

DataStream<IoTData> parsedStream = stream.map(json -> parseIoTData(json));

parsedStream.addSink(new ClickHouseSink("jdbc:clickhouse://clickhouse-server:8123/iot_db"));

env.execute("IoT Flink to ClickHouse");
```

### 2ï¸âƒ£ ClickHouse è¡¨ç»“æ„

```sql
CREATE TABLE iot_data (
    device_id String,
    temperature Float32,
    humidity Float32,
    timestamp DateTime
) ENGINE = MergeTree()
ORDER BY (device_id, timestamp);
```

---

## ğŸ˜† é²è¿…æ›¾è¯´......

> "æ•°æ®å¦‚æµæ°´ï¼Œå¤„ç†éœ€åŠæ—¶ã€‚" 

![luxun](https://cdn.jsdelivr.net/gh/jorgen-zhao/picGo/blog/luxun.jpg)
