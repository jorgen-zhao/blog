---
title: 权限设计
date: 2022-07-24 21:58:22
permalink: /pages/a2afbe/
categories:
  - 开发日志
  - LiteIoT
  - 功能实现
tags:
  - 
author: 
  name: Jorgen
  link: https://gitee.com/jorgenme
---
# 二、权限设计思路

1. 抽象实体：用户、角色、菜单、资源

    ```txt
    user
    role 
    menu
    element
    resource_authority：role_id（role.id）、resource_Id（element.id  + menu.id）、resource_type(menu、button)
    base_user_role : user_id（user.id）、role_id(role.id)
    ```

2. 实体对应关系

3. 菜单如何生成加载
    菜单设计规则：一级菜单100递增、二级菜单10递增、三级菜单1递增

    ```json
    -- 权限管理 [100]
    	--  基础配置管理 [110]
    		--  用户管理 [111]
    
    -- 系统管理 [200]
    	--  配置管理 [210]
    ```

1. **用户如何实现鉴权？**

    **SpringCloud Gateway**

    1. 配置文件

       * Filter过滤器：拦截/修改请求，对上游响应进行二次处理
       * Routes路由：网关配置的基本组织模块
         * ID：自定义的路由ID，唯一
         * 目标URI：目标服务地址
         * 一组断言：路由条件，接受一个输入参数，返回Boolean
         * 一组过滤器：router 与 predict必须同时申明
       * Predicate断言
         * 匹配来自HTTP请求的任何内容
         * 输入类型ServerWebExchange
         * 支持多种写法，常见如：Path、Query、Method、Header等。遵循key=value形式

       ```yaml
       spring:
         cloud:
           gateway:
             default-filters:
                - DedupeResponseHeader=Vary Access-Control-Allow-Origin Access-Control-Allow-Credentials, RETAIN_FIRST
             globalcors:
                add-to-simple-url-handler-mapping: true
                corsConfigurations:
                  '[/**]':
                    allowed-origins: https://convercomm.com, https://www.convercomm.com, https://wx.convercomm.com
                    allowed-methods: "*"
                    allowed-headers: "*"
                    allow-credentials: true
             routes:
               # =====================================
               - id: bms-auth
                 uri: lb://bms-admin
                 order: 8000
                 predicates:
                 - RequestBody=true
                 - Path=/api/auth/**
                 filters:
                 - StripPrefix=2 # 如果前端请求地址为 /api/auth/xxx 则过滤后为 /auth/xxx
               - id: bms-admin
                 uri: lb://bms-admin
                 order: 8001
                 predicates:
                 - RequestBody=true
                 - Path=/api/admin/**
                 filters:
                 - StripPrefix=2
       ```

    2. 网关过滤器

       1. 所有前端接口通过网关过滤器，获取当前请求的地址`uri`，先判断`uri`在权限池中是否存在，通过正则进行比对，如果不存在直接返回true。当前`uri`不受权限管控；
       2. 判断当前用户是否有访问资源的权限：通过用户名 `username`获取`menu与element资源（permission）`【用户的权限池】，判断请求`uri`是否在用户的权限池中，如果没有，则没有权限访问。
       
       ```java
       @Configuration
       public class AccessGatewayFilter implements GlobalFilter {
           @Override
           public Mono<Void> filter(ServerWebExchange serverWebExchange, GatewayFilterChain gatewayFilterChain) {}
       }
       ```
       
       参考：[SpingCloud Gateway详解](https://www.cnblogs.com/crazymakercircle/p/11704077.html)

    **SpingBoot 拦截器**

    1. 定义拦截器

       ```java
       public class UserAuthRestInterceptor extends HandlerIntercepterAdapter {
       
       	preHandle(){
       	 // 解析token, 设置当前访问用户的Id, username, name信息
       	}
       	
       	afterCompletion(){
       	 // 清除当前用户访问信息
       	 BaseContextHandler.remove()
       	}
       }
       ```

    2. 配置拦截器

       ```java
       @Configuration("admimWebConfig")
       public class WebConfiguration implements WebMvcConfigurer {
       
           @Override
           public void addInterceptors(InterceptorRegistry registry) {
               registry
                   .addInterceptor(getUserAuthRestInterceptor()) // 将定义好的拦截器进行注入
                   .addPathPatterns(getIncludePathPatterns());  //  将需要拦截的接口进行注入
           }
           // 将定义好的拦截器进行声明
       	@Bean
           UserAuthRestInterceptor getUserAuthRestInterceptor() {
               return new UserAuthRestInterceptor();
           }
       
           // 定义需要拦截的接口path
           private ArrayList<String> getIncludePathPatterns() {
               String[] urls = {"/element/**"}
       }
       ```

    参考：[拦截器配置](https://www.cnblogs.com/swzx-1213/p/12788576.html)


