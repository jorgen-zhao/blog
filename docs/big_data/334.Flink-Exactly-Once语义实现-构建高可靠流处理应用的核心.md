---
title: Flink Exactly-Onceè¯­ä¹‰å®ç°-æ„å»ºé«˜å¯é æµå¤„ç†åº”ç”¨çš„æ ¸å¿ƒ
date: 2026-01-28
tags: [Flink, æµå¤„ç†, å®¹é”™æœºåˆ¶]
---

## å‰è¨€

åœ¨æµå¤„ç†çš„ä¸–ç•Œä¸­ï¼Œæ•°æ®ä¸€è‡´æ€§æ˜¯ä¸€ä¸ªæ°¸æ’çš„è¯é¢˜ã€‚å½“æˆ‘ä»¬è°ˆè®ºæµå¤„ç†ç³»ç»Ÿçš„å¯é æ€§æ—¶ï¼ŒExactly-Onceè¯­ä¹‰æ— ç–‘æ˜¯è¡¡é‡ä¸€ä¸ªç³»ç»Ÿæˆç†Ÿåº¦çš„é‡è¦æŒ‡æ ‡ã€‚ğŸ—

> Exactly-Onceè¯­ä¹‰æ„å‘³ç€å³ä½¿ç³»ç»Ÿå‘ç”Ÿæ•…éšœï¼Œæ¯æ¡æ•°æ®ä¹Ÿåªä¼šè¢«ç²¾ç¡®å¤„ç†ä¸€æ¬¡ï¼Œæ—¢ä¸ä¼šä¸¢å¤±ï¼Œä¹Ÿä¸ä¼šé‡å¤å¤„ç†ã€‚

Apache Flinkä½œä¸ºä¸šç•Œé¢†å…ˆçš„æµå¤„ç†å¼•æ“ï¼Œå…¶Exactly-Onceè¯­ä¹‰çš„å®ç°æœºåˆ¶æ˜¯å…¶æ ¸å¿ƒç«äº‰åŠ›ä¹‹ä¸€ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨Flinkå¦‚ä½•å®ç°ç«¯åˆ°ç«¯çš„Exactly-Onceè¯­ä¹‰ï¼Œä»¥åŠåœ¨å®é™…åº”ç”¨ä¸­å¦‚ä½•é…ç½®å’Œä¼˜åŒ–è¿™ä¸€ç‰¹æ€§ã€‚

## Exactly-Onceçš„é‡è¦æ€§

åœ¨å¼€å§‹æ·±å…¥æŠ€æœ¯ç»†èŠ‚ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥ç†è§£ä¸ºä»€ä¹ˆExactly-Onceå¦‚æ­¤é‡è¦ï¼š

1. **æ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿ä¸šåŠ¡é€»è¾‘çš„æ­£ç¡®æ‰§è¡Œï¼Œé¿å…å› æ•°æ®é‡å¤æˆ–ä¸¢å¤±å¯¼è‡´çš„è®¡ç®—é”™è¯¯
2. **ä¸šåŠ¡å‡†ç¡®æ€§**ï¼šå¯¹äºé‡‘èã€ç”µå•†ç­‰å¯¹æ•°æ®å‡†ç¡®æ€§è¦æ±‚æé«˜çš„åœºæ™¯ï¼ŒExactly-Onceæ˜¯åˆšéœ€
3. **ç³»ç»Ÿå¯é æ€§**ï¼šæä¾›æ•…éšœæ¢å¤èƒ½åŠ›ï¼ŒåŒæ—¶ä¿è¯æ•°æ®å¤„ç†çš„ç²¾ç¡®æ€§

## Flinkä¸­çš„Exactly-Onceå®ç°æœºåˆ¶

### 1. Checkpointæœºåˆ¶

Flinkçš„Exactly-Onceè¯­ä¹‰æ ¸å¿ƒä¾èµ–äºå…¶å¼ºå¤§çš„Checkpointæœºåˆ¶ã€‚ğŸ’¡

::: theorem
Checkpointæœºåˆ¶æ˜¯Flinkå®ç°å®¹é”™å’ŒçŠ¶æ€æ¢å¤çš„åŸºç¡€ï¼Œé€šè¿‡å®šæœŸä¿å­˜åˆ†å¸ƒå¼æ•°æ®æµçš„å¿«ç…§ï¼Œç¡®ä¿ç³»ç»Ÿåœ¨æ•…éšœåèƒ½å¤Ÿä»ä¸€è‡´çš„çŠ¶æ€æ¢å¤ã€‚
:::

Checkpointçš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š

1. **Barrierå¯¹é½**ï¼šFlinkåœ¨æ•°æ®æµä¸­æ’å…¥ç‰¹æ®Šçš„Barrierï¼Œè¿™äº›Barrierä¼šéšç€æ•°æ®ä¸€èµ·æµåŠ¨
2. **çŠ¶æ€å¿«ç…§**ï¼šå½“Operatoræ¥æ”¶åˆ°æ‰€æœ‰Barrieråï¼Œå°†å…¶çŠ¶æ€ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨
3. **ç¡®è®¤æäº¤**ï¼šå¿«ç…§å®Œæˆåï¼Œå‘JobManagerç¡®è®¤æäº¤

```mermaid
graph LR
    A[Source] -->|Barrier| B(Operator 1)
    B -->|Barrier| C(Operator 2)
    B -->|Barrier| D(Operator 3)
    C -->|å¿«ç…§| E[çŠ¶æ€å­˜å‚¨]
    D -->|å¿«ç…§| E
```

### 2. ä¸¤é˜¶æ®µæäº¤åè®®(2PC)

å¯¹äºéœ€è¦ä¸å¤–éƒ¨ç³»ç»Ÿäº¤äº’çš„åœºæ™¯ï¼ŒFlinké€šè¿‡ä¸¤é˜¶æ®µæäº¤åè®®(2PC)æ¥å®ç°ç«¯åˆ°ç«¯çš„Exactly-Onceè¯­ä¹‰ã€‚

::: tip
ç«¯åˆ°ç«¯Exactly-Onceä¸ä»…åŒ…æ‹¬Flinkå†…éƒ¨çš„ç²¾ç¡®ä¸€æ¬¡å¤„ç†ï¼Œè¿˜åŒ…æ‹¬ä¸å¤–éƒ¨ç³»ç»Ÿ(å¦‚Kafkaã€HDFSç­‰)çš„ç²¾ç¡®ä¸€æ¬¡äº¤äº’ã€‚
:::

#### 2.1 é¢„æäº¤é˜¶æ®µ

1. Flinkå‘æ‰€æœ‰å‚ä¸äº‹åŠ¡çš„å¤–éƒ¨ç³»ç»Ÿå‘é€"é¢„æäº¤"è¯·æ±‚
2. å¤–éƒ¨ç³»ç»Ÿå‡†å¤‡äº‹åŠ¡ä½†ä¸æäº¤
3. Flinkä¿å­˜åŒ…å«æ‰€æœ‰é¢„æäº¤ä¿¡æ¯çš„Checkpoint

#### 2.2 æäº¤é˜¶æ®µ

1. Checkpointå®Œæˆåï¼ŒFlinké€šçŸ¥æ‰€æœ‰å¤–éƒ¨ç³»ç»Ÿæäº¤äº‹åŠ¡
2. å¦‚æœç³»ç»Ÿæ¢å¤ï¼ŒFlinkåªä¼šæäº¤å·²æˆåŠŸä¿å­˜çš„Checkpointå¯¹åº”çš„äº‹åŠ¡

### 3. Kafkaè¿æ¥å™¨çš„Exactly-Onceæ”¯æŒ

ä½œä¸ºæœ€å¸¸è§çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒKafkaä¸Flinkçš„Exactly-Onceé›†æˆå°¤ä¸ºé‡è¦ï¼š

```java
Properties properties = new Properties();
properties.setProperty("bootstrap.servers", "localhost:9092");
properties.setProperty("group.id", "flink-exactly-once");
properties.setProperty("isolation.level", "read_committed"); // è¯»å–å·²æäº¤æ¶ˆæ¯
properties.setProperty("enable.auto.commit", "false"); // ç¦ç”¨è‡ªåŠ¨æäº¤

FlinkKafkaConsumer<String> kafkaSource = new FlinkKafkaConsumer<>(
    "topic",
    new SimpleStringSchema(),
    properties
);
kafkaSource.setStartFromLatest();
```

å…³é”®é…ç½®ç‚¹ï¼š
- `isolation.level`: è®¾ç½®ä¸º`read_committed`ï¼Œåªè¯»å–å·²æäº¤çš„æ¶ˆæ¯
- `enable.auto.commit`: ç¦ç”¨è‡ªåŠ¨æäº¤ï¼Œç”±Flinkæ§åˆ¶æ¶ˆè´¹åç§»é‡
- ä½¿ç”¨Kafkaäº‹åŠ¡APIç¡®ä¿æ¶ˆæ¯å†™å…¥å’Œåç§»é‡æ›´æ–°çš„åŸå­æ€§

## é…ç½®Exactly-Onceè¯­ä¹‰

### 1. å¯ç”¨Checkpoint

```java
StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();

// å¯ç”¨Checkpointï¼Œæ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
env.enableCheckpointing(60000);

// è®¾ç½®è¯­ä¹‰ä¸ºEXACTLY_ONCE
env.getCheckpointConfig().setCheckpointingMode(CheckpointingMode.EXACTLY_ONCE);

// ç¡®ä¿Checkpointä¹‹é—´è‡³å°‘æœ‰500msçš„é—´éš”
env.getCheckpointConfig().setMinPauseBetweenCheckpoints(500);

// Checkpointå¿…é¡»åœ¨10åˆ†é’Ÿå†…å®Œæˆï¼Œå¦åˆ™è¶…æ—¶
env.getCheckpointConfig().setCheckpointTimeout(600000);

// åŒä¸€ä¸ªæ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªCheckpointåœ¨è¿è¡Œ
env.getCheckpointConfig().setMaxConcurrentCheckpoints(1);

// å¤–éƒ¨æŒä¹…åŒ–å­˜å‚¨è·¯å¾„
env.setStateBackend(new RocksDBStateBackend("file:///path/to/checkpoint"));
```

### 2. ä½¿ç”¨æ”¯æŒExactly-Onceçš„å¤–éƒ¨ç³»ç»Ÿ

ä¸åŒçš„å¤–éƒ¨ç³»ç»Ÿå¯¹Exactly-Onceçš„æ”¯æŒç¨‹åº¦ä¸åŒï¼š

| å¤–éƒ¨ç³»ç»Ÿ | æ”¯æŒç¨‹åº¦ | å®ç°æ–¹å¼ |
|---------|---------|---------|
| Kafka | å®Œå…¨æ”¯æŒ | äº‹åŠ¡API + å¹‚ç­‰å†™å…¥ |
| HDFS | å®Œå…¨æ”¯æŒ | åŸå­é‡å‘½åæ“ä½œ |
| Elasticsearch | éƒ¨åˆ†æ”¯æŒ | å¹‚ç­‰å†™å…¥ + å”¯ä¸€é”® |
| MySQL | éƒ¨åˆ†æ”¯æŒ | å¹‚ç­‰å†™å…¥ |

### 3. å®ç°å¹‚ç­‰å†™å…¥

å¯¹äºä¸æ”¯æŒåŸç”Ÿäº‹åŠ¡çš„å¤–éƒ¨ç³»ç»Ÿï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ä¸šåŠ¡é€»è¾‘å®ç°å¹‚ç­‰å†™å…¥ï¼š

```java
// ä½¿ç”¨ä¸šåŠ¡ä¸»é”®ä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼Œé¿å…é‡å¤å†™å…¥
DataStream<Tuple2<String, Integer>> result = ...;

result.addSink(new RichSinkFunction<Tuple2<String, Integer>>() {
    private transient PreparedStatement insertStatement;
    private transient PreparedStatement updateStatement;
    
    @Override
    public void open(Configuration parameters) throws Exception {
        Connection connection = getDbConnection();
        
        // æ’å…¥è¯­å¥ï¼ˆä½¿ç”¨ON DUPLICATE KEY UPDATEå®ç°å¹‚ç­‰ï¼‰
        insertStatement = connection.prepareStatement(
            "INSERT INTO metrics (metric_key, metric_value) VALUES (?, ?) " +
            "ON DUPLICATE KEY UPDATE metric_value = ?"
        );
    }
    
    @Override
    public void invoke(Tuple2<String, Integer> value, Context context) throws Exception {
        // æ— è®ºæ˜¯å¦å·²å­˜åœ¨ï¼Œæ‰§è¡Œç›¸åŒçš„æ’å…¥æ“ä½œ
        insertStatement.setString(1, value.f0);
        insertStatement.setInt(2, value.f1);
        insertStatement.setInt(3, value.f1);
        insertStatement.executeUpdate();
    }
});
```

## Exactly-Onceçš„æ€§èƒ½è€ƒé‡

å®ç°Exactly-Onceè¯­ä¹‰é€šå¸¸ä¼šå¸¦æ¥ä¸€å®šçš„æ€§èƒ½å¼€é”€ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä¸€è‡´æ€§å’Œæ€§èƒ½ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ç‚¹ï¼š

### 1. Checkpointé¢‘ç‡

- **é¢‘ç¹Checkpoint**ï¼šæé«˜æ•°æ®å®‰å…¨æ€§ï¼Œä½†å¢åŠ I/Oå¼€é”€
- **ç¨€ç–Checkpoint**ï¼šå‡å°‘I/Oå¼€é”€ï¼Œä½†å¢åŠ æ•…éšœæ¢å¤æ—¶çš„æ•°æ®é‡æ”¾é‡

### 2. å¼‚æ­¥Checkpoint

Flinkæ”¯æŒå¼‚æ­¥Checkpointï¼Œå°†çŠ¶æ€å¿«ç…§ä¸æ•°æ®å¤„ç†åˆ†ç¦»ï¼š

```java
env.getCheckpointConfig().setCheckpointingMode(CheckpointingMode.EXACTLY_ONCE);
env.getCheckpointConfig().enableUnalignedCheckpoints(); // å¯ç”¨éå¯¹é½Checkpoint
```

éå¯¹é½Checkpointå¯ä»¥å‡å°‘Barrierå¯¹é½å¸¦æ¥çš„å»¶è¿Ÿï¼Œç‰¹åˆ«é€‚åˆå¤„ç†èƒŒå‹ä¸¥é‡çš„åœºæ™¯ã€‚

### 3. å¢é‡Checkpoint

å¯¹äºå¤§è§„æ¨¡çŠ¶æ€ï¼Œå¯ä»¥ä½¿ç”¨å¢é‡Checkpointå‡å°‘å­˜å‚¨ç©ºé—´å’ŒI/Oå¼€é”€ï¼š

```java
env.setStateBackend(new RocksDBStateBackend("file:///path/to/checkpoint", true)); // å¯ç”¨å¢é‡Checkpoint
```

## Exactly-Once vs At-Least-Once

ç†è§£Exactly-Onceä¸At-Least-Onceçš„åŒºåˆ«å¯¹äºç³»ç»Ÿè®¾è®¡è‡³å…³é‡è¦ï¼š

| ç‰¹æ€§ | Exactly-Once | At-Least-Once |
|------|-------------|---------------|
| æ•°æ®å¤„ç† | æ¯æ¡æ•°æ®ç²¾ç¡®å¤„ç†ä¸€æ¬¡ | æ¯æ¡æ•°æ®è‡³å°‘å¤„ç†ä¸€æ¬¡ |
| é€‚ç”¨åœºæ™¯ | é‡‘èã€äº¤æ˜“ã€è®¡è´¹ | æ—¥å¿—åˆ†æã€ç›‘æ§ |
| å®ç°å¤æ‚åº¦ | é«˜ | ä½ |
| æ€§èƒ½å¼€é”€ | è¾ƒé«˜ | è¾ƒä½ |
| å¤–éƒ¨ç³»ç»Ÿä¾èµ– | éœ€è¦æ”¯æŒäº‹åŠ¡æˆ–å¹‚ç­‰å†™å…¥ | æ— ç‰¹æ®Šè¦æ±‚ |

## Exactly-Onceçš„æœ€ä½³å®è·µ

### 1. åˆç†è®¾ç½®Checkpointé—´éš”

æ ¹æ®ä¸šåŠ¡éœ€æ±‚å’ŒSLAè¦æ±‚ï¼Œé€‰æ‹©åˆé€‚çš„Checkpointé—´éš”ï¼š
- é«˜å»¶è¿Ÿå®¹å¿åœºæ™¯ï¼š5-10åˆ†é’Ÿ
- ä¸­ç­‰å»¶è¿Ÿå®¹å¿åœºæ™¯ï¼š1-5åˆ†é’Ÿ
- ä½å»¶è¿Ÿå®¹å¿åœºæ™¯ï¼š30ç§’-1åˆ†é’Ÿ

### 2. ç›‘æ§CheckpointæŒ‡æ ‡

å¯†åˆ‡å…³æ³¨ä»¥ä¸‹å…³é”®æŒ‡æ ‡ï¼š
- Checkpointå®Œæˆæ—¶é—´
- Checkpointå¤±è´¥ç‡
- çŠ¶æ€å¤§å°å˜åŒ–è¶‹åŠ¿
- Checkpointå¼•èµ·çš„èƒŒå‹æƒ…å†µ

### 3. ä½¿ç”¨å¤–éƒ¨ç³»ç»Ÿçš„äº‹åŠ¡åŠŸèƒ½

å°½å¯èƒ½ä½¿ç”¨å¤–éƒ¨ç³»ç»ŸåŸç”Ÿçš„äº‹åŠ¡æ”¯æŒï¼Œå¦‚Kafkaäº‹åŠ¡ã€HDFSåŸå­æ“ä½œç­‰ã€‚

### 4. å®ç°å¹‚ç­‰è®¾è®¡

å¯¹äºä¸æ”¯æŒäº‹åŠ¡çš„å¤–éƒ¨ç³»ç»Ÿï¼Œåœ¨åº”ç”¨å±‚å®ç°å¹‚ç­‰æ“ä½œï¼Œç¡®ä¿é‡å¤å†™å…¥ä¸ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚

## ç»“è¯­

Exactly-Onceè¯­ä¹‰æ˜¯æ„å»ºé«˜å¯é æµå¤„ç†åº”ç”¨çš„æ ¸å¿ƒï¼Œå®ƒç¡®ä¿äº†æ•°æ®åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„ç²¾ç¡®ä¸€è‡´æ€§ã€‚ğŸ¤”

é€šè¿‡æ·±å…¥ç†è§£Flinkçš„Checkpointæœºåˆ¶ã€ä¸¤é˜¶æ®µæäº¤åè®®ä»¥åŠä¸å¤–éƒ¨ç³»ç»Ÿçš„é›†æˆæ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¿è¯æ•°æ®ä¸€è‡´æ€§çš„åŒæ—¶ï¼Œæœ€å¤§é™åº¦åœ°é™ä½æ€§èƒ½å¼€é”€ã€‚

åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®ä¸šåŠ¡åœºæ™¯ã€SLAè¦æ±‚å’Œç³»ç»Ÿèµ„æºï¼Œåœ¨Exactly-Onceå’ŒAt-Least-Onceä¹‹é—´åšå‡ºåˆç†é€‰æ‹©ï¼Œå¹¶é€šè¿‡ç›‘æ§å’Œè°ƒä¼˜ä¸æ–­ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½ã€‚

> "åœ¨æµå¤„ç†çš„ä¸–ç•Œä¸­ï¼Œæ²¡æœ‰ç»å¯¹çš„ä¸€è‡´æ€§ï¼Œåªæœ‰é€‚åˆä¸šåŠ¡åœºæ™¯çš„æƒè¡¡ã€‚" â€”â€” æµå¤„ç†å“²å­¦

é€šè¿‡åˆç†é…ç½®å’Œè®¾è®¡ï¼ŒFlinkèƒ½å¤Ÿä¸ºå¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯æä¾›å¯é çš„Exactly-Onceè¯­ä¹‰æ”¯æŒï¼Œæˆä¸ºæ„å»ºä¸‹ä¸€ä»£å®æ—¶æ•°æ®ç®¡é“çš„ç†æƒ³é€‰æ‹©ã€‚