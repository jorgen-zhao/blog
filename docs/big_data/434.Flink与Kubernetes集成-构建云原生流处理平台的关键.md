---
title: Flinkä¸Kubernetesé›†æˆ-æ„å»ºäº‘åŸç”Ÿæµå¤„ç†å¹³å°çš„å…³é”®
date: 2026-02-03
tags:
  - Flink
  - Kubernetes
  - äº‘åŸç”Ÿ
---

## å‰è¨€

åœ¨å½“ä»Šå¤§æ•°æ®å’Œå®æ—¶è®¡ç®—é¢†åŸŸï¼ŒApache Flinkå·²æˆä¸ºæµå¤„ç†çš„äº‹å®æ ‡å‡†ï¼Œè€ŒKubernetesåˆ™æˆä¸ºäº†å®¹å™¨ç¼–æ’çš„ç‹è€…ã€‚å½“æˆ‘ç¬¬ä¸€æ¬¡å°è¯•å°†Flinkéƒ¨ç½²åˆ°Kubernetesé›†ç¾¤æ—¶ï¼Œè¯´å®è¯ï¼Œè¿‡ç¨‹å¹¶ä¸é¡ºåˆ©ã€‚ğŸ˜… ä»é…ç½®èµ„æºé™åˆ¶åˆ°è®¾ç½®æœåŠ¡å‘ç°ï¼Œæ¯ä¸€ä¸ªç¯èŠ‚éƒ½å¯èƒ½æˆä¸º"å‘"ã€‚ä½†ä¸€æ—¦æˆåŠŸæ­å»ºèµ·æ¥ï¼Œé‚£ç§å¼¹æ€§ä¼¸ç¼©å’Œè‡ªåŠ¨åŒ–è¿ç»´çš„ä¾¿åˆ©æ€§ï¼ŒçœŸçš„è®©äººçˆ±ä¸é‡Šæ‰‹ï¼

ä»Šå¤©ï¼Œæˆ‘æƒ³å’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹Flinkä¸Kubernetesé›†æˆçš„ç»éªŒï¼Œå¸Œæœ›å¯ä»¥å¸®åŠ©åˆ°é‚£äº›åŒæ ·åœ¨è¿™æ¡è·¯ä¸Šæ¢ç´¢çš„æœ‹å‹ä»¬ã€‚

::: tip
Kubernetesä¸Flinkçš„é›†æˆï¼Œä¸ä»…æ˜¯æŠ€æœ¯ä¸Šçš„ç»“åˆï¼Œæ›´æ˜¯äº‘åŸç”Ÿç†å¿µåœ¨æµå¤„ç†é¢†åŸŸçš„å®è·µã€‚é€šè¿‡è¿™ç§é›†æˆï¼Œæˆ‘ä»¬å¯ä»¥å®ç°çœŸæ­£çš„å¼¹æ€§ä¼¸ç¼©ã€è‡ªåŠ¨åŒ–éƒ¨ç½²å’Œé«˜æ•ˆè¿ç»´ã€‚
:::

## Flink on Kubernetesæ¦‚è¿°

### ä¸ºä»€ä¹ˆéœ€è¦Kubernetesï¼Ÿ

åœ¨æ·±å…¥æŠ€æœ¯ç»†èŠ‚å‰ï¼Œå…ˆæ€è€ƒä¸€ä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦å°†Flinkéƒ¨ç½²åˆ°Kubernetesä¸Šï¼Ÿ

ä¼ ç»Ÿéƒ¨ç½²æ–¹å¼ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨æ‰‹åŠ¨é…ç½®æˆ–è„šæœ¬ç®¡ç†Flinké›†ç¾¤ï¼Œè¿™ç§æ–¹å¼å­˜åœ¨ä»¥ä¸‹ç—›ç‚¹ï¼š

1. **èµ„æºåˆ©ç”¨ç‡ä½**ï¼šæ— æ³•æ ¹æ®è´Ÿè½½åŠ¨æ€è°ƒæ•´èµ„æº
2. **æ‰©å±•æ€§å·®**ï¼šæ‰‹åŠ¨æ‰©ç¼©å®¹ç¹çä¸”å®¹æ˜“å‡ºé”™
3. **è¿ç»´å¤æ‚**ï¼šç¼ºä¹ç»Ÿä¸€çš„ç®¡ç†å¹³å°å’Œç›‘æ§ä½“ç³»
4. **ç¯å¢ƒä¸ä¸€è‡´**ï¼šå¼€å‘ã€æµ‹è¯•å’Œç”Ÿäº§ç¯å¢ƒéš¾ä»¥ä¿æŒä¸€è‡´

è€ŒKubernetesæ°å¥½å¯ä»¥è§£å†³è¿™äº›é—®é¢˜ï¼š

- **å¼¹æ€§ä¼¸ç¼©**ï¼šæ ¹æ®è´Ÿè½½è‡ªåŠ¨è°ƒæ•´èµ„æº
- **å£°æ˜å¼é…ç½®**ï¼šé€šè¿‡YAMLå®šä¹‰åº”ç”¨çŠ¶æ€
- **æœåŠ¡å‘ç°**ï¼šè‡ªåŠ¨æœåŠ¡æ³¨å†Œå’Œå‘ç°æœºåˆ¶
- **è‡ªæˆ‘ä¿®å¤**ï¼šè‡ªåŠ¨æ›¿æ¢å¤±è´¥å®¹å™¨
- **èµ„æºéš”ç¦»**ï¼šç¡®ä¿ä¸åŒåº”ç”¨é—´çš„èµ„æºäº’ä¸å½±å“

### Flink Kubernetes Operator

Flinkå®˜æ–¹æä¾›äº†ä¸¤ç§Kuberneteséƒ¨ç½²æ¨¡å¼ï¼š

1. **Session Cluster**ï¼šå¤šä¸ªä½œä¸šå…±äº«ä¸€ä¸ªé›†ç¾¤ï¼Œé€‚åˆè½»é‡çº§ã€çŸ­æœŸçš„ä½œä¸š
2. **Job Cluster**ï¼šæ¯ä¸ªä½œä¸šè¿è¡Œåœ¨ç‹¬ç«‹çš„é›†ç¾¤ä¸­ï¼Œé€‚åˆé•¿æœŸè¿è¡Œçš„ä½œä¸š

è€ŒFlink Kubernetes Operatoråˆ™æä¾›äº†æ›´é«˜çº§çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š

- è‡ªåŠ¨åŒ–çš„ä½œä¸šç”Ÿå‘½å‘¨æœŸç®¡ç†
- åŸºäºè‡ªå®šä¹‰èµ„æº(CRD)çš„ä½œä¸šå®šä¹‰
- æ•…éšœè‡ªåŠ¨æ¢å¤
- ä½œä¸šçŠ¶æ€ç›‘æ§

## éƒ¨ç½²Flink Session Cluster

### å‰ç½®å‡†å¤‡

åœ¨å¼€å§‹éƒ¨ç½²å‰ï¼Œç¡®ä¿ä½ çš„ç¯å¢ƒå·²æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š

```bash
# å®‰è£…kubectl
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
chmod +x kubectl
sudo mv kubectl /usr/local/bin/

# å®‰è£…Helm
curl https://baltocdn.com/helm/signing.asc | gpg --dearmor | sudo tee /usr/share/keyrings/helm.gpg > /dev/null
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/helm.gpg] https://baltocdn.com/helm/stable/debian/ all main" | sudo tee /etc/apt/sources.list.d/helm-stable-debian.list
sudo apt-get update
sudo apt-get install helm
```

### ä½¿ç”¨Helméƒ¨ç½²Session Cluster

Helmæ˜¯Kubernetesçš„åŒ…ç®¡ç†å™¨ï¼Œå¯ä»¥ç®€åŒ–Flinkçš„éƒ¨ç½²è¿‡ç¨‹ï¼š

```bash
# æ·»åŠ Flink Helmä»“åº“
helm repo add flink-charts https://flink-charts.streamnative.io
helm repo update

# åˆ›å»ºå‘½åç©ºé—´
kubectl create namespace flink

# éƒ¨ç½²Session Cluster
helm install flink-session \
  flink-charts/flink \
  --namespace flink \
  --set image.tag=1.16.0 \
  --set jobManager.replicaCount=1 \
  --set taskManager.replicaCount=2 \
  --set taskManager.cpu=1 \
  --set taskManager.memory="1Gi"
```

### éªŒè¯éƒ¨ç½²

éƒ¨ç½²å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤éªŒè¯Flinké›†ç¾¤æ˜¯å¦æ­£å¸¸è¿è¡Œï¼š

```bash
# æŸ¥çœ‹PodçŠ¶æ€
kubectl get pods -n flink

# æŸ¥çœ‹Job ManageræœåŠ¡
kubectl get svc -n flink

# è®¿é—®Flink UI
kubectl port-forward svc/flink-session-jobmanager 8080:8080 -n flink
```

è®¿é—® http://localhost:8080 å³å¯çœ‹åˆ°Flinkçš„Web UIã€‚

## éƒ¨ç½²Flink Job Cluster

ä¸Session Clusterä¸åŒï¼ŒJob Clusterä¸ºæ¯ä¸ªä½œä¸šåˆ›å»ºç‹¬ç«‹çš„é›†ç¾¤ï¼Œé€‚åˆé•¿æœŸè¿è¡Œçš„ä½œä¸šã€‚

### åˆ›å»ºJob YAMLé…ç½®

```yaml
apiVersion: flink.apache.org/v1beta1
kind: FlinkJob
metadata:
  name: word-count-job
  namespace: flink
spec:
  image: flink:1.16.0-scala_2.12-java11
  flinkVersion: v1_16
  jobManager:
    replicas: 1
    resources:
      limits:
        cpu: "1"
        memory: "1Gi"
      requests:
        cpu: "500m"
        memory: "512Mi"
  taskManager:
    replicas: 2
    resources:
      limits:
        cpu: "1"
        memory: "1Gi"
      requests:
        cpu: "500m"
        memory: "512Mi"
  job:
    jarFile: "local:///opt/flink/examples/streaming/WordCount.jar"
    parallelism: 2
    upgradeMode: stateless
```

### æäº¤Job

```bash
# åº”ç”¨Jobé…ç½®
kubectl apply -f flink-job.yaml

# æŸ¥çœ‹JobçŠ¶æ€
kubectl get flinkjobs -n flink
```

## Flink Kubernetes Operatorè¯¦è§£

Flink Kubernetes Operatoræä¾›äº†æ›´å¼ºå¤§çš„åŠŸèƒ½ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿä»¥å£°æ˜å¼çš„æ–¹å¼ç®¡ç†Flinkä½œä¸šã€‚

### å®‰è£…Flink Kubernetes Operator

```bash
# æ·»åŠ Flink Operator Helmä»“åº“
helm repo add flink-operator-charts https://github.com/flink-operator/flink-operator/releases/download/helm-chart-1.2.0

# å®‰è£…Operator
helm install flink-operator flink-operator-charts/flink-operator \
  --namespace flink-operator \
  --create-namespace
```

### åˆ›å»ºFlinkCluster CRD

```yaml
apiVersion: flink.apache.org/v1beta1
kind: FlinkCluster
metadata:
  name: flink-cluster
  namespace: flink
spec:
  image: flink:1.16.0-scala_2.12-java11
  flinkVersion: v1_16
  serviceAccount: flink-service-account
  jobManager:
    replicas: 1
    resources:
      limits:
        cpu: "1"
        memory: "1Gi"
      requests:
        cpu: "500m"
        memory: "512Mi"
  taskManager:
    replicas: 2
    resources:
      limits:
        cpu: "1"
        memory: "1Gi"
      requests:
        cpu: "500m"
        memory: "512Mi"
  job:
    jarFile: "local:///opt/flink/examples/streaming/WordCount.jar"
    parallelism: 2
    upgradeMode: stateless
```

### ä½¿ç”¨Operatoræäº¤ä½œä¸š

```bash
# åº”ç”¨FlinkClusteré…ç½®
kubectl apply -f flink-cluster.yaml

# æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
kubectl get flinkclusters -n flink
```

## æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹

### èµ„æºç®¡ç†

åœ¨Kubernetesä¸­ç®¡ç†Flinkèµ„æºæ—¶ï¼Œéœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

1. **èµ„æºé™åˆ¶**ï¼šä¸ºJobManagerå’ŒTaskManagerè®¾ç½®é€‚å½“çš„èµ„æºé™åˆ¶
2. **å†…å­˜é…ç½®**ï¼šç¡®ä¿å †å¤–å†…å­˜(Off-heap Memory)é…ç½®æ­£ç¡®
3. **CPUé™åˆ¶**ï¼šé¿å…è¿‡åº¦åˆ†é…CPUå¯¼è‡´ç³»ç»Ÿä¸ç¨³å®š

```yaml
resources:
  limits:
    cpu: "2"
    memory: "2Gi"
  requests:
    cpu: "1"
    memory: "1Gi"
```

### ç½‘ç»œé…ç½®

Kubernetesçš„ç½‘ç»œé…ç½®å¯¹Flinkæ€§èƒ½æœ‰é‡è¦å½±å“ï¼š

1. **Podç½‘ç»œ**ï¼šç¡®ä¿Podé—´ç½‘ç»œå»¶è¿Ÿä½
2. **æœåŠ¡å‘ç°**ï¼šæ­£ç¡®é…ç½®Serviceç±»å‹(ClusterIP, NodePort, LoadBalancer)
3. **ç½‘ç»œç­–ç•¥**ï¼šæ ¹æ®å®‰å…¨éœ€æ±‚é…ç½®NetworkPolicy

### å­˜å‚¨ç®¡ç†

```yaml
volumeClaimTemplates:
- metadata:
    name: flink-data
  spec:
    accessModes: [ "ReadWriteOnce" ]
    resources:
      requests:
        storage: 10Gi
```

### ç›‘æ§ä¸æ—¥å¿—

1. **Prometheusç›‘æ§**ï¼šé…ç½®Flink Prometheus Exporter
2. **æ—¥å¿—æ”¶é›†**ï¼šä½¿ç”¨Fluentdæˆ–Filebeatæ”¶é›†æ—¥å¿—
3. **å‘Šè­¦è§„åˆ™**ï¼šè®¾ç½®åˆç†çš„å‘Šè­¦é˜ˆå€¼

::: theorem
ç›‘æ§æ˜¯ç¡®ä¿Flinké›†ç¾¤ç¨³å®šè¿è¡Œçš„å…³é”®ã€‚å»ºè®®è‡³å°‘ç›‘æ§ä»¥ä¸‹æŒ‡æ ‡ï¼šä½œä¸šå»¶è¿Ÿã€èƒŒå‹æƒ…å†µã€èµ„æºåˆ©ç”¨ç‡ã€GCæƒ…å†µç­‰ã€‚
:::

## å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šä½œä¸šæäº¤å¤±è´¥

**ç—‡çŠ¶**ï¼šä½œä¸šæäº¤åˆ°Kubernetesåä¸€ç›´å¤„äºRUNNINGçŠ¶æ€ï¼Œä½†å®é™…å¹¶æœªå¼€å§‹å¤„ç†æ•°æ®ã€‚

**åŸå› **ï¼šå¯èƒ½æ˜¯èµ„æºä¸è¶³æˆ–é…ç½®é”™è¯¯ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥PodçŠ¶æ€ï¼š`kubectl describe pods -n flink`
2. æ£€æŸ¥JobManageræ—¥å¿—ï¼š`kubectl logs -n flink <jobmanager-pod-name>`
3. å¢åŠ TaskManagerèµ„æºé™åˆ¶

### é—®é¢˜2ï¼šç½‘ç»œå»¶è¿Ÿé«˜

**ç—‡çŠ¶**ï¼šä½œä¸šå¤„ç†å»¶è¿Ÿé«˜ï¼Œååé‡ä½ã€‚

**åŸå› **ï¼šPodé—´ç½‘ç»œé…ç½®ä¸å½“ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ç½‘ç»œé…ç½®ï¼š`kubectl describe pod <pod-name> -n flink`
2. è€ƒè™‘ä½¿ç”¨HostNetworkæ¨¡å¼ï¼ˆéœ€è°¨æ…ï¼‰
3. ä¼˜åŒ–Kubernetesç½‘ç»œæ’ä»¶é…ç½®

### é—®é¢˜3ï¼šå†…å­˜æº¢å‡º

**ç—‡çŠ¶**ï¼šTaskManageré¢‘ç¹é‡å¯ï¼Œæ—¥å¿—ä¸­å‡ºç°OutOfMemoryErrorã€‚

**åŸå› **ï¼šå†…å­˜é…ç½®ä¸å½“æˆ–ä½œä¸šæ•°æ®é‡è¿‡å¤§ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. è°ƒæ•´JVMå‚æ•°ï¼š`-Xmx`å’Œ`-Xms`
2. å¢åŠ TaskManagerå†…å­˜é™åˆ¶
3. ä¼˜åŒ–ä½œä¸šä»£ç ï¼Œå‡å°‘å†…å­˜ä½¿ç”¨

## ç»“è¯­

é€šè¿‡å°†Flinkä¸Kubernetesé›†æˆï¼Œæˆ‘ä»¬èƒ½å¤Ÿæ„å»ºçœŸæ­£çš„äº‘åŸç”Ÿæµå¤„ç†å¹³å°ï¼Œå®ç°å¼¹æ€§ä¼¸ç¼©ã€è‡ªåŠ¨åŒ–éƒ¨ç½²å’Œé«˜æ•ˆè¿ç»´ã€‚è™½ç„¶åˆæœŸé…ç½®å¯èƒ½ä¼šæœ‰äº›å¤æ‚ï¼Œä½†ä¸€æ—¦æˆåŠŸæ­å»ºï¼Œåç»­çš„è¿ç»´å·¥ä½œå°†å¤§å¤§ç®€åŒ–ã€‚

::: right
"äº‘åŸç”Ÿä¸æ˜¯ç›®çš„ï¼Œè€Œæ˜¯æ‰‹æ®µã€‚çœŸæ­£çš„ç›®æ ‡æ˜¯æ„å»ºèƒ½å¤Ÿå¿«é€Ÿå“åº”å˜åŒ–çš„ç³»ç»Ÿã€‚"
:::

åœ¨æœªæ¥çš„æ–‡ç« ä¸­ï¼Œæˆ‘å°†è¿›ä¸€æ­¥æ¢è®¨Flinkåœ¨Kubernetesä¸Šçš„é«˜çº§åº”ç”¨ï¼ŒåŒ…æ‹¬è‡ªåŠ¨æ‰©ç¼©å®¹ç­–ç•¥ã€å¤šç§Ÿæˆ·ç®¡ç†å’Œæ··åˆäº‘éƒ¨ç½²ç­‰è¯é¢˜ã€‚å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºç•™è¨€äº¤æµï¼ğŸ‘‹

è®°ä½ï¼ŒæŠ€æœ¯é€‰å‹æ²¡æœ‰ç»å¯¹çš„å¯¹é”™ï¼Œå…³é”®æ˜¯é€‰æ‹©æœ€é€‚åˆä½ ä¸šåŠ¡åœºæ™¯çš„æ–¹æ¡ˆã€‚å¸Œæœ›ä»Šå¤©çš„åˆ†äº«å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼ğŸ’ª