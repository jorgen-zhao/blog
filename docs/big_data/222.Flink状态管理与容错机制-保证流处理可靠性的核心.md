---
title: FlinkçŠ¶æ€ç®¡ç†ä¸å®¹é”™æœºåˆ¶-ä¿è¯æµå¤„ç†å¯é æ€§çš„æ ¸å¿ƒ
date: 2023-11-15 10:30:00
permalink: /pages/flink-state-management/
categories: 
  - å¤§æ•°æ®
  - Flink
tags:
  - Flink
  - çŠ¶æ€ç®¡ç†
  - å®¹é”™æœºåˆ¶
  - Checkpoint
  - Savepoint
author: 
  name: Jorgen
  link: https://github.com/jorgen-zhao
---

## å‰è¨€

åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº†Flinkçš„åŸºæœ¬æ¶æ„å’Œé…ç½®ï¼Œä¹Ÿæ·±å…¥æ¢è®¨äº†åˆ†å¸ƒå¼æ•°æ®å¤„ç†å¼•æ“çš„æ ¸å¿ƒåŸç†ã€‚ä½†æ˜¯ï¼Œæœ‰ä¸€ä¸ªè‡³å…³é‡è¦çš„ä¸»é¢˜æˆ‘ä»¬è¿˜æ²¡æœ‰è¯¦ç»†è®¨è®ºâ€”â€”é‚£å°±æ˜¯**çŠ¶æ€ç®¡ç†ä¸å®¹é”™æœºåˆ¶**ã€‚ğŸ¤”

åœ¨æµå¤„ç†çš„ä¸–ç•Œé‡Œï¼Œæ•°æ®å¯èƒ½ä¼šå› ä¸ºå„ç§åŸå› ä¸¢å¤±æˆ–å¤„ç†å¤±è´¥ï¼Œæ¯”å¦‚ç½‘ç»œé—®é¢˜ã€èŠ‚ç‚¹æ•…éšœã€ç³»ç»Ÿå´©æºƒç­‰ã€‚å¦‚æœæ²¡æœ‰å¯é çš„çŠ¶æ€ç®¡ç†å’Œå®¹é”™æœºåˆ¶ï¼Œæˆ‘ä»¬çš„æ•°æ®å¤„ç†ç»“æœå°†å˜å¾—ä¸å¯é ï¼Œç”šè‡³äº§ç”Ÿé”™è¯¯çš„ä¸šåŠ¡å†³ç­–ã€‚ä»Šå¤©ï¼Œæˆ‘å°±æ¥å’Œå¤§å®¶ä¸€èµ·æ·±å…¥æ¢è®¨Flinkä¸­è¿™ä¸ªä¿è¯å¯é æ€§çš„æ ¸å¿ƒæœºåˆ¶ã€‚

::: tip
çŠ¶æ€ç®¡ç†æ˜¯æµå¤„ç†åŒºåˆ«äºæ‰¹å¤„ç†çš„å…³é”®ç‰¹å¾ä¹‹ä¸€ï¼Œä¹Ÿæ˜¯Flinkèƒ½å¤Ÿæä¾›"ç²¾ç¡®ä¸€æ¬¡"(exactly-once)è¯­ä¹‰ä¿è¯çš„åŸºç¡€ã€‚
:::

## Flinkä¸­çš„çŠ¶æ€æ¦‚è¿°

### ä»€ä¹ˆæ˜¯çŠ¶æ€ï¼Ÿ

åœ¨æµå¤„ç†åº”ç”¨ä¸­ï¼Œ**çŠ¶æ€**æ˜¯æŒ‡è®¡ç®—è¿‡ç¨‹ä¸­éœ€è¦è®°ä½çš„æ•°æ®ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯è®¡ç®—è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸­é—´ç»“æœæˆ–éœ€è¦é•¿æœŸä¿å­˜çš„æ•°æ®ã€‚ä¾‹å¦‚ï¼š

- åœ¨ç»Ÿè®¡å•è¯é¢‘ç‡çš„åº”ç”¨ä¸­ï¼Œæ¯ä¸ªå•è¯å‡ºç°çš„æ¬¡æ•°å°±æ˜¯çŠ¶æ€
- åœ¨æ£€æµ‹å¼‚å¸¸äº¤æ˜“çš„åº”ç”¨ä¸­ï¼Œæœ€è¿‘å‡ åˆ†é’Ÿçš„äº¤æ˜“è®°å½•å°±æ˜¯çŠ¶æ€
- åœ¨è®¡ç®—ç”¨æˆ·è¡Œä¸ºçš„åº”ç”¨ä¸­ï¼Œç”¨æˆ·çš„ç‚¹å‡»å†å²å°±æ˜¯çŠ¶æ€

Flinkä¸­çš„çŠ¶æ€å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š

1. **Keyed State** - ä¸ç‰¹å®šé”®å…³è”çš„çŠ¶æ€ï¼Œä¾‹å¦‚æŸä¸ªç”¨æˆ·çš„è´­ç‰©è½¦å†…å®¹
2. **Operator State** - ä¸ç‰¹å®šæ“ä½œç¬¦å®ä¾‹å…³è”çš„çŠ¶æ€ï¼Œä¾‹å¦‚Kafkaæ¶ˆè´¹è€…è¯»å–çš„åç§»é‡

### çŠ¶æ€åç«¯

Flinkä½¿ç”¨**çŠ¶æ€åç«¯**æ¥å­˜å‚¨å’Œç®¡ç†çŠ¶æ€ã€‚Flinkæä¾›äº†ä¸‰ç§å†…ç½®çš„çŠ¶æ€åç«¯ï¼š

1. **MemoryStateBackend** - çŠ¶æ€å­˜å‚¨åœ¨TaskManagerçš„å†…å­˜ä¸­
2. **FsStateBackend** - çŠ¶æ€å­˜å‚¨åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­
3. **RocksDBStateBackend** - çŠ¶æ€å­˜å‚¨åœ¨RocksDBæ•°æ®åº“ä¸­

::: theorem
é€‰æ‹©åˆé€‚çš„çŠ¶æ€åç«¯å¯¹åº”ç”¨çš„æ€§èƒ½å’Œå¯é æ€§è‡³å…³é‡è¦ã€‚å¯¹äºç”Ÿäº§ç¯å¢ƒï¼Œé€šå¸¸æ¨èä½¿ç”¨RocksDBStateBackendï¼Œå› ä¸ºå®ƒå¯ä»¥å¤„ç†å¤§è§„æ¨¡çŠ¶æ€æ•°æ®ã€‚
:::

## Checkpointæœºåˆ¶

### ä»€ä¹ˆæ˜¯Checkpointï¼Ÿ

**Checkpoint**æ˜¯Flinkæä¾›çš„ä¸€ç§å®¹é”™æœºåˆ¶ï¼Œå®ƒå®šæœŸåˆ›å»ºåˆ†å¸ƒå¼æ•°æ®æµçš„å¿«ç…§ï¼Œè®°å½•æ‰€æœ‰ç®—å­çš„çŠ¶æ€ã€‚å½“ç³»ç»Ÿå‘ç”Ÿæ•…éšœæ—¶ï¼ŒFlinkå¯ä»¥ä»æœ€è¿‘çš„Checkpointæ¢å¤çŠ¶æ€ï¼Œé‡æ–°å¤„ç†æ•°æ®ï¼Œä»è€Œä¿è¯è®¡ç®—ç»“æœçš„æ­£ç¡®æ€§ã€‚

### Checkpointçš„å·¥ä½œåŸç†

Flinkçš„Checkpointæœºåˆ¶åŸºäºChandy-Lamportç®—æ³•å®ç°ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š

1. **Barrierä¼ æ’­** - Flinkåœ¨æ•°æ®æµä¸­æ’å…¥ç‰¹æ®Šçš„Barrierï¼Œè¿™äº›Barrierä¼šéšç€æ•°æ®ä¸€èµ·æµåŠ¨
2. **çŠ¶æ€å¿«ç…§** - å½“Barrieråˆ°è¾¾ç®—å­æ—¶ï¼Œç®—å­ä¼šä¿å­˜å½“å‰çŠ¶æ€åˆ°æŒä¹…åŒ–å­˜å‚¨
3. **ç¡®è®¤åé¦ˆ** - ç®—å­å®ŒæˆçŠ¶æ€ä¿å­˜åï¼Œä¼šå‘JobManagerå‘é€ç¡®è®¤ä¿¡æ¯
4. **å®Œæˆé€šçŸ¥** - å½“æ‰€æœ‰ç®—å­éƒ½å®ŒæˆCheckpointåï¼ŒJobManagerä¼šé€šçŸ¥æ‰€æœ‰ç®—å­Checkpointå·²å®Œæˆ

![Checkpointå·¥ä½œåŸç†](/images/flink-checkpoint.png)

### é…ç½®Checkpoint

åœ¨Flinkä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼é…ç½®Checkpointï¼š

```java
// å¯ç”¨Checkpointï¼Œæ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
env.enableCheckpointing(60000);

// è®¾ç½®Checkpointæ¨¡å¼ä¸ºEXACTLY_ONCE
env.getCheckpointConfig().setCheckpointingMode(CheckpointingMode.EXACTLY_ONCE);

// è®¾ç½®Checkpointè¶…æ—¶æ—¶é—´
env.getCheckpointConfig().setCheckpointTimeout(60000);

// è®¾ç½®ä¸¤ä¸ªCheckpointä¹‹é—´çš„æœ€å°é—´éš”
env.getCheckpointConfig().setMinPauseBetweenCheckpoints(30000);

// è®¾ç½®åŒæ—¶è¿›è¡Œçš„Checkpointçš„æœ€å¤§æ•°é‡
env.getCheckpointConfig().setMaxConcurrentCheckpoints(1);

// è®¾ç½®å¤–éƒ¨æŒä¹…åŒ–å­˜å‚¨çš„è·¯å¾„
env.setStateBackend(new RocksDBStateBackend("hdfs://namenode:8020/flink/checkpoints"));
```

## Savepointæœºåˆ¶

### ä»€ä¹ˆæ˜¯Savepointï¼Ÿ

**Savepoint**æ˜¯Checkpointçš„ä¸€ç§ç‰¹æ®Šå½¢å¼ï¼Œå®ƒæä¾›äº†æ›´é«˜çº§çš„åŠŸèƒ½ï¼š

1. æ‰‹åŠ¨è§¦å‘ï¼Œä¸å—Checkpointé—´éš”é™åˆ¶
2. åŒ…å«æ›´å¤šå…ƒæ•°æ®ï¼Œå¯ä»¥ç”¨äºåº”ç”¨å‡çº§ã€è¿ç§»æˆ–æ¢å¤
3. å¯ä»¥åœ¨ä»»ä½•æ—¶é—´ç‚¹åˆ›å»ºï¼Œè€Œä¸å½±å“æ­£åœ¨è¿è¡Œçš„ä½œä¸š

### ä½¿ç”¨Savepoint

åˆ›å»ºSavepointçš„å‘½ä»¤å¦‚ä¸‹ï¼š

```bash
flink savepoint -p <savepointPath> -d <jobId>
```

ä½¿ç”¨Savepointæ¢å¤ä½œä¸šï¼š

```bash
flink run -s <savepointPath> -d <jobJarPath>
```

::: right
Savepointæ˜¯Flinkç”Ÿäº§ç¯å¢ƒä¸­çš„å¿…å¤‡å·¥å…·ï¼Œç‰¹åˆ«æ˜¯åœ¨è¿›è¡Œåº”ç”¨å‡çº§æˆ–è¿ç§»æ—¶ã€‚
:::

## é«˜çº§çŠ¶æ€ç®¡ç†

### çŠ¶æ€TTL

**çŠ¶æ€TTL**ï¼ˆTime-To-Liveï¼‰å…è®¸æˆ‘ä»¬ä¸ºçŠ¶æ€è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œè‡ªåŠ¨æ¸…ç†è¿‡æœŸçŠ¶æ€ï¼Œè¿™å¯¹äºèŠ‚çœå­˜å‚¨ç©ºé—´å’Œæé«˜æ€§èƒ½éå¸¸é‡è¦ã€‚

```java
StateTtlConfig ttlConfig = StateTtlConfig
    .newBuilder(Time.hours(24))
    .setUpdateType(StateTtlConfig.UpdateType.OnCreateAndWrite)
    .setStateVisibility(StateTtlConfig.StateVisibility.NeverReturnExpired)
    .cleanupInRocksdbCompactFilter(1000)
    .build();

ValueStateDescriptor<String> stateDescriptor = new ValueStateDescriptor<>("myState", String.class);
stateDescriptor.enableTimeToLive(ttlConfig);
```

### çŠ¶æ€åºåˆ—åŒ–

Flinkæä¾›äº†å¤šç§çŠ¶æ€åºåˆ—åŒ–æ–¹å¼ï¼ŒåŒ…æ‹¬ï¼š

1. **TypeSerializer** - é€‚ç”¨äºè‡ªå®šä¹‰ç±»å‹
2. **Kryo** - é«˜æ€§èƒ½çš„åºåˆ—åŒ–æ¡†æ¶
3. **Avro** - æ”¯æŒæ¨¡å¼æ¼”è¿›çš„åºåˆ—åŒ–æ ¼å¼

ä¼˜åŒ–çŠ¶æ€åºåˆ—åŒ–å¯ä»¥æ˜¾è‘—æé«˜åº”ç”¨çš„æ€§èƒ½ï¼š

```java
// ä½¿ç”¨è‡ªå®šä¹‰åºåˆ—åŒ–å™¨
env.getConfig().addDefaultKryoSerializer(MyCustomType.class, MyCustomSerializer.class);

// ç¦ç”¨Kryoçš„å¼•ç”¨è·Ÿè¸ªï¼Œæé«˜æ€§èƒ½
env.getConfig().disableGenericTypes();
```

## å®¹é”™æœ€ä½³å®è·µ

### Checkpointè°ƒä¼˜

1. **åˆç†è®¾ç½®Checkpointé—´éš”** - å¤ªé¢‘ç¹ä¼šå½±å“æ€§èƒ½ï¼Œå¤ªç¨€ç–ä¼šå¢åŠ æ¢å¤æ—¶é—´
2. **é€‰æ‹©åˆé€‚çš„çŠ¶æ€åç«¯** - æ ¹æ®çŠ¶æ€å¤§å°å’Œæ€§èƒ½è¦æ±‚é€‰æ‹©
3. **ä¼˜åŒ–çŠ¶æ€è®¿é—®æ¨¡å¼** - å‡å°‘éšæœºè®¿é—®ï¼Œå¢åŠ é¡ºåºè®¿é—®
4. **ç›‘æ§Checkpointæ€§èƒ½** - ä½¿ç”¨Flinkçš„ç›‘æ§å·¥å…·æ£€æŸ¥Checkpointå¤§å°å’Œè€—æ—¶

### å®¹é”™ç­–ç•¥é€‰æ‹©

æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„å®¹é”™ç­–ç•¥ï¼š

| å®¹é”™ç­–ç•¥ | è¯­ä¹‰ä¿è¯ | æ€§èƒ½å½±å“ | é€‚ç”¨åœºæ™¯ |
|---------|---------|---------|---------|
| AT_LEAST_ONCE | è‡³å°‘ä¸€æ¬¡ | ä½ | å¯ä»¥å®¹å¿é‡å¤æ•°æ® |
| EXACTLY_ONCE | ç²¾ç¡®ä¸€æ¬¡ | ä¸­ | é‡‘èäº¤æ˜“ç­‰å…³é”®ä¸šåŠ¡ |
| AT_MOST_ONCE | æœ€å¤šä¸€æ¬¡ | é«˜ | å¯ä»¥å®¹å¿æ•°æ®ä¸¢å¤± |

::: tip
åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒEXACTLY_ONCEè¯­ä¹‰æ˜¯æœ€å¸¸ç”¨çš„ï¼Œä½†éœ€è¦æƒè¡¡æ€§èƒ½å¼€é”€ã€‚Flink 1.12+ç‰ˆæœ¬ä¸­ï¼ŒEXACTLY_ONCEå·²ç»æˆä¸ºé»˜è®¤è®¾ç½®ã€‚
:::

## ç»“è¯­

ä»Šå¤©æˆ‘ä»¬ä¸€èµ·æ·±å…¥æ¢è®¨äº†Flinkçš„çŠ¶æ€ç®¡ç†ä¸å®¹é”™æœºåˆ¶ï¼Œè¿™æ˜¯Flinkèƒ½å¤Ÿæä¾›å¯é æµå¤„ç†æœåŠ¡çš„æ ¸å¿ƒã€‚ä»åŸºæœ¬çš„Stateæ¦‚å¿µåˆ°é«˜çº§çš„Checkpointå’ŒSavepointæœºåˆ¶ï¼Œå†åˆ°å®é™…åº”ç”¨ä¸­çš„æœ€ä½³å®è·µï¼Œå¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¤Ÿå¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£å’Œåº”ç”¨Flinkçš„å®¹é”™ç‰¹æ€§ã€‚

åœ¨æœªæ¥çš„æ–‡ç« ä¸­ï¼Œæˆ‘è®¡åˆ’ç»§ç»­æ¢è®¨Flinkä¸å…¶ä»–ç³»ç»Ÿçš„é›†æˆï¼Œç‰¹åˆ«æ˜¯ä¸Kafkaçš„æ·±åº¦é›†æˆï¼Œä»¥åŠå¦‚ä½•åœ¨çœŸå®ç”Ÿäº§ç¯å¢ƒä¸­éƒ¨ç½²å’Œè¿ç»´Flinkåº”ç”¨ã€‚å¦‚æœä½ å¯¹Flinkçš„ä»»ä½•æ–¹é¢æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºç•™è¨€ï¼Œæˆ‘ä¼šæ ¹æ®å¤§å®¶çš„åé¦ˆè°ƒæ•´åç»­çš„æ–‡ç« å†…å®¹ã€‚

> è®°ä½ï¼Œæ²¡æœ‰å®¹é”™æœºåˆ¶çš„æµå¤„ç†ç³»ç»Ÿå°±åƒæ²¡æœ‰åˆ¹è½¦çš„èµ›è½¦â€”â€”çœ‹èµ·æ¥å¾ˆé…·ï¼Œä½†ä¸€æ—¦å‡ºé—®é¢˜å°±ä¼šé€ æˆç¾éš¾æ€§çš„åæœã€‚é€‰æ‹©åˆé€‚çš„å®¹é”™ç­–ç•¥ï¼Œè®©ä½ çš„æµå¤„ç†åº”ç”¨æ—¢é«˜æ•ˆåˆå¯é ï¼

Happy Flinking! ğŸš€