---
title: FlinkçŠ¶æ€ç®¡ç†ä¸å®¹é”™æœºåˆ¶-æ„å»ºå¯é çš„æµå¤„ç†åº”ç”¨
date: 2023-11-15 10:30:00
permalink: /pages/flink-state-management/
categories: 
  - å¤§æ•°æ®
  - Flink
tags:
  - Flink
  - çŠ¶æ€ç®¡ç†
  - å®¹é”™æœºåˆ¶
  - æµå¤„ç†
author: 
  name: Jorgen
  link: https://github.com/jorgen-zhao
---

## å‰è¨€

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯Jorgenï¼ğŸ‘‹ åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å·²ç»æ·±å…¥æ¢è®¨äº†Flinkçš„åŸºç¡€çŸ¥è¯†ã€è¿›é˜¶æ¦‚å¿µã€é…ç½®é€‰é¡¹ä»¥åŠæ¶æ„åŸç†ã€‚ä»Šå¤©ï¼Œæˆ‘æƒ³å’Œå¤§å®¶èŠä¸€ä¸ªç‰¹åˆ«é‡è¦çš„è¯é¢˜â€”â€”Flinkçš„çŠ¶æ€ç®¡ç†ä¸å®¹é”™æœºåˆ¶ã€‚

è¯´å®è¯ï¼Œåˆšå¼€å§‹å­¦ä¹ Flinkçš„æ—¶å€™ï¼Œæˆ‘å¸¸å¸¸å¿½ç•¥è¿™ä¸¤ä¸ªæ¦‚å¿µï¼Œè§‰å¾—å®ƒä»¬å¤ª"åº•å±‚"äº†ï¼Œä¸å¦‚APIä½¿ç”¨é‚£ä¹ˆç›´è§‚ã€‚~~ç»“æœåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå› ä¸ºçŠ¶æ€ç®¡ç†ä¸å½“å¯¼è‡´çš„bugè®©æˆ‘åƒäº†ä¸å°‘è‹¦å¤´~~ã€‚ğŸ˜…

ä»Šå¤©ï¼Œæˆ‘ä»¬å°±æ¥ä¸€èµ·æ­å¼€FlinkçŠ¶æ€ç®¡ç†ä¸å®¹é”™æœºåˆ¶çš„ç¥ç§˜é¢çº±ï¼Œçœ‹çœ‹å®ƒä»¬å¦‚ä½•å¸®åŠ©æˆ‘ä»¬æ„å»ºæ›´åŠ å¥å£®ã€å¯é çš„æµå¤„ç†åº”ç”¨ã€‚

## ä»€ä¹ˆæ˜¯çŠ¶æ€ç®¡ç†ï¼Ÿ

åœ¨æµå¤„ç†çš„ä¸–ç•Œé‡Œï¼ŒçŠ¶æ€æ˜¯å¿…ä¸å¯å°‘çš„ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬è¦è®¡ç®—æ¯ä¸ªç”¨æˆ·çš„ç´¯è®¡æ¶ˆè´¹é‡‘é¢ï¼Œå°±å¿…é¡»è®°ä½æ¯ä¸ªç”¨æˆ·ä¹‹å‰çš„æ¶ˆè´¹æ€»å’Œï¼Œè¿™å°±æ˜¯çŠ¶æ€ï¼

::: tip
çŠ¶æ€å¯ä»¥ç†è§£ä¸ºæµå¤„ç†åº”ç”¨åœ¨å¤„ç†æ•°æ®è¿‡ç¨‹ä¸­éœ€è¦è®°ä½çš„ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯å¯ä»¥å¸®åŠ©æˆ‘ä»¬å®ç°æ›´å¤æ‚çš„è®¡ç®—é€»è¾‘ã€‚
:::

### çŠ¶æ€çš„ç±»å‹

Flinkä¸­çš„çŠ¶æ€ä¸»è¦åˆ†ä¸ºä¸¤å¤§ç±»ï¼š

1. **æ‰˜ç®¡çŠ¶æ€(Managed State)**ï¼šç”±Flinkç®¡ç†çš„çŠ¶æ€ï¼Œæ¨èä½¿ç”¨ï¼
   - **å€¼çŠ¶æ€(ValueState)**ï¼šå­˜å‚¨ä¸€ä¸ªå¯ä»¥æ›´æ–°å’Œæ£€ç´¢çš„å€¼
   - **åˆ—è¡¨çŠ¶æ€(ListState)**ï¼šå­˜å‚¨ä¸€ä¸ªå…ƒç´ çš„åˆ—è¡¨
   - **æ˜ å°„çŠ¶æ€(MapState)**ï¼šå­˜å‚¨ä¸€ä¸ªé”®å€¼å¯¹æ˜ å°„
   - **ReducingState**å’Œ**FoldingState**ï¼šç”¨äºè‡ªå®šä¹‰çš„èšåˆæ“ä½œ

2. **åŸå§‹çŠ¶æ€(Raw State)**ï¼šç”±ç”¨æˆ·è‡ªå·±ç®¡ç†çš„çŠ¶æ€ï¼Œä¸æ¨èï¼

::: theorem
ä¸ºä»€ä¹ˆæ¨èä½¿ç”¨æ‰˜ç®¡çŠ¶æ€ï¼Ÿ
æ‰˜ç®¡çŠ¶æ€ç”±Flinkæ¡†æ¶ç®¡ç†ï¼Œå¯ä»¥æ›´å¥½åœ°è¿›è¡Œåºåˆ—åŒ–ã€åˆ†åŒºå’Œå®¹é”™ï¼Œè€ŒåŸå§‹çŠ¶æ€éœ€è¦å¼€å‘è€…è‡ªå·±å¤„ç†è¿™äº›å¤æ‚çš„é—®é¢˜ã€‚
:::

### çŠ¶æ€åç«¯(State Backend)

Flinkæä¾›äº†ä¸‰ç§çŠ¶æ€åç«¯æ¥å­˜å‚¨çŠ¶æ€ï¼š

1. **MemoryStateBackend**ï¼šçŠ¶æ€å­˜å‚¨åœ¨TaskManagerçš„å†…å­˜ä¸­ï¼Œé€‚åˆå°è§„æ¨¡çŠ¶æ€å’Œè°ƒè¯•
2. **FsStateBackend**ï¼šçŠ¶æ€å­˜å‚¨åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œé€‚åˆä¸­ç­‰è§„æ¨¡çŠ¶æ€
3. **RocksDBStateBackend**ï¼šä½¿ç”¨RocksDBä½œä¸ºæœ¬åœ°çŠ¶æ€å­˜å‚¨ï¼Œé€‚åˆå¤§è§„æ¨¡çŠ¶æ€

```java
// ç¤ºä¾‹ï¼šè®¾ç½®çŠ¶æ€åç«¯
StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
env.setStateBackend(new RocksDBStateBackend("hdfs://path/to/checkpoint"));
```

## å®¹é”™æœºåˆ¶

å®¹é”™æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡çš„æ ¸å¿ƒæŒ‘æˆ˜ä¹‹ä¸€ã€‚Flinké€šè¿‡Checkpointæœºåˆ¶å®ç°äº†å¼ºå¤§çš„å®¹é”™èƒ½åŠ›ã€‚

### Checkpointæœºåˆ¶

::: tip
Checkpointæ˜¯Flinkå®¹é”™æœºåˆ¶çš„æ ¸å¿ƒï¼Œå®ƒå®šæœŸåˆ›å»ºæµå¤„ç†åº”ç”¨çš„ä¸€è‡´æ€§å¿«ç…§ï¼Œä»¥ä¾¿åœ¨å‘ç”Ÿæ•…éšœæ—¶èƒ½å¤Ÿä»æœ€è¿‘çš„å¿«ç…§æ¢å¤ã€‚
:::

#### Checkpointçš„å·¥ä½œåŸç†

1. **Barrierå¯¹é½**ï¼šFlinkåœ¨æ•°æ®æµä¸­æ’å…¥ç‰¹æ®Šçš„Barrierï¼Œè¿™äº›Barrierä¼šéšç€æ•°æ®æµåŠ¨
2. **çŠ¶æ€å¿«ç…§**ï¼šå½“ä»»åŠ¡æ¥æ”¶åˆ°æ‰€æœ‰Barrieræ—¶ï¼Œå®ƒä¼šå°†å½“å‰çŠ¶æ€ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨
3. **ç¡®è®¤å®Œæˆ**ï¼šä»»åŠ¡ç¡®è®¤Checkpointå®Œæˆåï¼Œé€šçŸ¥JobManager

```java
// ç¤ºä¾‹ï¼šå¯ç”¨Checkpoint
env.enableCheckpointing(60000); // æ¯60ç§’åšä¸€æ¬¡Checkpoint
env.getCheckpointConfig().setCheckpointingMode(CheckpointingMode.EXACTLY_ONCE);
env.getCheckpointConfig().setMinPauseBetweenCheckpoints(30000);
env.getCheckpointConfig().setCheckpointTimeout(60000);
env.getCheckpointConfig().setMaxConcurrentCheckpoints(1);
env.getCheckpointConfig().enableExternalizedCheckpoints(CheckpointConfig.ExternalizedCheckpointCleanup.RETAIN_ON_CANCELLATION);
```

### Savepoint

Savepointæ˜¯æ‰‹åŠ¨è§¦å‘çš„ã€å¯ç§»æ¤çš„Checkpointï¼Œä¸»è¦ç”¨äºæœ‰è®¡åˆ’çš„æ›´æ–°æˆ–è¿ç§»ã€‚

```bash
# åˆ›å»ºSavepoint
flink stop -p savepointPath -d jobId

# ä»Savepointæ¢å¤
flink run -s savepointPath -d jobJarPath
```

## å®è·µæ¡ˆä¾‹ï¼šçŠ¶æ€ç®¡ç†ä¸å®¹é”™

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®é™…çš„ä¾‹å­æ¥ç†è§£çŠ¶æ€ç®¡ç†å’Œå®¹é”™æœºåˆ¶çš„é‡è¦æ€§ã€‚

### åœºæ™¯ï¼šå®æ—¶æ¨èç³»ç»Ÿ

å‡è®¾æˆ‘ä»¬è¦æ„å»ºä¸€ä¸ªå®æ—¶æ¨èç³»ç»Ÿï¼Œéœ€è¦è·Ÿè¸ªç”¨æˆ·çš„è¡Œä¸ºå†å²ï¼Œå¹¶æ ¹æ®è¿™äº›å†å²è®°å½•ç”Ÿæˆä¸ªæ€§åŒ–æ¨èã€‚

```java
public class UserBehaviorRecommendation {
    
    // å®šä¹‰çŠ¶æ€æè¿°ç¬¦
    private static final ValueStateDescriptor<List<String>> BEHAVIOR_HISTORY_DESC = 
        new ValueStateDescriptor<>("userBehaviorHistory", List.class);
    
    public static void main(String[] args) throws Exception {
        final StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
        
        // å¯ç”¨Checkpoint
        env.enableCheckpointing(5000);
        env.getCheckpointConfig().setCheckpointingMode(CheckpointingMode.EXACTLY_ONCE);
        
        DataStream<UserBehavior> behaviors = env.addSource(new UserBehaviorSource());
        
        behaviors
            .keyBy(UserBehavior::getUserId)
            .process(new ProcessFunction<UserBehavior, Recommendation>() {
                
                private transient ValueState<List<String>> behaviorHistory;
                
                @Override
                public void open(Configuration parameters) throws Exception {
                    behaviorHistory = getRuntimeContext().getState(BEHAVIOR_HISTORY_DESC);
                }
                
                @Override
                public void processElement(UserBehavior behavior, Context ctx, Collector<Recommendation> out) throws Exception {
                    List<String> history = behaviorHistory.value();
                    if (history == null) {
                        history = new ArrayList<>();
                    }
                    
                    // æ›´æ–°è¡Œä¸ºå†å²
                    history.add(behavior.getItemId());
                    if (history.size() > 10) {
                        history.remove(0); // åªä¿ç•™æœ€è¿‘10ä¸ªè¡Œä¸º
                    }
                    
                    behaviorHistory.update(history);
                    
                    // åŸºäºè¡Œä¸ºå†å²ç”Ÿæˆæ¨è
                    Recommendation recommendation = generateRecommendation(history);
                    out.collect(recommendation);
                }
                
                private Recommendation generateRecommendation(List<String> history) {
                    // å®é™…åº”ç”¨ä¸­è¿™é‡Œä¼šæœ‰å¤æ‚çš„æ¨èç®—æ³•
                    return new Recommendation("based on your history");
                }
            });
        
        env.execute("User Behavior Recommendation");
    }
}
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†`ValueState`æ¥å­˜å‚¨ç”¨æˆ·çš„è¡Œä¸ºå†å²ï¼Œå³ä½¿å‘ç”Ÿæ•…éšœï¼ŒFlinkä¹Ÿèƒ½ä»æœ€è¿‘çš„Checkpointæ¢å¤çŠ¶æ€ï¼Œç¡®ä¿æ¨èç³»ç»Ÿçš„è¿ç»­æ€§ã€‚

## é«˜çº§ç‰¹æ€§

### çŠ¶æ€TTL

Flinkæ”¯æŒä¸ºçŠ¶æ€è®¾ç½®ç”Ÿå­˜æ—¶é—´(TTL)ï¼Œè‡ªåŠ¨æ¸…ç†è¿‡æœŸçŠ¶æ€ã€‚

```java
StateTtlConfig ttlConfig = StateTtlConfig
    .newBuilder(Time.hours(24))
    .setUpdateType(StateTtlConfig.UpdateType.OnCreateAndWrite)
    .setStateVisibility(StateTtlConfig.StateVisibility.NeverReturnExpired)
    .cleanupInRocksdbCompactFilter(1000)
    .build();

ValueStateDescriptor<String> descriptor = new ValueStateDescriptor<>("userStatus", String.class);
descriptor.enableTimeToLive(ttlConfig);
```

### å¢é‡Checkpoint

å¯¹äºRocksDBçŠ¶æ€åç«¯ï¼ŒFlinkæ”¯æŒå¢é‡Checkpointï¼Œåªä¿å­˜å˜åŒ–çš„éƒ¨åˆ†ï¼Œå¤§å¤§å‡å°‘äº†Checkpointçš„æ—¶é—´å’Œç©ºé—´å¼€é”€ã€‚

::: right
"å¢é‡Checkpointæ˜¯RocksDBçŠ¶æ€åç«¯çš„ä¸€å¤§ä¼˜åŠ¿ï¼Œç‰¹åˆ«æ˜¯åœ¨çŠ¶æ€éå¸¸å¤§çš„æƒ…å†µä¸‹ã€‚"
:::

## ç»“è¯­

ä»Šå¤©ï¼Œæˆ‘ä»¬ä¸€èµ·æ·±å…¥æ¢è®¨äº†Flinkçš„çŠ¶æ€ç®¡ç†ä¸å®¹é”™æœºåˆ¶ã€‚ä»åŸºç¡€æ¦‚å¿µåˆ°å®è·µæ¡ˆä¾‹ï¼Œå†åˆ°é«˜çº§ç‰¹æ€§ï¼Œå¸Œæœ›è¿™äº›å†…å®¹èƒ½å¤Ÿå¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£å’Œä½¿ç”¨Flinkæ„å»ºå¯é çš„æµå¤„ç†åº”ç”¨ã€‚

çŠ¶æ€ç®¡ç†å’Œå®¹é”™æœºåˆ¶æ˜¯æµå¤„ç†ç³»ç»Ÿçš„åŸºçŸ³ï¼Œå®ƒä»¬ç¡®ä¿äº†æˆ‘ä»¬çš„åº”ç”¨åœ¨é¢å¯¹æ•…éšœæ—¶èƒ½å¤Ÿä¿æŒä¸€è‡´æ€§å’Œå¯é æ€§ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œåˆç†è®¾è®¡çŠ¶æ€ã€é€‰æ‹©åˆé€‚çš„çŠ¶æ€åç«¯ã€é…ç½®æ°å½“çš„Checkpointç­–ç•¥ï¼Œéƒ½æ˜¯æ„å»ºé«˜æ€§èƒ½ã€é«˜å¯ç”¨æµå¤„ç†åº”ç”¨çš„å…³é”®ã€‚

å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–è€…æƒ³åˆ†äº«ä½ çš„å®è·µç»éªŒï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºç•™è¨€ï¼ğŸ‘‡

> æœ€åï¼Œè®°ä½ä¸€å¥è¯ï¼šåœ¨æµå¤„ç†çš„ä¸–ç•Œé‡Œï¼Œæ²¡æœ‰çŠ¶æ€ï¼Œå°±æ²¡æœ‰ä¸€åˆ‡ã€‚æŒæ¡çŠ¶æ€ç®¡ç†ï¼Œå°±æŒæ¡äº†Flinkçš„ç²¾é«“ï¼

---

å¸Œæœ›è¿™ç¯‡åšå®¢èƒ½å¤Ÿå¸®åŠ©å¤§å®¶æ›´å¥½åœ°ç†è§£Flinkçš„çŠ¶æ€ç®¡ç†ä¸å®¹é”™æœºåˆ¶ï¼å¦‚æœè§‰å¾—æœ‰ç”¨ï¼Œåˆ«å¿˜äº†ç‚¹èµå’Œåˆ†äº«å“¦ï¼ğŸ˜Š