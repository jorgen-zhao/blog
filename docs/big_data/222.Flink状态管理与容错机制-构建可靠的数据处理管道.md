```yaml
---
title: FlinkçŠ¶æ€ç®¡ç†ä¸å®¹é”™æœºåˆ¶-æ„å»ºå¯é çš„æ•°æ®å¤„ç†ç®¡é“
date: 2023-11-15 10:30:00
permalink: /pages/flink-state-fault-tolerance/
categories: 
  - å¤§æ•°æ®
  - Flink
tags:
  - Flink
  - çŠ¶æ€ç®¡ç†
  - å®¹é”™æœºåˆ¶
  - Checkpoint
author: 
  name: Jorgen
  link: https://github.com/jorgen-zhao
---

## å‰è¨€

åœ¨æµå¤„ç†çš„ä¸–ç•Œé‡Œï¼Œæ•°æ®ä¸ä¸¢å¤±ä¸”è®¡ç®—ç»“æœæ­£ç¡®æ˜¯åŸºæœ¬è¦æ±‚ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœä½ çš„é“¶è¡Œäº¤æ˜“ç³»ç»Ÿå› ä¸ºç½‘ç»œæ³¢åŠ¨è€Œä¸¢å¤±äº†ä¸€ç¬”è½¬è´¦è®°å½•ï¼Œé‚£åæœä¸å ªè®¾æƒ³ï¼ğŸ¤¯ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆçŠ¶æ€ç®¡ç†å’Œå®¹é”™æœºåˆ¶åœ¨Flinkä¸­å¦‚æ­¤é‡è¦çš„åŸå› ã€‚

åœ¨æˆ‘ä¹‹å‰çš„Flinkç³»åˆ—æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº†Flinkçš„åŸºæœ¬æ¶æ„å’Œé…ç½®ï¼Œä½†è¿˜æ²¡æœ‰æ·±å…¥æ¢è®¨Flinkå¦‚ä½•ä¿è¯åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„æ•°æ®ä¸€è‡´æ€§ã€‚ä»Šå¤©ï¼Œæˆ‘å°†å¸¦å¤§å®¶ä¸€èµ·æ¢ç´¢Flinkçš„çŠ¶æ€ç®¡ç†ä¸å®¹é”™æœºåˆ¶ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•æ„å»ºå¯é çš„æ•°æ®å¤„ç†ç®¡é“çš„ã€‚

::: tip
çŠ¶æ€ç®¡ç†æ˜¯æµå¤„ç†æ¡†æ¶çš„æ ¸å¿ƒèƒ½åŠ›ï¼Œå®¹é”™æœºåˆ¶åˆ™æ˜¯ä¿è¯ç³»ç»Ÿå¯é æ€§çš„åŸºçŸ³ã€‚ç†è§£è¿™ä¸¤è€…å¯¹äºæ„å»ºç”Ÿäº§çº§çš„Flinkåº”ç”¨è‡³å…³é‡è¦ã€‚
:::

## ä»€ä¹ˆæ˜¯çŠ¶æ€ç®¡ç†ï¼Ÿ

åœ¨æµå¤„ç†åº”ç”¨ä¸­ï¼ŒçŠ¶æ€(State)æ˜¯æŒ‡ç®—å­ä¸ºäº†å¤„ç†è¿ç»­äº‹ä»¶è€Œéœ€è¦ç»´æŠ¤çš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œè®¡ç®—çª—å£å†…å¹³å‡å€¼æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä¿å­˜å½“å‰çª—å£çš„å’Œä¸è®¡æ•°ï¼›æˆ–è€…æ£€æµ‹ç”¨æˆ·è¡Œä¸ºæ¨¡å¼æ—¶ï¼Œæˆ‘ä»¬éœ€è¦è®°å½•ç”¨æˆ·çš„å†å²è¡Œä¸ºã€‚

### çŠ¶æ€ç±»å‹

Flinkä¸»è¦æ”¯æŒä¸¤ç§ç±»å‹çš„çŠ¶æ€ï¼š

1. **æ‰˜ç®¡çŠ¶æ€(Managed State)**
   - ç”±Flink runtimeç®¡ç†ï¼Œå­˜å‚¨åœ¨Flinkå†…éƒ¨çš„æ•°æ®ç»“æ„ä¸­
   - å…·æœ‰æ›´å¥½çš„å¯ç§»æ¤æ€§å’Œä¼˜åŒ–èƒ½åŠ›
   - åŒ…æ‹¬ï¼šValueStateã€ListStateã€MapStateã€ReducingStateã€AggregatingStateç­‰

2. **åŸå§‹çŠ¶æ€(Raw State)**
   - ç”±ç”¨æˆ·è‡ªå·±ç®¡ç†ï¼Œå­˜å‚¨åœ¨ä»»æ„æ•°æ®ç»“æ„ä¸­
   - Flinkä»…å°†çŠ¶æ€æ•°æ®ä½œä¸ºå­—èŠ‚æ•°ç»„è¿›è¡ŒæŒä¹…åŒ–å’Œæ¢å¤
   - å…·æœ‰æ›´é«˜çš„çµæ´»æ€§ï¼Œä½†å¯ç§»æ¤æ€§è¾ƒå·®

::: theorem
æ‰˜ç®¡çŠ¶æ€æ˜¯Flinkæ¨èä½¿ç”¨çš„æ–¹å¼ï¼Œå› ä¸ºå®ƒèƒ½å¤Ÿæ›´å¥½åœ°ä¸Flinkçš„æ£€æŸ¥ç‚¹æœºåˆ¶é›†æˆï¼Œå¹¶ä¸”Flinkå¯ä»¥å¯¹å…¶è¿›è¡Œä¼˜åŒ–ã€‚
:::

### çŠ¶æ€åç«¯

çŠ¶æ€åç«¯(State Backend)å†³å®šäº†çŠ¶æ€æ•°æ®çš„å­˜å‚¨æ–¹å¼å’Œä½ç½®ã€‚Flinkæä¾›äº†ä¸‰ç§å†…ç½®çš„çŠ¶æ€åç«¯ï¼š

1. **MemoryStateBackend**
   - çŠ¶æ€å­˜å‚¨åœ¨TaskManagerçš„å†…å­˜ä¸­
   - é€‚åˆå°è§„æ¨¡çŠ¶æ€å’Œå¿«é€Ÿå¤„ç†
   - ä¸æ”¯æŒæ£€æŸ¥ç‚¹æŒä¹…åŒ–ï¼ˆä»…ä¿å­˜åˆ°JobManagerå†…å­˜ï¼‰

2. **FsStateBackend**
   - çŠ¶æ€å­˜å‚¨åœ¨TaskManagerå†…å­˜ä¸­ï¼Œä½†æ£€æŸ¥ç‚¹ä¿å­˜åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­
   - é€‚åˆå¤§è§„æ¨¡çŠ¶æ€å’Œéœ€è¦å®¹é”™çš„åœºæ™¯
   - æ£€æŸ¥ç‚¹æ¢å¤æ—¶éœ€è¦ä»æ–‡ä»¶ç³»ç»ŸåŠ è½½çŠ¶æ€

3. **RocksDBStateBackend**
   - çŠ¶æ€å­˜å‚¨åœ¨RocksDBæ•°æ®åº“ä¸­ï¼ˆæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼‰
   - é€‚åˆè¶…å¤§è§„æ¨¡çŠ¶æ€
   - æ”¯æŒå¢é‡æ£€æŸ¥ç‚¹ï¼Œå‡å°‘æ£€æŸ¥ç‚¹æ—¶é—´

## å®¹é”™æœºåˆ¶ä¸æ£€æŸ¥ç‚¹

Flinké€šè¿‡åˆ†å¸ƒå¼å¿«ç…§æŠ€æœ¯å®ç°å®¹é”™ï¼Œæ ¸å¿ƒæœºåˆ¶æ˜¯**æ£€æŸ¥ç‚¹(Checkpoint)**ã€‚

### æ£€æŸ¥ç‚¹åŸç†

Flinkçš„æ£€æŸ¥ç‚¹æœºåˆ¶åŸºäºChandy-Lamportç®—æ³•çš„å˜ç§ï¼Œä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š

1. **æ£€æŸ¥ç‚¹åè°ƒå™¨(Coordinator)å¯åŠ¨æ£€æŸ¥ç‚¹**ï¼šJobManagerä¸­çš„æ£€æŸ¥ç‚¹åè°ƒå™¨å‘æ‰€æœ‰Sourceç®—å­å‘é€ barriersï¼ˆå±éšœï¼‰
2. ** barriersä¼ æ’­**ï¼šbarriersåœ¨ç®—å­é—´ä¼ é€’ï¼Œç¡®ä¿æ¯ä¸ªç®—å­å¤„ç†å®Œbarrierä¹‹å‰çš„æ•°æ®åæ‰ä¼šç»§ç»­å¤„ç†barrierä¹‹åçš„æ•°æ®
3. **çŠ¶æ€å¿«ç…§**ï¼šå½“ç®—å­æ¥æ”¶åˆ°barrieræ—¶ï¼Œä¼šå°†è‡ªå·±çš„çŠ¶æ€ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨ä¸­
4. **ç¡®è®¤é€šçŸ¥**ï¼šç®—å­å®ŒæˆçŠ¶æ€å¿«ç…§åï¼Œå‘åè°ƒå™¨å‘é€ç¡®è®¤
5. **å®Œæˆæ£€æŸ¥ç‚¹**ï¼šå½“æ‰€æœ‰ç®—å­éƒ½ç¡®è®¤å®Œæˆï¼Œåè°ƒå™¨è®¤ä¸ºæ£€æŸ¥ç‚¹æˆåŠŸ

```mermaid
graph LR
    A[Sourceç®—å­] -->|Barrier| B[Transformationç®—å­1]
    B -->|Barrier| C[Transformationç®—å­2]
    C -->|Barrier| D[Sinkç®—å­]
    B -->|çŠ¶æ€å¿«ç…§| E[æŒä¹…åŒ–å­˜å‚¨]
    C -->|çŠ¶æ€å¿«ç…§| E
```

### æ£€æŸ¥ç‚¹é…ç½®

åœ¨Flinkä¸­ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼é…ç½®æ£€æŸ¥ç‚¹ï¼š

```java
// å¼€å¯æ£€æŸ¥ç‚¹å¹¶è®¾ç½®é—´éš”
StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
env.enableCheckpointing(5000); // æ¯5ç§’è¿›è¡Œä¸€æ¬¡æ£€æŸ¥ç‚¹

// é«˜çº§é…ç½®
env.getCheckpointConfig().setCheckpointingMode(CheckpointingMode.EXACTLY_ONCE);
env.getCheckpointConfig().setMinPauseBetweenCheckpoints(1000); // æœ€å°é—´éš”
env.getCheckpointConfig().setCheckpointTimeout(60000); // è¶…æ—¶æ—¶é—´
env.getCheckpointConfig().setMaxConcurrentCheckpoints(1); // æœ€å¤§å¹¶å‘æ•°
env.getCheckpointConfig().enableExternalizedCheckpoints(CheckpointConfig.ExternalizedCheckpointCleanup.RETAIN_ON_CANCELLATION); // å–æ¶ˆä½œä¸šæ—¶ä¿ç•™æ£€æŸ¥ç‚¹
```

### æ£€æŸ¥ç‚¹æ¢å¤

å½“ä½œä¸šå¤±è´¥æ—¶ï¼ŒFlinkå¯ä»¥é€šè¿‡æœ€è¿‘çš„æ£€æŸ¥ç‚¹æ¢å¤ï¼š

1. JobManageré€šçŸ¥æ‰€æœ‰ç®—å­åœæ­¢å¤„ç†æ•°æ®
2. ç®—å­ä»æŒä¹…åŒ–å­˜å‚¨ä¸­åŠ è½½æœ€è¿‘ä¸€æ¬¡æˆåŠŸæ£€æŸ¥ç‚¹çš„çŠ¶æ€
3. Sourceç®—å­ä»æ£€æŸ¥ç‚¹ä¿å­˜çš„ä½ç½®é‡æ–°è¯»å–æ•°æ®
4. ç®—å­ä»ä¿å­˜çš„offsetç»§ç»­å¤„ç†æ•°æ®

::: tip
æ£€æŸ¥ç‚¹æœºåˆ¶ç¡®ä¿äº†Flinkåº”ç”¨èƒ½å¤Ÿä»æ•…éšœä¸­æ¢å¤ï¼Œå¹¶ä¿æŒ"ç²¾ç¡®ä¸€æ¬¡"(Exactly-Once)çš„å¤„ç†è¯­ä¹‰ã€‚
:::

## é«˜çº§å®¹é”™æœºåˆ¶

é™¤äº†åŸºæœ¬çš„æ£€æŸ¥ç‚¹æœºåˆ¶ï¼ŒFlinkè¿˜æä¾›äº†ä¸€äº›é«˜çº§å®¹é”™ç‰¹æ€§ï¼š

### ä¿å­˜ç‚¹(Savepoints)

ä¿å­˜ç‚¹æ˜¯æ£€æŸ¥ç‚¹çš„ä¸€ç§ç‰¹æ®Šå½¢å¼ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

- ç”±ç”¨æˆ·æ‰‹åŠ¨è§¦å‘ï¼Œä¸å—è‡ªåŠ¨æ£€æŸ¥ç‚¹é—´éš”é™åˆ¶
- ä¸ä¾èµ–äºä½œä¸šçš„åœæ­¢å’Œé‡å¯
- å¯ä»¥ç”¨äºä½œä¸šå‡çº§ã€è¿ç§»æˆ–A/Bæµ‹è¯•

åˆ›å»ºä¿å­˜ç‚¹ï¼š
```bash
flink savepoints -p <jobId> -d <targetDirectory>
```

### ä¸¤é˜¶æ®µæäº¤(Two-Phase Commit, 2PC)

å¯¹äºéœ€è¦ç²¾ç¡®ä¸€æ¬¡è¯­ä¹‰çš„å¤–éƒ¨ç³»ç»Ÿï¼ˆå¦‚Kafkaã€JDBCç­‰ï¼‰ï¼ŒFlinkæ”¯æŒä¸¤é˜¶æ®µæäº¤æœºåˆ¶ï¼š

1. **é¢„æäº¤(Pre-commit)**ï¼šç®—å­å°†äº‹åŠ¡æ—¥å¿—å†™å…¥æ£€æŸ¥ç‚¹ï¼Œä½†ä¸æäº¤å®é™…æ“ä½œ
2. **æäº¤(Commit)**ï¼šæ£€æŸ¥ç‚¹æˆåŠŸå®Œæˆåï¼Œç®—å­æäº¤æ‰€æœ‰äº‹åŠ¡

å®ç°ä¸¤é˜¶æ®µæäº¤éœ€è¦å®ç°`TwoPhaseCommitSinkFunction`æ¥å£ã€‚

### ç«¯åˆ°ç«¯ç²¾ç¡®ä¸€æ¬¡è¯­ä¹‰

Flinké€šè¿‡ä»¥ä¸‹æœºåˆ¶å®ç°ç«¯åˆ°ç«¯çš„ç²¾ç¡®ä¸€æ¬¡è¯­ä¹‰ï¼š

1. **æº(Source)**ï¼šå¯é‡ç½®åç§»é‡çš„æºï¼ˆå¦‚Kafkaï¼‰
2. **Flinkå†…éƒ¨**ï¼šæ£€æŸ¥ç‚¹æœºåˆ¶
3. **æ±‡(Sink)**ï¼šæ”¯æŒä¸¤é˜¶æ®µæäº¤çš„æ±‡ï¼ˆå¦‚Kafkaã€å…³ç³»å‹æ•°æ®åº“ï¼‰

## å®æˆ˜ç¤ºä¾‹ï¼šçŠ¶æ€ç®¡ç†ä¸æ£€æŸ¥ç‚¹

ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹æ¥å±•ç¤ºå¦‚ä½•åœ¨Flinkä¸­ä½¿ç”¨çŠ¶æ€ç®¡ç†å’Œæ£€æŸ¥ç‚¹ï¼š

```java
public class StateManagementExample {
    public static void main(String[] args) throws Exception {
        // åˆ›å»ºæ‰§è¡Œç¯å¢ƒ
        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
        
        // å¯ç”¨æ£€æŸ¥ç‚¹
        env.enableCheckpointing(5000); // æ¯5ç§’ä¸€æ¬¡æ£€æŸ¥ç‚¹
        env.getCheckpointConfig().setCheckpointingMode(CheckpointingMode.EXACTLY_ONCE);
        
        // ä»Kafkaè¯»å–æ•°æ®
        Properties properties = new Properties();
        properties.setProperty("bootstrap.servers", "localhost:9092");
        properties.setProperty("group.id", "state-example");
        
        DataStream<String> stream = env
            .addSource(new FlinkKafkaConsumer<>("input-topic", new SimpleStringSchema(), properties))
            .uid("kafka-source");
            
        // ä½¿ç”¨KeyedStateè¿›è¡ŒçŠ¶æ€ç®¡ç†
        stream
            .keyBy(value -> value.split(",")[0]) // æŒ‰ç¬¬ä¸€ä¸ªå­—æ®µåˆ†ç»„
            .process(new KeyedProcessFunction<String, String, String>() {
                private ValueState<Integer> countState;
                
                @Override
                public void open(Configuration parameters) {
                    // åˆå§‹åŒ–çŠ¶æ€
                    ValueStateDescriptor<Integer> descriptor = 
                        new ValueStateDescriptor<>("count", Integer.class);
                    countState = getRuntimeContext().getState(descriptor);
                }
                
                @Override
                public void processElement(String value, Context ctx, Collector<String> out) {
                    // è·å–å½“å‰çŠ¶æ€
                    Integer currentCount = countState.value();
                    if (currentCount == null) {
                        currentCount = 0;
                    }
                    
                    // æ›´æ–°çŠ¶æ€
                    currentCount++;
                    countState.update(currentCount);
                    
                    // è¾“å‡ºç»“æœ
                    out.collect("Key: " + ctx.getCurrentKey() + ", Count: " + currentCount);
                }
            })
            .uid("keyed-process")
            .print();
            
        // æ‰§è¡Œä½œä¸š
        env.execute("State Management Example");
    }
}
```

## æ€§èƒ½ä¼˜åŒ–

åœ¨çŠ¶æ€ç®¡ç†å’Œå®¹é”™æœºåˆ¶æ–¹é¢ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ï¼š

1. **çŠ¶æ€åç«¯é€‰æ‹©**ï¼š
   - å°è§„æ¨¡çŠ¶æ€ï¼šMemoryStateBackend
   - å¤§è§„æ¨¡çŠ¶æ€ï¼šRocksDBStateBackend

2. **æ£€æŸ¥ç‚¹é…ç½®ä¼˜åŒ–**ï¼š
   - è°ƒæ•´æ£€æŸ¥ç‚¹é—´éš”ï¼Œé¿å…è¿‡äºé¢‘ç¹æˆ–è¿‡äºç¨€ç–
   - å¢åŠ æ£€æŸ¥ç‚¹è¶…æ—¶æ—¶é—´ï¼Œç¡®ä¿æœ‰è¶³å¤Ÿæ—¶é—´å®Œæˆ
   - ä½¿ç”¨å¢é‡æ£€æŸ¥ç‚¹å‡å°‘æ£€æŸ¥ç‚¹æ—¶é—´

3. **çŠ¶æ€è®¿é—®ä¼˜åŒ–**ï¼š
   - é¿å…åœ¨æ¯æ¡è®°å½•ä¸­è®¿é—®çŠ¶æ€
   - æ‰¹é‡è®¿é—®çŠ¶æ€å‡å°‘ç½‘ç»œå¼€é”€
   - åˆç†è®¾è®¡çŠ¶æ€ç»“æ„ï¼Œå‡å°‘çŠ¶æ€å¤§å°

4. **å¼‚æ­¥å¿«ç…§**ï¼š
   - å¯ç”¨å¼‚æ­¥å¿«ç…§ï¼Œå‡å°‘å¯¹å¤„ç†å»¶è¿Ÿçš„å½±å“

## æ€»ç»“

é€šè¿‡ä»Šå¤©çš„åˆ†äº«ï¼Œæˆ‘ä»¬æ·±å…¥äº†è§£äº†Flinkçš„çŠ¶æ€ç®¡ç†å’Œå®¹é”™æœºåˆ¶ï¼š

1. **çŠ¶æ€ç®¡ç†**ï¼šæ‰˜ç®¡çŠ¶æ€å’ŒåŸå§‹çŠ¶æ€ä¸¤ç§ç±»å‹ï¼Œä»¥åŠä¸‰ç§çŠ¶æ€åç«¯
2. **å®¹é”™æœºåˆ¶**ï¼šåŸºäºæ£€æŸ¥ç‚¹çš„åˆ†å¸ƒå¼å¿«ç…§æŠ€æœ¯
3. **é«˜çº§ç‰¹æ€§**ï¼šä¿å­˜ç‚¹ã€ä¸¤é˜¶æ®µæäº¤å’Œç«¯åˆ°ç«¯ç²¾ç¡®ä¸€æ¬¡è¯­ä¹‰
4. **å®é™…åº”ç”¨**ï¼šå¦‚ä½•åœ¨ä»£ç ä¸­ä½¿ç”¨çŠ¶æ€ç®¡ç†å’Œé…ç½®æ£€æŸ¥ç‚¹

çŠ¶æ€ç®¡ç†å’Œå®¹é”™æœºåˆ¶æ˜¯æ„å»ºå¯é æµå¤„ç†åº”ç”¨çš„åŸºç¡€ï¼Œç†è§£å¹¶æŒæ¡è¿™äº›æœºåˆ¶å¯¹äºå¼€å‘ç”Ÿäº§çº§çš„Flinkåº”ç”¨è‡³å…³é‡è¦ã€‚å¸Œæœ›ä»Šå¤©çš„åˆ†äº«èƒ½å¤Ÿå¸®åŠ©å¤§å®¶æ›´å¥½åœ°ç†è§£å’Œä½¿ç”¨Flinkçš„çŠ¶æ€ç®¡ç†ä¸å®¹é”™æœºåˆ¶ï¼

> "åœ¨æµå¤„ç†çš„æ—…ç¨‹ä¸­ï¼ŒçŠ¶æ€æ˜¯è®°å¿†ï¼Œå®¹é”™æ˜¯ä¿éšœã€‚åªæœ‰æ‹¥æœ‰å¯é çš„çŠ¶æ€ç®¡ç†å’Œå®¹é”™æœºåˆ¶ï¼Œæˆ‘ä»¬çš„æ•°æ®ç®¡é“æ‰èƒ½ç©¿è¶Šé£é›¨ï¼Œå§‹ç»ˆå¦‚ä¸€ã€‚"

å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºç•™è¨€äº¤æµï¼ğŸ‘‡

::: right
"çŠ¶æ€ç®¡ç†æ˜¯æµå¤„ç†çš„æ ¸å¿ƒï¼Œå®¹é”™æ˜¯å¯é æ€§çš„ä¿è¯ã€‚"
- Jorgen
:::
```