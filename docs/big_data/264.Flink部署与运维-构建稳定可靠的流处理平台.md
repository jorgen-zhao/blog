---
title: Flinkéƒ¨ç½²ä¸è¿ç»´-æ„å»ºç¨³å®šå¯é çš„æµå¤„ç†å¹³å°
date: 2023-11-15 14:30:00
categories: 
  - å¤§æ•°æ®
tags:
  - Flink
  - éƒ¨ç½²
  - è¿ç»´
  - æµå¤„ç†
author: 
  name: Jorgen
  link: https://github.com/jorgen-zhao
---

## å‰è¨€

åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å·²ç»æ·±å…¥æ¢è®¨äº†Flinkçš„æ¶æ„åŸç†ã€APIç¼–ç¨‹æ¨¡å‹ã€çŠ¶æ€ç®¡ç†ä»¥åŠTable APIç­‰æ ¸å¿ƒæ¦‚å¿µã€‚ğŸ¤” ä½†æ˜¯ï¼Œå½“æˆ‘ä»¬çœŸæ­£è¦å°†Flinkåº”ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒä¸­æ—¶ï¼Œå¦‚ä½•éƒ¨ç½²ã€ç®¡ç†å’Œç›‘æ§Flinké›†ç¾¤æˆä¸ºäº†ä¸€ä¸ªå…³é”®é—®é¢˜ã€‚ä»Šå¤©ï¼Œæˆ‘æƒ³å’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹æˆ‘åœ¨Flinkéƒ¨ç½²ä¸è¿ç»´æ–¹é¢çš„ä¸€äº›ç»éªŒå’Œå¿ƒå¾—ã€‚

::: tip
éƒ¨ç½²ä¸è¿ç»´æ˜¯æµå¤„ç†å¹³å°æˆåŠŸè½åœ°çš„å…³é”®ç¯èŠ‚ï¼Œä¸€ä¸ªç¨³å®šå¯é çš„Flinké›†ç¾¤èƒ½å¤Ÿç¡®ä¿æ•°æ®å¤„ç†çš„è¿ç»­æ€§å’Œå‡†ç¡®æ€§ã€‚
:::

## Flinkéƒ¨ç½²æ¨¡å¼æ¦‚è¿°

Flinkæ”¯æŒå¤šç§éƒ¨ç½²æ¨¡å¼ï¼Œæ ¹æ®ä¸šåŠ¡éœ€æ±‚å’Œèµ„æºç¯å¢ƒé€‰æ‹©åˆé€‚çš„éƒ¨ç½²æ¨¡å¼è‡³å…³é‡è¦ã€‚

### 1. Standaloneæ¨¡å¼

è¿™æ˜¯æœ€ç®€å•çš„éƒ¨ç½²æ¨¡å¼ï¼ŒFlinkè‡ªå·±ç®¡ç†èµ„æºï¼Œä¸ä¾èµ–å…¶ä»–èµ„æºç®¡ç†ç³»ç»Ÿã€‚

```bash
# å¯åŠ¨é›†ç¾¤
./bin/start-cluster.sh

# åœæ­¢é›†ç¾¤
./bin/stop-cluster.sh
```

**ä¼˜ç‚¹**ï¼š
- éƒ¨ç½²ç®€å•ï¼Œæ— éœ€é¢å¤–é…ç½®
- é€‚åˆå°å‹é›†ç¾¤å’Œæµ‹è¯•ç¯å¢ƒ

**ç¼ºç‚¹**ï¼š
- èµ„æºåˆ©ç”¨ç‡ä¸é«˜
- éš¾ä»¥å®ç°å¤§è§„æ¨¡é›†ç¾¤ç®¡ç†

### 2. YARNæ¨¡å¼

YARNæ¨¡å¼æ˜¯ç”Ÿäº§ç¯å¢ƒä¸­æœ€å¸¸ç”¨çš„éƒ¨ç½²æ–¹å¼ï¼Œèƒ½å¤Ÿå……åˆ†åˆ©ç”¨Hadoopç”Ÿæ€çš„èµ„æºç®¡ç†èƒ½åŠ›ã€‚

```bash
# æäº¤ä½œä¸šåˆ°YARN
./bin/flink run -d -m yarn-cluster -p 4 examples/streaming/WordCount.jar

# æŸ¥çœ‹YARNä¸Šçš„Flinkåº”ç”¨
yarn application -list -appTypes Flink
```

**ä¼˜ç‚¹**ï¼š
- ä¸Hadoopç”Ÿæ€æ— ç¼é›†æˆ
- èµ„æºåˆ©ç”¨ç‡é«˜
- æ”¯æŒåŠ¨æ€èµ„æºåˆ†é…

**ç¼ºç‚¹**ï¼š
- é…ç½®ç›¸å¯¹å¤æ‚
- ä¾èµ–YARNç¯å¢ƒ

### 3. Kubernetesæ¨¡å¼

éšç€å®¹å™¨åŒ–æŠ€æœ¯çš„æ™®åŠï¼ŒKubernetesæ¨¡å¼è¶Šæ¥è¶Šå—åˆ°å…³æ³¨ã€‚

```bash
# æäº¤ä½œä¸šåˆ°K8s
./bin/flink run -d -d kubernetes-session -p 4 -n my-flink-cluster examples/streaming/WordCount.jar
```

**ä¼˜ç‚¹**ï¼š
- å¼¹æ€§ä¼¸ç¼©
- é«˜å¯ç”¨æ€§
- ä¸äº‘åŸç”Ÿç”Ÿæ€é›†æˆ

**ç¼ºç‚¹**ï¼š
- éœ€è¦KubernetesçŸ¥è¯†
- è¿ç»´å¤æ‚åº¦è¾ƒé«˜

## Flinké›†ç¾¤é…ç½®ä¼˜åŒ–

### èµ„æºé…ç½®

åˆç†çš„èµ„æºé…ç½®æ˜¯Flinké›†ç¾¤ç¨³å®šè¿è¡Œçš„åŸºç¡€ã€‚

| é…ç½®é¡¹ | Standalone | YARN | Kubernetes |
|-------|-----------|------|------------|
| TaskManageræ•°é‡ | `taskmanager.numberOfTaskSlots` | `yarn.applicationMaster.vcores` | `flink.taskmanager.replicas` |
| å†…å­˜åˆ†é… | `taskmanager.memory.process.size` | `yarn.containerMemoryMB` | `flink.taskmanager.memory.mb` |
| å¹¶è¡Œåº¦ | `parallelism.default` | `yarn.applicationMaster.vcores` | `flink.taskmanager.cpu` |

### é«˜å¯ç”¨é…ç½®

::: theorem
é«˜å¯ç”¨æ€§æ˜¯ç”Ÿäº§ç¯å¢ƒçš„åŸºæœ¬è¦æ±‚ï¼ŒFlinké€šè¿‡å¤šç§æœºåˆ¶ç¡®ä¿é›†ç¾¤çš„å¯é æ€§ã€‚
:::

1. **ZooKeeperé…ç½®**

```yaml
# flink-conf.yaml
high-availability: zookeeper
high-availability.storageDir: hdfs:///flink/ha/
high-availability.zookeeper.quorum: zk1:2181,zk2:2181,zk3:2181
high-availability.zookeeper.port: 2181
high-availability.zookeeper.cluster-id: /flink-cluster
```

2. **JobManageré«˜å¯ç”¨**

```bash
# Standaloneæ¨¡å¼ä¸‹çš„JobManageré«˜å¯ç”¨
./bin/jobmanager.sh start --configDirectory ./config --zookeeperNamespace /flink-cluster
```

## Flinkä½œä¸šç›‘æ§ä¸ç®¡ç†

### 1. Web UIç›‘æ§

Flinkæä¾›äº†å¼ºå¤§çš„Web UIç•Œé¢ï¼Œç”¨äºç›‘æ§ä½œä¸šçŠ¶æ€å’Œèµ„æºä½¿ç”¨æƒ…å†µã€‚

- **ä½œä¸šç›‘æ§**ï¼šæŸ¥çœ‹ä½œä¸šçš„è¿è¡ŒçŠ¶æ€ã€ååé‡ã€å»¶è¿Ÿç­‰æŒ‡æ ‡
- **èµ„æºç›‘æ§**ï¼šè§‚å¯ŸTaskManagerå’ŒJobManagerçš„èµ„æºä½¿ç”¨æƒ…å†µ
- **æ—¥å¿—æŸ¥çœ‹**ï¼šå®æ—¶æŸ¥çœ‹ä½œä¸šæ—¥å¿—

### 2. REST API

Flinkæä¾›äº†REST APIï¼Œæ–¹ä¾¿è¿›è¡Œè‡ªåŠ¨åŒ–è¿ç»´ã€‚

```bash
# è·å–ä½œä¸šåˆ—è¡¨
curl http://localhost:8081/jobs

# åœæ­¢ä½œä¸š
curl -X POST http://localhost:8081/jobs/<job-id>/stop
```

### 3. æ—¥å¿—ç®¡ç†

::: tip
è‰¯å¥½çš„æ—¥å¿—ç®¡ç†æ˜¯é—®é¢˜æ’æŸ¥çš„å…³é”®ï¼Œå»ºè®®é…ç½®æ—¥å¿—èšåˆå’Œé›†ä¸­å­˜å‚¨ã€‚
:::

```yaml
# log4j.properties
log4j.appender.file=org.apache.log4j.RollingFileAppender
log4j.appender.file.File=${log.file}
log4j.appender.file.MaxFileSize=100MB
log4j.appender.file.MaxBackupIndex=10
log4j.appender.file.layout=org.apache.log4j.PatternLayout
log4j.appender.file.layout.ConversionPattern=%d{yyyy-MM-dd HH:mm:ss,SSS} %-5p %-60c %x - %m%n
```

## Flinkä½œä¸šè°ƒä¼˜

### 1. å¹¶è¡Œåº¦è°ƒæ•´

åˆç†çš„å¹¶è¡Œåº¦è®¾ç½®èƒ½å¤Ÿå……åˆ†åˆ©ç”¨é›†ç¾¤èµ„æºã€‚

```java
// è®¾ç½®ä½œä¸šçº§åˆ«çš„å¹¶è¡Œåº¦
StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
env.setParallelism(16);

// è®¾ç½®ç®—å­çº§åˆ«çš„å¹¶è¡Œåº¦
DataStream<String> text = env.socketTextStream("localhost", 9999).setParallelism(8);
```

### 2. çŠ¶æ€åç«¯é…ç½®

```yaml
# flink-conf.yaml
state.backend: rocksdb
state.backend.rocksdb.localdir: /mnt/flink/rocksdb
state.checkpoints.dir: hdfs:///flink/checkpoints
```

### 3. æ£€æŸ¥ç‚¹é…ç½®

```yaml
# flink-conf.yaml
execution.checkpointing.interval: 1min
execution.checkpointing.mode: EXACTLY_ONCE
execution.checkpointing.timeout: 1h
execution.checkpointing.min-pause: 1s
execution.checkpointing.max-concurrent-checkpoints: 1
```

## Flinkå¸¸è§é—®é¢˜æ’æŸ¥

### 1. ä½œä¸šå¯åŠ¨å¤±è´¥

**å¯èƒ½åŸå› **ï¼š
- èµ„æºä¸è¶³
- é…ç½®é”™è¯¯
- ä¾èµ–é—®é¢˜

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
2. éªŒè¯èµ„æºé…ç½®æ˜¯å¦åˆç†
3. ç¡®è®¤ä¾èµ–æ˜¯å¦æ­£ç¡®

### 2. ä½œä¸šæ€§èƒ½é—®é¢˜

**å¯èƒ½åŸå› **ï¼š
- å¹¶è¡Œåº¦è®¾ç½®ä¸åˆç†
- çŠ¶æ€è¿‡å¤§
- ç½‘ç»œç“¶é¢ˆ

**æ’æŸ¥æ­¥éª¤**ï¼š
1. ç›‘æ§èµ„æºä½¿ç”¨æƒ…å†µ
2. åˆ†æä½œä¸šæ‰§è¡Œè®¡åˆ’
3. æ£€æŸ¥æ•°æ®å€¾æ–œæƒ…å†µ

### 3. ä½œä¸šå¤±è´¥æ¢å¤

**å¤„ç†ç­–ç•¥**ï¼š
1. è®¾ç½®åˆç†çš„æ£€æŸ¥ç‚¹é—´éš”
2. é…ç½®é‡å¯ç­–ç•¥
3. å®ç°è‡ªå®šä¹‰æ¢å¤é€»è¾‘

```java
// é…ç½®é‡å¯ç­–ç•¥
env.setRestartStrategy(RestartStrategies.fixedDelayRestart(
    3, // é‡è¯•æ¬¡æ•°
    Time.seconds(10) // é‡è¯•é—´éš”
));
```

## ç»“è¯­

Flinkçš„éƒ¨ç½²ä¸è¿ç»´æ˜¯ä¸€ä¸ªå¤æ‚ä½†è‡³å…³é‡è¦çš„ç¯èŠ‚ï¼Œå®ƒç›´æ¥å…³ç³»åˆ°æµå¤„ç†å¹³å°çš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚é€šè¿‡åˆç†çš„éƒ¨ç½²æ¨¡å¼é€‰æ‹©ã€é›†ç¾¤é…ç½®ä¼˜åŒ–ã€ä½œä¸šç›‘æ§ç®¡ç†å’Œé—®é¢˜æ’æŸ¥ï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºä¸€ä¸ªé«˜æ•ˆå¯é çš„Flinkæµå¤„ç†å¹³å°ã€‚

> éƒ¨ç½²ä¸è¿ç»´ä¸æ˜¯ä¸€è¹´è€Œå°±çš„å·¥ä½œï¼Œå®ƒéœ€è¦æŒç»­çš„ä¼˜åŒ–å’Œæ”¹è¿›ï¼Œåªæœ‰ä¸æ–­å­¦ä¹ å’Œå®è·µï¼Œæ‰èƒ½æŒæ¡Flinkè¿ç»´çš„ç²¾é«“ã€‚

å¸Œæœ›ä»Šå¤©çš„åˆ†äº«å¯¹å¤§å®¶æœ‰æ‰€å¸®åŠ©ï¼Œå¦‚æœæœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºäº¤æµè®¨è®ºï¼ğŸ™‹â€â™‚ï¸

::: right
"è¿ç»´çš„æœ¬è´¨æ˜¯é¢„é˜²é—®é¢˜ï¼Œè€Œä¸æ˜¯è§£å†³é—®é¢˜"
:::