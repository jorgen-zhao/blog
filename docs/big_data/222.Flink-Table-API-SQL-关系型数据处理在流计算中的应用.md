---
title: Flink Table API & SQL - å…³ç³»å‹æ•°æ®å¤„ç†åœ¨æµè®¡ç®—ä¸­çš„åº”ç”¨
date: 2023-11-15 10:30:00
permalink: /pages/flink-table-api-sql/
categories: 
  - å¤§æ•°æ®
tags:
  - Flink
  - SQL
  - Table API
  - æµè®¡ç®—
  - æ•°æ®å¤„ç†
author: 
  name: Jorgen
  link: https://github.com/jorgen-zhao
---

## å‰è¨€

åœ¨ä¹‹å‰çš„ä¸€ç³»åˆ—æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å·²ç»æ·±å…¥æ¢è®¨äº†Flinkçš„æ ¸å¿ƒæ¶æ„ã€é…ç½®é€‰é¡¹ä»¥åŠåŸºç¡€ä¸è¿›é˜¶æ¦‚å¿µã€‚ç„¶è€Œï¼Œæœ‰ä¸€ä¸ªå¼ºå¤§çš„åŠŸèƒ½æˆ‘ä»¬å°šæœªæ¶‰åŠï¼Œé‚£å°±æ˜¯Flinkçš„Table API & SQLã€‚ğŸ¤”

éšç€å¤§æ•°æ®å¤„ç†çš„æ™®åŠï¼Œè¶Šæ¥è¶Šå¤šçš„æ•°æ®åˆ†æå¸ˆå’Œå·¥ç¨‹å¸ˆä¹ æƒ¯äºä½¿ç”¨SQLè¿›è¡Œæ•°æ®æŸ¥è¯¢å’Œåˆ†æã€‚Flinkçš„Table API & SQLæ­£æ˜¯ä¸ºäº†æ»¡è¶³è¿™ä¸€éœ€æ±‚è€Œç”Ÿï¼Œå®ƒå°†å…³ç³»å‹æ•°æ®å¤„ç†èƒ½åŠ›æ— ç¼é›†æˆåˆ°äº†æµè®¡ç®—å¼•æ“ä¸­ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥ç”¨ç†Ÿæ‚‰çš„SQLè¯­æ³•æ¥å¤„ç†å®æ—¶æ•°æ®æµã€‚

::: tip
Table API & SQLæ˜¯Flinkç”Ÿæ€ç³»ç»Ÿä¸­è¿æ¥ä¼ ç»Ÿæ‰¹å¤„ç†ä¸æµå¤„ç†çš„é‡è¦æ¡¥æ¢ï¼Œå®ƒè®©Flinkä¸ä»…ä»…æ˜¯ä¸€ä¸ªæŠ€æœ¯å·¥å…·ï¼Œæ›´æ˜¯ä¸€ä¸ªä¸šåŠ¡å‹å¥½çš„æ•°æ®å¤„ç†å¹³å°ã€‚
:::

## ä»€ä¹ˆæ˜¯Flink Table API & SQLï¼Ÿ

Flinkçš„Table API & SQLæ˜¯ä¸€å¥—ç”¨äºå…³ç³»å‹æ•°æ®å¤„ç†çš„é«˜çº§APIï¼Œå®ƒå…è®¸ç”¨æˆ·ä½¿ç”¨SQLè¯­å¥æˆ–è¡¨æ“ä½œæ¥å¤„ç†æµæ•°æ®å’Œæ‰¹æ•°æ®ã€‚è¿™å¥—APIå»ºç«‹åœ¨Flinkçš„DataStreamå’ŒDataSet APIä¹‹ä¸Šï¼Œæä¾›äº†å£°æ˜å¼çš„ç¼–ç¨‹æ¥å£ã€‚

### æ ¸å¿ƒç‰¹æ€§

- **ç»Ÿä¸€çš„API**ï¼šæ— è®ºæ˜¯æ‰¹å¤„ç†è¿˜æ˜¯æµå¤„ç†ï¼Œéƒ½å¯ä»¥ä½¿ç”¨ç›¸åŒçš„APIè¿›è¡Œæ“ä½œ
- **æ ‡å‡†SQLæ”¯æŒ**ï¼šæ”¯æŒå¤§éƒ¨åˆ†ANSI SQLæ ‡å‡†ï¼Œé™ä½å­¦ä¹ æˆæœ¬
- **æµæ‰¹ä¸€ä½“**ï¼šåŒä¸€å¥—SQLå¯ä»¥åŒæ—¶åº”ç”¨äºæµæ•°æ®å’Œæ‰¹æ•°æ®
- **è‡ªåŠ¨ä¼˜åŒ–**ï¼šFlinkä¼šè‡ªåŠ¨ä¼˜åŒ–SQLæŸ¥è¯¢ï¼Œç”Ÿæˆé«˜æ•ˆçš„æ‰§è¡Œè®¡åˆ’
- **ä¸°å¯Œçš„ç±»å‹ç³»ç»Ÿ**ï¼šæ”¯æŒFlinkçš„æ‰€æœ‰æ•°æ®ç±»å‹

## Table API vs. SQL

è™½ç„¶Table APIå’ŒSQLéƒ½ç”¨äºå…³ç³»å‹æ•°æ®å¤„ç†ï¼Œä½†å®ƒä»¬æœ‰ä»¥ä¸‹åŒºåˆ«ï¼š

| ç‰¹æ€§ | Table API | SQL |
|------|-----------|-----|
| ç¼–ç¨‹æ–¹å¼ | å£°æ˜å¼è¿‡ç¨‹ç¼–ç¨‹ | å£°æ˜å¼å£°æ˜ç¼–ç¨‹ |
| çµæ´»æ€§ | æ›´çµæ´»ï¼Œå¯ä»¥æ··åˆä½¿ç”¨Java/Scalaä»£ç  | è¯­æ³•ä¸¥æ ¼ï¼Œå¿…é¡»éµå¾ªSQLæ ‡å‡† |
| é€‚ç”¨åœºæ™¯ | å¤æ‚çš„æ•°æ®å¤„ç†é€»è¾‘ | æ ‡å‡†åŒ–çš„æŸ¥è¯¢å’Œåˆ†æ |
| å­¦ä¹ æ›²çº¿ | éœ€è¦äº†è§£Table APIçš„ç‰¹å®šè¯­æ³• | åªéœ€äº†è§£SQLè¯­æ³• |

## åŸºæœ¬ä½¿ç”¨ç¤ºä¾‹

### åˆ›å»ºè¡¨ç¯å¢ƒ

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªTableEnvironmentï¼š

```java
import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;
import org.apache.flink.table.api.EnvironmentSettings;
import org.apache.flink.table.api.TableEnvironment;

public class TableApiExample {
    public static void main(String[] args) {
        // åˆ›å»ºæµæ‰§è¡Œç¯å¢ƒ
        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
        
        // åˆ›å»ºè¡¨ç¯å¢ƒè®¾ç½®
        EnvironmentSettings settings = EnvironmentSettings.newInstance()
            .useBlinkPlanner()
            .inStreamingMode()
            .build();
            
        // åˆ›å»ºè¡¨ç¯å¢ƒ
        TableEnvironment tableEnv = TableEnvironment.create(settings);
    }
}
```

### ä»DataStreamåˆ›å»ºè¡¨

```java
// åˆ›å»ºDataStream
DataStream<Order> orderStream = env.addSource(new OrderSource());

// å°†DataStreamè½¬æ¢ä¸ºè¡¨
Table orderTable = tableEnv.fromDataStream(orderStream);

// æ³¨å†Œè¡¨
tableEnv.createTemporaryView("orders", orderTable);
```

### æ‰§è¡ŒSQLæŸ¥è¯¢

```java
// æ‰§è¡ŒSQLæŸ¥è¯¢
Table result = tableEnv.sqlQuery(
    "SELECT customer, amount, COUNT(*) as order_count " +
    "FROM orders " +
    "GROUP BY customer, amount"
);

// å°†è¡¨ç»“æœè¾“å‡ºåˆ°æ§åˆ¶å°
tableEnv.toDataStream(result).print();
```

### ä½¿ç”¨Table APIè¿›è¡ŒæŸ¥è¯¢

```java
// ä½¿ç”¨Table APIè¿›è¡ŒæŸ¥è¯¢
Table result = orderTable
    .groupBy($("customer"), $("amount"))
    .select($("customer"), $("amount"), $("customer").count().as("order_count"));
```

## é«˜çº§ç‰¹æ€§

### åŠ¨æ€è¡¨

åŠ¨æ€è¡¨æ˜¯Flink Table API & SQLçš„æ ¸å¿ƒæ¦‚å¿µä¹‹ä¸€ï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ªä¸æ–­å˜åŒ–çš„è¡¨ã€‚åŠ¨æ€è¡¨å¯ä»¥åƒé™æ€è¡¨ä¸€æ ·è¿›è¡ŒæŸ¥è¯¢ï¼Œä½†æŸ¥è¯¢ç»“æœä¹Ÿæ˜¯ä¸€ä¸ªåŠ¨æ€è¡¨ã€‚

```java
// å°†DataStreamè½¬æ¢ä¸ºåŠ¨æ€è¡¨
Table dynamicOrderTable = tableEnv.fromDataStream(orderStream);

// åœ¨åŠ¨æ€è¡¨ä¸Šæ‰§è¡Œè¿ç»­æŸ¥è¯¢
Table result = dynamicOrderTable
    .groupBy($("customer"))
    .select($("customer"), $("amount").sum().as("total_amount"));
```

### æ—¶é—´å±æ€§å¤„ç†

åœ¨æµå¤„ç†ä¸­ï¼Œæ—¶é—´å±æ€§è‡³å…³é‡è¦ã€‚Flink Table API & SQLæä¾›äº†å¤šç§æ—¶é—´å±æ€§å¤„ç†æ–¹å¼ï¼š

```java
// å®šä¹‰è¡¨schemaæ—¶æŒ‡å®šæ—¶é—´å±æ€§
TableSchema schema = TableSchema.builder()
    .field("order_time", DataTypes.TIMESTAMP(3))
    .field("proctime", DataTypes.TIMESTAMP(3).nullable())
    .build();

// åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨æ—¶é—´å±æ€§
Table result = tableEnv.sqlQuery(
    "SELECT TUMBLE_START(order_time, INTERVAL '1' HOUR) as window_start, " +
    "       customer, " +
    "       SUM(amount) as total_amount " +
    "FROM orders " +
    "GROUP BY TUMBLE(order_time, INTERVAL '1' HOUR), customer"
);
```

### è¿æ¥å™¨ä¸æ ¼å¼

Flink Table API & SQLæ”¯æŒå¤šç§è¿æ¥å™¨å’Œæ•°æ®æ ¼å¼ï¼š

```java
// æ³¨å†ŒKafkaè¡¨
String kafkaDDL = "CREATE TABLE orders (" +
    "  order_id STRING, " +
    "  customer STRING, " +
    "  amount DOUBLE, " +
    "  order_time TIMESTAMP(3), " +
    "  WATERMARK FOR order_time AS order_time - INTERVAL '5' SECOND " +
    ") WITH (" +
    "  'connector' = 'kafka', " +
    "  'topic' = 'orders', " +
    "  'properties.bootstrap.servers' = 'localhost:9092', " +
    "  'format' = 'json' " +
    ")";

tableEnv.executeSql(kafkaDDL);
```

## å®é™…åº”ç”¨åœºæ™¯

### å®æ—¶æ•°æ®åˆ†æ

```java
// å®æ—¶ç”¨æˆ·è¡Œä¸ºåˆ†æ
Table userBehavior = tableEnv.sqlQuery(
    "SELECT user_id, " +
    "       COUNT(*) as page_views, " +
    "       COLLECT_LIST(action) as actions " +
    "FROM user_events " +
    "GROUP BY TUMBLE(event_time, INTERVAL '1' MINUTE), user_id"
);
```

### å®æ—¶ETL

```java
// ä»Kafkaè¯»å–æ•°æ®ï¼Œå¤„ç†åå†™å…¥Elasticsearch
tableEnv.sqlQuery(
    "INSERT INTO elasticsearch_index " +
    "SELECT " +
    "  order_id, " +
    "  customer, " +
    "  amount, " +
    "  CONCAT('order_', order_id) as document_id " +
    "FROM orders " +
    "WHERE amount > 100"
);
```

### å®æ—¶æŠ¥è¡¨ç”Ÿæˆ

```java
// ç”Ÿæˆå®æ—¶é”€å”®æŠ¥è¡¨
Table salesReport = tableEnv.sqlQuery(
    "SELECT " +
    "  DATE_FORMAT(order_time, 'yyyy-MM-dd') as date, " +
    "  HOUR(order_time) as hour, " +
    "  SUM(amount) as total_sales, " +
    "  COUNT(DISTINCT customer) as unique_customers " +
    "FROM orders " +
    "GROUP BY DATE_FORMAT(order_time, 'yyyy-MM-dd'), HOUR(order_time)"
);
```

## æœ€ä½³å®è·µ

### 1. åˆç†ä½¿ç”¨æ—¶é—´çª—å£

```java
// æ¨èä½¿ç”¨äº‹ä»¶æ—¶é—´å¤„ç†æ—¶é—´è¯­ä¹‰
TableSchema schema = TableSchema.builder()
    .field("event_time", DataTypes.TIMESTAMP(3))
    .field("proctime", DataTypes.TIMESTAMP(3).nullable())
    .build();

// å®šä¹‰æ°´å°
tableEnv.sqlUpdate(
    "CREATE TABLE events (" +
    "  event_time TIMESTAMP(3), " +
    "  -- å…¶ä»–å­—æ®µ..." +
    "  WATERMARK FOR event_time AS event_time - INTERVAL '5' SECOND " +
    ") WITH (...)"
);
```

### 2. ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

```java
// ä½¿ç”¨é€‚å½“çš„ç´¢å¼•
tableEnv.sqlUpdate("CREATE INDEX idx_customer ON orders (customer)");

// é¿å…å…¨è¡¨æ‰«æ
Table result = tableEnv.sqlQuery(
    "SELECT * FROM orders WHERE customer = 'John' AND amount > 100"
);
```

### 3. åˆç†å¤„ç†çŠ¶æ€åç«¯

```java
// é…ç½®çŠ¶æ€åç«¯
env.setStateBackend(new RocksDBStateBackend("hdfs://path/to/rocksdb"));
env.enableCheckpointing(60000); // 60ç§’æ£€æŸ¥ç‚¹é—´éš”
```

## ç»“è¯­

Flinkçš„Table API & SQLä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§å¼ºå¤§è€Œçµæ´»çš„æ–¹å¼æ¥å¤„ç†å®æ—¶å’Œæ‰¹å¤„ç†æ•°æ®ã€‚é€šè¿‡ç†Ÿæ‚‰çš„SQLè¯­æ³•ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°å°†å®æ—¶æ•°æ®å¤„ç†èƒ½åŠ›é›†æˆåˆ°ç°æœ‰çš„æ•°æ®å·¥ä½œæµä¸­ï¼Œæ— éœ€å­¦ä¹ å¤æ‚çš„æµå¤„ç†APIã€‚ğŸ—

éšç€Flinkçš„ä¸æ–­å‘å±•å’Œå®Œå–„ï¼ŒTable API & SQLä¹Ÿåœ¨æŒç»­å¢å¼ºï¼Œæ”¯æŒæ›´å¤šSQLæ ‡å‡†å’Œä¼˜åŒ–æŠ€æœ¯ã€‚å¯¹äºå¸Œæœ›å°†å®æ—¶æ•°æ®å¤„ç†èƒ½åŠ›å¼•å…¥ç»„ç»‡çš„æ•°æ®å›¢é˜Ÿæ¥è¯´ï¼ŒæŒæ¡Flinkçš„Table API & SQLæ˜¯ä¸€é¡¹éå¸¸æœ‰ä»·å€¼çš„æŠ€èƒ½ã€‚

> æ­£å¦‚æ•°æ®åº“å¤§å¸ˆC.J. Dateæ‰€è¨€ï¼š"SQLæ˜¯æ•°æ®å¤„ç†çš„è¯­è¨€ï¼Œè€ŒFlinkè®©è¿™ç§è¯­è¨€èƒ½å¤Ÿåº”ç”¨äºå®æ—¶ä¸–ç•Œã€‚"

---

**ä¸ªäººå»ºè®®**ï¼šå¦‚æœä½ å·²ç»ç†Ÿæ‚‰äº†Flinkçš„åŸºç¡€æ¦‚å¿µå’ŒAPIï¼Œé‚£ä¹ˆä¸‹ä¸€æ­¥åº”è¯¥æ·±å…¥æ¢ç´¢Table API & SQLã€‚å®ƒä¸ä»…èƒ½å¤Ÿç®€åŒ–ä½ çš„å¼€å‘æµç¨‹ï¼Œè¿˜èƒ½è®©ä½ æ›´å¥½åœ°åˆ©ç”¨Flinkçš„æµæ‰¹ä¸€ä½“èƒ½åŠ›ã€‚åŒæ—¶ï¼Œå»ºè®®åœ¨å®é™…é¡¹ç›®ä¸­å°è¯•ä½¿ç”¨Table API & SQLæ¥è§£å†³å®é™…é—®é¢˜ï¼Œæ‰èƒ½çœŸæ­£ä½“ä¼šåˆ°å®ƒçš„ä¼˜åŠ¿ã€‚