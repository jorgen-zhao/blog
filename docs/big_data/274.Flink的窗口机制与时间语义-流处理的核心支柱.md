---
title: Flinkçš„çª—å£æœºåˆ¶ä¸æ—¶é—´è¯­ä¹‰-æµå¤„ç†çš„æ ¸å¿ƒæ”¯æŸ±
date: 2023-11-15 09:30:00
categories: 
  - å¤§æ•°æ®
tags:
  - Flink
  - æµå¤„ç†
  - çª—å£æœºåˆ¶
  - æ—¶é—´è¯­ä¹‰
author: 
  name: Jorgen
  link: https://github.com/jorgen-zhao
---

## å‰è¨€

åœ¨åˆ†å¸ƒå¼æµå¤„ç†çš„ä¸–ç•Œä¸­ï¼ŒFlinkä»¥å…¶å“è¶Šçš„æ€§èƒ½å’Œå¼ºå¤§çš„åŠŸèƒ½è„±é¢–è€Œå‡ºã€‚ç„¶è€Œï¼Œè¦çœŸæ­£æŒæ¡Flinkï¼Œæ·±å…¥ç†è§£å…¶çª—å£æœºåˆ¶å’Œæ—¶é—´è¯­ä¹‰æ˜¯å¿…ä¸å¯å°‘çš„ã€‚ğŸ¤”

æœ¬æ–‡å°†å¸¦ä½ æ·±å…¥æ¢ç´¢Flinkçš„çª—å£æœºåˆ¶ä¸æ—¶é—´è¯­ä¹‰ï¼Œè¿™ä¸¤ä¸ªæ¦‚å¿µæ„æˆäº†æµå¤„ç†çš„æ ¸å¿ƒæ”¯æŸ±ã€‚æ— è®ºä½ æ˜¯Flinkçš„æ–°æ‰‹è¿˜æ˜¯å¸Œæœ›æ·±åŒ–ç†è§£çš„å¼€å‘è€…ï¼Œè¿™ç¯‡æ–‡ç« éƒ½å°†ä¸ºä½ æä¾›å®è´µçš„è§è§£ã€‚

::: tip
çª—å£æœºåˆ¶å’Œæ—¶é—´è¯­ä¹‰æ˜¯ç†è§£æµå¤„ç†çš„å…³é”®ï¼Œå®ƒä»¬å†³å®šäº†æ•°æ®å¦‚ä½•è¢«åˆ†ç»„ã€å¤„ç†ä»¥åŠæ—¶é—´å¦‚ä½•è¢«å®šä¹‰å’Œè®¡ç®—ã€‚
:::

## æ—¶é—´è¯­ä¹‰ï¼šæµå¤„ç†çš„åŸºçŸ³

åœ¨æ·±å…¥çª—å£æœºåˆ¶ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»å…ˆç†è§£Flinkä¸­çš„æ—¶é—´è¯­ä¹‰ã€‚Flinkæ”¯æŒä¸‰ç§æ—¶é—´è¯­ä¹‰ï¼Œæ¯ç§éƒ½æœ‰å…¶ç‰¹å®šçš„åº”ç”¨åœºæ™¯ã€‚

### 1. å¤„ç†æ—¶é—´ (Processing Time)

å¤„ç†æ—¶é—´æ˜¯æŒ‡äº‹ä»¶è¢«Flinkç³»ç»Ÿå¤„ç†çš„æ—¶é—´ã€‚è¿™æ˜¯æœ€ç®€å•çš„æ—¶é—´è¯­ä¹‰ï¼Œå› ä¸ºå®ƒä¸éœ€è¦åè°ƒäº‹ä»¶å’Œæ—¶é’Ÿã€‚

```java
// ä½¿ç”¨å¤„ç†æ—¶é—´
DataStream<Tuple2<String, Integer>> counts = 
    text.flatMap(new Splitter())
        .keyBy(value -> value.f0)
        .window(TumblingEventTimeWindows.of(Time.seconds(5))) // é”™è¯¯ç¤ºä¾‹ï¼Œåº”è¯¥ç”¨ProcessingTimeWindows
        .sum(1);
```

**ä¼˜ç‚¹**ï¼š
- å®ç°ç®€å•
- ä¿è¯ç»“æœä¸å¤„ç†é€Ÿåº¦ä¸€è‡´
- ä¸éœ€è¦ç­‰å¾…äº‹ä»¶æ—¶é—´æˆ³

**ç¼ºç‚¹**ï¼š
- ç»“æœå¯èƒ½ä¸å‡†ç¡®ï¼ˆä¹±åºäº‹ä»¶å½±å“ï¼‰
- æ— æ³•ä¿è¯ç¡®å®šæ€§ç»“æœ

### 2. äº‹ä»¶æ—¶é—´ (Event Time)

äº‹ä»¶æ—¶é—´æ˜¯æŒ‡äº‹ä»¶å®é™…å‘ç”Ÿçš„æ—¶é—´ã€‚è¿™é€šå¸¸åµŒå…¥åœ¨äº‹ä»¶æ•°æ®ä¸­ï¼Œå¦‚æ—¶é—´æˆ³æˆ–æ—¥å¿—è®°å½•çš„æ—¶é—´ã€‚

```java
// ä½¿ç”¨äº‹ä»¶æ—¶é—´
DataStream<Tuple2<String, Integer>> counts = 
    text.flatMap(new Splitter())
        .assignTimestampsAndWatermarks(new BoundedOutOfOrdernessTimestampExtractor<Tuple2<String, Integer>>(Time.seconds(5)) {
            @Override
            public long extractTimestamp(Tuple2<String, Integer> element) {
                return element.f1; // å‡è®¾æ—¶é—´æˆ³åœ¨ç¬¬äºŒä¸ªå­—æ®µ
            }
        })
        .keyBy(value -> value.f0)
        .window(TumblingEventTimeWindows.of(Time.seconds(5)))
        .sum(1);
```

**ä¼˜ç‚¹**ï¼š
- ç»“æœå‡†ç¡®ä¸”ä¸€è‡´
- èƒ½å¤Ÿå¤„ç†ä¹±åºäº‹ä»¶
- é€‚åˆéœ€è¦ç²¾ç¡®ç»“æœçš„åº”ç”¨

**ç¼ºç‚¹**ï¼š
- å®ç°å¤æ‚
- éœ€è¦ç­‰å¾…å»¶è¿Ÿäº‹ä»¶
- å¯èƒ½å¢åŠ å»¶è¿Ÿ

### 3. æ‘„å…¥æ—¶é—´ (Ingestion Time)

æ‘„å…¥æ—¶é—´ä»‹äºå¤„ç†æ—¶é—´å’Œäº‹ä»¶æ—¶é—´ä¹‹é—´ï¼Œæ˜¯äº‹ä»¶è¿›å…¥Flinkç³»ç»Ÿçš„æ—¶é—´ã€‚

```java
// ä½¿ç”¨æ‘„å…¥æ—¶é—´
DataStream<Tuple2<String, Integer>> counts = 
    text.flatMap(new Splitter())
        .assignTimestampsAndWatermarks(new AscendingTimestampExtractor<Tuple2<String, Integer>>() {
            @Override
            public long extractAscendingTimestamp(Tuple2<String, Integer> element) {
                return System.currentTimeMillis(); // ä½¿ç”¨ç³»ç»Ÿæ—¶é—´ä½œä¸ºæ‘„å…¥æ—¶é—´
            }
        })
        .keyBy(value -> value.f0)
        .window(TumblingEventTimeWindows.of(Time.seconds(5))) // æ³¨æ„ï¼šè¿™é‡Œåº”è¯¥ç”¨ProcessingTimeWindows
        .sum(1);
```

**ä¼˜ç‚¹**ï¼š
- æ¯”äº‹ä»¶æ—¶é—´ç®€å•
- æ¯”å¤„ç†æ—¶é—´å‡†ç¡®
- ä¸éœ€è¦ç­‰å¾…äº‹ä»¶æ—¶é—´æˆ³

**ç¼ºç‚¹**ï¼š
- ç»“æœå¯èƒ½å—ä¹±åºäº‹ä»¶å½±å“
- æ¯”çº¯å¤„ç†æ—¶é—´ç¨å¤æ‚

## çª—å£æœºåˆ¶ï¼šåˆ†ç»„å¤„ç†çš„è‰ºæœ¯

çª—å£æœºåˆ¶æ˜¯Flinkä¸­å¤„ç†æ— é™æµæ•°æ®çš„æ ¸å¿ƒæ–¹æ³•ã€‚å®ƒå…è®¸æˆ‘ä»¬å°†æ— é™æ•°æ®æµåˆ’åˆ†ä¸ºæœ‰é™å¤§å°çš„"æ¡¶"ï¼Œä»¥ä¾¿è¿›è¡Œæœ‰ç•Œè®¡ç®—ã€‚

### 1. çª—å£ç±»å‹

#### æ»šåŠ¨çª—å£ (Tumbling Windows)

æ»šåŠ¨çª—å£æœ‰å›ºå®šçš„å¤§å°ä¸”ä¸é‡å ï¼Œæ¯ä¸ªæ•°æ®ç‚¹åªå±äºä¸€ä¸ªçª—å£ã€‚

```java
// 5ç§’çš„æ»šåŠ¨çª—å£
.window(TumblingEventTimeWindows.of(Time.seconds(5)))
```

![æ»šåŠ¨çª—å£ç¤ºæ„å›¾](/images/flink/tumbling-windows.png)

#### æ»‘åŠ¨çª—å£ (Sliding Windows)

æ»‘åŠ¨çª—å£æœ‰å›ºå®šçš„å¤§å°ä¸”å¯ä»¥é‡å ï¼Œæ•°æ®ç‚¹å¯èƒ½å±äºå¤šä¸ªçª—å£ã€‚

```java
// 5ç§’å¤§å°ï¼Œ1ç§’æ»‘åŠ¨é—´éš”çš„æ»‘åŠ¨çª—å£
.window(SlidingEventTimeWindows.of(Time.seconds(5), Time.seconds(1)))
```

![æ»‘åŠ¨çª—å£ç¤ºæ„å›¾](/images/flink/sliding-windows.png)

#### ä¼šè¯çª—å£ (Session Windows)

ä¼šè¯çª—å£æ ¹æ®æ•°æ®çš„æ´»åŠ¨æ€§åˆ’åˆ†ï¼Œå½“ä¸€æ®µæ—¶é—´æ²¡æœ‰æ•°æ®åˆ°è¾¾æ—¶ï¼Œçª—å£å…³é—­ã€‚

```java
// 10ç§’é—´éš”çš„ä¼šè¯çª—å£
.window(EventTimeSessionWindows.withGap(Time.seconds(10)))
```

![ä¼šè¯çª—å£ç¤ºæ„å›¾](/images/flink/session-windows.png)

#### å…¨å±€çª—å£ (Global Windows)

å…¨å±€çª—å£å°†æ‰€æœ‰æ•°æ®åˆ†é…åˆ°ä¸€ä¸ªçª—å£ä¸­ï¼Œé€šå¸¸éœ€è¦è‡ªå®šä¹‰è§¦å‘å™¨æ¥è®¡ç®—ç»“æœã€‚

```java
// å…¨å±€çª—å£
.window(GlobalWindows.create())
```

### 2. çª—å£å‡½æ•°

çª—å£å‡½æ•°å®šä¹‰äº†å¦‚ä½•å¤„ç†çª—å£ä¸­çš„æ•°æ®ã€‚Flinkæä¾›äº†å‡ ç§çª—å£å‡½æ•°ï¼š

#### çª—å£èšåˆå‡½æ•° (Window Aggregation)

```java
// ç®€å•èšåˆ
.keyBy(value -> value.f0)
.window(TumblingEventTimeWindows.of(Time.seconds(5)))
.sum(1); // è®¡æ•°

// å¤æ‚èšåˆ
.keyBy(value -> value.f0)
.window(TumblingEventTimeWindows.of(Time.seconds(5)))
.reduce(new ReduceFunction<Tuple2<String, Integer>>() {
    @Override
    public Tuple2<String, Integer> reduce(Tuple2<String, Integer> value1, Tuple2<String, Integer> value2) throws Exception {
        return new Tuple2<>(value1.f0, value1.f1 + value2.f1);
    }
});
```

#### çª—å£åº”ç”¨å‡½æ•° (Window Apply Function)

```java
// åº”ç”¨å‡½æ•°
.keyBy(value -> value.f0)
.window(TumblingEventTimeWindows.of(Time.seconds(5)))
.apply(new WindowFunction<Tuple2<String, Integer>, String, String, TimeWindow>() {
    @Override
    public void apply(String key, TimeWindow window, Iterable<Tuple2<String, Integer>> input, Collector<String> out) throws Exception {
        int sum = 0;
        for (Tuple2<String, Integer> tuple : input) {
            sum += tuple.f1;
        }
        out.collect("Window " + window + " for key " + key + " has sum " + sum);
    }
});
```

#### çª—å£å¤„ç†å‡½æ•° (Window Process Function)

```java
// å¤„ç†å‡½æ•°
.keyBy(value -> value.f0)
.window(TumblingEventTimeWindows.of(Time.seconds(5)))
.process(new ProcessWindowFunction<Tuple2<String, Integer>, String, String, TimeWindow>() {
    @Override
    public void process(String key, Context context, Iterable<Tuple2<String, Integer>> elements, Collector<String> out) throws Exception {
        int sum = 0;
        for (Tuple2<String, Integer> tuple : elements) {
            sum += tuple.f1;
        }
        long start = context.window().getStart();
        long end = context.window().getEnd();
        out.collect("Key: " + key + " Window: [" + start + " - " + end + ") Sum: " + sum);
    }
});
```

### 3. æ°´å°æœºåˆ¶ (Watermarks)

æ°´å°æ˜¯å¤„ç†äº‹ä»¶æ—¶é—´å»¶è¿Ÿçš„å…³é”®æœºåˆ¶ã€‚å®ƒè¡¨ç¤ºäº‹ä»¶æ—¶é—´è¿›åº¦çš„ä¸‹é™ï¼Œå¸®åŠ©Flinkå¤„ç†ä¹±åºäº‹ä»¶ã€‚

```java
// ç”Ÿæˆæ°´å°
DataStream<Tuple2<String, Integer>> stream = ...;
stream.assignTimestampsAndWatermarks(
    new WatermarkStrategy<Tuple2<String, Integer>>() {
        @Override
        public WatermarkGenerator<Tuple2<String, Integer>> createWatermarkGenerator(WatermarkGeneratorSupplier.Context context) {
            return new BoundedOutOfOrdernessWatermarks<>(Time.seconds(5));
        }
        
        @Override
        public TimestampAssigner<Tuple2<String, Integer>> createTimestampAssigner(TimestampAssignerSupplier.Context context) {
            return (element, timestamp) -> element.f1; // å‡è®¾æ—¶é—´æˆ³åœ¨ç¬¬äºŒä¸ªå­—æ®µ
        }
    }
);
```

## å®æˆ˜æ¡ˆä¾‹ï¼šç½‘ç«™æµé‡åˆ†æ

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç½‘ç«™æµé‡åˆ†æçš„æ¡ˆä¾‹ï¼Œç»¼åˆè¿ç”¨æ—¶é—´è¯­ä¹‰å’Œçª—å£æœºåˆ¶ã€‚

### åœºæ™¯æè¿°

æˆ‘ä»¬éœ€è¦åˆ†æç½‘ç«™çš„ç”¨æˆ·è®¿é—®é‡ï¼ŒæŒ‰å°æ—¶ç»Ÿè®¡æ¯åˆ†é’Ÿçš„ç‹¬ç«‹è®¿å®¢æ•°ï¼ˆUVï¼‰å’Œé¡µé¢æµè§ˆé‡ï¼ˆPVï¼‰ã€‚

### å®ç°æ­¥éª¤

```java
// 1. å®šä¹‰æ•°æ®æº
DataStream<PageViewEvent> pageViewEvents = env.addSource(new PageViewSource());

// 2. åˆ†é…æ—¶é—´æˆ³å’Œæ°´å°
DataStream<PageViewEvent> eventsWithTimestamps = pageViewEvents
    .assignTimestampsAndWatermarks(
        WatermarkStrategy.<PageViewEvent>forBoundedOutOfOrderness(Duration.ofSeconds(5))
            .withTimestampAssigner((event, timestamp) -> event.getTimestamp())
    );

// 3. å®šä¹‰çª—å£å’Œè®¡ç®—
DataStream<PageViewStats> stats = eventsWithTimestamps
    .keyBy(PageViewEvent::getUserId)
    .window(TumblingEventTimeWindows.of(Time.minutes(1)))
    .aggregate(
        new PageViewStatsAggregator(), // èšåˆå‡½æ•°
        new PageViewStatsWindowFunction() // çª—å£å‡½æ•°
    );

// 4. è¾“å‡ºç»“æœ
stats.print();
```

### èšåˆå‡½æ•°å®ç°

```java
public static class PageViewStatsAggregator implements AggregateFunction<PageViewEvent, PageViewStats, PageViewStats> {
    @Override
    public PageViewStats createAccumulator() {
        return new PageViewStats("", 0L, 0, 0);
    }

    @Override
    public PageViewStats add(PageViewEvent event, PageViewStats acc) {
        acc.userId = event.getUserId();
        acc.windowStart = event.getTimestamp();
        acc.pvCount += 1;
        acc.lastPageViewTime = event.getTimestamp();
        return acc;
    }

    @Override
    public PageViewStats getResult(PageViewStats acc) {
        return acc;
    }

    @Override
    public PageViewStats merge(PageViewStats a, PageViewStats b) {
        return new PageViewStats(
            a.userId,
            a.windowStart,
            a.pvCount + b.pvCount,
            Math.max(a.lastPageViewTime, b.lastPageViewTime)
        );
    }
}
```

### çª—å£å‡½æ•°å®ç°

```java
public static class PageViewStatsWindowFunction extends ProcessWindowFunction<PageViewStats, PageViewStats, String, TimeWindow> {
    @Override
    public void process(String userId, Context context, Iterable<PageViewStats> stats, Collector<PageViewStats> out) throws Exception {
        PageViewStats finalStats = stats.iterator().next();
        finalStats.windowEnd = context.window().getEnd();
        finalStats.windowStart = context.window().getStart();
        out.collect(finalStats);
    }
}
```

## æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ

### 1. çª—å£å¤§å°é€‰æ‹©

é€‰æ‹©åˆé€‚çš„çª—å£å¤§å°å¯¹æ€§èƒ½è‡³å…³é‡è¦ï¼š
- å¤ªå°çš„çª—å£ä¼šå¢åŠ ç³»ç»Ÿå¼€é”€
- å¤ªå¤§çš„çª—å£å¯èƒ½å¯¼è‡´å†…å­˜å‹åŠ›

::: theorem
çª—å£å¤§å°åº”è¯¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚å’Œæ•°æ®ç‰¹æ€§æ¥é€‰æ‹©ã€‚å¯¹äºå®æ—¶æ€§è¦æ±‚é«˜çš„åœºæ™¯ï¼Œé€‰æ‹©è¾ƒå°çš„çª—å£ï¼›å¯¹äºåˆ†æå‹åœºæ™¯ï¼Œå¯ä»¥é€‰æ‹©è¾ƒå¤§çš„çª—å£ã€‚
:::

### 2. æ°´å°ç­–ç•¥

åˆç†çš„æ°´å°ç­–ç•¥å¯ä»¥å¹³è¡¡å‡†ç¡®æ€§å’Œå»¶è¿Ÿï¼š
- ä¿å®ˆçš„æ°´å°ç­–ç•¥ï¼ˆå¦‚å°å»¶è¿Ÿï¼‰å¯ä»¥æé«˜å‡†ç¡®æ€§
- æ¿€è¿›çš„æ°´å°ç­–ç•¥ï¼ˆå¦‚å¤§å»¶è¿Ÿï¼‰å¯ä»¥å‡å°‘å»¶è¿Ÿ

```java
// æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹è°ƒæ•´æ°´å°å»¶è¿Ÿ
.assignTimestampsAndWatermarks(
    WatermarkStrategy.<PageViewEvent>forBoundedOutOfOrderness(Duration.ofSeconds(30)) // 30ç§’å»¶è¿Ÿ
        .withTimestampAssigner((event, timestamp) -> event.getTimestamp())
)
```

### 3. çŠ¶æ€ç®¡ç†

å¯¹äºçª—å£æ“ä½œï¼Œåˆç†çš„çŠ¶æ€ç®¡ç†å¯ä»¥æé«˜æ€§èƒ½ï¼š

```java
// å¯ç”¨å¢é‡èšåˆ
.keyBy(PageViewEvent::getUserId)
.window(TumblingEventTimeWindows.of(Time.minutes(1)))
.aggregate(
    new PageViewStatsAggregator(),
    new PageViewStatsWindowFunction(),
    TypeInformation.of(PageViewStats.class)
);
```

## ç»“è¯­

çª—å£æœºåˆ¶å’Œæ—¶é—´è¯­ä¹‰æ˜¯Flinkæµå¤„ç†çš„ä¸¤å¤§æ”¯æŸ±ï¼Œå®ƒä»¬å…±åŒæ„æˆäº†å¤„ç†æ— é™æ•°æ®æµçš„åŸºç¡€ã€‚ç†è§£è¿™äº›æ¦‚å¿µå¯¹äºæ„å»ºé«˜æ•ˆã€å‡†ç¡®çš„æµå¤„ç†åº”ç”¨è‡³å…³é‡è¦ã€‚

é€šè¿‡æœ¬æ–‡çš„ä»‹ç»ï¼Œæˆ‘ä»¬äº†è§£äº†Flinkä¸­çš„ä¸‰ç§æ—¶é—´è¯­ä¹‰ï¼ˆå¤„ç†æ—¶é—´ã€äº‹ä»¶æ—¶é—´ã€æ‘„å…¥æ—¶é—´ï¼‰ä»¥åŠå„ç§çª—å£ç±»å‹ï¼ˆæ»šåŠ¨çª—å£ã€æ»‘åŠ¨çª—å£ã€ä¼šè¯çª—å£ã€å…¨å±€çª—å£ï¼‰ã€‚æˆ‘ä»¬è¿˜é€šè¿‡ä¸€ä¸ªå®é™…çš„ç½‘ç«™æµé‡åˆ†ææ¡ˆä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•å°†è¿™äº›æ¦‚å¿µåº”ç”¨åˆ°å®é™…å¼€å‘ä¸­ã€‚

> åœ¨æµå¤„ç†çš„ä¸–ç•Œä¸­ï¼Œæ—¶é—´æ˜¯æœ€å®è´µçš„èµ„æºï¼Œè€Œçª—å£åˆ™æ˜¯æˆ‘ä»¬é©¾é©­æ—¶é—´æµçš„å·¥å…·ã€‚æŒæ¡Flinkçš„çª—å£æœºåˆ¶å’Œæ—¶é—´è¯­ä¹‰ï¼Œä½ å°†èƒ½å¤Ÿæ„å»ºå‡ºæ—¢å‡†ç¡®åˆé«˜æ•ˆçš„æµå¤„ç†åº”ç”¨ã€‚

å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¤Ÿå¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£Flinkçš„æ ¸å¿ƒæ¦‚å¿µã€‚å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºç•™è¨€äº¤æµï¼ğŸ¤

::: right
"åœ¨æµå¤„ç†ä¸­ï¼Œæ—¶é—´ä¸ä»…æ˜¯æ¦‚å¿µï¼Œæ›´æ˜¯æŒ‘æˆ˜ã€‚"
:::