---
title: Flink SQLä¸Table API - ç»“æ„åŒ–æ•°æ®å¤„ç†çš„æ–°èŒƒå¼
date: 2023-11-15 14:30:00
categories: 
  - å¤§æ•°æ®
tags:
  - Flink
  - SQL
  - Table API
  - ç»“æ„åŒ–æ•°æ®å¤„ç†
author: 
  name: Jorgen
  link: https://github.com/jorgen-zhao
---

## å‰è¨€

ä½œä¸ºä¸€åå¤§æ•°æ®å¼€å‘è€…ï¼Œæˆ‘ä¸€ç›´åœ¨å¯»æ‰¾èƒ½å¤Ÿç®€åŒ–æ•°æ®å¤„ç†æµç¨‹çš„å·¥å…·å’Œæ–¹æ³•ã€‚Flinkä½œä¸ºæµå¤„ç†çš„é¢†å†›æ¡†æ¶ï¼Œä¸ä»…æä¾›äº†å¼ºå¤§çš„æµå¤„ç†èƒ½åŠ›ï¼Œè¿˜é€šè¿‡SQLå’ŒTable APIä¸ºå¼€å‘è€…å¸¦æ¥äº†å£°æ˜å¼ç¼–ç¨‹çš„ä¾¿åˆ©ã€‚ä»Šå¤©ï¼Œæˆ‘æƒ³å’Œå¤§å®¶ä¸€èµ·æ¢ç´¢Flink SQLä¸Table APIçš„é­…åŠ›ï¼Œçœ‹çœ‹å®ƒä»¬å¦‚ä½•æ”¹å˜æˆ‘ä»¬å¤„ç†ç»“æ„åŒ–æ•°æ®çš„æ–¹å¼ã€‚

::: tip
"SQLæ˜¯æ•°æ®å¤„ç†çš„é€šç”¨è¯­è¨€ï¼Œè€ŒFlink SQLå°†è¿™ç§é€šç”¨æ€§ä¸æµå¤„ç†çš„å¼ºå¤§èƒ½åŠ›å®Œç¾ç»“åˆã€‚"
:::

åœ¨æ·±å…¥æ¢è®¨ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆæ˜ç¡®ä¸€ä¸‹ä»€ä¹ˆæ˜¯Flink SQLå’ŒTable APIï¼š

- **Flink SQL**ï¼šFlinkçš„SQLå®ç°ï¼Œå…è®¸ç”¨æˆ·ä½¿ç”¨æ ‡å‡†SQLæŸ¥è¯¢æµæ•°æ®å’Œæ‰¹æ•°æ®
- **Table API**ï¼šä¸€ç§ç±»å‹åŒ–çš„å…³ç³»å‹APIï¼Œå¯ä»¥é€šè¿‡ç±»ä¼¼äºSQLçš„å£°æ˜å¼æŸ¥è¯¢æ¥æ“ä½œæ•°æ®

## ä¸ºä»€ä¹ˆéœ€è¦Flink SQLä¸Table APIï¼Ÿ

åœ¨æ¥è§¦Flink SQLä¹‹å‰ï¼Œæˆ‘ä¸»è¦ä½¿ç”¨DataStream APIè¿›è¡Œå¼€å‘ã€‚è™½ç„¶åŠŸèƒ½å¼ºå¤§ï¼Œä½†ç¼–å†™å’Œç»´æŠ¤å¤æ‚çš„è½¬æ¢é€»è¾‘ç¡®å®æœ‰äº›ç¹çã€‚ğŸ¤”

### ä¼ ç»ŸDataStream APIçš„æŒ‘æˆ˜

```java
DataStream<Tuple2<String, Integer>> wordCounts = env
    .fromElements("hello world", "hello flink", "hello big data")
    .flatMap(new Splitter())
    .keyBy(0)
    .window(TumblingProcessingTimeWindows.of(Time.seconds(5)))
    .sum(1);
```

ä½¿ç”¨DataStream APIæ—¶ï¼Œæˆ‘ä»¬éœ€è¦ï¼š
1. æ˜ç¡®æŒ‡å®šæ•°æ®ç±»å‹ï¼ˆå¦‚Tuple2ï¼‰
2. æ‰‹åŠ¨å®ç°è½¬æ¢é€»è¾‘
3. å¤„ç†çª—å£æ“ä½œç­‰åº•å±‚ç»†èŠ‚

### Flink SQLçš„ç®€æ´æ€§

ç›¸æ¯”ä¹‹ä¸‹ï¼Œä½¿ç”¨Flink SQLå®ç°ç›¸åŒåŠŸèƒ½åªéœ€å‡ è¡Œä»£ç ï¼š

```sql
-- åˆ›å»ºè¡¨
CREATE TABLE words (
  word STRING,
  count INT
) WITH (
  'connector' = 'datagen',
  'rows-per-second' = '1'
);

-- æ‰§è¡ŒæŸ¥è¯¢
SELECT word, COUNT(*) as count
FROM TABLE(HOP(TABLE(words), DESCRIPTOR(rowtime), INTERVAL '5' SECOND, INTERVAL '5' SECOND))
GROUP BY word;
```

çœ‹åˆ°è¿™æ ·çš„å¯¹æ¯”ï¼Œæˆ‘ä¸ç¦æ„Ÿå¹ï¼šSQLç¡®å®è®©æ•°æ®å¤„ç†å˜å¾—æ›´åŠ ç›´è§‚å’Œç®€æ´ï¼ğŸ˜„

## Flink SQLåŸºç¡€

### åˆ›å»ºè¡¨

åœ¨Flinkä¸­ï¼Œä¸€åˆ‡éƒ½æ˜¯"è¡¨"ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼åˆ›å»ºè¡¨ï¼š

#### 1. ä»DataStreamåˆ›å»ºè¡¨

```java
// åˆ›å»ºDataStream
DataStream<Event> eventStream = env.addSource(new FlinkKafkaConsumer<>(
  "events",
  new EventDeserializer(),
  properties
));

// å°†DataStreamè½¬æ¢ä¸ºTable
Table eventTable = tableEnv.fromDataStream(eventStream);
```

#### 2. é€šè¿‡DDLåˆ›å»ºè¡¨

```java
String ddl = "CREATE TABLE events (" +
  "id BIGINT," +
  "user_id STRING," +
  "event_time TIMESTAMP(3)," +
  "event_type STRING" +
  ") WITH (" +
  "'connector' = 'kafka'," +
  "'topic' = 'events'," +
  "'properties.bootstrap.servers' = 'localhost:9092'," +
  "'format' = 'json'" +
  ")";

tableEnv.executeSql(ddl);
```

### æ‰§è¡ŒSQLæŸ¥è¯¢

```java
// æ‰§è¡ŒæŸ¥è¯¢
Table result = tableEnv.sqlQuery(
  "SELECT event_type, COUNT(*) as count " +
  "FROM events " +
  "GROUP BY event_type"
);

// å°†ç»“æœè½¬æ¢ä¸ºDataStream
DataStream<Row> resultStream = tableEnv.toDataStream(result);
```

## Table APIè¯¦è§£

Table APIæ˜¯Flinkæä¾›çš„å¦ä¸€ç§å£°æ˜å¼APIï¼Œå®ƒç»“åˆäº†SQLçš„å£°æ˜å¼ç‰¹æ€§å’Œç¼–ç¨‹å¼APIçš„çµæ´»æ€§ã€‚

### åŸºæœ¬æ“ä½œ

```java
// åˆ›å»ºè¡¨
Table orders = tableEnv.fromDataStream(orderStream);

// æ‰§è¡Œè½¬æ¢
Table result = orders
    .filter($("amount").isNotNull())
    .filter($("status").isEqual("COMPLETED"))
    .groupBy($("product"))
    .select($("product"), $("amount").sum().as("total_amount"));
```

è¿™é‡Œ `$()` æ˜¯åˆ—å¼•ç”¨çš„ç®€å†™æ–¹å¼ï¼Œä½¿å¾—ä»£ç æ›´åŠ ç®€æ´ã€‚

### å¸¸ç”¨æ“ä½œ

Table APIæä¾›äº†ä¸°å¯Œçš„æ“ä½œæ–¹æ³•ï¼š

| æ“ä½œç±»å‹ | æ–¹æ³•ç¤ºä¾‹ | æè¿° |
|---------|---------|------|
| è¿‡æ»¤ | `.filter($("age").isGreaterThan(18))` | ç­›é€‰ç¬¦åˆæ¡ä»¶çš„è¡Œ |
| æŠ•å½± | `.select($("name"), $("age"))` | é€‰æ‹©ç‰¹å®šåˆ— |
| èšåˆ | `.groupBy($("department")).select($("department"), $("salary").avg())` | æŒ‰ç»„èšåˆ |
| æ’åº | `.orderBy($("age").desc())` | æ’åºç»“æœ |
| è¿æ¥ | `.join(secondTable, $("id").isEqual($("foreign_id")))` | è¿æ¥ä¸¤ä¸ªè¡¨ |

### çª—å£æ“ä½œ

Table APIç®€åŒ–äº†çª—å£æ“ä½œï¼š

```java
// å®šä¹‰æ—¶é—´å±æ€§
Table orders = tableEnv.fromDataStream(orderStream, 
  $("order_time").as("order_time").rowtime());

// çª—å£èšåˆ
Table result = orders
    .window(Hop.over("1 hour").on("order_time").every("30 minutes"))
    .groupBy($("product"), $("window_start"), $("window_end"))
    .select($("product"), $("window_start"), $("window_end"), $("amount").sum());
```

## å®é™…åº”ç”¨æ¡ˆä¾‹

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®é™…æ¡ˆä¾‹æ¥å±•ç¤ºFlink SQLçš„å¨åŠ›ï¼šå®æ—¶ç”µå•†ç”¨æˆ·è¡Œä¸ºåˆ†æã€‚

### åœºæ™¯æè¿°

æˆ‘ä»¬éœ€è¦åˆ†æç”µå•†ç½‘ç«™çš„ç”¨æˆ·è¡Œä¸ºæ•°æ®ï¼ŒåŒ…æ‹¬ï¼š
- é¡µé¢æµè§ˆ
- å•†å“ç‚¹å‡»
- åŠ å…¥è´­ç‰©è½¦
- ä¸‹å•è´­ä¹°

### æ•°æ®æ¨¡å‹

```sql
-- ç”¨æˆ·è¡Œä¸ºè¡¨
CREATE TABLE user_actions (
  user_id STRING,
  action_time TIMESTAMP(3),
  action_type STRING, -- 'PAGE_VIEW', 'CLICK', 'ADD_TO_CART', 'PURCHASE'
  product_id STRING,
  category STRING,
  properties STRING, -- JSONæ ¼å¼å­˜å‚¨é¢å¤–å±æ€§
  WATERMARK FOR action_time AS action_time - INTERVAL '5' SECOND
) WITH (
  'connector' = 'kafka',
  'topic' = 'user_actions',
  'properties.bootstrap.servers' = 'localhost:9092',
  'format' = 'json'
);
```

### å®æ—¶åˆ†ææŸ¥è¯¢

#### 1. å®æ—¶çƒ­é—¨å•†å“

```sql
-- æœ€è¿‘10åˆ†é’Ÿå†…çš„çƒ­é—¨å•†å“
SELECT 
  product_id,
  category,
  COUNT(*) as view_count
FROM user_actions
WHERE action_type = 'PAGE_VIEW'
  AND action_time >= NOW() - INTERVAL '10' MINUTE
GROUP BY product_id, category
ORDER BY view_count DESC
LIMIT 10;
```

#### 2. è½¬åŒ–æ¼æ–—åˆ†æ

```sql
-- ç”¨æˆ·è¡Œä¸ºè½¬åŒ–æ¼æ–—
WITH funnel AS (
  SELECT 
    user_id,
    MAX(CASE WHEN action_type = 'PAGE_VIEW' THEN 1 ELSE 0 END) as page_view,
    MAX(CASE WHEN action_type = 'CLICK' THEN 1 ELSE 0 END) as click,
    MAX(CASE WHEN action_type = 'ADD_TO_CART' THEN 1 ELSE 0 END) as add_to_cart,
    MAX(CASE WHEN action_type = 'PURCHASE' THEN 1 ELSE 0 END) as purchase
  FROM user_actions
  WHERE action_time >= NOW() - INTERVAL '1' HOUR
  GROUP BY user_id
)
SELECT 
  SUM(page_view) as total_page_views,
  SUM(click) as total_clicks,
  SUM(add_to_cart) as total_add_to_carts,
  SUM(purchase) as total_purchases,
  SUM(click) / SUM(page_view) * 100 as click_rate,
  SUM(add_to_cart) / SUM(click) * 100 as add_to_cart_rate,
  SUM(purchase) / SUM(add_to_cart) * 100 as purchase_rate
FROM funnel;
```

#### 3. å®æ—¶ç”¨æˆ·æ´»è·ƒåº¦

```sql
-- å®æ—¶è®¡ç®—ç”¨æˆ·æ´»è·ƒåº¦
SELECT 
  user_id,
  COUNT(*) as action_count,
  COUNT(DISTINCT product_id) as viewed_products,
  MAX(action_time) as last_action_time
FROM user_actions
GROUP BY user_id, TUMBLE(action_time, INTERVAL '5' MINUTE)
ORDER BY last_action_time DESC;
```

è¿™äº›æŸ¥è¯¢å±•ç¤ºäº†Flink SQLåœ¨å®æ—¶åˆ†æä¸­çš„å¼ºå¤§èƒ½åŠ›ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿä»¥å£°æ˜å¼çš„æ–¹å¼å®ç°å¤æ‚çš„å®æ—¶è®¡ç®—é€»è¾‘ã€‚

## æ€§èƒ½ä¼˜åŒ–

åœ¨ä½¿ç”¨Flink SQLæ—¶ï¼Œäº†è§£ä¸€äº›æ€§èƒ½ä¼˜åŒ–æŠ€å·§éå¸¸é‡è¦ï¼š

### 1. åˆç†ä½¿ç”¨åˆ†åŒº

```sql
-- æŒ‰ç”¨æˆ·IDåˆ†åŒºï¼Œæé«˜å¹¶è¡Œåº¦
CREATE TABLE user_actions (
  -- åˆ—å®šä¹‰...
) PARTITIONED BY (user_id) WITH (
  -- å…¶ä»–é…ç½®...
);
```

### 2. è°ƒæ•´å¹¶è¡Œåº¦

```java
// è®¾ç½®è¡¨çš„å¹¶è¡Œåº¦
tableConfig.set("table.exec.mini-batch.enabled", "true");
tableConfig.set("table.exec.mini-batch.allow-latency", "1s");
tableConfig.set("table.exec.mini-batch.size", "1000");
```

### 3. ä½¿ç”¨çŠ¶æ€åç«¯

```sql
-- é…ç½®çŠ¶æ€åç«¯
SET 'state.backend' = 'rocksdb';
SET 'state.backend.rocksdb.localdir' = '/tmp/flink/rocksdb';
```

## ç»“è¯­

é€šè¿‡ä»Šå¤©çš„æ¢ç´¢ï¼Œæˆ‘ä»¬ä¸€èµ·äº†è§£äº†Flink SQLä¸Table APIçš„é­…åŠ›ã€‚ä½œä¸ºå¤§æ•°æ®å¼€å‘è€…ï¼Œæˆ‘è®¤ä¸ºæŒæ¡è¿™äº›å·¥å…·ä¸ä»…èƒ½æé«˜æˆ‘ä»¬çš„å¼€å‘æ•ˆç‡ï¼Œè¿˜èƒ½è®©æˆ‘ä»¬ä»¥æ›´ç›´è§‚çš„æ–¹å¼æ€è€ƒæ•°æ®å¤„ç†é—®é¢˜ã€‚

Flink SQLå’ŒTable APIæ˜¯ç°ä»£æ•°æ®å¤„ç†çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå®ƒä»¬å°†å£°æ˜å¼ç¼–ç¨‹çš„ä¾¿åˆ©æ€§ä¸æµå¤„ç†çš„å¼ºå¤§èƒ½åŠ›å®Œç¾ç»“åˆã€‚æ— è®ºä½ æ˜¯SQLä¸“å®¶è¿˜æ˜¯Javaå¼€å‘è€…ï¼Œéƒ½èƒ½æ‰¾åˆ°é€‚åˆè‡ªå·±çš„æ–¹å¼æ¥ä½¿ç”¨è¿™äº›å·¥å…·ã€‚

::: right
"SQLè®©å¤æ‚çš„æ•°æ®å¤„ç†å˜å¾—ç®€å•ï¼Œè€ŒFlinkè®©SQLå˜å¾—å¼ºå¤§ã€‚"
::>

å¦‚æœä½ è¿˜æ²¡æœ‰å°è¯•è¿‡Flink SQLï¼Œæˆ‘å¼ºçƒˆå»ºè®®ä½ ä»ä»Šå¤©å¼€å§‹æ¢ç´¢è¿™ä¸ªå¼ºå¤§çš„å·¥å…·ã€‚ç›¸ä¿¡æˆ‘ï¼Œä¸€æ—¦ä½ å¼€å§‹ä½¿ç”¨å®ƒï¼Œå°±ä¼šçˆ±ä¸Šè¿™ç§ç®€æ´è€Œé«˜æ•ˆçš„æ•°æ®å¤„ç†æ–¹å¼ï¼ğŸš€

> åœ¨å¤§æ•°æ®çš„ä¸–ç•Œé‡Œï¼Œå·¥å…·åªæ˜¯æ‰‹æ®µï¼Œè§£å†³å®é™…é—®é¢˜æ‰æ˜¯æˆ‘ä»¬çš„ç›®æ ‡ã€‚Flink SQLä¸Table APIä¸ºæˆ‘ä»¬æä¾›äº†ä¸€æŠŠé”‹åˆ©çš„"ç‘å£«å†›åˆ€"ï¼Œä½†å¦‚ä½•ç”¨å¥½å®ƒï¼Œè¿˜éœ€è¦æˆ‘ä»¬åœ¨å®è·µä¸­ä¸æ–­æ¢ç´¢å’Œæ€»ç»“ã€‚