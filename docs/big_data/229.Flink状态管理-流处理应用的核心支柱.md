---
title: FlinkçŠ¶æ€ç®¡ç†-æµå¤„ç†åº”ç”¨çš„æ ¸å¿ƒæ”¯æŸ±
date: 2023-11-15 14:30:00
categories: 
  - å¤§æ•°æ®
tags:
  - Flink
  - çŠ¶æ€ç®¡ç†
  - æµå¤„ç†
author: 
  name: Jorgen
  link: https://github.com/jorgen-zhao
---

## å‰è¨€

åœ¨æ·±å…¥äº†è§£Flinkçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘å‘ç°å¾ˆå¤šåˆå­¦è€…å’Œæˆ‘ä¸€æ ·ï¼Œä¸€å¼€å§‹ä¼šè¿‡äºå…³æ³¨Flinkçš„APIå’Œæ“ä½œç¬¦ï¼Œè€Œå¿½ç•¥äº†å¦ä¸€ä¸ªè‡³å…³é‡è¦çš„æ¦‚å¿µâ€”â€”çŠ¶æ€ç®¡ç†ï¼ˆState Managementï¼‰ã€‚ğŸ¤”

å®é™…ä¸Šï¼ŒçŠ¶æ€ç®¡ç†æ˜¯æµå¤„ç†åº”ç”¨çš„æ ¸å¿ƒæ”¯æŸ±ï¼Œå®ƒèµ‹äºˆäº†Flinkå¤„ç†å¤æ‚ä¸šåŠ¡é€»è¾‘çš„èƒ½åŠ›ã€‚æ²¡æœ‰çŠ¶æ€ç®¡ç†ï¼Œæµå¤„ç†å°†å¤±å»å¤§éƒ¨åˆ†ä»·å€¼ã€‚ä»Šå¤©ï¼Œæˆ‘æƒ³å’Œå¤§å®¶ä¸€èµ·æ·±å…¥æ¢è®¨Flinkçš„çŠ¶æ€ç®¡ç†æœºåˆ¶ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•æ”¯æ’‘èµ·æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­çš„å„ç§å¤æ‚åœºæ™¯çš„ã€‚

::: tip
çŠ¶æ€ç®¡ç†æ˜¯åŒºåˆ†ç®€å•æµå¤„ç†å’Œå¤æ‚æµå¤„ç†åº”ç”¨çš„å…³é”®ã€‚å®ƒå…è®¸æˆ‘ä»¬åœ¨å¤„ç†æ•°æ®æµæ—¶ç»´æŠ¤å’Œè®¿é—®çŠ¶æ€ï¼Œä»è€Œå®ç°è®¡æ•°ã€èšåˆã€è¿æ¥ç­‰å¤æ‚æ“ä½œã€‚
:::

## FlinkçŠ¶æ€ç®¡ç†æ¦‚è¿°

åœ¨Flinkä¸­ï¼ŒçŠ¶æ€ï¼ˆStateï¼‰æ˜¯è®¡ç®—è¿‡ç¨‹ä¸­çš„æ•°æ®ï¼Œè¿™äº›æ•°æ®è¢«å­˜å‚¨å¹¶å¯ä»¥åœ¨åç»­æ“ä½œä¸­è¢«è®¿é—®ã€‚ä¸ä¼ ç»Ÿçš„æ‰¹å¤„ç†ä¸åŒï¼Œæµå¤„ç†ä¸­çš„çŠ¶æ€éœ€è¦è€ƒè™‘å®¹é”™æ€§å’Œä¸€è‡´æ€§ã€‚

### ä¸ºä»€ä¹ˆçŠ¶æ€ç®¡ç†å¦‚æ­¤é‡è¦ï¼Ÿ

æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ç»Ÿè®¡ç½‘ç«™è®¿é—®é‡ã€‚å¦‚æœæ²¡æœ‰çŠ¶æ€ç®¡ç†ï¼Œæˆ‘ä»¬æ¯æ¬¡åªèƒ½å¤„ç†å•ä¸ªäº‹ä»¶ï¼Œæ— æ³•ç´¯è®¡æ€»æ•°ã€‚æœ‰äº†çŠ¶æ€ç®¡ç†ï¼Œæˆ‘ä»¬å¯ä»¥ç»´æŠ¤ä¸€ä¸ªè®¡æ•°å™¨ï¼Œæ¯æ¬¡è®¿é—®æ—¶é€’å¢ï¼Œä»è€Œå¾—åˆ°å®æ—¶çš„è®¿é—®æ€»é‡ã€‚ğŸ“Š

### çŠ¶æ€çš„åŸºæœ¬ç±»å‹

Flinkä¸»è¦æ”¯æŒä¸¤ç§åŸºæœ¬çŠ¶æ€ç±»å‹ï¼š

1. **ValueState**ï¼šå­˜å‚¨å•ä¸ªå€¼çš„çŠ¶æ€
2. **ListState**ï¼šå­˜å‚¨ä¸€ä¸ªåˆ—è¡¨çš„çŠ¶æ€

é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ï¼š

- **MapState**ï¼šå­˜å‚¨é”®å€¼å¯¹æ˜ å°„çš„çŠ¶æ€
- **ReducingState**ï¼šå­˜å‚¨ä¸€ä¸ªå€¼ï¼Œå¹¶é€šè¿‡ç”¨æˆ·å®šä¹‰çš„reduceå‡½æ•°ä¸æ–­æ›´æ–°
- **AggregatingState**ï¼šå­˜å‚¨ä¸€ä¸ªå€¼ï¼Œå¹¶é€šè¿‡ç”¨æˆ·å®šä¹‰çš„aggregateå‡½æ•°ä¸æ–­æ›´æ–°

## çŠ¶æ€åç«¯ï¼ˆState Backendï¼‰

çŠ¶æ€å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿè¿™å°±æ˜¯çŠ¶æ€åç«¯ï¼ˆState Backendï¼‰çš„ä½œç”¨ã€‚Flinkæä¾›äº†ä¸‰ç§å†…ç½®çš„çŠ¶æ€åç«¯ï¼š

### 1. MemoryStateBackend

```java
StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
env.setStateBackend(new MemoryStateBackend());
```

- **ä¼˜ç‚¹**ï¼šç®€å•ã€å¿«é€Ÿ
- **ç¼ºç‚¹**ï¼šçŠ¶æ€å¤§å°æœ‰é™ï¼Œä¸é€‚ç”¨äºç”Ÿäº§ç¯å¢ƒ
- **é€‚ç”¨åœºæ™¯**ï¼šå¼€å‘ã€è°ƒè¯•å’Œå°è§„æ¨¡åº”ç”¨

### 2. FsStateBackend

```java
StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
env.setStateBackend(new FsStateBackend("file:////flink/checkpoints"));
```

- **ä¼˜ç‚¹**ï¼šæ”¯æŒå¤§çŠ¶æ€ï¼Œå®¹é”™æ€§å¥½
- **ç¼ºç‚¹**ï¼šéœ€è¦å¤–éƒ¨æ–‡ä»¶ç³»ç»Ÿ
- **é€‚ç”¨åœºæ™¯**ï¼šéœ€è¦å¤§çŠ¶æ€çš„åº”ç”¨

### 3. RocksDBStateBackend

```java
StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
env.setStateBackend(new RocksDBStateBackend("file:///flink/rocksdb"));
```

- **ä¼˜ç‚¹**ï¼šæ”¯æŒè¶…å¤§çŠ¶æ€ï¼ŒåŸºäºç£ç›˜å­˜å‚¨
- **ç¼ºç‚¹**ï¼šæ¯”å†…å­˜çŠ¶æ€åç«¯æ…¢
- **é€‚ç”¨åœºæ™¯**ï¼šéœ€è¦è¶…å¤§çŠ¶æ€çš„åº”ç”¨

::: theorem
é€‰æ‹©åˆé€‚çš„çŠ¶æ€åç«¯æ˜¯æµå¤„ç†åº”ç”¨è®¾è®¡çš„é‡è¦å†³ç­–ã€‚å®ƒç›´æ¥å½±å“åº”ç”¨çš„æ€§èƒ½ã€å®¹é”™èƒ½åŠ›å’Œèµ„æºä½¿ç”¨æ•ˆç‡ã€‚
:::

## çŠ¶æ€ä¸€è‡´æ€§ï¼ˆState Consistencyï¼‰

åœ¨åˆ†å¸ƒå¼æµå¤„ç†ä¸­ï¼ŒçŠ¶æ€ä¸€è‡´æ€§æ˜¯ä¸€ä¸ªå…³é”®é—®é¢˜ã€‚Flinkæä¾›äº†ä¸‰ç§ä¸€è‡´æ€§çº§åˆ«ï¼š

### 1. At-most-onceï¼ˆæœ€å¤šä¸€æ¬¡ï¼‰

- **ç‰¹ç‚¹**ï¼šä¸ä¿è¯å¤„ç†ç»“æœï¼Œå¯èƒ½ä¼šä¸¢å¤±è®°å½•
- **é€‚ç”¨åœºæ™¯**ï¼šå¯¹æ•°æ®ä¸¢å¤±ä¸æ•æ„Ÿçš„åº”ç”¨

### 2. At-least-onceï¼ˆè‡³å°‘ä¸€æ¬¡ï¼‰

- **ç‰¹ç‚¹**ï¼šä¿è¯æ¯æ¡è®°å½•è‡³å°‘è¢«å¤„ç†ä¸€æ¬¡ï¼Œä½†å¯èƒ½é‡å¤
- **é€‚ç”¨åœºæ™¯**ï¼šå¤§å¤šæ•°æµå¤„ç†åº”ç”¨

### 3. Exactly-onceï¼ˆç²¾ç¡®ä¸€æ¬¡ï¼‰

- **ç‰¹ç‚¹**ï¼šä¿è¯æ¯æ¡è®°å½•æ°å¥½è¢«å¤„ç†ä¸€æ¬¡
- **é€‚ç”¨åœºæ™¯**ï¼šå¯¹æ•°æ®å‡†ç¡®æ€§è¦æ±‚é«˜çš„åº”ç”¨

## å®è·µï¼šå®ç°ä¸€ä¸ªæœ‰çŠ¶æ€çš„è®¡æ•°å™¨

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥ç†è§£çŠ¶æ€ç®¡ç†çš„å®é™…åº”ç”¨ã€‚å‡è®¾æˆ‘ä»¬è¦ç»Ÿè®¡æ¯ä¸ªç”¨æˆ·åœ¨5ç§’å†…çš„ç‚¹å‡»æ¬¡æ•°ã€‚

```java
public class ClickCount {
    public static void main(String[] args) throws Exception {
        // åˆ›å»ºæ‰§è¡Œç¯å¢ƒ
        final StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
        
        // å¯ç”¨æ£€æŸ¥ç‚¹ï¼Œæ¯5ç§’ä¸€æ¬¡
        env.enableCheckpointing(5000);
        
        // ä»Kafkaè·å–ç‚¹å‡»äº‹ä»¶
        DataStream<ClickEvent> clicks = env.addSource(new FlinkKafkaConsumer<>(
            "clicks",
            new ClickEventSchema(),
            properties
        ));
        
        // ä½¿ç”¨KeyedStateè¿›è¡ŒçŠ¶æ€ç®¡ç†
        DataStream<UserCount> result = clicks
            .keyBy("userId")
            .window(TumblingEventTimeWindows.of(Time.seconds(5)))
            .process(new ClickCountProcessFunction());
        
        // è¾“å‡ºç»“æœ
        result.print();
        
        env.execute("Click Count");
    }
}

public class ClickCountProcessFunction extends KeyedProcessFunction<String, ClickEvent, UserCount> {
    // å£°æ˜ValueStateç”¨äºå­˜å‚¨è®¡æ•°
    private ValueState<Integer> countState;
    
    @Override
    public void open(Configuration parameters) throws Exception {
        // åˆå§‹åŒ–çŠ¶æ€
        ValueStateDescriptor<Integer> descriptor = new ValueStateDescriptor<>(
            "count", // çŠ¶æ€åç§°
            Integer.class // çŠ¶æ€ç±»å‹
        );
        countState = getRuntimeContext().getState(descriptor);
    }
    
    @Override
    public void processElement(ClickEvent value, Context ctx, Collector<UserCount> out) throws Exception {
        // è·å–å½“å‰çŠ¶æ€å€¼
        Integer currentCount = countState.value();
        if (currentCount == null) {
            currentCount = 0;
        }
        
        // æ›´æ–°çŠ¶æ€
        currentCount++;
        countState.update(currentCount);
        
        // è¾“å‡ºç»“æœ
        out.collect(new UserCount(value.getUserId(), currentCount));
    }
}
```

è¿™ä¸ªä¾‹å­å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨`ValueState`æ¥ç»´æŠ¤ä¸€ä¸ªç®€å•çš„è®¡æ•°å™¨ã€‚æ¯å½“æœ‰æ–°çš„ç‚¹å‡»äº‹ä»¶åˆ°è¾¾æ—¶ï¼Œæˆ‘ä»¬éƒ½ä¼šæ›´æ–°çŠ¶æ€å¹¶è¾“å‡ºç»“æœã€‚

## é«˜çº§çŠ¶æ€ç®¡ç†æŠ€å·§

### 1. çŠ¶æ€TTLï¼ˆTime-To-Liveï¼‰

Flinkæ”¯æŒä¸ºçŠ¶æ€è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œè‡ªåŠ¨æ¸…ç†è¿‡æœŸçŠ¶æ€ï¼š

```java
StateTtlConfig ttlConfig = StateTtlConfig
    .newBuilder(Time.hours(24))
    .setUpdateType(StateTtlConfig.UpdateType.OnCreateAndWrite)
    .setStateVisibility(StateTtlConfig.StateVisibility.NeverReturnExpired)
    .cleanupInRocksdbCompactFilter(1000)
    .build();

ValueStateDescriptor<String> descriptor = new ValueStateDescriptor<>("lastVisit", String.class);
descriptor.enableTimeToLive(ttlConfig);
```

### 2. çŠ¶æ€é‡ç½®

åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦é‡ç½®çŠ¶æ€ï¼Œä¾‹å¦‚ï¼š

```java
// åœ¨çª—å£å…³é—­æ—¶é‡ç½®çŠ¶æ€
@Override
public void onWindowProcess(WindowFunctionContext context, Iterable<ClickEvent> elements, Collector<UserCount> out) {
    // å¤„ç†çª—å£æ•°æ®
    // ...
    
    // é‡ç½®çŠ¶æ€
    countState.clear();
}
```

### 3. çŠ¶æ€è®¿é—®æ¨¡å¼

Flinkæ”¯æŒä¸¤ç§çŠ¶æ€è®¿é—®æ¨¡å¼ï¼š

- **åŸå§‹çŠ¶æ€ï¼ˆRaw Stateï¼‰**ï¼šç›´æ¥è®¿é—®çŠ¶æ€ï¼Œä¸æä¾›ç±»å‹å®‰å…¨
- **æ‰˜ç®¡çŠ¶æ€ï¼ˆManaged Stateï¼‰**ï¼šç”±Flinkç®¡ç†ï¼Œæä¾›ç±»å‹å®‰å…¨

::: right
> æ‰˜ç®¡çŠ¶æ€æ˜¯æ¨èçš„æ–¹å¼ï¼Œå› ä¸ºå®ƒä¸Flinkçš„æ£€æŸ¥ç‚¹å’Œä¿å­˜ç‚¹æœºåˆ¶é›†æˆå¾—æ›´å¥½ã€‚
:::

## ç»“è¯­

çŠ¶æ€ç®¡ç†æ˜¯Flinkæµå¤„ç†çš„æ ¸å¿ƒæ”¯æŸ±ï¼Œå®ƒèµ‹äºˆäº†æµå¤„ç†åº”ç”¨å¤„ç†å¤æ‚ä¸šåŠ¡é€»è¾‘çš„èƒ½åŠ›ã€‚é€šè¿‡åˆç†ä½¿ç”¨çŠ¶æ€ç®¡ç†ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°å„ç§å¤æ‚çš„æµå¤„ç†åœºæ™¯ï¼Œå¦‚å®æ—¶ç»Ÿè®¡ã€å¼‚å¸¸æ£€æµ‹ã€å¤æ‚äº‹ä»¶å¤„ç†ç­‰ã€‚

åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„çŠ¶æ€ç±»å‹ã€çŠ¶æ€åç«¯å’Œä¸€è‡´æ€§çº§åˆ«ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ³¨æ„çŠ¶æ€çš„è§„æ¨¡å’Œæ€§èƒ½å½±å“ï¼Œé¿å…çŠ¶æ€è¿‡å¤§å¯¼è‡´å†…å­˜æº¢å‡ºæˆ–æ€§èƒ½ä¸‹é™ã€‚

å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£Flinkçš„çŠ¶æ€ç®¡ç†æœºåˆ¶ã€‚å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºäº¤æµï¼ğŸ˜Š

> æ€»ç»“ï¼šçŠ¶æ€ç®¡ç†æ˜¯æµå¤„ç†åº”ç”¨çš„æ ¸å¿ƒï¼ŒæŒæ¡çŠ¶æ€ç®¡ç†æ˜¯æˆä¸ºä¸€ååˆæ ¼çš„Flinkå¼€å‘è€…çš„å¿…ç»ä¹‹è·¯ã€‚