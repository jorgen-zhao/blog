---
title: Flinkåå‹æœºåˆ¶è¯¦è§£-æ„å»ºç¨³å®šé«˜æ•ˆæµå¤„ç†ç³»ç»Ÿçš„å…³é”®
date: 2026-02-04
tags: [Flink, æµå¤„ç†, åå‹æœºåˆ¶]
---

## å‰è¨€

åœ¨æ„å»ºæµå¤„ç†åº”ç”¨æ—¶ï¼Œæˆ‘ä»¬å¸¸å¸¸ä¼šé‡åˆ°è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼šç³»ç»Ÿåœ¨è¿è¡Œä¸€æ®µæ—¶é—´åï¼Œå¤„ç†é€Ÿåº¦çªç„¶ä¸‹é™ï¼Œç”šè‡³å®Œå…¨åœæ»ã€‚~~è¿™ç§æƒ…å†µé€šå¸¸ä¸æ˜¯ä»£ç bugï¼Œè€Œæ˜¯åå‹(Backpressure)åœ¨ä½œç¥Ÿ~~ã€‚åå‹æ˜¯æµå¤„ç†ç³»ç»Ÿä¸­çš„æ ¸å¿ƒæŒ‘æˆ˜ï¼Œå®ƒå…³ç³»åˆ°ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œæ€§èƒ½ï¼Œæ˜¯æ„å»ºé«˜æ•ˆæµå¤„ç†åº”ç”¨çš„å…³é”®å› ç´ ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å°±æ¥æ·±å…¥æ¢è®¨Flinkä¸­çš„åå‹æœºåˆ¶åŠå…¶è§£å†³æ–¹æ¡ˆã€‚

## ä»€ä¹ˆæ˜¯åå‹ï¼Ÿ

åå‹æ˜¯æŒ‡å½“æ•°æ®ç”Ÿäº§é€Ÿåº¦è¶…è¿‡æ•°æ®æ¶ˆè´¹é€Ÿåº¦æ—¶ï¼Œç³»ç»Ÿä¸ºäº†é˜²æ­¢æ•°æ®ä¸¢å¤±å’Œå†…å­˜æº¢å‡ºè€Œé‡‡å–çš„ä¸€ç§æµé‡æ§åˆ¶æœºåˆ¶ã€‚åœ¨åˆ†å¸ƒå¼æµå¤„ç†ç³»ç»Ÿä¸­ï¼Œç”±äºå„ä¸ªå¤„ç†èŠ‚ç‚¹çš„å¤„ç†èƒ½åŠ›ä¸åŒï¼Œæ•°æ®æµåŠ¨ä¸å¹³è¡¡æ˜¯å¸¸æ€ã€‚

ğŸ“Œ **åå‹çš„æœ¬è´¨**ï¼šæ˜¯ä¸€ç§æµé‡æ§åˆ¶æœºåˆ¶ï¼Œç¡®ä¿æ•°æ®ç”Ÿäº§é€Ÿåº¦ä¸æ¶ˆè´¹é€Ÿåº¦çš„å¹³è¡¡ã€‚

åœ¨Flinkä¸­ï¼Œåå‹è¡¨ç°ä¸ºï¼š

- çª—å£è®¡ç®—å»¶è¿Ÿå¢åŠ 
- ç®—å­ä¹‹é—´çš„æ•°æ®é˜Ÿåˆ—ç§¯å‹
- æ•´ä½“ååé‡ä¸‹é™
- èƒŒå‹æŒ‡æ ‡(Backpressure)å‡é«˜

## Flinkä¸­çš„åå‹æ£€æµ‹æœºåˆ¶

Flinkæä¾›äº†å¤šç§æœºåˆ¶æ¥æ£€æµ‹å’Œç›‘æ§åå‹æƒ…å†µï¼š

### 1. åå‹æŒ‡æ ‡

Flinkå†…ç½®äº†åå‹ç›‘æ§æŒ‡æ ‡ï¼Œå¯ä»¥é€šè¿‡Flink UIæˆ–APIè·å–ï¼š

```java
// è·å–ç®—å­åå‹æ¯”ç‡
double backpressureRatio = getBackpressureRatio(jobID, operatorID);
```

åå‹æ¯”ç‡çš„è®¡ç®—å…¬å¼ä¸ºï¼š
```
backpressureRatio = å½“å‰å»¶è¿Ÿ / æœ€å¤§å»¶è¿Ÿ
```

- 0.0è¡¨ç¤ºæ— åå‹
- 1.0è¡¨ç¤ºå®Œå…¨é˜»å¡

### 2. é€šè¿‡Flink UIç›‘æ§

åœ¨Flink UIä¸­ï¼Œå¯ä»¥æŸ¥çœ‹æ¯ä¸ªç®—å­çš„åå‹æƒ…å†µï¼š

- **å…¥åº¦(Incoming)å’Œå‡ºåº¦(Outgoing)æ•°æ®é€Ÿç‡**ï¼šæ¯”è¾ƒç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„æ•°æ®é€Ÿç‡
- **ç¼“å†²æ± ä½¿ç”¨æƒ…å†µ**ï¼šç›‘æ§ç®—å­ä¹‹é—´çš„ç¼“å†²åŒºä½¿ç”¨ç‡
- **åå‹æŒ‡æ ‡**ï¼šç›´è§‚æ˜¾ç¤ºå„ç®—å­çš„åå‹ç¨‹åº¦

### 3. é€šè¿‡REST APIè·å–

```bash
curl http://<jobmanager-host>:8081/jobs/<job-id>/backpressure
```

## åå‹äº§ç”Ÿçš„åŸå› åˆ†æ

### 1. ç®—å­å¤„ç†èƒ½åŠ›ä¸åŒ¹é…

ä¸åŒç®—å­çš„å¤„ç†èƒ½åŠ›å·®å¼‚æ˜¯åå‹çš„ä¸»è¦åŸå› ï¼š

```java
// ç¤ºä¾‹ï¼šå¤„ç†èƒ½åŠ›ä¸åŒ¹é…çš„ç®—å­é“¾
DataStream<String> source = env.addSource(new SlowStringSource()); // ç”Ÿäº§é€Ÿåº¦æ…¢
DataStream<String> processed = source.map(new FastStringProcessor()); // æ¶ˆè´¹é€Ÿåº¦å¿«
DataStream<String> sink = processed.addSink(new SlowStringSink()); // ç”Ÿäº§é€Ÿåº¦å¿«ï¼Œæ¶ˆè´¹é€Ÿåº¦æ…¢
```

### 2. æ•°æ®å€¾æ–œ

```java
// ç¤ºä¾‹ï¼šå¯¼è‡´æ•°æ®å€¾æ–œçš„åˆ†ç»„æ“ä½œ
DataStream<Tuple2<String, Integer>> data = ...;
DataStream<Tuple2<String, Integer>> keyedStream = data.keyBy(0); // æŸä¸ªkeyçš„æ•°æ®é‡è¿œå¤§äºå…¶ä»–key
```

### 3. çª—å£è®¡ç®—å¤æ‚åº¦é«˜

```java
// ç¤ºä¾‹ï¼šå¤æ‚çª—å£æ“ä½œå¯¼è‡´åå‹
WindowedStream<Tuple2<String, Integer>, String, TimeWindow> windowed = keyedStream
    .timeWindow(Time.minutes(5))
    .process(new ComplexWindowFunction()); // å¤æ‚è®¡ç®—å¯¼è‡´å¤„ç†é€Ÿåº¦æ…¢
```

### 4. èµ„æºé™åˆ¶

- å†…å­˜ä¸è¶³
- CPUèµ„æºç´§å¼ 
- ç½‘ç»œå¸¦å®½å—é™

## åå‹çš„è§£å†³æ–¹æ¡ˆå’Œæœ€ä½³å®è·µ

### 1. ç®—å­å¹¶è¡Œåº¦è°ƒæ•´

```java
// è°ƒæ•´ç®—å­å¹¶è¡Œåº¦ä»¥åŒ¹é…å¤„ç†èƒ½åŠ›
DataStream<String> source = env.addSource(new SlowStringSource())
    .setParallelism(2); // é™ä½ç”Ÿäº§è€…å¹¶è¡Œåº¦

DataStream<String> processed = source.map(new FastStringProcessor())
    .setParallelism(8); // å¢åŠ æ¶ˆè´¹è€…å¹¶è¡Œåº¦
```

### 2. ä½¿ç”¨åå‹æ„ŸçŸ¥çš„ç®—å­

```java
// ä½¿ç”¨èƒŒå‹æ„ŸçŸ¥çš„æºç®—å­
DataStream<String> source = env.addSource(new BackpressureAwareSource());

// ä½¿ç”¨èƒŒå‹æ„ŸçŸ¥çš„mapç®—å­
DataStream<String> processed = source.transform("BackpressureAwareMap", 
    BasicTypeInfo.STRING_TYPE_INFO, 
    new BackpressureAwareMapFunction());
```

### 3. æ°´ä½çº¿(Watermark)ä¼˜åŒ–

```java
// ä¼˜åŒ–æ°´ä½çº¿ç”Ÿæˆç­–ç•¥
DataStream<Tuple2<String, Long>> eventStream = ...;
DataStream<Tuple2<String, Long>> withWatermark = eventStream
    .assignTimestampsAndWatermarks(new WatermarkStrategy<Tuple2<String, Long>>() {
        @Override
        public WatermarkGenerator<Tuple2<String, Long>> createWatermarkGenerator(
            WatermarkGeneratorSupplier.Context context) {
            return new PunctuatedWatermarkGenerator(1000); // è°ƒæ•´æ°´ä½çº¿ç”Ÿæˆé¢‘ç‡
        }
    });
```

### 4. çŠ¶æ€ç®¡ç†ä¼˜åŒ–

```java
// ä½¿ç”¨å¢é‡æ£€æŸ¥ç‚¹å‡å°‘çŠ¶æ€å¤§å°
stateBackend = new RocksDBStateBackend("file:///path/to/rocksdb");
env.setStateBackend(stateBackend);
env.enableCheckpointing(5000); // 5ç§’æ£€æŸ¥ç‚¹é—´éš”
env.getCheckpointConfig().setMinPauseBetweenCheckpoints(1000); // æœ€å°æ£€æŸ¥ç‚¹é—´éš”
```

### 5. èµ„æºé…ç½®ä¼˜åŒ–

```java
// é…ç½®é€‚å½“çš„ç¼“å†²åŒºå¤§å°
env.getConfig().setTaskManagerMemory("4g");
env.getConfig().setJobManagerMemory("2g");
env.getConfig().setNetworkBufferMemory("1g");
```

## å®é™…æ¡ˆä¾‹åˆ†æ

### æ¡ˆä¾‹1ï¼šå®æ—¶æ¨èç³»ç»Ÿä¸­çš„åå‹é—®é¢˜

**é—®é¢˜æè¿°**ï¼šæŸç”µå•†å¹³å°å®æ—¶æ¨èç³»ç»Ÿåœ¨ä¿ƒé”€æ´»åŠ¨æœŸé—´å‡ºç°ä¸¥é‡åå‹ï¼Œå¯¼è‡´æ¨èå»¶è¿Ÿä»100mså¢åŠ åˆ°5sã€‚

**åŸå› åˆ†æ**ï¼š
- ç”¨æˆ·è¡Œä¸ºæ•°æ®é‡æ¿€å¢10å€
- ç‰¹å®šçƒ­é—¨å•†å“çš„æ¨èè®¡ç®—å¤æ‚åº¦å¢åŠ 
- çŠ¶æ€è®¿é—®æˆä¸ºç“¶é¢ˆ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```java
// 1. å¢åŠ ç®—å­å¹¶è¡Œåº¦
DataStream<UserBehavior> behaviorStream = ...;
behaviorStream.keyBy("userId")
    .window(TumblingEventTimeWindows.of(Time.minutes(5)))
    .process(new RecommendationProcessFunction())
    .setParallelism(16); // ä»8å¢åŠ åˆ°16

// 2. ä¼˜åŒ–çŠ¶æ€è®¿é—®
public class RecommendationProcessFunction extends KeyedProcessFunction<String, UserBehavior, Recommendation> {
    private ValueState<UserProfile> userProfileState;
    
    @Override
    public void open(Configuration parameters) throws Exception {
        ValueStateDescriptor<UserProfile> descriptor = 
            new ValueStateDescriptor<>("userProfile", UserProfile.class);
        userProfileState = getRuntimeContext().getState(descriptor);
    }
    
    @Override
    public void processElement(UserBehavior behavior, Context ctx, Collector<Recommendation> out) {
        // ä½¿ç”¨å¢é‡æ›´æ–°å‡å°‘çŠ¶æ€è®¿é—®
        UserProfile profile = userProfileState.value();
        if (profile == null) {
            profile = new UserProfile();
        }
        profile.updateIncrementally(behavior);
        userProfileState.update(profile);
    }
}
```

### æ¡ˆä¾‹2ï¼šé‡‘èé£æ§ç³»ç»Ÿä¸­çš„åå‹å¤„ç†

**é—®é¢˜æè¿°**ï¼šé‡‘èé£æ§ç³»ç»Ÿåœ¨é«˜å³°æœŸå‡ºç°åå‹ï¼Œå¯¼è‡´äº¤æ˜“å¤„ç†å»¶è¿Ÿå¢åŠ ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å®ç°åå‹æ£€æµ‹å’Œè‡ªåŠ¨é™çº§æœºåˆ¶
2. ä½¿ç”¨èƒŒå‹æ„ŸçŸ¥çš„æºç®—å­
3. ä¼˜åŒ–çª—å£è®¡ç®—é€»è¾‘

```java
// åå‹æ£€æµ‹å’Œè‡ªåŠ¨é™çº§
public class BackpressureAwareSource extends RichSourceFunction<String> {
    private volatile boolean isRunning = true;
    private volatile double backpressureRatio = 0.0;
    
    @Override
    public void run(SourceContext<String> ctx) throws Exception {
        while (isRunning) {
            // æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆ
            if (backpressureRatio > 0.8) {
                // é«˜åå‹æ—¶é™ä½æ•°æ®ç”Ÿæˆé€Ÿç‡
                Thread.sleep(100);
            } else {
                // æ­£å¸¸æ•°æ®ç”Ÿæˆ
                ctx.collect(generateData());
                Thread.sleep(10);
            }
        }
    }
    
    public void setBackpressureRatio(double ratio) {
        this.backpressureRatio = ratio;
    }
}
```

## ç»“è¯­

åå‹æ˜¯æµå¤„ç†ç³»ç»Ÿä¸­çš„å¸¸è§æŒ‘æˆ˜ï¼Œä½†é€šè¿‡æ·±å…¥ç†è§£å…¶æœºåˆ¶å¹¶é‡‡å–é€‚å½“çš„ä¼˜åŒ–æªæ–½ï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºæ›´åŠ ç¨³å®šå’Œé«˜æ•ˆçš„æµå¤„ç†åº”ç”¨ã€‚è®°ä½ï¼Œåå‹ä¸æ˜¯æ•Œäººï¼Œè€Œæ˜¯ç³»ç»Ÿå¥åº·çš„æŒ‡ç¤ºå™¨â€”â€”é€šè¿‡ç›‘æ§åå‹æŒ‡æ ‡ï¼Œæˆ‘ä»¬å¯ä»¥åŠæ—¶å‘ç°ç³»ç»Ÿç“¶é¢ˆå¹¶è¿›è¡Œä¼˜åŒ–ã€‚

åœ¨å®é™…åº”ç”¨ä¸­ï¼Œåå‹å¤„ç†æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œéœ€è¦æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹å’Œç³»ç»Ÿè´Ÿè½½ä¸æ–­è°ƒæ•´å’Œä¼˜åŒ–ã€‚å¸Œæœ›æœ¬æ–‡çš„åˆ†äº«èƒ½å¤Ÿå¸®åŠ©å¤§å®¶æ›´å¥½åœ°ç†è§£å’Œå¤„ç†Flinkä¸­çš„åå‹é—®é¢˜ï¼Œæ„å»ºæ›´åŠ å¥å£®çš„æµå¤„ç†ç³»ç»Ÿã€‚

> "åœ¨æµå¤„ç†çš„ä¸–ç•Œé‡Œï¼Œåå‹ä¸æ˜¯é—®é¢˜ï¼Œè€Œæ˜¯å¸¸æ€ã€‚ç†è§£å®ƒã€æ¥å—å®ƒï¼Œç„¶åä¼˜é›…åœ°å¤„ç†å®ƒï¼Œè¿™æ‰æ˜¯æµå¤„ç†å·¥ç¨‹å¸ˆçš„å¿…å¤‡æŠ€èƒ½ã€‚" â€”â€” æµå¤„ç†ä¸“å®¶