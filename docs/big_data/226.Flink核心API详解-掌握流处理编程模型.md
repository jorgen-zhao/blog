---
title: Flinkæ ¸å¿ƒAPIè¯¦è§£-æŒæ¡æµå¤„ç†ç¼–ç¨‹æ¨¡å‹
date: 2023-11-15 10:30:00
categories: 
  - å¤§æ•°æ®
tags:
  - Flink
  - API
  - æµå¤„ç†
author: 
  name: Jorgen
  link: https://github.com/jorgen-zhao
---

## å‰è¨€

åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å·²ç»æ·±å…¥æ¢è®¨äº†Flinkçš„[æ¶æ„åŸç†](/pages/212abc/)å’Œ[é…ç½®ç®¡ç†](/pages/202def/)ã€‚ğŸ—ï¸ å½“æˆ‘ä»¬æ­å»ºå¥½äº†åŸºç¡€ç¯å¢ƒï¼Œé…ç½®å¥½äº†å‚æ•°ï¼Œæ¥ä¸‹æ¥æœ€å…³é”®çš„å°±æ˜¯å¦‚ä½•ä½¿ç”¨Flinkçš„APIæ¥æ„å»ºæˆ‘ä»¬çš„æµå¤„ç†åº”ç”¨ã€‚ğŸ’¡

::: tip
"APIæ˜¯è¿æ¥å¼€å‘è€…ä¸æ¡†æ¶çš„æ¡¥æ¢ï¼ŒæŒæ¡æ ¸å¿ƒAPIæ˜¯æµå¤„ç†å·¥ç¨‹å¸ˆçš„å¿…å¤‡æŠ€èƒ½"
:::

æœ¬æ–‡å°†ç³»ç»Ÿæ€§åœ°ä»‹ç»Flinkä¸‰å¤§æ ¸å¿ƒAPIï¼šDataStream APIã€Table API/SQLå’ŒProcess Functionï¼Œå¸®åŠ©å¤§å®¶å»ºç«‹å®Œæ•´çš„ç¼–ç¨‹æ¨¡å‹è®¤çŸ¥ã€‚ğŸ“¡

---

## DataStream APIï¼šæµå¤„ç†çš„åŸºçŸ³

DataStream APIæ˜¯Flinkæœ€æ ¸å¿ƒçš„APIï¼Œæä¾›äº†æœ€åº•å±‚çš„æµå¤„ç†èƒ½åŠ›ã€‚å®ƒæ”¯æŒJavaå’ŒScalaä¸¤ç§è¯­è¨€ï¼Œæä¾›äº†ä¸°å¯Œçš„è½¬æ¢ç®—å­ã€‚

### åŸºç¡€è½¬æ¢ç®—å­

```java
// åˆ›å»ºæ•°æ®æµ
DataStream<String> text = env.socketTextStream("localhost", 9999);

// åŸºç¡€è½¬æ¢
DataStream<Tuple2<String, Integer>> wordCounts = text
    .flatMap(new Splitter())      // åˆ†è¯
    .keyBy(0)                     // æŒ‰å•è¯åˆ†ç»„
    .sum(1);                      // æ±‚å’Œ
```

### é«˜çº§è½¬æ¢ç®—å­

- **çª—å£æ“ä½œ**ï¼šæ—¶é—´çª—å£ã€è®¡æ•°çª—å£ã€ä¼šè¯çª—å£
- **çŠ¶æ€ç®¡ç†**ï¼šValueStateã€ListStateã€MapState
- **è¿æ¥å™¨**ï¼šKafkaã€Redisã€Elasticsearchç­‰

::: theorem
DataStream APIçš„ç‰¹ç‚¹ï¼š
1. å£°æ˜å¼APIï¼šé€šè¿‡é“¾å¼è°ƒç”¨æè¿°æ•°æ®å¤„ç†æµç¨‹
2. æ— çŠ¶æ€/æœ‰çŠ¶æ€æ“ä½œï¼šæ”¯æŒç®€å•è½¬æ¢å’Œå¤æ‚çŠ¶æ€è®¡ç®—
3. ä½å»¶è¿Ÿï¼šæ¯«ç§’çº§å¤„ç†å»¶è¿Ÿ
4. å®¹é”™æ€§ï¼šåŸºäºæ£€æŸ¥ç‚¹çš„Exactly-Onceè¯­ä¹‰
:::

---

## Table API & SQLï¼šå£°æ˜å¼è®¡ç®—çš„åˆ©å™¨

éšç€ä¸šåŠ¡å¤æ‚åº¦æå‡ï¼Œè¶Šæ¥è¶Šå¤šçš„å¼€å‘è€…å€¾å‘äºä½¿ç”¨å£°æ˜å¼è¯­è¨€ã€‚Table APIå’ŒSQLåº”è¿è€Œç”Ÿï¼Œè®©æ•°æ®å·¥ç¨‹å¸ˆèƒ½å¤Ÿç”¨ç†Ÿæ‚‰çš„SQLè¯­æ³•å¤„ç†æµæ•°æ®ã€‚

### Table APIåŸºç¡€

```java
// åˆ›å»ºè¡¨ç¯å¢ƒ
TableEnvironment tEnv = TableEnvironment.create();

// æ³¨å†Œæ•°æ®æº
tEnv.executeSql("CREATE TABLE clicks (" +
    "user STRING, " +
    "url STRING, " +
    "ts TIMESTAMP(3), " +
    "WATERMARK FOR ts AS ts - INTERVAL '5' SECOND" +
    ") WITH (" +
    " 'connector' = 'kafka'," +
    " ... " +
    ")");

// æŸ¥è¯¢æ•°æ®
Table result = tEnv.sqlQuery("SELECT user, COUNT(url) FROM clicks GROUP BY user, TUMBLE(ts, INTERVAL '1' MINUTE)");
```

### SQLç‰¹æ€§

- **æµå¼SQL**ï¼šæ”¯æŒæ ‡å‡†SQLè¯­æ³•ï¼Œè‡ªåŠ¨å¤„ç†æµå¼ç‰¹æ€§
- **æ—¶é—´å±æ€§**ï¼šå¤„ç†æ—¶é—´ã€äº‹ä»¶æ—¶é—´å’Œæ‘„å…¥æ—¶é—´
- **è¿æ¥å™¨**ï¼šä¸°å¯Œçš„å†…ç½®è¿æ¥å™¨
- **çª—å£å‡½æ•°**ï¼šTUMBLEã€HOPã€CUMULATEç­‰çª—å£

> ğŸ¤” å½“æˆ‘ä»¬éœ€è¦å¿«é€Ÿå®ç°å¤æ‚èšåˆé€»è¾‘æ—¶ï¼ŒTable API/SQLå¾€å¾€æ¯”DataStream APIæ›´ç®€æ´é«˜æ•ˆã€‚ä½†è¦æ³¨æ„ï¼ŒæŸäº›å¤æ‚çš„çŠ¶æ€æ“ä½œä»éœ€å›é€€åˆ°DataStream APIã€‚

---

## Process Functionï¼šç²¾ç»†åŒ–æ§åˆ¶çš„åˆ©å™¨

å½“æ ‡å‡†APIæ— æ³•æ»¡è¶³éœ€æ±‚æ—¶ï¼ŒProcess Functionæä¾›äº†å¯¹äº‹ä»¶æ—¶é—´å’ŒçŠ¶æ€çš„æœ€ç»†ç²’åº¦æ§åˆ¶ã€‚

### KeyedProcessFunctionç¤ºä¾‹

```java
public class AverageSensorReadings extends KeyedProcessFunction<String, SensorReading, Tuple3<String, Double, Long>> {
    private ValueState<Double> sumState;
    private ValueState<Long> countState;
    
    @Override
    public void open(Configuration parameters) {
        sumState = getRuntimeContext().getState(
            new ValueStateDescriptor<>("sum", Double.class));
        countState = getRuntimeContext().getState(
            new ValueStateDescriptor<>("count", Long.class));
    }
    
    @Override
    public void processElement(SensorReading value, Context ctx, Collector<Tuple3<String, Double, Long>> out) {
        // çŠ¶æ€æ›´æ–°é€»è¾‘
        // å®šæ—¶å™¨è§¦å‘é€»è¾‘
    }
}
```

### æ ¸å¿ƒèƒ½åŠ›

1. **äº‹ä»¶æ—¶é—´å¤„ç†**ï¼šç²¾ç¡®æ§åˆ¶æ—¶é—´æˆ³å’Œæ°´ä½çº¿
2. **çŠ¶æ€ç®¡ç†**ï¼šè®¿é—®Keyed Stateå’ŒOperator State
3. **å®šæ—¶å™¨**ï¼šå¤„ç†å»¶è¿Ÿæ•°æ®å’Œå¤æ‚æ—¶é—´é€»è¾‘
4. **ä¾§è¾“å‡ºæµ**ï¼šåˆ†æµå¤„ç†å¼‚å¸¸æ•°æ®

::: right
"Process Functionæ˜¯Flinkæœ€å¼ºå¤§çš„APIï¼Œä¹Ÿæ˜¯æœ€éš¾æŒæ¡çš„API"
:::

---

## çŠ¶æ€ç®¡ç†ï¼šæµå¤„ç†çš„çµé­‚

æœ‰çŠ¶æ€è®¡ç®—æ˜¯æµå¤„ç†çš„æ ¸å¿ƒã€‚Flinkæä¾›äº†ä¸‰ç§çŠ¶æ€ç±»å‹ï¼š

### çŠ¶æ€ç±»å‹å¯¹æ¯”

| çŠ¶æ€ç±»å‹ | é€‚ç”¨åœºæ™¯ | ç‰¹ç‚¹ |
|---------|---------|------|
| ValueState | å•å€¼çŠ¶æ€ | æ¯ä¸ªKeyå¯¹åº”ä¸€ä¸ªå€¼ |
| ListState | åˆ—è¡¨çŠ¶æ€ | å­˜å‚¨å¯å˜é•¿åˆ—è¡¨ |
| MapState | æ˜ å°„çŠ¶æ€ | Key-Valueå¯¹å­˜å‚¨ |
| ReducingState | èšåˆçŠ¶æ€ | å†…ç½®reduceå‡½æ•° |
| AggregatingState | èšåˆçŠ¶æ€ | è‡ªå®šä¹‰èšåˆé€»è¾‘ |

### çŠ¶æ€ä¸€è‡´æ€§ä¿éšœ

```java
// å¼€å¯æ£€æŸ¥ç‚¹
env.enableCheckpointing(5000); // 5ç§’é—´éš”

// é…ç½®ä¸€è‡´æ€§çº§åˆ«
env.getCheckpointConfig().setCheckpointingMode(CheckpointingMode.EXACTLY_ONCE);
```

---

## çª—å£æ“ä½œï¼šæ—¶é—´ä¸æ•°æ®çš„è‰ºæœ¯

çª—å£æ˜¯æµå¤„ç†ä¸­æœ€æ ¸å¿ƒçš„æ¦‚å¿µä¹‹ä¸€ï¼ŒFlinkæä¾›äº†ä¸°å¯Œçš„çª—å£ç±»å‹ï¼š

### çª—å£ç±»å‹è¯¦è§£

#### 1. æ»šåŠ¨çª—å£ï¼ˆTumbling Windowï¼‰

```java
DataStream<SensorReading> readings = ...;
readings
    .keyBy("sensorId")
    .window(TumblingEventTimeWindows.of(Time.minutes(5)))
    .aggregate(new AvgTemp());
```

#### 2. æ»‘åŠ¨çª—å£ï¼ˆSliding Windowï¼‰

```java
readings
    .keyBy("sensorId")
    .window(SlidingEventTimeWindows.of(Time.minutes(10), Time.minutes(5)))
    .process(new WindowProcessFunction());
```

#### 3. ä¼šè¯çª—å£ï¼ˆSession Windowï¼‰

```java
readings
    .keyBy("sensorId")
    .window(EventTimeSessionWindows.withGap(Time.minutes(10)))
    .aggregate(new AvgTemp());
```

### çª—å£å‡½æ•°é€‰æ‹©

- **å¢é‡èšåˆ**ï¼š`reduce()`/`aggregate()`ï¼ˆä½å»¶è¿Ÿï¼‰
- **å…¨é‡çª—å£**ï¼š`process()`ï¼ˆçµæ´»ä½†é«˜å»¶è¿Ÿï¼‰
- **çª—å£API**ï¼š`apply()`ï¼ˆå·²å¼ƒç”¨ï¼‰

---

## ç»“è¯­

é€šè¿‡æœ¬æ–‡çš„ç³»ç»Ÿä»‹ç»ï¼Œæˆ‘ä»¬æŒæ¡äº†Flinkä¸‰å¤§æ ¸å¿ƒAPIçš„ç‰¹ç‚¹å’Œé€‚ç”¨åœºæ™¯ï¼š

1. **DataStream API**ï¼šåŸºç¡€æµå¤„ç†ï¼Œçµæ´»ä½†éœ€è¦æ›´å¤šç¼–ç 
2. **Table API/SQL**ï¼šå£°æ˜å¼è®¡ç®—ï¼Œé€‚åˆä¸šåŠ¡é€»è¾‘å®ç°
3. **Process Function**ï¼šç²¾ç»†åŒ–æ§åˆ¶ï¼Œè§£å†³å¤æ‚åœºæ™¯éœ€æ±‚

åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œå»ºè®®é‡‡ç”¨ç»„åˆä½¿ç”¨çš„æ–¹å¼ï¼šç”¨Table API/SQLå®ç°ä¸šåŠ¡é€»è¾‘ï¼Œé‡åˆ°å¤æ‚åœºæ™¯æ—¶å›é€€åˆ°Process Functionã€‚ğŸš€

> "æŒæ¡APIåªæ˜¯å¼€å§‹ï¼Œç†è§£èƒŒåçš„çŠ¶æ€ç®¡ç†å’Œæ—¶é—´è¯­ä¹‰æ‰æ˜¯æµå¤„ç†å·¥ç¨‹å¸ˆè¿›é˜¶çš„å…³é”®"

æœªæ¥æˆ‘ä»¬å°†ç»§ç»­æ¢è®¨Flinkçš„æ€§èƒ½ä¼˜åŒ–å’Œå®æˆ˜æ¡ˆä¾‹ï¼Œæ•¬è¯·å…³æ³¨ï¼ğŸ¤

<!-- more -->
```