---
title: FlinkçŠ¶æ€ç®¡ç†ä¸å®¹é”™æœºåˆ¶-æ„å»ºå¯é çš„æµå¤„ç†åº”ç”¨
date: 2023-11-15 14:30:00
categories: 
  - å¤§æ•°æ®
tags:
  - Flink
  - çŠ¶æ€ç®¡ç†
  - å®¹é”™æœºåˆ¶
  - æµå¤„ç†
author: 
  name: Jorgen
  link: https://github.com/jorgen-zhao
---

## å‰è¨€

åœ¨æµå¤„ç†çš„ä¸–ç•Œé‡Œï¼Œ**çŠ¶æ€ç®¡ç†**ä¸**å®¹é”™æœºåˆ¶**æ˜¯æ„å»ºå¯é åº”ç”¨çš„æ ¸å¿ƒè¦ç´ ã€‚ğŸ— å½“æˆ‘ä»¬è°ˆè®º Flink æ—¶ï¼Œè¿™ä¸¤ä¸ªæ¦‚å¿µå°¤ä¸ºé‡è¦ï¼Œå› ä¸ºå®ƒä»¬ç›´æ¥å†³å®šäº†æˆ‘ä»¬çš„åº”ç”¨èƒ½å¦åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ç¨³å®šè¿è¡Œã€‚

::: tip
"æ²¡æœ‰çŠ¶æ€ç®¡ç†çš„æµå¤„ç†å°±åƒæ²¡æœ‰è®°å¿†çš„æ€è€ƒè€…ï¼Œå¯ä»¥å¤„ç†å½“å‰äº‹ä»¶ï¼Œä½†æ— æ³•ä»å†å²ä¸­å­¦ä¹ ã€‚"
:::

åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å·²ç»æ¢è®¨äº† Flink çš„æ¶æ„åŸç†å’ŒåŸºæœ¬é…ç½®ï¼Œä½†çŠ¶æ€ç®¡ç†ä¸å®¹é”™æœºåˆ¶è¿™ä¸€å…³é”®ä¸»é¢˜å°šæœªæ·±å…¥è®¨è®ºã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å°±æ¥æ­å¼€ Flink çŠ¶æ€ç®¡ç†çš„ç¥ç§˜é¢çº±ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•ä¿éšœæˆ‘ä»¬çš„æµå¤„ç†åº”ç”¨åœ¨æ•…éšœå‘ç”Ÿæ—¶ä¾ç„¶å¯é çš„ã€‚

## FlinkçŠ¶æ€ç±»å‹

Flink æä¾›äº†å¤šç§çŠ¶æ€ç±»å‹ï¼Œä»¥æ»¡è¶³ä¸åŒåœºæ™¯çš„éœ€æ±‚ã€‚äº†è§£è¿™äº›çŠ¶æ€ç±»å‹æ˜¯æ„å»ºé«˜æ•ˆæµå¤„ç†åº”ç”¨çš„ç¬¬ä¸€æ­¥ã€‚

### Keyed State

Keyed State æ˜¯ä¸ç‰¹å®š Key ç»‘å®šçš„çŠ¶æ€ï¼Œåªèƒ½åœ¨ Keyed Stream ä¸Šä½¿ç”¨ã€‚å®ƒæä¾›äº†ä»¥ä¸‹å‡ ç§çŠ¶æ€ç±»å‹ï¼š

- **ValueState**ï¼šå­˜å‚¨å•ä¸ªå€¼çš„çŠ¶æ€
- **ListState**ï¼šå­˜å‚¨ä¸€ä¸ªåˆ—è¡¨çš„çŠ¶æ€
- **ReducingState**ï¼šå­˜å‚¨ä¸€ä¸ªå€¼ï¼Œé€šè¿‡ç”¨æˆ·æä¾›çš„ ReduceFunction è¿›è¡Œèšåˆ
- **AggregatingState**ï¼šå­˜å‚¨ä¸€ä¸ªå€¼ï¼Œé€šè¿‡ç”¨æˆ·æä¾›çš„ AggregateFunction è¿›è¡Œèšåˆ
- **MapState**ï¼šå­˜å‚¨ä¸€ä¸ªé”®å€¼å¯¹æ˜ å°„çš„çŠ¶æ€

```java
// ValueState ç¤ºä¾‹
ValueState<String> state = getRuntimeContext().getState(
    new ValueStateDescriptor<>("myState", String.class));

// è·å–çŠ¶æ€
String currentState = state.value();
// æ›´æ–°çŠ¶æ€
state.update("newValue");
```

### Operator State

Operator State ä¹Ÿç§°ä¸ºéé”®æ§çŠ¶æ€ï¼Œå®ƒä¸ç‰¹å®š Operator å®ä¾‹ç»‘å®šï¼Œä¸ä¾èµ–äº Keyã€‚å®ƒä¸»è¦ç”¨äºï¼š

- æ‰¹å¤„ç†æºï¼ˆå¦‚è¯»å–æ–‡ä»¶ï¼‰
- è¿­ä»£çŠ¶æ€
- è®°å½•åç§»é‡ï¼ˆå¦‚ Kafka æ¶ˆè´¹è€…ï¼‰

```java
// ListState ç¤ºä¾‹
ListState<String> listState = getRuntimeContext().getListState(
    new ListStateDescriptor<>("myListState", String.class));

// æ·»åŠ å…ƒç´ åˆ°çŠ¶æ€
listState.add("element1");
// è·å–çŠ¶æ€è¿­ä»£å™¨
Iterable<String> elements = listState.get();
```

## çŠ¶æ€åç«¯

Flink çš„çŠ¶æ€åç«¯è´Ÿè´£å­˜å‚¨å’Œç®¡ç†åº”ç”¨ç¨‹åºçš„çŠ¶æ€ã€‚Flink æä¾›äº†ä¸‰ç§çŠ¶æ€åç«¯ï¼š

### MemoryStateBackend

- **ç‰¹ç‚¹**ï¼šçŠ¶æ€å­˜å‚¨åœ¨ TaskManager çš„å†…å­˜ä¸­
- **é€‚ç”¨åœºæ™¯**ï¼šçŠ¶æ€è¾ƒå°ã€ä½å»¶è¿Ÿè¦æ±‚çš„ä½œä¸š
- **é™åˆ¶**ï¼šçŠ¶æ€å¤§å°å—é™ï¼Œé‡å¯åçŠ¶æ€ä¸¢å¤±

```java
// é…ç½® MemoryStateBackend
StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
env.setStateBackend(new MemoryStateBackend());
```

### FsStateBackend

- **ç‰¹ç‚¹**ï¼šçŠ¶æ€å­˜å‚¨åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ï¼ˆå¦‚ HDFSã€S3ï¼‰
- **é€‚ç”¨åœºæ™¯**ï¼šéœ€è¦æŒä¹…åŒ–çŠ¶æ€ã€çŠ¶æ€è¾ƒå¤§çš„ä½œä¸š
- **ä¼˜åŠ¿**ï¼šä½œä¸šé‡å¯åçŠ¶æ€ä¸ä¸¢å¤±

```java
// é…ç½® FsStateBackend
StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
env.setStateBackend(new FsStateBackend("hdfs://namenode:8021/flink/checkpoints"));
```

### RocksDBStateBackend

- **ç‰¹ç‚¹**ï¼šä½¿ç”¨ RocksDB ä½œä¸ºæœ¬åœ°çŠ¶æ€å­˜å‚¨ï¼Œå®šæœŸå°†æ£€æŸ¥ç‚¹ä¿å­˜åˆ°è¿œç¨‹æ–‡ä»¶ç³»ç»Ÿ
- **é€‚ç”¨åœºæ™¯**ï¼šè¶…å¤§è§„æ¨¡çŠ¶æ€ã€éœ€è¦é«˜ååé‡çš„ä½œä¸š
- **ä¼˜åŠ¿**ï¼šçŠ¶æ€å®¹é‡å¤§ï¼Œæ€§èƒ½å¥½

```java
// é…ç½® RocksDBStateBackend
StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
env.setStateBackend(new RocksDBStateBackend("hdfs://namenode:8021/flink/checkpoints"));
```

## Checkpointæœºåˆ¶

Flink çš„ Checkpoint æœºåˆ¶æ˜¯å®ç°å®¹é”™çš„æ ¸å¿ƒã€‚å®ƒé€šè¿‡å®šæœŸä¿å­˜åº”ç”¨çŠ¶æ€çš„ä¸€è‡´æ€§å¿«ç…§ï¼Œä½¿åº”ç”¨åœ¨æ•…éšœå‘ç”Ÿåèƒ½å¤Ÿæ¢å¤åˆ°ä¹‹å‰çš„çŠ¶æ€ã€‚

### CheckpointåŸç†

Flink çš„ Checkpoint æœºåˆ¶åŸºäº Chandy-Lamport ç®—æ³•å®ç°ï¼š

1. **Barrier æ³¨å…¥**ï¼šSource æ³¨å…¥ Barrierï¼Œéšæ•°æ®æµå‘ä¸‹ä¼ æ’­
2. **Barrier å¯¹é½**ï¼šæ‰€æœ‰è¾“å…¥æµéƒ½æ”¶åˆ° Barrier åï¼ŒOperator æ‰ä¼šå¤„ç† Checkpoint
3. **çŠ¶æ€å¿«ç…§**ï¼šOperator å°†çŠ¶æ€å†™å…¥æŒä¹…åŒ–å­˜å‚¨
4. **ç¡®è®¤**ï¼šå®Œæˆå¿«ç…§åå‘ JobManager å‘é€ç¡®è®¤

```java
// å¯ç”¨ Checkpoint
StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
env.enableCheckpointing(5000); // æ¯5ç§’æ‰§è¡Œä¸€æ¬¡Checkpoint
env.getCheckpointConfig().setCheckpointingMode(CheckpointingMode.EXACTLY_ONCE);
env.getCheckpointConfig().setMinPauseBetweenCheckpoints(1000);
env.getCheckpointConfig().setCheckpointTimeout(60000);
env.getCheckpointConfig().setMaxConcurrentCheckpoints(1);
env.getCheckpointConfig().enableExternalizedCheckpoints(CheckpointConfig.ExternalizedCheckpointCleanup.RETAIN_ON_CANCELLATION);
```

### Checkpointé…ç½®

Flink æä¾›äº†ä¸°å¯Œçš„ Checkpoint é…ç½®é€‰é¡¹ï¼š

- **checkpointInterval**ï¼šCheckpoint æ‰§è¡Œé—´éš”
- **checkpointMode**ï¼šç²¾ç¡®ä¸€æ¬¡ï¼ˆEXACTLY_ONCEï¼‰æˆ–è‡³å°‘ä¸€æ¬¡ï¼ˆAT_LEAST_ONCEï¼‰
- **minPauseBetweenCheckpoints**ï¼šä¸¤æ¬¡ Checkpoint ä¹‹é—´çš„æœ€å°é—´éš”
- **checkpointTimeout**ï¼šCheckpoint è¶…æ—¶æ—¶é—´
- **maxConcurrentCheckpoints**ï¼šæœ€å¤§å¹¶å‘ Checkpoint æ•°é‡
- **externalizedCheckpoints**ï¼šå¤–éƒ¨ Checkpoint ç®¡ç†

## Savepointæœºåˆ¶

Savepoint æ˜¯ Flink æä¾›çš„ä¸€ç§æ‰‹åŠ¨è§¦å‘çš„ã€å¯ç§»æ¤çš„ Checkpointã€‚å®ƒå…è®¸æˆ‘ä»¬åœ¨ä¸ä¸¢å¤±çŠ¶æ€çš„æƒ…å†µä¸‹æ›´æ–°æˆ–è¿ç§»åº”ç”¨ã€‚

### åˆ›å»ºSavepoint

```bash
# ä½¿ç”¨ Flink CLI åˆ›å»º Savepoint
./bin/flink savepoint -d <jobId> -h <savepointPath>

# ä½¿ç”¨ Flink REST API åˆ›å»º Savepoint
curl -X POST http://localhost:8081/jobs/<jobId>/savepoints -H "Content-Type: application/json" -d '{"target-directory": "/savepoints"}'
```

### ä»Savepointæ¢å¤

```java
// ä» Savepoint å¯åŠ¨ä½œä¸š
StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
env.setStateBackend(new FsStateBackend("hdfs://namenode:8021/flink/savepoints"));
env.restoreSavepoint("/path/to/savepoint");
```

### Savepointç®¡ç†

Savepoint çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†åŒ…æ‹¬ï¼š

- **åˆ›å»º**ï¼šæ‰‹åŠ¨è§¦å‘
- **æ¢å¤**ï¼šç”¨äºä½œä¸šé‡å¯æˆ–å‡çº§
- **åˆ é™¤**ï¼šä¸å†éœ€è¦æ—¶æ¸…ç†ï¼Œé¿å…å ç”¨å­˜å‚¨ç©ºé—´

## å®¹é”™ç­–ç•¥ä¸æœ€ä½³å®è·µ

### å®¹é”™ç­–ç•¥

Flink æä¾›äº†å¤šç§å®¹é”™ç­–ç•¥ï¼š

1. **è‡ªåŠ¨é‡å¯**ï¼šä½œä¸šå¤±è´¥æ—¶è‡ªåŠ¨é‡å¯
2. **å›ºå®šå»¶è¿Ÿé‡å¯**ï¼šæœ€å¤šé‡å¯æŒ‡å®šæ¬¡æ•°
3. **å¤±è´¥ç‡é‡å¯**ï¼šåŸºäºå¤±è´¥ç‡åŠ¨æ€è°ƒæ•´é‡å¯ç­–ç•¥
4. **æ— é‡å¯**ï¼šä½œä¸šå¤±è´¥æ—¶ä¸è‡ªåŠ¨é‡å¯

```java
// é…ç½®é‡å¯ç­–ç•¥
StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
env.setRestartStrategy(RestartStrategies.fixedDelayRestart(
    3, // é‡è¯•æ¬¡æ•°
    Time.seconds(10) // é‡è¯•é—´éš”
));
```

### æœ€ä½³å®è·µ

1. **åˆç†é€‰æ‹©çŠ¶æ€åç«¯**ï¼šæ ¹æ®çŠ¶æ€å¤§å°å’Œæ€§èƒ½è¦æ±‚é€‰æ‹©åˆé€‚çš„çŠ¶æ€åç«¯
2. **è®¾ç½®åˆç†çš„ Checkpoint é—´éš”**ï¼šå¹³è¡¡æ€§èƒ½å’Œæ¢å¤æ—¶é—´
3. **ç›‘æ§ Checkpoint å¤§å°å’Œè€—æ—¶**ï¼šåŠæ—¶å‘ç°å’Œè§£å†³æ€§èƒ½é—®é¢˜
4. **å®šæœŸåˆ›å»º Savepoint**ï¼šç‰¹åˆ«æ˜¯åœ¨éƒ¨ç½²æ–°ç‰ˆæœ¬å‰
5. **å¤„ç†åå‹é—®é¢˜**ï¼šé¿å… Checkpoint å› åå‹è€Œå¤±è´¥

## ç»“è¯­

çŠ¶æ€ç®¡ç†ä¸å®¹é”™æœºåˆ¶æ˜¯ Flink æµå¤„ç†åº”ç”¨çš„åŸºçŸ³ã€‚ğŸ¤” æ²¡æœ‰è‰¯å¥½çš„çŠ¶æ€ç®¡ç†ï¼Œæˆ‘ä»¬çš„æµå¤„ç†åº”ç”¨å°†æ— æ³•å¤„ç†å¤æ‚çš„ä¸šåŠ¡åœºæ™¯ï¼›æ²¡æœ‰å¼ºå¤§çš„å®¹é”™æœºåˆ¶ï¼Œæˆ‘ä»¬çš„åº”ç”¨å°†åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ä¸¾æ­¥ç»´è‰°ã€‚

é€šè¿‡æœ¬æ–‡ï¼Œæˆ‘ä»¬äº†è§£äº† Flink çš„çŠ¶æ€ç±»å‹ã€çŠ¶æ€åç«¯ã€Checkpoint å’Œ Savepoint æœºåˆ¶ï¼Œä»¥åŠå¦‚ä½•é…ç½®å®¹é”™ç­–ç•¥ã€‚è¿™äº›çŸ¥è¯†å°†å¸®åŠ©æˆ‘ä»¬åœ¨æ„å»ºæµå¤„ç†åº”ç”¨æ—¶ï¼Œæ›´åŠ è‡ªä¿¡åœ°é¢å¯¹å„ç§æŒ‘æˆ˜ã€‚

> "åœ¨æµå¤„ç†çš„ä¸–ç•Œé‡Œï¼ŒçŠ¶æ€ä¸æ˜¯è´Ÿæ‹…ï¼Œè€Œæ˜¯è´¢å¯Œã€‚å®ƒè®©æˆ‘ä»¬èƒ½å¤Ÿä»å†å²ä¸­å­¦ä¹ ï¼Œä»è€Œåšå‡ºæ›´æ˜æ™ºçš„å†³ç­–ã€‚"

å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£ Flink çš„çŠ¶æ€ç®¡ç†ä¸å®¹é”™æœºåˆ¶ã€‚å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºç•™è¨€äº¤æµï¼ğŸ‘‹
