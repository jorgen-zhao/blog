---
title: Flinkæ—¶é—´è¯­ä¹‰è¯¦è§£ï¼šæŒæ¡æµå¤„ç†ä¸­çš„æ—¶é—´æ§åˆ¶
date: 2026-02-03
tags: [Flink, æ—¶é—´è¯­ä¹‰, æµå¤„ç†]
---

## å‰è¨€

åœ¨æµå¤„ç†çš„ä¸–ç•Œé‡Œï¼Œæ—¶é—´æ˜¯æœ€æ ¸å¿ƒçš„ç»´åº¦ä¹‹ä¸€ã€‚å½“æˆ‘ä»¬è°ˆè®º"å®æ—¶è®¡ç®—"æ—¶ï¼Œæˆ‘ä»¬åˆ°åº•åœ¨è¯´ä»€ä¹ˆï¼Ÿæ˜¯æ•°æ®äº§ç”Ÿçš„æ—¶é—´ï¼Ÿæ•°æ®åˆ°è¾¾ç³»ç»Ÿçš„æ—¶é—´ï¼Ÿè¿˜æ˜¯ç³»ç»Ÿå¤„ç†æ•°æ®çš„æ—¶é—´ï¼ŸFlinké€šè¿‡å¼ºå¤§çš„æ—¶é—´è¯­ä¹‰æœºåˆ¶ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿç²¾ç¡®æ§åˆ¶æµå¤„ç†ä¸­çš„æ—¶é—´ç»´åº¦ï¼Œç¡®ä¿è®¡ç®—ç»“æœçš„å‡†ç¡®æ€§å’Œä¸€è‡´æ€§ã€‚

> ğŸ• "æ—¶é—´åœ¨æµå¤„ç†ä¸­ä¸æ˜¯å•è°ƒé€’å¢çš„æ•°å­—ï¼Œè€Œæ˜¯ç†è§£æ•°æ®æ„ä¹‰çš„é’¥åŒ™" â€”â€” æµå¤„ç†ä¸“å®¶

æœ¬æ–‡å°†æ·±å…¥è§£æFlinkçš„ä¸‰ç§æ—¶é—´è¯­ä¹‰ï¼Œæ¢è®¨å®ƒä»¬åœ¨æµå¤„ç†ä¸­çš„æ ¸å¿ƒä½œç”¨ï¼Œä»¥åŠå¦‚ä½•åœ¨å®é™…åº”ç”¨ä¸­æ­£ç¡®ä½¿ç”¨æ—¶é—´è¯­ä¹‰æ¥æ„å»ºå¯é çš„å®æ—¶è®¡ç®—ç³»ç»Ÿã€‚

## æ—¶é—´è¯­ä¹‰çš„ä¸‰ç§ç±»å‹

Flinkæä¾›äº†ä¸‰ç§æ—¶é—´è¯­ä¹‰ï¼Œæ¯ç§éƒ½æœ‰å…¶ç‹¬ç‰¹çš„åº”ç”¨åœºæ™¯å’Œç‰¹ç‚¹ï¼š

### 1. å¤„ç†æ—¶é—´ï¼ˆProcessing Timeï¼‰

å¤„ç†æ—¶é—´æ˜¯æŒ‡äº‹ä»¶è¢«Flinkç³»ç»Ÿå¤„ç†çš„æ—¶é—´ç‚¹ï¼Œå³æœºå™¨æ—¶é’Ÿæ—¶é—´ã€‚

```java
// ä½¿ç”¨å¤„ç†æ—¶é—´
DataStream<Event> stream = env.addSource(...)
    .assignTimestampsAndWatermarks(
        WatermarkStrategy.noWatermarks()
    );
```

**ç‰¹ç‚¹ï¼š**
- ğŸ“¡ **ä½å»¶è¿Ÿ**ï¼šæ•°æ®å‡ ä¹å®æ—¶å¤„ç†
- âš ï¸ **ä¸ç¡®å®šæ€§**ï¼šå¤„ç†ç»“æœå—ç½‘ç»œå»¶è¿Ÿå’Œç³»ç»Ÿè´Ÿè½½å½±å“
- ğŸ¯ **é€‚ç”¨åœºæ™¯**ï¼šå®æ—¶ç›‘æ§ã€ç®€å•ç»Ÿè®¡ã€å¯¹æ—¶é—´ç²¾åº¦è¦æ±‚ä¸é«˜çš„åœºæ™¯

**ç¤ºä¾‹ï¼š** å®æ—¶ç½‘ç«™ç‚¹å‡»æµç»Ÿè®¡ï¼Œéœ€è¦å¿«é€Ÿå±•ç¤ºå½“å‰è®¿é—®é‡

### 2. äº‹ä»¶æ—¶é—´ï¼ˆEvent Timeï¼‰

äº‹ä»¶æ—¶é—´æ˜¯æŒ‡äº‹ä»¶å®é™…å‘ç”Ÿçš„æ—¶é—´ï¼Œé€šå¸¸ç”±æ•°æ®æœ¬èº«æºå¸¦çš„æ—¶é—´æˆ³å†³å®šã€‚

```java
// ä½¿ç”¨äº‹ä»¶æ—¶é—´
DataStream<Event> stream = env.addSource(...)
    .assignTimestampsAndWatermarks(
        WatermarkStrategy.<Event>forBoundedOutOfOrderness(Duration.ofSeconds(5))
            .withTimestampAssigner((event, timestamp) -> event.getTimestamp())
    );
```

**ç‰¹ç‚¹ï¼š**
- ğŸ¯ **å‡†ç¡®æ€§**ï¼šåŸºäºäº‹ä»¶çœŸå®å‘ç”Ÿæ—¶é—´è®¡ç®—
- ğŸ”„ **å®¹é”™æ€§**ï¼šèƒ½æ­£ç¡®å¤„ç†ä¹±åºäº‹ä»¶å’Œå»¶è¿Ÿæ•°æ®
- â³ **å»¶è¿Ÿæ€§**ï¼šéœ€è¦ç­‰å¾…å»¶è¿Ÿæ•°æ®åˆ°è¾¾ï¼Œå¤„ç†æ—¶é—´è¾ƒé•¿
- ğŸ— **é€‚ç”¨åœºæ™¯**ï¼šé‡‘èé£æ§ã€å®æ—¶æŠ¥è¡¨ã€éœ€è¦ç²¾ç¡®æ—¶é—´ç»Ÿè®¡çš„åœºæ™¯

**ç¤ºä¾‹ï¼š** ç”µå•†è®¢å•å®æ—¶ç»Ÿè®¡ï¼Œéœ€è¦æŒ‰è®¢å•å®é™…ä¸‹å•æ—¶é—´ç»Ÿè®¡

### 3. æ‘„å…¥æ—¶é—´ï¼ˆIngestion Timeï¼‰

æ‘„å…¥æ—¶é—´ä»‹äºå¤„ç†æ—¶é—´å’Œäº‹ä»¶æ—¶é—´ä¹‹é—´ï¼ŒæŒ‡æ•°æ®è¿›å…¥Flinkç³»ç»Ÿçš„æ—¶é—´ã€‚

```java
// ä½¿ç”¨æ‘„å…¥æ—¶é—´ï¼ˆè‡ªåŠ¨åˆ†é…ï¼‰
DataStream<Event> stream = env.addSource(...);
```

**ç‰¹ç‚¹ï¼š**
- âš–ï¸ **å¹³è¡¡æ€§**ï¼šæ¯”å¤„ç†æ—¶é—´æ›´å‡†ç¡®ï¼Œæ¯”äº‹ä»¶æ—¶é—´å»¶è¿Ÿæ›´ä½
- ğŸš€ **ç®€å•æ€§**ï¼šæ— éœ€æ‰‹åŠ¨åˆ†é…æ—¶é—´æˆ³å’Œæ°´ä½çº¿
- ğŸ“Š **é€‚ç”¨åœºæ™¯**ï¼šä¸­ç­‰ç²¾åº¦è¦æ±‚çš„å®æ—¶è®¡ç®—ã€æ—¥å¿—åˆ†æ

**ç¤ºä¾‹ï¼š** å®æ—¶ç”¨æˆ·è¡Œä¸ºåˆ†æï¼Œéœ€è¦å¹³è¡¡å‡†ç¡®æ€§å’Œå¤„ç†é€Ÿåº¦

## æ°´ä½çº¿ï¼ˆWatermarkï¼‰ï¼šæ—¶é—´è¯­ä¹‰çš„æ ¸å¿ƒ

æ°´ä½çº¿æ˜¯Flinkå¤„ç†äº‹ä»¶æ—¶é—´çš„å…³é”®æœºåˆ¶ï¼Œç”¨äºè¡¡é‡äº‹ä»¶æ—¶é—´çš„è¿›åº¦å¹¶å¤„ç†ä¹±åºäº‹ä»¶ã€‚

### æ°´ä½çº¿åŸç†

æ°´ä½çº¿æ˜¯ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œè¡¨ç¤º"åœ¨æ­¤æ—¶é—´æˆ³ä¹‹å‰çš„äº‹ä»¶åº”è¯¥å·²ç»å…¨éƒ¨åˆ°è¾¾"ã€‚Flinké€šè¿‡æ°´ä½çº¿æ¥è·Ÿè¸ªäº‹ä»¶æ—¶é—´çš„è¿›åº¦ã€‚

```java
// è‡ªå®šä¹‰æ°´ä½çº¿ç”Ÿæˆå™¨
WatermarkStrategy.<Event>forGenerator(
    ctx -> new WatermarkGenerator<Event>() {
        private long maxTimestamp = Long.MIN_VALUE;
        private final long outOfOrderness = 5000; // 5ç§’å»¶è¿Ÿ

        @Override
        public void onEvent(Event event, long eventTimestamp, WatermarkOutput output) {
            maxTimestamp = Math.max(maxTimestamp, eventTimestamp);
        }

        @Override
        public void onPeriodicEmit(WatermarkOutput output) {
            output.emitWatermark(new Watermark(maxTimestamp - outOfOrderness));
        }
    }
);
```

### æ°´ä½çº¿çš„ä½œç”¨

1. **å¤„ç†ä¹±åºäº‹ä»¶**ï¼šå…è®¸åœ¨è®¾å®šå»¶è¿ŸèŒƒå›´å†…çš„ä¹±åºäº‹ä»¶
2. **è§¦å‘çª—å£è®¡ç®—**ï¼šå½“æ°´ä½çº¿è¶…è¿‡çª—å£ç»“æŸæ—¶é—´æ—¶è§¦å‘è®¡ç®—
3. **æ¸…ç†çŠ¶æ€**ï¼šæ¸…ç†ä¸å†éœ€è¦çš„æ—§çŠ¶æ€æ•°æ®

### æ°´ä½çº¿ç­–ç•¥

Flinkæä¾›äº†å¤šç§æ°´ä½çº¿ç”Ÿæˆç­–ç•¥ï¼š

| ç­–ç•¥ç±»å‹ | é€‚ç”¨åœºæ™¯ | ç‰¹ç‚¹ |
|---------|---------|------|
| å›ºå®šå»¶è¿Ÿ | å»¶è¿ŸèŒƒå›´å·²çŸ¥ | ç®€å•é«˜æ•ˆ |
| æœ‰ç•Œä¹±åº | å»¶è¿Ÿå¯ä¼°è®¡ | é€‚ç”¨äºå¤§å¤šæ•°åœºæ™¯ |
| æ— ç•Œä¹±åº | å»¶è¿Ÿä¸å¯é¢„æµ‹ | éœ€è¦ç‰¹æ®Šå¤„ç† |
| è‡ªå®šä¹‰ | å¤æ‚ä¸šåŠ¡é€»è¾‘ | çµæ´»ä½†å¤æ‚ |

## æ—¶é—´è¯­ä¹‰åœ¨Flink APIä¸­çš„ä½¿ç”¨

### DataStream APIä¸­çš„æ—¶é—´è¯­ä¹‰

```java
// åˆ›å»ºäº‹ä»¶æ—¶é—´æµ
DataStream<Event> eventTimeStream = env.addSource(new FlinkKafkaConsumer<>("events", ...))
    .assignTimestampsAndWatermarks(
        WatermarkStrategy.<Event>forBoundedOutOfOrderness(Duration.ofSeconds(10))
            .withTimestampAssigner((event, timestamp) -> event.getTimestamp())
    );

// ä½¿ç”¨äº‹ä»¶æ—¶é—´è¿›è¡Œçª—å£æ“ä½œ
eventTimeStream.keyBy(event -> event.getUserId())
    .window(TumblingEventTimeWindows.of(Time.minutes(5)))
    .aggregate(new CountAggregator());
```

### Table API/SQLä¸­çš„æ—¶é—´è¯­ä¹‰

```java
// å®šä¹‰è¡¨æ—¶æŒ‡å®šäº‹ä»¶æ—¶é—´å­—æ®µ
Table table = tableEnv.fromDataStream(
    eventTimeStream,
    Schema.newBuilder()
        .columnByExpression("ts", "CAST(timestamp AS TIMESTAMP(3))")
        .watermark("ts", "ts - INTERVAL '5' SECOND")
        .build()
);

// åŸºäºäº‹ä»¶æ—¶é—´çš„çª—å£æŸ¥è¯¢
Table result = tableEnv.sqlQuery(
    "SELECT " +
    "TUMBLE_START(ts, INTERVAL '5' MINUTE) as window_start, " +
    "COUNT(*) as count " +
    "FROM table " +
    "GROUP BY TUMBLE(ts, INTERVAL '5' MINUTE)"
);
```

## æ—¶é—´è¯­ä¹‰çš„æœ€ä½³å®è·µ

### 1. é€‰æ‹©åˆé€‚çš„æ—¶é—´è¯­ä¹‰

| åœºæ™¯ç±»å‹ | æ¨èæ—¶é—´è¯­ä¹‰ | åŸå›  |
|---------|-------------|------|
| é‡‘èäº¤æ˜“ | äº‹ä»¶æ—¶é—´ | éœ€è¦ç²¾ç¡®æ—¶é—´æˆ³ |
| å®æ—¶ç›‘æ§ | å¤„ç†æ—¶é—´ | éœ€è¦ä½å»¶è¿Ÿ |
| æ—¥å¿—åˆ†æ | æ‘„å…¥æ—¶é—´ | å¹³è¡¡å‡†ç¡®æ€§å’Œæ€§èƒ½ |
| ç‰©æµè¿½è¸ª | äº‹ä»¶æ—¶é—´ | éœ€è¦åŸºäºå®é™…æ—¶é—´ |

### 2. è®¾ç½®åˆç†çš„å»¶è¿Ÿå®¹å¿

```java
// æ ¹æ®ä¸šåŠ¡ç‰¹æ€§è®¾ç½®å»¶è¿Ÿ
WatermarkStrategy.forBoundedOutOfOrderness(Duration.ofSeconds(30))
    .withTimestampAssigner(...);
```

**ç»éªŒæ³•åˆ™ï¼š**
- äº’è”ç½‘ä¸šåŠ¡ï¼š5-10ç§’
- é‡‘èä¸šåŠ¡ï¼š1-3ç§’
- ç‰©è”ç½‘æ•°æ®ï¼š30ç§’-2åˆ†é’Ÿ

### 3. å¤„ç†è¿Ÿåˆ°æ•°æ®

```java
// å…è®¸è¿Ÿåˆ°æ•°æ®
windowedStream.allowedLateness(Time.minutes(5))
    .sideOutputLateData(lateDataTag)
    .aggregate(...);
```

### 4. ç›‘æ§æ°´ä½çº¿è¿›åº¦

```java
// æ°´ä½çº¿ç›‘æ§
DataStream<Watermark> watermarkStream = ...;
watermarkStream.print("Watermark: ");
```

## å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šçª—å£è®¡ç®—ç»“æœä¸å‡†ç¡®

**åŸå› ï¼š** æ°´ä½çº¿å»¶è¿Ÿè®¾ç½®è¿‡å°ï¼Œå¯¼è‡´éƒ¨åˆ†ä¹±åºæ•°æ®è¢«ä¸¢å¼ƒ  
**è§£å†³ï¼š** å¢åŠ æ°´ä½çº¿å»¶è¿Ÿå®¹å¿æ—¶é—´ï¼Œä½¿ç”¨`allowedLateness`å¤„ç†è¿Ÿåˆ°æ•°æ®

### é—®é¢˜2ï¼šå¤„ç†å»¶è¿Ÿè¿‡é«˜

**åŸå› ï¼š** æ°´ä½çº¿å»¶è¿Ÿè®¾ç½®è¿‡å¤§ï¼Œå¯¼è‡´çª—å£è®¡ç®—å»¶è¿Ÿ  
**è§£å†³ï¼š** è¯„ä¼°å®é™…æ•°æ®å»¶è¿Ÿæƒ…å†µï¼Œåˆç†è®¾ç½®å»¶è¿Ÿæ—¶é—´

### é—®é¢˜3ï¼šæ—¶é—´æˆ³è§£æé”™è¯¯

**åŸå› ï¼š** äº‹ä»¶æ—¶é—´æˆ³è§£æä¸æ­£ç¡®ï¼Œå¯¼è‡´æ°´ä½çº¿å¼‚å¸¸  
**è§£å†³ï¼š** éªŒè¯æ•°æ®æºæ—¶é—´æˆ³æ ¼å¼ï¼Œä½¿ç”¨`TimestampExtractor`è‡ªå®šä¹‰è§£æé€»è¾‘

## ç»“è¯­

æ—¶é—´è¯­ä¹‰æ˜¯Flinkæµå¤„ç†çš„æ ¸å¿ƒæ”¯æŸ±ï¼Œæ­£ç¡®ç†è§£å’Œä½¿ç”¨æ—¶é—´è¯­ä¹‰æ˜¯æ„å»ºå¯é å®æ—¶è®¡ç®—ç³»ç»Ÿçš„å…³é”®ã€‚é€šè¿‡åˆç†é€‰æ‹©å¤„ç†æ—¶é—´ã€äº‹ä»¶æ—¶é—´æˆ–æ‘„å…¥æ—¶é—´ï¼Œé…ç½®åˆé€‚çš„æ°´ä½çº¿ç­–ç•¥ï¼Œå¹¶éµå¾ªæœ€ä½³å®è·µï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºå‡ºæ—¢å‡†ç¡®åˆé«˜æ•ˆçš„æµå¤„ç†åº”ç”¨ã€‚

> ğŸš€ "æŒæ¡Flinkæ—¶é—´è¯­ä¹‰ï¼Œå°±æŒæ¡äº†æµå¤„ç†çš„æ—¶é—´ä¹‹é’¥ â€”â€” è®©æ•°æ®åœ¨æ­£ç¡®çš„æ—¶é—´å±•ç°æ­£ç¡®çš„ä»·å€¼"

åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©åˆé€‚çš„æ—¶é—´è¯­ä¹‰ï¼Œå¹¶é€šè¿‡ç›‘æ§å’Œè°ƒä¼˜ä¸æ–­ä¼˜åŒ–æ—¶é—´å¤„ç†æœºåˆ¶ã€‚éšç€ä¸šåŠ¡å¤æ‚åº¦çš„å¢åŠ ï¼Œæ—¶é—´è¯­ä¹‰çš„æ­£ç¡®ä½¿ç”¨å°†æˆä¸ºåŒºåˆ†æ™®é€šæµå¤„ç†ç³»ç»Ÿå’Œä¸“ä¸šçº§æµå¤„ç†å¹³å°çš„å…³é”®å› ç´ ã€‚

---

**æ‰©å±•é˜…è¯»ï¼š**
- [Flinkå®˜æ–¹æ–‡æ¡£ï¼šæ—¶é—´è¯­ä¹‰ä¸æ°´ä½çº¿](https://nightlies.apache.org/flink/flink-docs-stable/docs/concepts/time/)
- [æµå¤„ç†ä¸­çš„æ—¶é—´è¯­ä¹‰ï¼šä»ç†è®ºåˆ°å®è·µ](https://www.infoq.cn/article/time-in-stream-processing)
- [Flinkæ°´ä½çº¿æœºåˆ¶æ·±åº¦è§£æ](https://zhuanlan.zhihu.com/p/343529943)