```yaml
---
title: GitOpsï¼šå£°æ˜å¼åŸºç¡€è®¾æ–½ç®¡ç†çš„æœªæ¥
date: 2023-11-15 10:30:00
permalink: /pages/gitops-declarative-infrastructure/
categories: 
  - DevOps
tags:
  - GitOps
  - IaC
  - Kubernetes
  - DevOps
author: 
  name: Jorgen
  link: https://github.com/jorgen-zhao
---
```

## å‰è¨€

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯Jorgenï¼ä»Šå¤©æˆ‘æƒ³å’Œå¤§å®¶èŠèŠä¸€ä¸ªåœ¨DevOpsé¢†åŸŸè¶Šæ¥è¶Šç«çš„æ¦‚å¿µâ€”â€”GitOpsã€‚ğŸ”¥ å¦‚æœä½ å·²ç»ç†Ÿæ‚‰äº†åŸºç¡€è®¾æ–½å³ä»£ç (IaC)ï¼Œé‚£ä¹ˆGitå¯¹ä½ æ¥è¯´åº”è¯¥ä¸é™Œç”Ÿï¼Œä½†GitOpsä¸ä»…ä»…æ˜¯æŠŠä½ çš„é…ç½®æ–‡ä»¶æ”¾åœ¨Gitä»“åº“é‡Œé‚£ä¹ˆç®€å•ã€‚

::: tip
GitOpsæ˜¯ä¸€ç§ç°ä»£åŒ–çš„è¿ç»´æ¨¡å¼ï¼Œå®ƒä½¿ç”¨Gitä½œä¸ºå£°æ˜å¼åŸºç¡€è®¾æ–½å’Œåº”ç”¨ç¨‹åºçš„å”¯ä¸€çœŸå®æ¥æºã€‚
:::

ä½œä¸ºä¸€åDevOpså®è·µè€…ï¼Œæˆ‘æ›¾ç»åœ¨ä¼ ç»ŸIaCå’Œæ‰‹åŠ¨è¿ç»´ä¹‹é—´æŒ£æ‰ï¼Œç›´åˆ°å‘ç°äº†GitOpsè¿™ä¸ª"ç¥å™¨"ã€‚ä»Šå¤©ï¼Œæˆ‘æƒ³å’Œå¤§å®¶åˆ†äº«GitOpsçš„æ ¸å¿ƒæ¦‚å¿µã€ä¼˜åŠ¿ä»¥åŠå¦‚ä½•åœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨å®ƒã€‚

## ä»€ä¹ˆæ˜¯GitOpsï¼Ÿ

GitOpsçš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†Gitä»“åº“ä½œä¸ºç³»ç»ŸæœŸæœ›çŠ¶æ€çš„å”¯ä¸€çœŸå®æ¥æºã€‚è¿™æ„å‘³ç€ï¼š

- ç³»ç»Ÿçš„æœŸæœ›çŠ¶æ€ä»¥å£°æ˜å¼çš„æ–¹å¼å­˜å‚¨åœ¨Gitä¸­
- è‡ªåŠ¨åŒ–ç³»ç»Ÿè´Ÿè´£å°†å®é™…çŠ¶æ€ä¸æœŸæœ›çŠ¶æ€åŒæ­¥
- ä»»ä½•å¯¹ç³»ç»Ÿçš„å˜æ›´éƒ½å¿…é¡»é€šè¿‡Git Pull Requestæµç¨‹è¿›è¡Œ

å¬èµ·æ¥å¾ˆç®€å•ï¼Œå¯¹å§ï¼Ÿä½†å®ƒçš„å¨åŠ›å¯ä¸å°ï¼ğŸš€

### GitOpsçš„æ ¸å¿ƒåŸåˆ™

1. **å£°æ˜å¼å®šä¹‰**ï¼šç³»ç»Ÿçš„æœŸæœ›çŠ¶æ€ä»¥å£°æ˜æ–¹å¼æè¿°ï¼Œè€Œä¸æ˜¯å‘½ä»¤å¼æ­¥éª¤
2. **ç‰ˆæœ¬æ§åˆ¶**ï¼šGitæä¾›å®Œæ•´çš„å˜æ›´å†å²å’Œç‰ˆæœ¬æ§åˆ¶
3. **è‡ªåŠ¨åŒ–åŒæ­¥**ï¼šè‡ªåŠ¨åŒ–ç³»ç»ŸæŒç»­ç›‘æ§å¹¶ç¡®ä¿å®é™…çŠ¶æ€ä¸æœŸæœ›çŠ¶æ€ä¸€è‡´
4. **åŸºç¡€è®¾æ–½å³ä»£ç **ï¼šæ‰€æœ‰åŸºç¡€è®¾æ–½å®šä¹‰éƒ½ä»¥ä»£ç å½¢å¼å­˜å‚¨
5. **æŒç»­äº¤ä»˜**ï¼šé€šè¿‡è‡ªåŠ¨åŒ–æµç¨‹å®ç°æŒç»­äº¤ä»˜

## GitOps vs ä¼ ç»ŸIaC

ä¼ ç»ŸIaCå’ŒGitOpsæœ‰å¾ˆå¤šç›¸ä¼¼ä¹‹å¤„ï¼Œä½†ä¹Ÿæœ‰ä¸€äº›å…³é”®åŒºåˆ«ï¼š

| ç‰¹æ€§ | ä¼ ç»ŸIaC | GitOps |
|------|--------|--------|
| å˜æ›´æµç¨‹ | æ‰‹åŠ¨æ‰§è¡Œæˆ–é€šè¿‡CI/CDæµæ°´çº¿ | é€šè¿‡Git Pull Request |
| çŠ¶æ€ç®¡ç† | éœ€è¦é¢å¤–å·¥å…·ç®¡ç†çŠ¶æ€ | Gitä½œä¸ºçŠ¶æ€å­˜å‚¨ |
| å®¡è®¡è·Ÿè¸ª | ä¾èµ–äºCI/CDç³»ç»Ÿ | å®Œæ•´çš„Gitå†å²è®°å½• |
| å›æ»šèƒ½åŠ› | ä¾èµ–äºç‰ˆæœ¬æ§åˆ¶å’Œéƒ¨ç½²å·¥å…· | ä½¿ç”¨Gitå†å²è½»æ¾å›æ»š |
| å›¢é˜Ÿåä½œ | ä¾èµ–äºCI/CDæƒé™ç®¡ç† | åŸºäºGitçš„æƒé™å’Œåä½œæ¨¡å¼ |

::: theorem
GitOpså¯ä»¥çœ‹ä½œæ˜¯IaCçš„ä¸€ç§æ¼”è¿›ï¼Œç‰¹åˆ«å¼ºè°ƒä½¿ç”¨Gitå·¥ä½œæµæ¥ç®¡ç†å’ŒåŒæ­¥åŸºç¡€è®¾æ–½çŠ¶æ€ã€‚
:::

## GitOpsçš„ä¼˜åŠ¿

ä¸ºä»€ä¹ˆè¶Šæ¥è¶Šå¤šçš„å›¢é˜Ÿé€‰æ‹©GitOpsï¼Ÿè®©æˆ‘æ¥åˆ†äº«ä¸€äº›å®ƒçš„ä¸»è¦ä¼˜åŠ¿ï¼š

### 1. æé«˜å®‰å…¨æ€§å’Œåˆè§„æ€§

æ‰€æœ‰å˜æ›´éƒ½é€šè¿‡Git Pull Requestè¿›è¡Œï¼Œè¿™æ„å‘³ç€ï¼š
- å˜æ›´éœ€è¦ç»è¿‡åŒè¡Œå®¡æŸ¥
- æ‰€æœ‰å˜æ›´éƒ½æœ‰å®Œæ•´çš„å®¡è®¡è·Ÿè¸ª
- å¯ä»¥è½»æ¾å›æ»šåˆ°ä¹‹å‰çš„ç‰ˆæœ¬

### 2. ç®€åŒ–è¿ç»´æµç¨‹

æƒ³è±¡ä¸€ä¸‹ï¼Œä¸å†éœ€è¦æ‰‹åŠ¨ç™»å½•æœåŠ¡å™¨æˆ–ä½¿ç”¨å¤æ‚çš„éƒ¨ç½²è„šæœ¬ï¼Œåªéœ€è¦æ›´æ–°Gitä»“åº“ï¼Œç³»ç»Ÿå°±ä¼šè‡ªåŠ¨åŒæ­¥åˆ°æœŸæœ›çŠ¶æ€ï¼ğŸ¤¯

### 3. å¢å¼ºå›¢é˜Ÿåä½œ

å¼€å‘äººå‘˜ã€è¿ç»´äººå‘˜å’Œå®‰å…¨ä¸“å®¶å¯ä»¥åœ¨åŒä¸€ä¸ªGitä»“åº“ä¸­åä½œï¼Œä½¿ç”¨ä»–ä»¬ç†Ÿæ‚‰çš„å·¥å…·å’Œæµç¨‹ã€‚

### 4. æé«˜éƒ¨ç½²é€Ÿåº¦å’Œå¯é æ€§

è‡ªåŠ¨åŒ–åŒæ­¥è¿‡ç¨‹å¯ä»¥æ˜¾è‘—å‡å°‘äººä¸ºé”™è¯¯ï¼Œæé«˜éƒ¨ç½²çš„å¯é æ€§ã€‚

## å®è·µGitOpsçš„å¸¸è§å·¥å…·

è¦å®è·µGitOpsï¼Œä½ éœ€è¦ä¸€äº›ç‰¹å®šçš„å·¥å…·ï¼š

### 1. Gitä»“åº“

ä»»ä½•Gitæ‰˜ç®¡æœåŠ¡éƒ½å¯ä»¥ï¼Œå¦‚GitHubã€GitLabã€Bitbucketç­‰ã€‚

### 2. å£°æ˜å¼é…ç½®ç®¡ç†å·¥å…·

- **Kubernetes**ï¼šä½¿ç”¨YAMLæ¸…å•æ–‡ä»¶
- **Terraform**ï¼šç”¨äºç®¡ç†äº‘åŸºç¡€è®¾æ–½
- **Helm**ï¼šç”¨äºKubernetesåº”ç”¨æ‰“åŒ…

### 3. GitOpsæ“ä½œå·¥å…·

- **Argo CD**ï¼šæµè¡Œçš„Kubernetes GitOpså·¥å…·
- **Flux CD**ï¼šå¦ä¸€ä¸ªKubernetes GitOpsè§£å†³æ–¹æ¡ˆ
- **Atlantis**ï¼šç”¨äºTerraformçš„GitOpså·¥å…·

### 4. CI/CDå·¥å…·

ç”¨äºè‡ªåŠ¨åŒ–æµ‹è¯•å’ŒéªŒè¯Pull Requestï¼Œå¦‚GitHub Actionsã€GitLab CIç­‰ã€‚

## å®æˆ˜æ¡ˆä¾‹ï¼šä½¿ç”¨Argo CDå®ç°Kubernetes GitOps

è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå¦‚ä½•ä½¿ç”¨Argo CDåœ¨Kubernetesä¸­å®ç°GitOpsã€‚

### æ­¥éª¤1ï¼šå‡†å¤‡Gitä»“åº“

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªåŒ…å«Kubernetesæ¸…å•çš„Gitä»“åº“ï¼š

```bash
mkdir gitops-demo
cd gitops-demo
git init
echo "# Kubernetes GitOps Demo" > README.md
mkdir manifests
cat <<EOF > manifests/nginx-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.21
        ports:
        - containerPort: 80
EOF
git add .
git commit -m "Initial commit: Add nginx deployment"
git remote add origin https://github.com/yourusername/gitops-demo.git
git push -u origin main
```

### æ­¥éª¤2ï¼šå®‰è£…Argo CD

åœ¨Kubernetesé›†ç¾¤ä¸­å®‰è£…Argo CDï¼š

```bash
kubectl create namespace argocd
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
```

### æ­¥éª¤3ï¼šé…ç½®Argo CDåº”ç”¨

åˆ›å»ºä¸€ä¸ªArgo CD Applicationèµ„æºï¼ŒæŒ‡å‘æˆ‘ä»¬çš„Gitä»“åº“ï¼š

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: nginx-app
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/yourusername/gitops-demo.git
    targetRevision: HEAD
    path: manifests
  destination:
    server: https://kubernetes.default.svc
    namespace: default
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
```

### æ­¥éª¤4ï¼šåŒæ­¥åº”ç”¨

ç°åœ¨ï¼ŒArgo CDä¼šè‡ªåŠ¨å°†Gitä»“åº“ä¸­çš„éƒ¨ç½²åº”ç”¨åˆ°Kubernetesé›†ç¾¤ä¸­ã€‚ä½ å¯ä»¥é€šè¿‡Argo CD UIæˆ–CLIç›‘æ§åŒæ­¥çŠ¶æ€ã€‚

### æ­¥éª¤5ï¼šæ›´æ–°åº”ç”¨

è®©æˆ‘ä»¬æ›´æ–°nginxé•œåƒç‰ˆæœ¬ï¼š

```bash
cat <<EOF > manifests/nginx-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.23  # æ›´æ–°é•œåƒç‰ˆæœ¬
        ports:
        - containerPort: 80
EOF
git add .
git commit -m "Update nginx to version 1.23"
git push
```

Argo CDä¼šæ£€æµ‹åˆ°Gitä»“åº“çš„å˜æ›´ï¼Œå¹¶è‡ªåŠ¨å°†æ›´æ–°åŒæ­¥åˆ°Kubernetesé›†ç¾¤ï¼

## GitOpsé¢ä¸´çš„æŒ‘æˆ˜

è™½ç„¶GitOpsæœ‰å¾ˆå¤šä¼˜åŠ¿ï¼Œä½†å®ƒä¹Ÿé¢ä¸´ä¸€äº›æŒ‘æˆ˜ï¼š

### 1. å¯†é’¥ç®¡ç†

å¦‚ä½•å®‰å…¨åœ°ç®¡ç†æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚æ•°æ®åº“å¯†ç ã€APIå¯†é’¥ï¼‰æ˜¯ä¸€ä¸ªå¸¸è§æŒ‘æˆ˜ã€‚è§£å†³æ–¹æ¡ˆåŒ…æ‹¬ï¼š
- ä½¿ç”¨Kubernetes Secrets
- ä½¿ç”¨å¤–éƒ¨å¯†é’¥ç®¡ç†å·¥å…·å¦‚Vault
- ä½¿ç”¨GitOpså·¥å…·çš„å¯†é’¥ç®¡ç†åŠŸèƒ½

### 2. å­¦ä¹ æ›²çº¿

å¯¹äºä¸ç†Ÿæ‚‰Gitå·¥ä½œæµçš„å›¢é˜Ÿï¼ŒGitOpså¯èƒ½æœ‰ä¸€å®šçš„å­¦ä¹ æ›²çº¿ã€‚

### 3. å·¥å…·é€‰æ‹©

å¸‚åœºä¸Šæœ‰å¤šç§GitOpså·¥å…·ï¼Œé€‰æ‹©é€‚åˆä½ éœ€æ±‚çš„å·¥å…·éœ€è¦ä¸€äº›ç ”ç©¶å’Œè¯•éªŒã€‚

### 4. å¤§è§„æ¨¡éƒ¨ç½²

åœ¨å¤§å‹ç»„ç»‡ä¸­å®æ–½GitOpså¯èƒ½é¢ä¸´ä¸€äº›æ‰©å±•æ€§å’Œæ²»ç†æ–¹é¢çš„æŒ‘æˆ˜ã€‚

## æœªæ¥å±•æœ›

GitOpsæ­£åœ¨å¿«é€Ÿå‘å±•ï¼Œæˆ‘çœ‹å¥½ä»¥ä¸‹å‡ ä¸ªè¶‹åŠ¿ï¼š

1. **å¤šäº‘GitOps**ï¼šæ”¯æŒè·¨å¤šä¸ªäº‘å¹³å°çš„ä¸€è‡´ç®¡ç†
2. **è¾¹ç¼˜è®¡ç®—GitOps**ï¼šå°†GitOpsåŸåˆ™åº”ç”¨åˆ°è¾¹ç¼˜ç¯å¢ƒ
3. **AIè¾…åŠ©çš„GitOps**ï¼šä½¿ç”¨AIæ¥ä¼˜åŒ–GitOpså·¥ä½œæµ
4. **æ›´ç´§å¯†çš„DevSecOpsé›†æˆ**ï¼šå°†å®‰å…¨å®è·µæ›´æ·±å…¥åœ°é›†æˆåˆ°GitOpså·¥ä½œæµä¸­

## ä¸ªäººå»ºè®®

å¦‚æœä½ æ­£åœ¨è€ƒè™‘å¼•å…¥GitOpsåˆ°ä½ çš„ç»„ç»‡ä¸­ï¼Œæˆ‘æœ‰å‡ ç‚¹å»ºè®®ï¼š

1. **ä»å°å¤„å¼€å§‹**ï¼šé€‰æ‹©ä¸€ä¸ªéå…³é”®åº”ç”¨ä½œä¸ºè¯•ç‚¹é¡¹ç›®
2. **æŠ•èµ„åŸ¹è®­**ï¼šç¡®ä¿å›¢é˜Ÿç†è§£Gitå’ŒGitOpsåŸåˆ™
3. **å»ºç«‹æ¸…æ™°çš„æµç¨‹**ï¼šå®šä¹‰Pull Requestæµç¨‹ã€ä»£ç å®¡æŸ¥æ ‡å‡†ç­‰
4. **é€‰æ‹©åˆé€‚çš„å·¥å…·**ï¼šæ ¹æ®ä½ çš„æŠ€æœ¯æ ˆå’Œç»„ç»‡éœ€æ±‚é€‰æ‹©å·¥å…·
5. **å…³æ³¨å®‰å…¨**ï¼šä»ä¸€å¼€å§‹å°±å°†å®‰å…¨è€ƒè™‘çº³å…¥è®¾è®¡

## ç»“è¯­

GitOpsä¸ä»…ä»…æ˜¯ä¸€ç§å·¥å…·æˆ–æŠ€æœ¯ï¼Œå®ƒæ˜¯ä¸€ç§å…¨æ–°çš„è¿ç»´ç†å¿µå’Œå·¥ä½œæ–¹å¼ã€‚é€šè¿‡å°†Gitä½œä¸ºç³»ç»ŸæœŸæœ›çŠ¶æ€çš„å”¯ä¸€çœŸå®æ¥æºï¼ŒGitOpså¯ä»¥å¸®åŠ©æˆ‘ä»¬æ„å»ºæ›´å®‰å…¨ã€æ›´å¯é ã€æ›´é«˜æ•ˆçš„ç³»ç»Ÿã€‚

ä½œä¸ºä¸€åDevOpså®è·µè€…ï¼Œæˆ‘è®¤ä¸ºGitOpsä»£è¡¨äº†åŸºç¡€è®¾æ–½ç®¡ç†çš„ä¸€ä¸ªé‡è¦å‘å±•æ–¹å‘ã€‚å¦‚æœä½ è¿˜æ²¡æœ‰å°è¯•è¿‡GitOpsï¼Œæˆ‘å¼ºçƒˆå»ºè®®ä½ ä»ä¸€ä¸ªå°é¡¹ç›®å¼€å§‹ä½“éªŒå®ƒçš„é­…åŠ›ã€‚

> "GitOpsä¸æ˜¯å…³äºæŠ€æœ¯ï¼Œè€Œæ˜¯å…³äºæµç¨‹å’Œåä½œã€‚å®ƒè®©æˆ‘ä»¬èƒ½å¤Ÿä»¥æ›´é€æ˜ã€æ›´å¯è¿½æº¯çš„æ–¹å¼ç®¡ç†æˆ‘ä»¬çš„åŸºç¡€è®¾æ–½ã€‚"
