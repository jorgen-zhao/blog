---
title: Android Jetpackä¸æ¶æ„ç»„ä»¶-æ„å»ºç°ä»£åŒ–åº”ç”¨
date: 2023-11-15 10:30:00
permalink: /pages/android-jetpack/
categories: 
  - Android
tags:
  - Android
  - Jetpack
  - æ¶æ„ç»„ä»¶
  - MVVM
author: 
  name: Jorgen
  link: https://github.com/jorgen-zhao
---

## å‰è¨€

ä½œä¸ºä¸€åAndroidå¼€å‘è€…ï¼Œä½ æ˜¯å¦æ›¾ç»è¢«Activityå’ŒFragmentçš„ç”Ÿå‘½å‘¨æœŸæå¾—æ™•å¤´è½¬å‘ï¼ŸğŸ¤¯ æ˜¯å¦æ›¾ç»å› ä¸ºå±å¹•æ—‹è½¬å¯¼è‡´æ•°æ®ä¸¢å¤±è€ŒæŠ“ç‹‚ï¼Ÿæˆ–è€…æ˜¯åœ¨æµ‹è¯•UIé€»è¾‘æ—¶æŸæ‰‹æ— ç­–ï¼Ÿ

æˆ‘æ›¾ç»ä¹Ÿæ˜¯è¿™æ ·ï¼Œç›´åˆ°æˆ‘å‘ç°äº†Android Jetpackå’Œæ¶æ„ç»„ä»¶çš„å¼ºå¤§åŠ›é‡ï¼å®ƒä»¬å°±åƒæ˜¯Androidå¼€å‘ç•Œçš„"è¶…çº§è‹±é›„"ï¼Œæ‹¯æ•‘æˆ‘ä»¬äºæ°´æ·±ç«çƒ­ä¹‹ä¸­ã€‚ğŸ˜

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†å¸¦ä½ æ·±å…¥äº†è§£Android Jetpackçš„æ ¸å¿ƒæ¶æ„ç»„ä»¶ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨å®ƒä»¬æ¥æ„å»ºæ›´åŠ å¥å£®ã€å¯æµ‹è¯•å’Œç°ä»£åŒ–çš„Androidåº”ç”¨ã€‚

## ä»€ä¹ˆæ˜¯Android Jetpackï¼Ÿ

Android Jetpackæ˜¯Googleæ¨å‡ºçš„å®˜æ–¹åº“åˆé›†ï¼Œæ—¨åœ¨å¸®åŠ©å¼€å‘è€…ç®€åŒ–ã€åŠ é€ŸAndroidåº”ç”¨å¼€å‘è¿‡ç¨‹ã€‚å®ƒæä¾›äº†ç»è¿‡æµ‹è¯•çš„åº“ã€å·¥å…·å’Œæœ€ä½³å®è·µï¼Œå¸®åŠ©å¼€å‘è€…ç¼–å†™é«˜è´¨é‡çš„åº”ç”¨ã€‚

::: tip
Jetpackç»„ä»¶åˆ†ä¸ºå››ç±»ï¼šåŸºç¡€æ¶æ„ã€è¡Œä¸ºã€ç•Œé¢å’Œæ¨èç»„ä»¶ã€‚æœ¬æ–‡å°†é‡ç‚¹ä»‹ç»åŸºç¡€æ¶æ„ç»„ä»¶ï¼Œå› ä¸ºå®ƒä»¬æ˜¯æ„å»ºç°ä»£Androidåº”ç”¨çš„åŸºç¡€ã€‚
:::

## æ ¸å¿ƒæ¶æ„ç»„ä»¶

### ViewModel

ViewModelæ˜¯Jetpackä¸­æœ€å…·ä»£è¡¨æ€§çš„ç»„ä»¶ä¹‹ä¸€ã€‚å®ƒè´Ÿè´£ä¸ºUIå‡†å¤‡æ•°æ®ï¼Œå¹¶èƒ½å¤Ÿé…ç½®æ›´æ”¹ï¼ˆå¦‚å±å¹•æ—‹è½¬ï¼‰æ—¶å­˜æ´»ä¸‹æ¥ã€‚

```kotlin
class MyViewModel : ViewModel() {
    private val _data = MutableLiveData<String>()
    val data: LiveData<String> = _data

    fun loadData() {
        // åœ¨åå°åŠ è½½æ•°æ®
        viewModelScope.launch {
            val result = apiService.getData()
            _data.value = result
        }
    }
}
```

**ä¼˜ç‚¹**ï¼š
- å±å¹•æ—‹è½¬æ—¶ä¸ä¼šä¸¢å¤±æ•°æ®
- ä¸UIæ§åˆ¶å™¨åˆ†ç¦»ï¼Œä¾¿äºæµ‹è¯•
- è‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸ

### LiveData

LiveDataæ˜¯ä¸€ç§å¯è§‚å¯Ÿçš„æ•°æ®æŒæœ‰è€…ç±»ï¼Œéµå¾ªè§‚å¯Ÿè€…æ¨¡å¼ã€‚å½“ç”Ÿå‘½å‘¨æœŸçŠ¶æ€æ”¹å˜æ—¶ï¼ŒLiveDataä¼šé€šçŸ¥è§‚å¯Ÿè€…ã€‚

```kotlin
val user: LiveData<User> = Transformations.map(database.userDao().getUser(userId)) { 
    user -> 
    // å¯¹æ•°æ®è¿›è¡Œè½¬æ¢
    user.name = "${user.name} (Updated)"
    user
}
```

**ç‰¹ç‚¹**ï¼š
- æ•°æ®å˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°UI
- ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥ï¼Œåªåœ¨æ´»è·ƒçŠ¶æ€ä¸‹é€šçŸ¥è§‚å¯Ÿè€…
- é˜²æ­¢å†…å­˜æ³„æ¼

### RoomæŒä¹…åŒ–åº“

Roomæ˜¯ä¸€ä¸ªå¯¹è±¡æ˜ å°„åº“ï¼Œæä¾›äº†æœ¬åœ°æ•°æ®åº“åŠŸèƒ½ï¼Œå¯ä»¥åœ¨è®¾å¤‡ä¸ŠæŒä¹…åŒ–åº”ç”¨æ•°æ®ã€‚

```kotlin
@Entity
data class User(
    @PrimaryKey val uid: Int,
    @ColumnInfo(name = "first_name") firstName: String?,
    @ColumnInfo(name = "last_name") lastName: String?
)

@Dao
interface UserDao {
    @Query("SELECT * FROM user")
    fun getAllUsers(): List<User>
}

@Database(entities = [User::class], version = 1)
abstract class AppDatabase : RoomDatabase() {
    abstract fun userDao(): UserDao
}
```

**ä¼˜åŠ¿**ï¼š
- ç¼–è¯‘æ—¶SQLéªŒè¯ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯
- ç®€åŒ–æ•°æ®åº“æ“ä½œ
- æ”¯æŒRxJavaã€Flowå’ŒLiveData

### Data Binding

Data Bindingåº“å…è®¸ä½ å°†UIç»„ä»¶ç»‘å®šåˆ°æ•°æ®æºï¼Œå‡å°‘æ ·æ¿ä»£ç ï¼Œæé«˜å¯ç»´æŠ¤æ€§ã€‚

```xml
<layout xmlns:android="http://schemas.android.com/apk/res/android">
    <data>
        <variable
            name="user"
            type="com.example.User" />
    </data>
    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        android:orientation="vertical">
        <TextView
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="@{user.firstName}" />
        <TextView
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="@{user.lastName}" />
    </LinearLayout>
</layout>
```

### Navigation Component

Navigationç»„ä»¶ç”¨äºå®ç°åº”ç”¨å†…çš„å¯¼èˆªï¼Œç®€åŒ–äº†Fragmentä¹‹é—´çš„å¯¼èˆªé€»è¾‘ã€‚

```kotlin
val navController = findNavController(R.id.nav_host_fragment)
navController.navigate(R.id.action_firstFragment_to_secondFragment)
```

## MVVMæ¶æ„æ¨¡å¼

ç»“åˆä¸Šè¿°ç»„ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºç°ä»£åŒ–çš„MVVMï¼ˆModel-View-ViewModelï¼‰æ¶æ„ï¼š

![MVVMæ¶æ„å›¾](/images/mvvm-architecture.png)

1. **Model**ï¼šè¡¨ç¤ºæ•°æ®å’Œä¸šåŠ¡é€»è¾‘ï¼Œé€šå¸¸åŒ…æ‹¬Repositoryå’Œæ•°æ®æºï¼ˆå¦‚Roomæ•°æ®åº“ï¼‰
2. **View**ï¼šXMLå¸ƒå±€å’ŒActivity/Fragmentï¼Œè´Ÿè´£æ˜¾ç¤ºæ•°æ®å’Œç”¨æˆ·äº¤äº’
3. **ViewModel**ï¼šä½œä¸ºViewå’ŒModelä¹‹é—´çš„æ¡¥æ¢ï¼Œå¤„ç†ä¸šåŠ¡é€»è¾‘å¹¶æä¾›æ•°æ®ç»™View

::: theorem MVVMçš„ä¼˜åŠ¿
- å…³æ³¨ç‚¹åˆ†ç¦»ï¼šå„ç»„ä»¶èŒè´£æ˜ç¡®
- å¯æµ‹è¯•æ€§ï¼šViewModelå’ŒModelä¸ä¾èµ–äºAndroidæ¡†æ¶ï¼Œæ˜“äºæµ‹è¯•
- å¯ç»´æŠ¤æ€§ï¼šä»£ç ç»“æ„æ¸…æ™°ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•
:::

## å®æˆ˜æ¡ˆä¾‹ï¼šç”¨æˆ·åˆ—è¡¨åº”ç”¨

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ç”¨æˆ·åˆ—è¡¨åº”ç”¨æ¥å®è·µè¿™äº›ç»„ä»¶ã€‚

### 1. æ·»åŠ ä¾èµ–

```gradle
dependencies {
    // ViewModel
    implementation "androidx.lifecycle:lifecycle-viewmodel-ktx:2.6.1"
    
    // LiveData
    implementation "androidx.lifecycle:lifecycle-livedata-ktx:2.6.1"
    
    // Room
    implementation "androidx.room:room-runtime:2.5.1"
    kapt "androidx.room:room-compiler:2.5.1"
    
    // Data Binding
    implementation "androidx.databinding:databinding-runtime:8.0.1"
    
    // Navigation
    implementation "androidx.navigation:navigation-fragment-ktx:2.5.3"
    implementation "androidx.navigation:navigation-ui-ktx:2.5.3"
}
```

### 2. åˆ›å»ºæ•°æ®æ¨¡å‹

```kotlin
@Entity(tableName = "users")
data class User(
    @PrimaryKey val id: Int,
    @ColumnInfo(name = "name") val name: String,
    @ColumnInfo(name = "email") val email: String
)

@Dao
interface UserDao {
    @Query("SELECT * FROM users")
    fun getAllUsers(): LiveData<List<User>>
    
    @Insert
    suspend fun insertAll(users: List<User>)
}

@Database(entities = [User::class], version = 1)
abstract class AppDatabase : RoomDatabase() {
    abstract fun userDao(): UserDao
    
    companion object {
        @Volatile
        private var INSTANCE: AppDatabase? = null
        
        fun getDatabase(context: Context): AppDatabase {
            return INSTANCE ?: synchronized(this) {
                val instance = Room.databaseBuilder(
                    context.applicationContext,
                    AppDatabase::class.java,
                    "user_database"
                ).build()
                INSTANCE = instance
                instance
            }
        }
    }
}
```

### 3. åˆ›å»ºRepository

```kotlin
class UserRepository(private val userDao: UserDao) {
    val allUsers: LiveData<List<User>> = userDao.getAllUsers()
    
    suspend fun refreshUsers() {
        // ä»ç½‘ç»œè·å–ç”¨æˆ·æ•°æ®
        val users = apiService.getUsers()
        // æ’å…¥åˆ°æ•°æ®åº“
        userDao.insertAll(users)
    }
}
```

### 4. åˆ›å»ºViewModel

```kotlin
class UserViewModel(private val repository: UserRepository) : ViewModel() {
    val users: LiveData<List<User>> = repository.allUsers
    
    fun refreshUsers() {
        viewModelScope.launch {
            repository.refreshUsers()
        }
    }
    
    class Factory(private val repository: UserRepository) : ViewModelProvider.Factory {
        override fun <T : ViewModel> create(modelClass: Class<T>): T {
            if (modelClass.isAssignableFrom(UserViewModel::class.java)) {
                @Suppress("UNCHECKED_CAST")
                return UserViewModel(repository) as T
            }
            throw IllegalArgumentException("Unknown ViewModel class")
        }
    }
}
```

### 5. åˆ›å»ºUI

```xml
<!-- activity_main.xml -->
<layout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    xmlns:tools="http://schemas.android.com/tools">
    
    <data>
        <variable
            name="viewModel"
            type="com.example.UserViewModel" />
    </data>
    
    <androidx.constraintlayout.widget.ConstraintLayout
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        tools:context=".MainActivity">
        
        <androidx.recyclerview.widget.RecyclerView
            android:id="@+id/userRecyclerView"
            android:layout_width="0dp"
            android:layout_height="0dp"
            app:layout_constraintTop_toTopOf="parent"
            app:layout_constraintBottom_toBottomOf="parent"
            app:layout_constraintStart_toStartOf="parent"
            app:layout_constraintEnd_toEndOf="parent"
            app:listData="@{viewModel.users}" />
            
        <Button
            android:id="@+id/refreshButton"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="åˆ·æ–°æ•°æ®"
            android:onClick="@{() -> viewModel.refreshUsers()}"
            app:layout_constraintBottom_toBottomOf="parent"
            app:layout_constraintEnd_toEndOf="parent"
            app:layout_constraintStart_toStartOf="parent" />
            
    </androidx.constraintlayout.widget.ConstraintLayout>
</layout>
```

### 6. åœ¨Activityä¸­ç»‘å®šViewModel

```kotlin
class MainActivity : AppCompatActivity() {
    private lateinit var binding: ActivityMainBinding
    private lateinit var viewModel: UserViewModel
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        
        binding = DataBindingUtil.setContentView(this, R.layout.activity_main)
        
        val database = AppDatabase.getDatabase(this)
        val repository = UserRepository(database.userDao())
        
        viewModel = ViewModelProvider(
            this,
            UserViewModel.Factory(repository)
        ).get(UserViewModel::class.java)
        
        binding.viewModel = viewModel
        binding.lifecycleOwner = this
        
        // è®¾ç½®RecyclerViewé€‚é…å™¨
        binding.userRecyclerView.layoutManager = LinearLayoutManager(this)
        binding.userRecyclerView.adapter = UserAdapter()
    }
}
```

## æœ€ä½³å®è·µ

1. **å•ä¸€èŒè´£åŸåˆ™**ï¼šæ¯ä¸ªç»„ä»¶åªè´Ÿè´£ä¸€é¡¹ä»»åŠ¡
2. **ä¾èµ–æ³¨å…¥**ï¼šä½¿ç”¨Hiltæˆ–Daggerç®¡ç†ä¾èµ–å…³ç³»
3. **é”™è¯¯å¤„ç†**ï¼šä½¿ç”¨`try-catch`å—å¤„ç†å¼‚å¸¸ï¼Œå¹¶å‘ç”¨æˆ·æ˜¾ç¤ºé€‚å½“çš„é”™è¯¯æ¶ˆæ¯
4. **æµ‹è¯•**ï¼šä¸ºViewModelç¼–å†™å•å…ƒæµ‹è¯•ï¼Œä¸ºUIç¼–å†™UIæµ‹è¯•
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨`DiffUtil`ä¼˜åŒ–RecyclerViewæ›´æ–°ï¼Œé¿å…ä¸å¿…è¦çš„UIæ›´æ–°

## å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šViewModelä¸æ›´æ–°UI

**åŸå› **ï¼šLiveDataæ²¡æœ‰è¢«æ­£ç¡®è§‚å¯Ÿï¼Œæˆ–è€…æ•°æ®æ²¡æœ‰é€šè¿‡`setValue()`æˆ–`postValue()`æ–¹æ³•æ›´æ–°

**è§£å†³æ–¹æ¡ˆ**ï¼š
```kotlin
// é”™è¯¯æ–¹å¼
_data.value = newData // åœ¨ä¸»çº¿ç¨‹å¤–è°ƒç”¨ä¼šå´©æºƒ

// æ­£ç¡®æ–¹å¼
if (Looper.myLooper() == Looper.getMainLooper()) {
    _data.value = newData
} else {
    _data.postValue(newData)
}
```

### é—®é¢˜2ï¼šRoomæ•°æ®åº“æŸ¥è¯¢åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œ

**åŸå› **ï¼šRoomä¸å…è®¸åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œè€—æ—¶æ“ä½œ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```kotlin
// ä½¿ç”¨åç¨‹åœ¨IOçº¿ç¨‹æ‰§è¡Œ
viewModelScope.launch(Dispatchers.IO) {
    val users = database.userDao().getAllUsersSync()
    withContext(Dispatchers.Main) {
        // æ›´æ–°UI
    }
}
```

## ç»“è¯­

Android Jetpackå’Œæ¶æ„ç»„ä»¶ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€å¥—å¼ºå¤§çš„å·¥å…·ï¼Œå¸®åŠ©æˆ‘ä»¬æ„å»ºæ›´åŠ å¥å£®ã€å¯æµ‹è¯•å’Œç°ä»£åŒ–çš„Androidåº”ç”¨ã€‚é€šè¿‡é‡‡ç”¨MVVMæ¶æ„æ¨¡å¼ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°æ›´å¥½çš„å…³æ³¨ç‚¹åˆ†ç¦»ï¼Œæé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯æµ‹è¯•æ€§ã€‚

è™½ç„¶å­¦ä¹ è¿™äº›ç»„ä»¶éœ€è¦ä¸€äº›æ—¶é—´æŠ•å…¥ï¼Œä½†ç›¸ä¿¡æˆ‘ï¼Œè¿™æ˜¯å€¼å¾—çš„ï¼~~æˆ‘æ›¾ç»ä¹Ÿæ˜¯ä¸€å"å›ºæ‰§"çš„MVPæ¶æ„æ‹¥æŠ¤è€…ï¼Œä½†è‡ªä»è½¬å‘Jetpackåï¼Œæˆ‘å†ä¹Ÿä¸æƒ³å›å»äº†~~ã€‚ğŸ˜‰

å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£å’Œä½¿ç”¨Android Jetpackå’Œæ¶æ„ç»„ä»¶ã€‚å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºç•™è¨€äº¤æµï¼

> "ä»£ç æ˜¯å†™ç»™äººçœ‹çš„ï¼Œé¡ºä¾¿èƒ½åœ¨æœºå™¨ä¸Šè¿è¡Œã€‚" â€”â€” Donald Knuth

è®©æˆ‘ä»¬ç”¨Jetpackå’Œæ¶æ„ç»„ä»¶æ„å»ºæ›´åŠ å‡ºè‰²çš„Androidåº”ç”¨å§ï¼ğŸš€