---
title: Androidåº”ç”¨çŠ¶æ€ç®¡ç†ï¼šä»LiveDataåˆ°ComposeçŠ¶æ€ç®¡ç†çš„æ¼”è¿›ä¹‹è·¯
date: 2026-02-04
tags: [Android, Jetpack, çŠ¶æ€ç®¡ç†]
---

## å‰è¨€

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯Jorgenï¼ğŸ‘‹ åœ¨Androidå¼€å‘çš„ä¸–ç•Œé‡Œï¼ŒçŠ¶æ€ç®¡ç†å¯ä»¥è¯´æ˜¯æ¯ä¸ªå¼€å‘è€…éƒ½å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæŠ€èƒ½ã€‚ä»æœ€åˆçš„`Handler`ã€`EventBus`ï¼Œåˆ°åæ¥çš„`LiveData`ï¼Œå†åˆ°ç°åœ¨çš„`Jetpack Compose`çŠ¶æ€ç®¡ç†ï¼ŒAndroidçš„çŠ¶æ€ç®¡ç†æ–¹å¼ä¸€ç›´åœ¨ä¸æ–­æ¼”è¿›ã€‚

ä»Šå¤©ï¼Œæˆ‘æƒ³å’Œå¤§å®¶ä¸€èµ·æ¢è®¨Androidåº”ç”¨çŠ¶æ€ç®¡ç†çš„å®Œæ•´æ¼”è¿›å†ç¨‹ï¼Œä»¥åŠå¦‚ä½•åœ¨ç°ä»£Androidå¼€å‘ä¸­ä¼˜é›…åœ°ç®¡ç†åº”ç”¨çŠ¶æ€ã€‚å¦‚æœä½ ä¹Ÿæ›¾åœ¨çŠ¶æ€ç®¡ç†ä¸­è¸©è¿‡å‘ï¼Œæˆ–è€…å¯¹å¦‚ä½•é€‰æ‹©åˆé€‚çš„çŠ¶æ€ç®¡ç†æ–¹æ¡ˆæ„Ÿåˆ°å›°æƒ‘ï¼Œé‚£ä¹ˆè¿™ç¯‡æ–‡ç« æˆ–è®¸èƒ½ç»™ä½ ä¸€äº›å¯å‘ã€‚

::: tip
çŠ¶æ€ç®¡ç†æ˜¯æ„å»ºå“åº”å¼UIçš„å…³é”®ï¼Œé€‰æ‹©åˆé€‚çš„çŠ¶æ€ç®¡ç†æ–¹å¼å¯ä»¥æ˜¾è‘—æå‡åº”ç”¨çš„å¯ç»´æŠ¤æ€§å’Œæ€§èƒ½ã€‚
:::

## AndroidçŠ¶æ€ç®¡ç†çš„æ¼”è¿›

### æ—©æœŸï¼šæ‰‹åŠ¨ç®¡ç†ä¸å›è°ƒåœ°ç‹±

è¿˜è®°å¾—æ—©æœŸAndroidå¼€å‘çš„æ—¥å­å—ï¼Ÿæˆ‘ä»¬ç»å¸¸éœ€è¦æ‰‹åŠ¨ç®¡ç†UIçŠ¶æ€ï¼Œå¤„ç†å„ç§å›è°ƒï¼Œä»£ç å¾€å¾€åƒè¿™æ ·ï¼š

```kotlin
// æ—©æœŸçš„å›è°ƒåœ°ç‹±
button.setOnClickListener {
    loading = true
    api.getData(object : Callback<Data> {
        override fun onSuccess(data: Data) {
            loading = false
            updateUI(data)
        }
        
        override fun onFailure(error: Throwable) {
            loading = false
            showError(error)
        }
    })
}
```

è¿™ç§æ–¹å¼ä¸ä»…ä»£ç å†—é•¿ï¼Œè€Œä¸”å®¹æ˜“å‡ºé”™ï¼Œç»´æŠ¤èµ·æ¥ä¹Ÿéå¸¸å›°éš¾ã€‚è¿™å°±æ˜¯æ‰€è°“çš„"å›è°ƒåœ°ç‹±"ï¼Œè®©è®¸å¤šå¼€å‘è€…è‹¦ä¸å ªè¨€ã€‚

### LiveDataï¼šå“åº”å¼ç¼–ç¨‹çš„å¼•å…¥

éšç€Android Architecture Componentsçš„æ¨å‡ºï¼Œ`LiveData`æˆä¸ºäº†AndroidçŠ¶æ€ç®¡ç†çš„æ–°æ ‡å‡†ã€‚å®ƒæä¾›äº†ä¸€ç§è§‚å¯Ÿè€…æ¨¡å¼ï¼Œä½¿å¾—UIå¯ä»¥è‡ªåŠ¨å“åº”æ•°æ®å˜åŒ–ï¼š

```kotlin
// ä½¿ç”¨LiveData
val data: LiveData<Data> = MutableLiveData()

data.observe(this, Observer { newData ->
    updateUI(newData)
})
```

`LiveData`è§£å†³äº†è®¸å¤šæ‰‹åŠ¨çŠ¶æ€ç®¡ç†çš„é—®é¢˜ï¼Œä½†å®ƒä¹Ÿæœ‰ä¸€äº›å±€é™æ€§ï¼š

1. åªèƒ½åœ¨ä¸»çº¿ç¨‹æ›´æ–°
2. éœ€è¦ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥
3. åœ¨Fragmentä¸­å®¹æ˜“é‡å¤æ³¨å†Œè§‚å¯Ÿè€…

### ViewModelï¼šä¸UIåˆ†ç¦»çš„çŠ¶æ€å®¹å™¨

ä¸ºäº†è¿›ä¸€æ­¥æ”¹å–„çŠ¶æ€ç®¡ç†ï¼Œ`ViewModel`åº”è¿è€Œç”Ÿã€‚å®ƒå…è®¸æˆ‘ä»¬å°†UIçŠ¶æ€ä¸UIåˆ†ç¦»ï¼Œå³ä½¿å±å¹•æ—‹è½¬ä¹Ÿèƒ½ä¿æŒçŠ¶æ€ï¼š

```kotlin
class MyViewModel : ViewModel() {
    private val _data = MutableLiveData<Data>()
    val data: LiveData<Data> = _data
    
    fun loadData() {
        viewModelScope.launch {
            val result = api.getData()
            _data.value = result
        }
    }
}
```

### StateFlowï¼šæ›´ç°ä»£çš„å“åº”å¼çŠ¶æ€

éšç€Kotlinåç¨‹çš„å‘å±•ï¼Œ`StateFlow`æˆä¸ºäº†`LiveData`çš„ç°ä»£åŒ–æ›¿ä»£æ–¹æ¡ˆã€‚å®ƒæä¾›äº†æ›´å¼ºå¤§çš„åŠŸèƒ½å’Œæ›´å¥½çš„æ€§èƒ½ï¼š

```kotlin
// ä½¿ç”¨StateFlow
private val _uiState = MutableStateFlow(UiState())
val uiState: StateFlow<UiState> = _uiState

fun loadData() {
    viewModelScope.launch {
        _uiState.value = _uiState.value.copy(loading = true)
        try {
            val data = api.getData()
            _uiState.value = _uiState.value.copy(data = data, loading = false)
        } catch (e: Exception) {
            _uiState.value = _uiState.value.copy(error = e, loading = false)
        }
    }
}
```

`StateFlow`ç›¸æ¯”`LiveData`æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

1. æ”¯æŒåç¨‹ï¼Œå¯ä»¥åœ¨ä»»ä½•çº¿ç¨‹æ›´æ–°
2. ç±»å‹æ›´å®‰å…¨ï¼Œä¸ä¼šå‡ºç°nullå€¼é—®é¢˜
3. å¯ä»¥ç»„åˆå¤šä¸ªæµ
4. æ›´å¥½çš„æ€§èƒ½

## Jetpack Composeä¸­çš„çŠ¶æ€ç®¡ç†

éšç€Jetpack Composeçš„æ¨å‡ºï¼ŒAndroidçš„çŠ¶æ€ç®¡ç†æ–¹å¼åˆå‘ç”Ÿäº†é©å‘½æ€§çš„å˜åŒ–ã€‚åœ¨Composeä¸­ï¼ŒçŠ¶æ€ç®¡ç†æ›´åŠ ç®€æ´å’Œå£°æ˜å¼ã€‚

### rememberå’ŒmutableStateOf

åœ¨Composeä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`remember`å’Œ`mutableStateOf`æ¥åˆ›å»ºå¯è§‚å¯Ÿçš„çŠ¶æ€ï¼š

```kotlin
@Composable
fun MyScreen() {
    var count by remember { mutableStateOf(0) }
    
    Button(onClick = { count++ }) {
        Text("Count: $count")
    }
}
```

å½“`count`å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒComposeä¼šè‡ªåŠ¨é‡ç»„å—å½±å“çš„UIéƒ¨åˆ†ã€‚

### ViewModelåœ¨Composeä¸­çš„ä½¿ç”¨

åœ¨Composeåº”ç”¨ä¸­ï¼Œæˆ‘ä»¬ä»ç„¶å¯ä»¥ä½¿ç”¨ViewModelæ¥ç®¡ç†æ›´å¤æ‚çš„çŠ¶æ€ï¼š

```kotlin
@Composable
fun MyScreen(viewModel: MyViewModel = viewModel()) {
    val uiState by viewModel.uiState.collectAsState()
    
    when {
        uiState.loading -> LoadingIndicator()
        uiState.error -> ErrorMessage(uiState.error)
        else -> Content(uiState.data)
    }
}
```

### StateFlowåœ¨Composeä¸­çš„é›†æˆ

`StateFlow`å¯ä»¥å¾ˆå¥½åœ°ä¸Composeé›†æˆï¼Œä½¿ç”¨`collectAsState()`æ‰©å±•å‡½æ•°ï¼š

```kotlin
// åœ¨ViewModelä¸­
private val _uiState = MutableStateFlow(UiState())
val uiState: StateFlow<UiState> = _uiState

// åœ¨Composableä¸­
@Composable
fun MyScreen(viewModel: MyViewModel = viewModel()) {
    val uiState by viewModel.uiState.collectAsState()
    
    // æ ¹æ®uiStateæ›´æ–°UI
}
```

### MVIæ¶æ„æ¨¡å¼

åœ¨Composeä¸­ï¼ŒMVI(Model-View-Intent)æ¶æ„æ¨¡å¼å˜å¾—æ›´åŠ æµè¡Œã€‚è¿™ç§æ¨¡å¼å°†åº”ç”¨çŠ¶æ€è§†ä¸ºä¸å¯å˜çš„ï¼Œé€šè¿‡Intentæ¥è§¦å‘çŠ¶æ€æ›´æ–°ï¼š

```kotlin
// å®šä¹‰çŠ¶æ€
data class UiState(
    val data: Data? = null,
    val loading: Boolean = false,
    val error: Throwable? = null
)

// å®šä¹‰Intent
sealed class UiIntent {
    object LoadData : UiIntent()
    class RefreshData : UiIntent()
}

// åœ¨ViewModelä¸­
class MyViewModel : ViewModel() {
    private val _uiState = MutableStateFlow(UiState())
    val uiState: StateFlow<UiState> = _uiState
    
    fun handleIntent(intent: UiIntent) {
        when (intent) {
            is UiIntent.LoadData -> loadData()
            is UiIntent.RefreshData -> refreshData()
        }
    }
    
    private fun loadData() {
        viewModelScope.launch {
            _uiState.value = _uiState.value.copy(loading = true)
            try {
                val data = api.getData()
                _uiState.value = _uiState.value.copy(data = data, loading = false)
            } catch (e: Exception) {
                _uiState.value = _uiState.value.copy(error = e, loading = false)
            }
        }
    }
}
```

## çŠ¶æ€ç®¡ç†çš„æœ€ä½³å®è·µ

### 1. çŠ¶æ€æå‡åŸåˆ™

åœ¨Composeä¸­ï¼Œå°½é‡å°†çŠ¶æ€æå‡åˆ°å°½å¯èƒ½é«˜çš„å±‚æ¬¡ï¼Œä»¥ä¾¿å¤šä¸ªç»„ä»¶å¯ä»¥å…±äº«ç›¸åŒçš„çŠ¶æ€ï¼š

```kotlin
@Composable
fun ParentScreen() {
    val sharedState = remember { mutableStateOf(0) }
    
    ChildA(sharedState.value) { sharedState.value = it }
    ChildB(sharedState.value)
}
```

### 2. é¿å…è¿‡åº¦é‡ç»„

ä½¿ç”¨`remember`å’Œ`derivedStateOf`æ¥é¿å…ä¸å¿…è¦çš„é‡ç»„ï¼š

```kotlin
@Composable
fun MyScreen() {
    val count by remember { mutableStateOf(0) }
    val isEven by remember(count) { derivedStateOf { count % 2 == 0 } }
    
    Text("Count: $count")
    if (isEven) {
        Text("Even number!")
    }
}
```

### 3. ä½¿ç”¨çŠ¶æ€å®¹å™¨ç®¡ç†å¤æ‚çŠ¶æ€

å¯¹äºå¤æ‚çš„çŠ¶æ€ï¼Œä½¿ç”¨çŠ¶æ€å®¹å™¨ç±»ï¼š

```kotlin
data class MyUiState(
    val data: List<Item> = emptyList(),
    val loading: Boolean = false,
    val error: String? = null
)

class MyViewModel : ViewModel() {
    private val _uiState = MutableStateFlow(MyUiState())
    val uiState: StateFlow<MyUiState> = _uiState
    
    fun loadData() {
        viewModelScope.launch {
            _uiState.value = _uiState.value.copy(loading = true)
            try {
                val data = api.getData()
                _uiState.value = _uiState.value.copy(data = data, loading = false)
            } catch (e: Exception) {
                _uiState.value = _uiState.value.copy(error = e.message, loading = false)
            }
        }
    }
}
```

### 4. ä½¿ç”¨ä¾èµ–æ³¨å…¥ç®¡ç†ViewModel

ä½¿ç”¨Hiltæˆ–Koinç­‰ä¾èµ–æ³¨å…¥æ¡†æ¶æ¥ç®¡ç†ViewModelçš„ç”Ÿå‘½å‘¨æœŸå’Œä¾èµ–å…³ç³»ï¼š

```kotlin
@HiltViewModel
class MyViewModel @Inject constructor(
    private val api: MyApi
) : ViewModel() {
    // ViewModelå®ç°
}
```

## çŠ¶æ€ç®¡ç†å·¥å…·å¯¹æ¯”

| ç‰¹æ€§ | LiveData | StateFlow | ComposeçŠ¶æ€ |
|------|---------|----------|------------|
| çº¿ç¨‹å®‰å…¨ | æ˜¯ | æ˜¯ | æ˜¯ |
| ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥ | æ˜¯ | å¦ | å¦ |
| ç±»å‹å®‰å…¨ | éƒ¨åˆ† | æ˜¯ | æ˜¯ |
| æ”¯æŒåç¨‹ | å¦ | æ˜¯ | æ˜¯ |
| æ€§èƒ½ | ä¸­ç­‰ | é«˜ | é«˜ |
| é€‚ç”¨åœºæ™¯ | ä¼ ç»ŸUI | ç°ä»£UI | Compose UI |

## ç»“è¯­

ä»æ—©æœŸçš„æ‰‹åŠ¨ç®¡ç†åˆ°ç°ä»£çš„å“åº”å¼çŠ¶æ€ç®¡ç†ï¼ŒAndroidçš„çŠ¶æ€ç®¡ç†æ–¹å¼ç»å†äº†å·¨å¤§çš„å˜é©ã€‚ğŸš€ æ¯ä¸€ç§æ–¹å¼éƒ½æœ‰å…¶é€‚ç”¨åœºæ™¯ï¼Œé€‰æ‹©åˆé€‚çš„çŠ¶æ€ç®¡ç†æ–¹å¼å¯¹äºæ„å»ºé«˜è´¨é‡çš„Androidåº”ç”¨è‡³å…³é‡è¦ã€‚

åœ¨Jetpack Composeæ—¶ä»£ï¼Œæˆ‘ä»¬æœ‰äº†æ›´å¼ºå¤§ã€æ›´ç®€æ´çš„çŠ¶æ€ç®¡ç†å·¥å…·ã€‚é€šè¿‡åˆç†ä½¿ç”¨`remember`ã€`mutableStateOf`ã€`StateFlow`å’Œ`ViewModel`ï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºå‡ºæ—¢é«˜æ•ˆåˆæ˜“äºç»´æŠ¤çš„åº”ç”¨ã€‚

> çŠ¶æ€ç®¡ç†ä¸æ˜¯é“¶å¼¹ï¼Œé€‰æ‹©åˆé€‚çš„æ–¹å¼å–å†³äºä½ çš„åº”ç”¨éœ€æ±‚å’Œå›¢é˜ŸæŠ€æœ¯æ ˆã€‚ä¸è¦ç›²ç›®è¿½æ±‚æœ€æ–°æŠ€æœ¯ï¼Œè€Œè¦è€ƒè™‘é¡¹ç›®çš„é•¿æœŸå¯ç»´æŠ¤æ€§ã€‚

å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£AndroidçŠ¶æ€ç®¡ç†çš„æ¼”è¿›å’Œæœ€ä½³å®è·µã€‚å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºç•™è¨€äº¤æµï¼ğŸ˜Š

::: right
"çŠ¶æ€ç®¡ç†æ˜¯æ„å»ºå“åº”å¼UIçš„æ ¸å¿ƒï¼ŒæŒæ¡å®ƒï¼Œä½ å°±æŒæ¡äº†ç°ä»£Androidå¼€å‘çš„å…³é”®ã€‚"
:::