---
title: Android Jetpackç»„ä»¶ï¼šæ„å»ºç°ä»£Androidåº”ç”¨çš„æ ¸å¿ƒåˆ©å™¨
date: 2023-11-15 10:30:00
categories: 
  - Android
tags:
  - Jetpack
  - Androidå¼€å‘
  - æ¶æ„ç»„ä»¶
author: 
  name: Jorgen
  link: https://github.com/jorgen-zhao
---

## å‰è¨€

ä½œä¸ºä¸€åAndroidå¼€å‘è€…ï¼Œæˆ‘ç›¸ä¿¡å¤§å®¶éƒ½ç»å†è¿‡è¿™æ ·çš„å›°æƒ‘ï¼šå¦‚ä½•åœ¨æ—¥ç›Šå¤æ‚çš„Androidåº”ç”¨ä¸­ä¿æŒä»£ç çš„æ¸…æ™°ä¸å¯ç»´æŠ¤æ€§ï¼Ÿå¦‚ä½•å¤„ç†é…ç½®å˜æ›´å¯¼è‡´çš„Activityé‡å»ºé—®é¢˜ï¼Ÿå¦‚ä½•é«˜æ•ˆåœ°ç®¡ç†UIä¸æ•°æ®ä¹‹é—´çš„é€šä¿¡ï¼Ÿ

åœ¨è¿‡å»ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±è§£å†³è¿™äº›é—®é¢˜ï¼Œæˆ–è€…ä¾èµ–ç¬¬ä¸‰æ–¹åº“ã€‚è€Œç°åœ¨ï¼ŒGoogleä¸ºæˆ‘ä»¬æä¾›äº†ä¸€å¥—å¼ºå¤§çš„å·¥å…·é›†â€”â€”**Android Jetpack**ã€‚ğŸš€

Jetpackä¸æ˜¯å•ä¸€ç»„ä»¶ï¼Œè€Œæ˜¯ä¸€å¥—åº“ã€å·¥å…·å’ŒæŒ‡å—ï¼Œæ—¨åœ¨å¸®åŠ©å¼€å‘è€…ç¼–å†™æ›´ä¼˜è´¨çš„åº”ç”¨ã€‚å®ƒåŒ…å«å¤šä¸ªç»„ä»¶ï¼Œè¦†ç›–äº†ä»æ¶æ„ã€UIåˆ°è¡Œä¸ºç­‰å¤šä¸ªæ–¹é¢ã€‚

ä»Šå¤©ï¼Œæˆ‘æƒ³å’Œå¤§å®¶ä¸€èµ·æ¢ç´¢Jetpackçš„æ ¸å¿ƒç»„ä»¶ï¼Œçœ‹çœ‹å®ƒä»¬å¦‚ä½•å¸®åŠ©æˆ‘ä»¬æ„å»ºæ›´ç°ä»£ã€æ›´å¥å£®çš„Androidåº”ç”¨ã€‚

## Jetpackç®€ä»‹

Android Jetpackæ˜¯ä¸€å¥—åº“ã€å·¥å…·å’ŒæŒ‡å¯¼ï¼Œæ—¨åœ¨å¸®åŠ©å¼€å‘è€…æ›´è½»æ¾åœ°ç¼–å†™é«˜è´¨é‡çš„Androidåº”ç”¨ã€‚å®ƒåŸºäºKotlinè¯­è¨€æœ€ä½³å®è·µï¼Œå¹¶é‡‡ç”¨ç°ä»£è®¾è®¡æ–¹æ³•æ„å»ºã€‚

::: tip
Jetpackç»„ä»¶çš„ç›®æ ‡æ˜¯ï¼š
- åŠ é€Ÿå¼€å‘ï¼šæä¾›æ ·æ¿ä»£ç ï¼Œè®©å¼€å‘è€…ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘
- åšå›ºå¯é ï¼šåŒ…å«ç»è¿‡ä¸¥æ ¼æµ‹è¯•çš„åº“ï¼Œå¤„ç†å‘åå…¼å®¹æ€§é—®é¢˜
- æ¨èæœ€ä½³å®è·µï¼šéµå¾ªç°ä»£Androidè®¾è®¡åŸåˆ™
:::

Jetpackç»„ä»¶ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š

1. **åŸºç¡€ç»„ä»¶**ï¼šæä¾›æ ¸å¿ƒåŠŸèƒ½ï¼Œå¦‚åº”ç”¨å…¼å®¹æ€§ã€æƒé™ç®¡ç†ç­‰
2. **æ¶æ„ç»„ä»¶**ï¼šå¸®åŠ©è®¾è®¡ç¨³å¥ã€å¯æµ‹è¯•ä¸”å¯ç»´æŠ¤çš„åº”ç”¨
3. **è¡Œä¸ºç»„ä»¶**ï¼šå¸®åŠ©å¤„ç†æ ‡å‡†Androidæ¨¡å¼
4. **ç•Œé¢ç»„ä»¶**ï¼šæä¾›ä¸°å¯Œçš„ç•Œé¢å’Œå¯¼èˆªåŠŸèƒ½
5. **åŠŸèƒ½ç»„ä»¶**ï¼šæä¾›ç‰¹å®šåŠŸèƒ½ï¼Œå¦‚æ¨é€é€šçŸ¥ã€æƒé™ç®¡ç†ç­‰

## æ ¸å¿ƒæ¶æ„ç»„ä»¶

æ¶æ„ç»„ä»¶æ˜¯Jetpackä¸­æœ€é‡è¦çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒä»¬å…±åŒæ„æˆäº†Androidåº”ç”¨å¼€å‘çš„åšå®åŸºç¡€ã€‚

### ViewModel

`ViewModel`æ˜¯Jetpackæ¶æ„ç»„ä»¶çš„æ ¸å¿ƒï¼Œå®ƒè´Ÿè´£ä¸ºUIå‡†å¤‡æ•°æ®å¹¶ç®¡ç†UIç›¸å…³çš„ç”Ÿå‘½å‘¨æœŸã€‚

```kotlin
class UserViewModel : ViewModel() {
    private val _users = MutableLiveData<List<User>>()
    val users: LiveData<List<User>> = _users

    fun loadUsers() {
        viewModelScope.launch {
            val result = repository.getUsers()
            _users.value = result
        }
    }
}
```

**ViewModel**çš„ä¸»è¦ç‰¹ç‚¹ï¼š
- åœ¨é…ç½®å˜æ›´ï¼ˆå¦‚å±å¹•æ—‹è½¬ï¼‰æ—¶ä¸ä¼šè¢«é”€æ¯
- é€šè¿‡`viewModelScope`è‡ªåŠ¨ç®¡ç†åç¨‹ç”Ÿå‘½å‘¨æœŸ
- ä¸UIæ§åˆ¶å™¨ï¼ˆActivity/Fragmentï¼‰åˆ†ç¦»ï¼Œä¾¿äºæµ‹è¯•

### LiveData

`LiveData`æ˜¯ä¸€ç§å¯è§‚å¯Ÿçš„æ•°æ®æŒæœ‰è€…ç±»ï¼Œå®ƒéµå¾ªè§‚å¯Ÿè€…æ¨¡å¼ã€‚å½“æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒLiveDataä¼šé€šçŸ¥è§‚å¯Ÿè€…å¯¹è±¡ã€‚

```kotlin
val user: LiveData<User> = Transformations.map(repository.getUser(userId)) { user ->
    // æ•°æ®è½¬æ¢é€»è¾‘
    user?.copy(isAdult = user.age >= 18)
}
```

`LiveData`çš„ä¼˜åŠ¿ï¼š
- ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥ï¼šåªåœ¨æ´»è·ƒçŠ¶æ€ä¸‹é€šçŸ¥è§‚å¯Ÿè€…
- é˜²æ­¢å†…å­˜æ³„æ¼ï¼šè‡ªåŠ¨æ¸…ç†ä¸å†éœ€è¦çš„è§‚å¯Ÿè€…
- æ•°æ®å§‹ç»ˆä¿æŒæœ€æ–°ï¼šåœ¨å˜ä¸ºæ´»è·ƒçŠ¶æ€æ—¶ç«‹å³æ¥æ”¶æœ€æ–°æ•°æ®

### Roomæ•°æ®åº“

Roomæ˜¯ä¸€ä¸ªæŒä¹…æ€§åº“ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œå…è®¸åœ¨è®¾å¤‡ä¸Šæœ¬åœ°ä¿å­˜å…³ç³»æ•°æ®ã€‚

```kotlin
@Entity
data class User(
    @PrimaryKey val id: Int,
    val name: String,
    val age: Int
)

@Dao
interface UserDao {
    @Query("SELECT * FROM users WHERE age > :minAge")
    fun getUsersOlderThan(minAge: Int): LiveData<List<User>>
}

@Database(entities = [User::class], version = 1)
abstract class AppDatabase : RoomDatabase() {
    abstract fun userDao(): UserDao
}
```

Roomçš„ä¸»è¦ç‰¹ç‚¹ï¼š
- ç¼–è¯‘æ—¶éªŒè¯SQLæŸ¥è¯¢
- è½»æ¾è¿ç§»æ•°æ®åº“
- ä¸LiveDataæ— ç¼é›†æˆ
- æ”¯æŒRxJavaã€Flowå’Œåç¨‹

### Navigationç»„ä»¶

Navigationç»„ä»¶å¸®åŠ©å¼€å‘è€…å®ç°åº”ç”¨å†…çš„å¯¼èˆªï¼Œå¤„ç†Fragmentä¹‹é—´çš„åˆ‡æ¢ã€‚

```kotlin
// åœ¨å¯¼èˆªå›¾ä¸­å®šä¹‰
<navigation xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    xmlns:tools="http://schemas.android.com/tools"
    android:id="@+id/mobile_navigation"
    app:startDestination="@+id/homeFragment">

    <fragment
        android:id="@+id/homeFragment"
        android:name="com.example.HomeFragment"
        android:label="fragment_home"
        tools:layout="@layout/fragment_home">
        <action
            android:id="@+id/action_homeFragment_to_profileFragment"
            app:destination="@id/profileFragment" />
    </fragment>
    
    <fragment
        android:id="@+id/profileFragment"
        android:name="com.example.ProfileFragment"
        android:label="fragment_profile"
        tools:layout="@layout/fragment_profile" />
</navigation>
```

Navigationç»„ä»¶çš„ä¼˜åŠ¿ï¼š
- å¤„ç†å¤æ‚çš„Fragmentåˆ‡æ¢
- å¯è§†åŒ–å¯¼èˆªå›¾
- Deep Linkæ”¯æŒ
- ç±»å‹å®‰å…¨çš„å‚æ•°ä¼ é€’

## å…¶ä»–é‡è¦ç»„ä»¶

é™¤äº†æ¶æ„ç»„ä»¶å¤–ï¼ŒJetpackè¿˜æä¾›äº†è®¸å¤šå…¶ä»–æœ‰ç”¨çš„ç»„ä»¶ã€‚

### WorkManager

`WorkManager`ç”¨äºè°ƒåº¦å¯å»¶è¿Ÿçš„ã€ä¿è¯ä¼šæ‰§è¡Œçš„ä»»åŠ¡ï¼Œå³ä½¿åœ¨åº”ç”¨é€€å‡ºæˆ–è®¾å¤‡é‡å¯çš„æƒ…å†µä¸‹ã€‚

```kotlin
class UploadWorker(appContext: Context, workerParams: WorkerParameters)
    : CoroutineWorker(appContext, workerParams) {

    override suspend fun doWork(): Result {
        // æ‰§è¡Œä¸Šä¼ ä»»åŠ¡
        uploadData()
        return Result.success()
    }
}

// è°ƒåº¦ä»»åŠ¡
val uploadWorkRequest = OneTimeWorkRequestBuilder<UploadWorker>()
    .setConstraints(constraints)
    .build()
WorkManager.getInstance(context).enqueue(uploadWorkRequest)
```

### DataStore

`DataStore`æ˜¯æ–°çš„æ•°æ®å­˜å‚¨è§£å†³æ–¹æ¡ˆï¼Œç”¨äºæ›¿ä»£SharedPreferencesã€‚å®ƒæä¾›ä¸¤ç§å®ç°æ–¹å¼ï¼š

- **Preferences DataStore**ï¼šå­˜å‚¨é”®å€¼å¯¹
- **Proto DataStore**ï¼šå­˜å‚¨è‡ªå®šä¹‰ç±»å‹çš„æ•°æ®

```kotlin
// ä½¿ç”¨Preferences DataStore
val Context.dataStore: DataStore<Preferences> by preferencesDataStore(name = "settings")

// è¯»å–æ•°æ®
val exampleFlow = context.dataStore.data.map { preferences ->
    preferences[EXAMPLE_COUNTER] ?: 0
}

// å†™å…¥æ•°æ®
context.dataStore.edit { settings ->
    settings[EXAMPLE_COUNTER] = newValue
}
```

### Paging 3

`Paging 3`åº“å¸®åŠ©å¼€å‘è€…æ›´è½»æ¾åœ°ä»æ•°æ®æºåŠ è½½å’Œæ˜¾ç¤ºåˆ†é¡µæ•°æ®ã€‚

```kotlin
@Dao
interface UserDao {
    @Query("SELECT * FROM users ORDER BY name ASC")
    fun pagingSource(): PagingSource<Int, User>
}

val pager = Pager(
    config = PagingConfig(pageSize = 20),
    remoteMediator = UserRemoteMediator(...)
) {
    userDao.pagingSource()
}.flow.cachedIn(viewModelScope)
```

## å®é™…åº”ç”¨æ¡ˆä¾‹

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®é™…æ¡ˆä¾‹æ¥çœ‹çœ‹å¦‚ä½•ç»„åˆä½¿ç”¨è¿™äº›Jetpackç»„ä»¶ã€‚

å‡è®¾æˆ‘ä»¬è¦æ„å»ºä¸€ä¸ªç”¨æˆ·åˆ—è¡¨åº”ç”¨ï¼Œéœ€è¦å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š
1. ä»ç½‘ç»œåŠ è½½ç”¨æˆ·æ•°æ®
2. å°†ç”¨æˆ·æ•°æ®ç¼“å­˜åˆ°æœ¬åœ°æ•°æ®åº“
3. å®ç°åˆ†é¡µåŠ è½½
4. å¤„ç†åŠ è½½çŠ¶æ€å’Œé”™è¯¯æƒ…å†µ
5. æ”¯æŒä¸‹æ‹‰åˆ·æ–°

### å®ç°æ­¥éª¤

1. **å®šä¹‰æ•°æ®æ¨¡å‹**ï¼š

```kotlin
@Entity
data class User(
    @PrimaryKey val id: Int,
    val name: String,
    val email: String,
    @Embedded val address: Address
)

data class Address(
    val street: String,
    val city: String
)
```

2. **åˆ›å»ºRepository**ï¼š

```kotlin
class UserRepository(
    private val apiService: ApiService,
    private val userDao: UserDao
) {
    fun getUsers(): Flow<PagingData<User>> {
        return Pager(
            config = PagingConfig(pageSize = 20),
            remoteMediator = UserRemoteMediator(apiService, userDao)
        ) {
            userDao.pagingSource()
        }.flow.cachedIn(viewModelScope)
    }
}
```

3. **åˆ›å»ºViewModel**ï¼š

```kotlin
class UserViewModel(private val repository: UserRepository) : ViewModel() {
    val users: Flow<PagingData<User>> = repository.getUsers()
    
    fun refreshUsers() {
        viewModelScope.launch {
            repository.refreshUsers()
        }
    }
}
```

4. **åœ¨UIä¸­å±•ç¤º**ï¼š

```kotlin
@Composable
fun UserScreen(viewModel: UserViewModel = viewModel()) {
    val users by viewModel.users.collectAsLazyPagingItems()
    val context = LocalContext.current
    
    SwipeRefresh(
        state = rememberSwipeRefreshState(isRefreshing = false),
        onRefresh = { viewModel.refreshUsers() }
    ) {
        LazyColumn {
            items(users.itemCount) { index ->
                users[index]?.let { user ->
                    UserItem(user = user)
                }
            }
            
            when (users.loadState.append) {
                is LoadState.Loading -> {
                    item { LoadingIndicator() }
                }
                is LoadState.Error -> {
                    item {
                        ErrorRetryItem(
                            message = (users.loadState.append as LoadState.Error).error.message ?: "",
                            onRetry = { users.retry() }
                        )
                    }
                }
                else -> {}
            }
        }
    }
}
```

## æœ€ä½³å®è·µ

åœ¨ä½¿ç”¨Jetpackç»„ä»¶æ—¶ï¼Œæˆ‘æ€»ç»“äº†ä¸€äº›æœ€ä½³å®è·µï¼š

1. **åˆ†å±‚æ¶æ„**ï¼š
   - UIå±‚ï¼šActivityã€Fragmentã€Compose UI
   - ViewModelå±‚ï¼šå¤„ç†UIé€»è¾‘å’ŒçŠ¶æ€
   - Repositoryå±‚ï¼šå¤„ç†æ•°æ®æº
   - æ•°æ®å±‚ï¼šç½‘ç»œã€æ•°æ®åº“ã€æœ¬åœ°å­˜å‚¨

2. **ä¾èµ–æ³¨å…¥**ï¼š
   - ä½¿ç”¨Hiltæˆ–Koinè¿›è¡Œä¾èµ–æ³¨å…¥
   - é¿å…åœ¨ViewModelä¸­ç›´æ¥åˆ›å»ºä¾èµ–é¡¹

3. **é”™è¯¯å¤„ç†**ï¼š
   - åœ¨Repositoryå±‚ç»Ÿä¸€å¤„ç†é”™è¯¯
   - ä½¿ç”¨sealed classè¡¨ç¤ºä¸åŒçš„çŠ¶æ€ï¼ˆåŠ è½½ä¸­ã€æˆåŠŸã€é”™è¯¯ï¼‰

4. **æµ‹è¯•**ï¼š
   - ä¸ºViewModelç¼–å†™å•å…ƒæµ‹è¯•
   - ä½¿ç”¨Android Testæ¡†æ¶æµ‹è¯•UIäº¤äº’

5. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨åç¨‹è¿›è¡Œå¼‚æ­¥æ“ä½œ
   - åˆç†ä½¿ç”¨Pagingåº“å®ç°åˆ†é¡µåŠ è½½
   - é¿å…åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œè€—æ—¶æ“ä½œ

## ç»“è¯­

Jetpackç»„ä»¶å·²ç»æˆä¸ºç°ä»£Androidå¼€å‘çš„æ ‡é…ï¼Œå®ƒä»¬å¸®åŠ©æˆ‘ä»¬è§£å†³äº†è®¸å¤šå¸¸è§é—®é¢˜ï¼Œè®©å¼€å‘è€…èƒ½å¤Ÿä¸“æ³¨äºä¸šåŠ¡é€»è¾‘è€Œéåº•å±‚å®ç°ã€‚

é€šè¿‡åˆç†ä½¿ç”¨ViewModelã€LiveDataã€Roomã€Navigationç­‰ç»„ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºæ›´åŠ å¥å£®ã€å¯ç»´æŠ¤å’Œå¯æµ‹è¯•çš„Androidåº”ç”¨ã€‚åŒæ—¶ï¼Œéšç€Jetpackçš„ä¸æ–­æ›´æ–°ï¼Œå¦‚Paging 3ã€DataStoreç­‰æ–°ç»„ä»¶çš„åŠ å…¥ï¼Œæˆ‘ä»¬æœ‰æ›´å¤šå·¥å…·æ¥åº”å¯¹æ—¥ç›Šå¤æ‚çš„å¼€å‘éœ€æ±‚ã€‚

ä½œä¸ºä¸€åAndroidå¼€å‘è€…ï¼Œæˆ‘å»ºè®®å¤§å®¶æ·±å…¥å­¦ä¹ å’Œå®è·µJetpackç»„ä»¶ï¼Œå®ƒä»¬ä¸ä»…èƒ½æå‡å¼€å‘æ•ˆç‡ï¼Œè¿˜èƒ½è®©æˆ‘ä»¬çš„ä»£ç æ›´åŠ ä¸“ä¸šå’Œè§„èŒƒã€‚

> è®°ä½ï¼Œå·¥å…·åªæ˜¯æ‰‹æ®µï¼ŒçœŸæ­£çš„ä»·å€¼åœ¨äºå¦‚ä½•ä½¿ç”¨è¿™äº›å·¥å…·æ„å»ºå‡ºä¼˜ç§€çš„ç”¨æˆ·ä½“éªŒã€‚Jetpackä¸ºæˆ‘ä»¬æä¾›äº†å¼ºå¤§çš„æ­¦å™¨ï¼Œä½†å¦‚ä½•è¿ç”¨è¿™äº›æ­¦å™¨ï¼Œè¿˜éœ€è¦æˆ‘ä»¬ä¸æ–­å­¦ä¹ å’Œå®è·µã€‚

å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£å’Œä½¿ç”¨Jetpackç»„ä»¶ã€‚å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºç•™è¨€äº¤æµï¼ğŸ˜Š