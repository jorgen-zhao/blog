---
title: Androidæ¶æ„è®¾è®¡ä¹‹MVVMæ¨¡å¼å®æˆ˜æŒ‡å—
date: 2023-11-15 10:30:00
categories: 
  - Android
tags:
  - æ¶æ„è®¾è®¡
  - MVVM
  - Jetpack
author: 
  name: Jorgen
  link: https://github.com/jorgen-zhao
---

## å‰è¨€

ä½œä¸ºä¸€åAndroidå¼€å‘è€…ï¼Œä½ æ˜¯å¦æ›¾ç»é¢å¯¹è¿‡è¿™æ ·çš„å›°å¢ƒï¼šéšç€é¡¹ç›®è§„æ¨¡ä¸æ–­æ‰©å¤§ï¼Œä»£ç å˜å¾—è¶Šæ¥è¶Šéš¾ä»¥ç»´æŠ¤ï¼Œä¸šåŠ¡é€»è¾‘å’ŒUIé€»è¾‘æ··æ‚åœ¨ä¸€èµ·ï¼Œä¿®æ”¹ä¸€ä¸ªåŠŸèƒ½éœ€è¦ç‰µä¸€å‘è€ŒåŠ¨å…¨èº«ï¼ŸğŸ¤”

æˆ‘æ›¾åœ¨å¤šä¸ªé¡¹ç›®ä¸­ç»å†è¿‡è¿™æ ·çš„"ä»£ç å™©æ¢¦"ï¼Œç›´åˆ°æ¥è§¦åˆ°äº†MVVMæ¶æ„æ¨¡å¼ï¼Œæ‰çœŸæ­£ä½“ä¼šåˆ°äº†ä»£ç ç»“æ„åŒ–å¸¦æ¥çš„ä¾¿åˆ©ã€‚ä»Šå¤©ï¼Œæˆ‘æƒ³å’Œå¤§å®¶åˆ†äº«å¦‚ä½•åœ¨Androidå¼€å‘ä¸­å®è·µMVVMæ¶æ„æ¨¡å¼ï¼Œä»¥åŠå®ƒå¦‚ä½•å¸®åŠ©æˆ‘ä»¬æ„å»ºæ›´æ¸…æ™°ã€æ›´æ˜“ç»´æŠ¤çš„åº”ç”¨ç¨‹åºã€‚

::: tip
MVVMï¼ˆModel-View-ViewModelï¼‰æ˜¯ä¸€ç§æ¶æ„è®¾è®¡æ¨¡å¼ï¼Œå®ƒå°†åº”ç”¨ç¨‹åºåˆ†ä¸ºä¸‰ä¸ªä¸»è¦ç»„ä»¶ï¼šæ¨¡å‹ï¼ˆModelï¼‰ã€è§†å›¾ï¼ˆViewï¼‰å’Œè§†å›¾æ¨¡å‹ï¼ˆViewModelï¼‰ã€‚è¿™ç§æ¨¡å¼æœ‰åŠ©äºåˆ†ç¦»å…³æ³¨ç‚¹ï¼Œæé«˜ä»£ç çš„å¯æµ‹è¯•æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚
:::

## MVVMæ¶æ„æ¦‚è¿°

### ä»€ä¹ˆæ˜¯MVVMï¼Ÿ

MVVMæ¶æ„æ¨¡å¼æœ€åˆç”±å¾®è½¯å·¥ç¨‹å¸ˆJohn Gossmanäº2005å¹´æå‡ºï¼Œåæ¥åœ¨Androidå¼€å‘ä¸­å¾—åˆ°äº†å¹¿æ³›åº”ç”¨ã€‚å®ƒé€šè¿‡å¼•å…¥ViewModelå±‚ï¼Œå®ç°äº†è§†å›¾ï¼ˆViewï¼‰å’Œä¸šåŠ¡é€»è¾‘ï¼ˆModelï¼‰ä¹‹é—´çš„å®Œå…¨åˆ†ç¦»ã€‚

- **Model**ï¼šè´Ÿè´£å¤„ç†æ•°æ®å’Œä¸šåŠ¡é€»è¾‘ï¼Œé€šå¸¸åŒ…æ‹¬æ•°æ®æ¨¡å‹ã€æ•°æ®æºã€APIè°ƒç”¨ç­‰ã€‚
- **View**ï¼šè´Ÿè´£UIå±•ç¤ºå’Œç”¨æˆ·äº¤äº’ï¼Œåœ¨Androidä¸­é€šå¸¸æŒ‡Activityã€Fragmentã€Layoutç­‰ã€‚
- **ViewModel**ï¼šä½œä¸ºViewå’ŒModelä¹‹é—´çš„æ¡¥æ¢ï¼Œå¤„ç†Viewçš„ä¸šåŠ¡é€»è¾‘ï¼Œä½†ä¸ç›´æ¥å¼•ç”¨Viewã€‚

### MVVMçš„ä¼˜åŠ¿

ä½¿ç”¨MVVMæ¶æ„æ¨¡å¼ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—ä»¥ä¸‹å¥½å¤„ï¼š

1. **å…³æ³¨ç‚¹åˆ†ç¦»**ï¼šUIé€»è¾‘å’Œä¸šåŠ¡é€»è¾‘è¢«æ¸…æ™°åœ°åˆ†ç¦»ï¼Œä½¿ä»£ç æ›´æ˜“äºç†è§£å’Œç»´æŠ¤ã€‚
2. **å¯æµ‹è¯•æ€§**ï¼šViewModelä¸ä¾èµ–Viewï¼Œå¯ä»¥è½»æ¾è¿›è¡Œå•å…ƒæµ‹è¯•ã€‚
3. **ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥**ï¼šViewModelèƒ½å¤Ÿæ„ŸçŸ¥ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚
4. **å›¢é˜Ÿåä½œ**ï¼šä¸åŒçš„å¼€å‘è€…å¯ä»¥åŒæ—¶å·¥ä½œåœ¨Viewå’ŒViewModelä¸Šï¼Œå‡å°‘å†²çªã€‚

## MVVMåœ¨Androidä¸­çš„å®è·µ

### åŸºæœ¬ç»“æ„

ä¸€ä¸ªå…¸å‹çš„Android MVVMåº”ç”¨ç»“æ„å¦‚ä¸‹ï¼š

```
app/
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ local/
â”‚   â”‚   â””â”€â”€ dao/          // æ•°æ®è®¿é—®å¯¹è±¡
â”‚   â”œâ”€â”€ remote/
â”‚   â”‚   â””â”€â”€ api/          // APIæ¥å£
â”‚   â””â”€â”€ repository/       // ä»“åº“æ¨¡å¼
â”œâ”€â”€ di/                    // ä¾èµ–æ³¨å…¥æ¨¡å—
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ model/            // é¢†åŸŸæ¨¡å‹
â”‚   â”œâ”€â”€ repository/       // ä»“åº“æ¥å£
â”‚   â””â”€â”€ usecase/          // ç”¨ä¾‹
â”œâ”€â”€ presentation/
â”‚   â”œâ”€â”€ ui/               // UIç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ activity/     // Activity
â”‚   â”‚   â”œâ”€â”€ fragment/     // Fragment
â”‚   â”‚   â””â”€â”€ adapter/      // é€‚é…å™¨
â”‚   â””â”€â”€ viewmodel/        // ViewModel
â””â”€â”€ util/                  // å·¥å…·ç±»
```

### å®æˆ˜æ¡ˆä¾‹ï¼šç”¨æˆ·ä¿¡æ¯å±•ç¤º

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ç”¨æˆ·ä¿¡æ¯å±•ç¤ºåº”ç”¨æ¥å®è·µMVVMæ¶æ„ã€‚

#### 1. å®šä¹‰Model

é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰ç”¨æˆ·æ•°æ®æ¨¡å‹ï¼š

```kotlin
// domain/model/User.kt
data class User(
    val id: String,
    val name: String,
    val email: String,
    val avatarUrl: String
)
```

#### 2. åˆ›å»ºRepository

Repositoryä½œä¸ºæ•°æ®å±‚ï¼Œè´Ÿè´£ä»ä¸åŒæ•°æ®æºè·å–æ•°æ®ï¼š

```kotlin
// data/repository/UserRepository.kt
class UserRepository @Inject constructor(
    private val apiService: ApiService,
    private val userDao: UserDao
) {
    
    suspend fun getUser(userId: String): User {
        // 1. å…ˆä»æ•°æ®åº“æ£€æŸ¥ç¼“å­˜
        var user = userDao.getUserById(userId)
        
        // 2. å¦‚æœæ²¡æœ‰ç¼“å­˜æˆ–ç¼“å­˜è¿‡æœŸï¼Œä»ç½‘ç»œè·å–
        if (user == null) {
            user = apiService.getUser(userId)
            userDao.insertUser(user)
        }
        
        return user
    }
}
```

#### 3. åˆ›å»ºUseCase

UseCaseå®šä¹‰åº”ç”¨ç¨‹åºçš„ä¸šåŠ¡è§„åˆ™ï¼š

```kotlin
// domain/usecase/GetUserUseCase.kt
class GetUserUseCase @Inject constructor(
    private val userRepository: UserRepository
) {
    suspend operator fun invoke(userId: String): Result<User> {
        return try {
            Result.success(userRepository.getUser(userId))
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
}
```

#### 4. åˆ›å»ºViewModel

ViewModelå¤„ç†UIç›¸å…³çš„ä¸šåŠ¡é€»è¾‘ï¼š

```kotlin
// presentation/viewmodel/UserViewModel.kt
@HiltViewModel
class UserViewModel @Inject constructor(
    private val getUserUseCase: GetUserUseCase
) : ViewModel() {
    
    private val _user = MutableLiveData<User>()
    val user: LiveData<User> = _user
    
    private val _loading = MutableLiveData<Boolean>()
    val loading: LiveData<Boolean> = _loading
    
    private val _error = MutableLiveData<String>()
    val error: LiveData<String> = _error
    
    fun loadUser(userId: String) {
        viewModelScope.launch {
            _loading.value = true
            when (val result = getUserUseCase(userId)) {
                is Result.Success -> {
                    _user.value = result.data
                }
                is Result.Failure -> {
                    _error.value = result.exception.message ?: "Unknown error"
                }
            }
            _loading.value = false
        }
    }
}
```

#### 5. åˆ›å»ºUI

æœ€åï¼Œæˆ‘ä»¬åœ¨Activityæˆ–Fragmentä¸­å±•ç¤ºæ•°æ®ï¼š

```kotlin
// presentation/ui/UserActivity.kt
class UserActivity : AppCompatActivity() {
    
    private lateinit var binding: ActivityUserBinding
    private val viewModel: UserViewModel by viewModels()
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        binding = ActivityUserBinding.inflate(layoutInflater)
        setContentView(binding.root)
        
        val userId = intent.getStringExtra("USER_ID") ?: ""
        
        // è§‚å¯ŸViewModelä¸­çš„æ•°æ®å˜åŒ–
        viewModel.user.observe(this) { user ->
            binding.nameTextView.text = user.name
            binding.emailTextView.text = user.email
            Glide.with(this)
                .load(user.avatarUrl)
                .into(binding.avatarImageView)
        }
        
        viewModel.loading.observe(this) { isLoading ->
            binding.progressBar.visibility = if (isLoading) View.VISIBLE else View.GONE
        }
        
        viewModel.error.observe(this) { errorMessage ->
            Toast.makeText(this, errorMessage, Toast.LENGTH_SHORT).show()
        }
        
        // åŠ è½½ç”¨æˆ·æ•°æ®
        viewModel.loadUser(userId)
    }
}
```

## Jetpackç»„ä»¶ä¸MVVMçš„ç»“åˆ

Android Jetpackç»„ä»¶ä¸MVVMæ¶æ„æ¨¡å¼æ˜¯å¤©ä½œä¹‹åˆï¼Œä»¥ä¸‹æ˜¯å‡ ä¸ªå…³é”®ç»„ä»¶ï¼š

### 1. ViewModel

`ViewModel`ç±»ä¸“é—¨ç”¨äºå­˜å‚¨å’Œç®¡ç†ä¸UIç›¸å…³çš„æ•°æ®ï¼Œåœ¨é…ç½®æ›´æ”¹ï¼ˆå¦‚å±å¹•æ—‹è½¬ï¼‰æ—¶ä¸ä¼šé”€æ¯ã€‚

```kotlin
class MyViewModel : ViewModel() {
    private val _items = MutableLiveData<List<Item>>()
    val items: LiveData<List<Item>> = _items
    
    fun loadItems() {
        // ä»æ•°æ®æºåŠ è½½æ•°æ®
    }
}
```

### 2. LiveData

`LiveData`æ˜¯ä¸€ç§å¯è§‚å¯Ÿçš„æ•°æ®æŒæœ‰è€…ç±»ï¼Œéµå¾ªè§‚å¯Ÿè€…æ¨¡å¼ã€‚å½“æ•°æ®å˜åŒ–æ—¶ï¼Œå®ƒä¼šé€šçŸ¥è§‚å¯Ÿè€…ï¼ˆé€šå¸¸æ˜¯UIç»„ä»¶ï¼‰ã€‚

```kotlin
// åœ¨ViewModelä¸­
private val _user = MutableLiveData<User>()
val user: LiveData<User> = _user

// åœ¨Activity/Fragmentä¸­
viewModel.user.observe(this) { user ->
    // æ›´æ–°UI
}
```

### 3. Data Binding

Data Bindingåº“å…è®¸æˆ‘ä»¬ç›´æ¥åœ¨XMLå¸ƒå±€æ–‡ä»¶ä¸­ç»‘å®šUIç»„ä»¶åˆ°æ•°æ®æºï¼š

```xml
<!-- activity_user.xml -->
<layout xmlns:android="http://schemas.android.com/apk/res/android">
    <data>
        <variable
            name="viewModel"
            type="com.example.UserViewModel" />
    </data>
    
    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        android:orientation="vertical">
        
        <TextView
            android:id="@+id/nameTextView"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="@{viewModel.user.name}" />
            
        <ProgressBar
            android:id="@+id/progressBar"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:visibility="@{viewModel.loading ? View.VISIBLE : View.GONE}" />
            
    </LinearLayout>
</layout>
```

### 4. Roomæ•°æ®åº“

RoomæŒä¹…åŒ–åº“æä¾›äº†æœ¬åœ°æ•°æ®åº“åŠŸèƒ½ï¼Œå¯ä»¥è½»æ¾åœ°å°†æ•°æ®å­˜å‚¨åœ¨è®¾å¤‡ä¸Šï¼š

```kotlin
// æ•°æ®å®ä½“
@Entity
data class User(
    @PrimaryKey val id: String,
    val name: String,
    val email: String
)

// DAOæ¥å£
@Dao
interface UserDao {
    @Query("SELECT * FROM users WHERE id = :userId")
    suspend fun getUserById(userId: String): User?
    
    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun insertUser(user: User)
}
```

## MVVMæœ€ä½³å®è·µ

### 1. å•ä¸€èŒè´£åŸåˆ™

æ¯ä¸ªç±»éƒ½åº”è¯¥åªæœ‰ä¸€ä¸ªè´£ä»»ã€‚ä¾‹å¦‚ï¼š

- ViewModelåªè´Ÿè´£å¤„ç†UIç›¸å…³çš„ä¸šåŠ¡é€»è¾‘
- Repositoryåªè´Ÿè´£æ•°æ®è·å–
- UseCaseåªåŒ…å«ä¸€ä¸ªä¸šåŠ¡ç”¨ä¾‹

### 2. ä¾èµ–æ³¨å…¥

ä½¿ç”¨Hiltæˆ–Daggerè¿›è¡Œä¾èµ–æ³¨å…¥ï¼Œå‡å°‘ç±»ä¹‹é—´çš„è€¦åˆï¼š

```kotlin
@HiltViewModel
class UserViewModel @Inject constructor(
    private val getUserUseCase: GetUserUseCase
) : ViewModel()
```

### 3. é”™è¯¯å¤„ç†

å®ç°ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼š

```kotlin
sealed class Result<out T> {
    data class Success<out T>(val data: T) : Result<T>()
    data class Failure(val exception: Exception) : Result<Nothing>()
}

// åœ¨ViewModelä¸­ä½¿ç”¨
private val _error = MutableLiveData<String>()
val error: LiveData<String> = _error

// åœ¨UIä¸­è§‚å¯Ÿ
viewModel.error.observe(this) { errorMessage ->
    showErrorSnackbar(errorMessage)
}
```

### 4. æµ‹è¯•ç­–ç•¥

MVVMæ¶æ„ä½¿æµ‹è¯•å˜å¾—æ›´åŠ å®¹æ˜“ï¼š

```kotlin
// ViewModelæµ‹è¯•
class UserViewModelTest {
    private lateinit var viewModel: UserViewModel
    private val getUserUseCase: MockKMockScope<GetUserUseCase> = mockk()
    
    @Before
    fun setup() {
        viewModel = UserViewModel(getUserUseCase)
    }
    
    @Test
    fun `loadUser should update user LiveData when successful`() = runTest {
        // Given
        val user = User("1", "John Doe", "john@example.com")
        coEvery { getUserUseCase(any()) } returns Result.success(user)
        
        // When
        viewModel.loadUser("1")
        
        // Then
        assertEquals(user, viewModel.user.value)
    }
}
```

## å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 1. ViewModelæŒæœ‰Contextå¯¼è‡´å†…å­˜æ³„æ¼

**é—®é¢˜**ï¼šåœ¨ViewModelä¸­ç›´æ¥ä½¿ç”¨Activityæˆ–Fragmentçš„Contextä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨Application Contextï¼š

```kotlin
class MyViewModel(application: Application) : AndroidViewModel(application) {
    private val context = application.applicationContext
    
    // ä½¿ç”¨contextè€Œä¸æ˜¯activity/fragmentçš„context
}
```

### 2. è¿‡åº¦ä½¿ç”¨LiveData

**é—®é¢˜**ï¼šå°†æ‰€æœ‰æ•°æ®éƒ½åŒ…è£…åœ¨LiveDataä¸­ï¼Œå¯¼è‡´ä¸å¿…è¦çš„è§‚å¯Ÿè€…æ³¨å†Œã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šæ ¹æ®éœ€æ±‚é€‰æ‹©åˆé€‚çš„æ•°æ®ç±»å‹ï¼š

```kotlin
// å¯¹äºç®€å•çŠ¶æ€ï¼Œå¯ä»¥ä½¿ç”¨StateFlow
private val _uiState = MutableStateFlow(UiState())
val uiState: StateFlow<UiState> = _uiState.asStateFlow()

// å¯¹äºä¸€æ¬¡æ€§äº‹ä»¶ï¼Œå¯ä»¥ä½¿ç”¨SingleLiveEvent
private val _event = SingleLiveEvent<String>()
val event: LiveData<String> = _event
```

### 3. ViewModelä¸Viewçš„å¼ºè€¦åˆ

**é—®é¢˜**ï¼šViewModelç›´æ¥å¼•ç”¨Viewï¼Œè¿åäº†MVVMçš„åŸåˆ™ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šé€šè¿‡LiveDataæˆ–Flowè¿›è¡Œé€šä¿¡ï¼š

```kotlin
// ViewModelä¸­
private val _showSnackbar = MutableLiveData<String>()
val showSnackbar: LiveData<String> = _showSnackbar

// Viewä¸­
viewModel.showSnackbar.observe(this) { message ->
    Snackbar.make(binding.root, message, Snackbar.LENGTH_SHORT).show()
}
```

## ç»“è¯­

MVVMæ¶æ„æ¨¡å¼ä¸ºAndroidå¼€å‘æä¾›äº†ä¸€ç§æ¸…æ™°ã€å¯ç»´æŠ¤çš„ä»£ç ç»„ç»‡æ–¹å¼ã€‚é€šè¿‡å°†UIé€»è¾‘ä¸ä¸šåŠ¡é€»è¾‘åˆ†ç¦»ï¼Œæˆ‘ä»¬èƒ½å¤Ÿæ„å»ºæ›´åŠ å¥å£®ã€å¯æµ‹è¯•çš„åº”ç”¨ç¨‹åºã€‚

å½“ç„¶ï¼Œæ¶æ„é€‰æ‹©åº”è¯¥æ ¹æ®é¡¹ç›®éœ€æ±‚å’Œå›¢é˜Ÿç‰¹ç‚¹æ¥å†³å®šï¼Œæ²¡æœ‰æ”¾ä¹‹å››æµ·è€Œçš†å‡†çš„"æœ€ä½³æ¶æ„"ã€‚ä½†MVVMç»“åˆJetpackç»„ä»¶ç¡®å®ä¸ºå¤§å¤šæ•°Androidé¡¹ç›®æä¾›äº†ä¸€ä¸ªå¾ˆå¥½çš„èµ·ç‚¹ã€‚

> è®°ä½ï¼Œå¥½çš„æ¶æ„ä¸ä»…ä»…æ˜¯å…³äºä»£ç ç»„ç»‡ï¼Œæ›´æ˜¯å…³äºå›¢é˜Ÿåä½œå’Œé•¿æœŸç»´æŠ¤ã€‚é€‰æ‹©é€‚åˆä½ å›¢é˜Ÿçš„æ¶æ„æ¨¡å¼ï¼Œå¹¶åšæŒä¸‹å»ï¼Œä½ ä¼šå‘ç°éšç€é¡¹ç›®çš„å‘å±•ï¼Œä»£ç è´¨é‡ä¼šè¶Šæ¥è¶Šé«˜ã€‚

å¸Œæœ›è¿™ç¯‡æŒ‡å—èƒ½å¸®åŠ©ä½ åœ¨Androidå¼€å‘ä¸­æ›´å¥½åœ°å®è·µMVVMæ¶æ„æ¨¡å¼ï¼å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºç•™è¨€äº¤æµã€‚ğŸ‘‹

::: right
"æ¶æ„ä¸æ˜¯å…³äºå·¥å…·ï¼Œè€Œæ˜¯å…³äºæ€ç»´æ¨¡å¼ã€‚"
:::