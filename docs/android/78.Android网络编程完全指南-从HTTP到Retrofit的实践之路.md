---
title: Androidç½‘ç»œç¼–ç¨‹å®Œå…¨æŒ‡å—-ä»HTTPåˆ°Retrofitçš„å®è·µä¹‹è·¯
date: 2023-11-15 10:30:00
categories: 
  - Android
tags:
  - Android
  - ç½‘ç»œç¼–ç¨‹
  - OkHttp
  - Retrofit
author: 
  name: Jorgen
  link: https://github.com/jorgen-zhao
---

## å‰è¨€

åœ¨å½“ä»Šç§»åŠ¨åº”ç”¨å¼€å‘ä¸­ï¼Œç½‘ç»œç¼–ç¨‹æ˜¯ä¸å¯æˆ–ç¼ºçš„ä¸€éƒ¨åˆ†ã€‚æ— è®ºæ˜¯è·å–æœ€æ–°èµ„è®¯ã€åŠ è½½ç¤¾äº¤åª’ä½“åŠ¨æ€ï¼Œè¿˜æ˜¯ä¸åç«¯APIäº¤äº’ï¼Œç½‘ç»œè¯·æ±‚éƒ½æ‰®æ¼”ç€è‡³å…³é‡è¦çš„è§’è‰²ã€‚ğŸŒ

ä½œä¸ºä¸€åAndroidå¼€å‘è€…ï¼ŒæŒæ¡ç½‘ç»œç¼–ç¨‹æŠ€èƒ½ä¸ä»…èƒ½æå‡åº”ç”¨çš„ç”¨æˆ·ä½“éªŒï¼Œè¿˜èƒ½è®©ä½ æ›´å¥½åœ°ç†è§£ç°ä»£åº”ç”¨çš„å·¥ä½œåŸç†ã€‚æœ¬æ–‡å°†å¸¦ä½ ä»é›¶å¼€å§‹ï¼Œå…¨é¢äº†è§£Androidç½‘ç»œç¼–ç¨‹çš„æ ¸å¿ƒæ¦‚å¿µå’Œæœ€ä½³å®è·µã€‚

> "ç½‘ç»œæ˜¯ç°ä»£åº”ç”¨çš„è¡€è„‰ï¼Œç†è§£ç½‘ç»œç¼–ç¨‹å°±æ˜¯ç†è§£åº”ç”¨çš„å‘¼å¸æ–¹å¼ã€‚"

## Androidç½‘ç»œåŸºç¡€

åœ¨æ·±å…¥æ¢è®¨å…·ä½“çš„ç½‘ç»œè¯·æ±‚åº“ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ä¸€äº›åŸºç¡€çŸ¥è¯†ã€‚

### ç½‘ç»œæƒé™

é¦–å…ˆï¼Œç¡®ä¿åœ¨AndroidManifest.xmlä¸­æ·»åŠ ç½‘ç»œæƒé™ï¼š

```xml
<uses-permission android:name="android.permission.INTERNET" />
```

å¯¹äºAndroid 9.0 (APIçº§åˆ«28)åŠä»¥ä¸Šï¼Œé»˜è®¤æƒ…å†µä¸‹åº”ç”¨åªèƒ½ä½¿ç”¨HTTPSè¿æ¥ã€‚å¦‚æœéœ€è¦ä½¿ç”¨HTTPï¼Œéœ€è¦åœ¨networkSecurityConfig.xmlä¸­é…ç½®ï¼š

```xml
<application
    android:networkSecurityConfig="@xml/network_security_config"
    ...>
    
    <network-security-config>
        <domain-config cleartextTrafficPermitted="true">
            <domain includeSubdomains="true">example.com</domain>
        </domain-config>
    </network-security-config>
```

### HTTP/HTTPSåè®®

HTTPï¼ˆè¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼‰æ˜¯äº’è”ç½‘ä¸Šåº”ç”¨æœ€å¹¿æ³›çš„ç½‘ç»œåè®®ã€‚HTTPSåˆ™æ˜¯HTTPçš„å®‰å…¨ç‰ˆæœ¬ï¼Œé€šè¿‡SSL/TLSåŠ å¯†ä¼ è¾“æ•°æ®ï¼Œä¿æŠ¤æ•°æ®ä¸è¢«çªƒå–æˆ–ç¯¡æ”¹ã€‚

::: tip
ä»Android 9.0å¼€å§‹ï¼Œé»˜è®¤ç¦ç”¨äº†HTTPæ˜æ–‡æµé‡ï¼Œæ¨èä½¿ç”¨HTTPSç¡®ä¿æ•°æ®å®‰å…¨ã€‚
:::

## ä¼ ç»Ÿç½‘ç»œè¯·æ±‚æ–¹å¼

åœ¨ç¬¬ä¸‰æ–¹ç½‘ç»œåº“æµè¡Œä¹‹å‰ï¼ŒAndroidä¸»è¦ä½¿ç”¨HttpURLConnectionå’ŒHttpClientè¿›è¡Œç½‘ç»œè¯·æ±‚ã€‚

### HttpURLConnection

HttpURLConnectionæ˜¯Javaæ ‡å‡†åº“æä¾›çš„HTTPå®¢æˆ·ç«¯ï¼ŒAndroidå¯¹å…¶è¿›è¡Œäº†ä¼˜åŒ–ï¼š

```java
URL url = new URL("https://example.com/api/data");
HttpURLConnection connection = (HttpURLConnection) url.openConnection();
connection.setRequestMethod("GET");
connection.setConnectTimeout(15000);
connection.setReadTimeout(15000);

int responseCode = connection.getResponseCode();
if (responseCode == HttpURLConnection.HTTP_OK) {
    InputStream inputStream = connection.getInputStream();
    BufferedReader reader = new BufferedReader(new InputStreamReader(inputStream));
    StringBuilder response = new StringBuilder();
    String line;
    while ((line = reader.readLine()) != null) {
        response.append(line);
    }
    reader.close();
    // å¤„ç†å“åº”æ•°æ®
}
connection.disconnect();
```

### HttpClient

HttpClientæ˜¯Apacheæä¾›çš„HTTPå®¢æˆ·ç«¯åº“ï¼ŒåŠŸèƒ½æ›´ä¸°å¯Œä½†å·²è¢«åºŸå¼ƒï¼Œä¸æ¨èåœ¨æ–°é¡¹ç›®ä¸­ä½¿ç”¨ã€‚

::: theorem
æ³¨æ„ï¼šHttpClientåœ¨Android API 23+å·²è¢«ç§»é™¤ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨ï¼Œéœ€æ·»åŠ å¤–éƒ¨ä¾èµ–ã€‚
:::

## OkHttpè¯¦è§£

OkHttpæ˜¯Squareå…¬å¸å¼€å‘çš„ä¸€æ¬¾ä¼˜ç§€çš„HTTPå®¢æˆ·ç«¯ï¼Œå·²æˆä¸ºAndroidç½‘ç»œè¯·æ±‚çš„äº‹å®æ ‡å‡†ã€‚

### OkHttpåŸºæœ¬ä½¿ç”¨

é¦–å…ˆæ·»åŠ ä¾èµ–ï¼š

```gradle
implementation("com.squareup.okhttp3:okhttp:4.10.0")
```

#### GETè¯·æ±‚

```java
OkHttpClient client = new OkHttpClient();

Request request = new Request.Builder()
    .url("https://example.com/api/data")
    .build();

client.newCall(request).enqueue(new Callback() {
    @Override
    public void onFailure(Call call, IOException e) {
        // è¯·æ±‚å¤±è´¥å¤„ç†
    }

    @Override
    public void onResponse(Call call, Response response) throws IOException {
        if (response.isSuccessful()) {
            String responseData = response.body().string();
            // å¤„ç†å“åº”æ•°æ®
        }
    }
});
```

#### POSTè¯·æ±‚

```java
OkHttpClient client = new OkHttpClient();

MediaType JSON = MediaType.parse("application/json; charset=utf-8");
JSONObject jsonObject = new JSONObject();
jsonObject.put("key", "value");

RequestBody body = RequestBody.create(JSON, jsonObject.toString());

Request request = new Request.Builder()
    .url("https://example.com/api/create")
    .post(body)
    .build();

client.newCall(request).enqueue(new Callback() {
    @Override
    public void onFailure(Call call, IOException e) {
        // è¯·æ±‚å¤±è´¥å¤„ç†
    }

    @Override
    public void onResponse(Call call, Response response) throws IOException {
        // å¤„ç†å“åº”
    }
});
```

### OkHttpé«˜çº§ç‰¹æ€§

#### æ‹¦æˆªå™¨

æ‹¦æˆªå™¨æ˜¯OkHttpæœ€å¼ºå¤§çš„åŠŸèƒ½ä¹‹ä¸€ï¼Œå…è®¸ä½ åœ¨è¯·æ±‚å‘é€å‰å’Œå“åº”è¿”å›åè¿›è¡Œå¹²é¢„ï¼š

```java
OkHttpClient client = new OkHttpClient.Builder()
    .addInterceptor(new Interceptor() {
        @Override
        public Response intercept(Chain chain) throws IOException {
            Request request = chain.request();
            
            // æ·»åŠ å…¬å…±å¤´
            Request newRequest = request.newBuilder()
                .addHeader("Authorization", "Bearer token")
                .build();
                
            return chain.proceed(newRequest);
        }
    })
    .build();
```

#### ç¼“å­˜

OkHttpå†…ç½®äº†ç¼“å­˜æœºåˆ¶ï¼Œå¯ä»¥å‡å°‘ç½‘ç»œè¯·æ±‚ï¼Œæé«˜åº”ç”¨æ€§èƒ½ï¼š

```java
int cacheSize = 10 * 1024 * 1024; // 10MB
Cache cache = new Cache(context.getCacheDir(), cacheSize);

OkHttpClient client = new OkHttpClient.Builder()
    .cache(cache)
    .build();
```

## Retrofitå…¥é—¨ä¸å®è·µ

Retrofitæ˜¯Squareå…¬å¸å¼€å‘çš„ç±»å‹å®‰å…¨çš„HTTPå®¢æˆ·ç«¯ï¼Œå®ƒåŸºäºOkHttpï¼Œå°†HTTP APIè½¬æ¢ä¸ºJavaæ¥å£ã€‚

### åŸºæœ¬ä½¿ç”¨

é¦–å…ˆæ·»åŠ ä¾èµ–ï¼š

```gradle
implementation("com.squareup.retrofit2:retrofit:2.9.0")
implementation("com.squareup.retrofit2:converter-gson:2.9.0") // JSONè½¬æ¢å™¨
```

#### å®šä¹‰APIæ¥å£

```java
public interface ApiService {
    @GET("users/{user}/repos")
    Call<List<Repo>> listRepos(@Path("user") String user);
}
```

#### åˆ›å»ºRetrofitå®ä¾‹å¹¶è°ƒç”¨API

```java
Retrofit retrofit = new Retrofit.Builder()
    .baseUrl("https://api.github.com/")
    .addConverterFactory(GsonConverterFactory.create())
    .build();

ApiService service = retrofit.create(ApiService.class);

Call<List<Repo>> call = service.listRepos("octocat");
call.enqueue(new Callback<List<Repo>>() {
    @Override
    public void onResponse(Call<List<Repo>> call, Response<List<Repo>> response) {
        if (response.isSuccessful()) {
            List<Repo> repos = response.body();
            // å¤„ç†æ•°æ®
        }
    }

    @Override
    public void onFailure(Call<List<Repo>> call, Throwable t) {
        // è¯·æ±‚å¤±è´¥å¤„ç†
    }
});
```

### Retrofité«˜çº§ç‰¹æ€§

#### å¼‚æ­¥è¯·æ±‚ä¸åç¨‹

Retrofit 2.6+æ”¯æŒKotlinåç¨‹ï¼Œå¯ä»¥æ›´ä¼˜é›…åœ°å¤„ç†å¼‚æ­¥è¯·æ±‚ï¼š

```kotlin
interface ApiService {
    @GET("users/{user}/repos")
    suspend fun listRepos(@Path("user") user: String): List<Repo>
}

// åœ¨åç¨‹ä¸­è°ƒç”¨
viewModelScope.launch {
    try {
        val repos = apiService.listRepos("octocat")
        // å¤„ç†æ•°æ®
    } catch (e: Exception) {
        // é”™è¯¯å¤„ç†
    }
}
```

#### è‡ªå®šä¹‰é€‚é…å™¨

Retrofitæ”¯æŒå¤šç§é€‚é…å™¨ï¼Œå¦‚RxJavaã€Guavaç­‰ï¼Œå¯ä»¥è½»æ¾é›†æˆå“åº”å¼ç¼–ç¨‹ï¼š

```gradle
implementation("com.squareup.retrofit2:adapter-rxjava2:2.9.0")
```

```java
Retrofit retrofit = new Retrofit.Builder()
    .baseUrl("https://api.github.com/")
    .addCallAdapterFactory(RxJava2CallAdapterFactory.create())
    .build();
```

## ç½‘ç»œçŠ¶æ€ç›‘æµ‹

äº†è§£ç½‘ç»œçŠ¶æ€å¯¹äºæä¾›è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒè‡³å…³é‡è¦ã€‚

### ConnectivityManager

```java
ConnectivityManager connectivityManager = (ConnectivityManager) getSystemService(Context.CONNECTIVITY_SERVICE);
Network network = connectivityManager.getActiveNetwork();
NetworkCapabilities capabilities = connectivityManager.getNetworkCapabilities(network);

if (capabilities != null) {
    if (capabilities.hasTransport(NetworkCapabilities.TRANSPORT_WIFI)) {
        // WiFiè¿æ¥
    } else if (capabilities.hasTransport(NetworkCapabilities.TRANSPORT_CELLULAR)) {
        // ç§»åŠ¨æ•°æ®è¿æ¥
    }
}
```

### ç½‘ç»œçŠ¶æ€å˜åŒ–ç›‘å¬

```java
ConnectivityManager.NetworkCallback networkCallback = new ConnectivityManager.NetworkCallback() {
    @Override
    public void onAvailable(Network network) {
        // ç½‘ç»œå¯ç”¨
    }

    @Override
    public void onLost(Network network) {
        // ç½‘ç»œä¸¢å¤±
    }
};

ConnectivityManager connectivityManager = (ConnectivityManager) getSystemService(Context.CONNECTIVITY_SERVICE);
connectivityManager.registerNetworkCallback(
    new NetworkRequest.Builder().build(), networkCallback);
```

## ç½‘ç»œè¯·æ±‚æœ€ä½³å®è·µ

### çº¿ç¨‹ç®¡ç†

ç½‘ç»œè¯·æ±‚åº”è¯¥åœ¨åå°çº¿ç¨‹æ‰§è¡Œï¼Œé¿å…é˜»å¡UIçº¿ç¨‹ã€‚Retrofitçš„enqueue()æ–¹æ³•å·²ç»å¤„ç†äº†çº¿ç¨‹åˆ‡æ¢ï¼Œä½†å¦‚æœä½ ä½¿ç”¨çš„æ˜¯åŒæ­¥è¯·æ±‚ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†ï¼š

```java
// åœ¨å­çº¿ç¨‹ä¸­æ‰§è¡Œ
new Thread(() -> {
    try {
        Response response = call.execute();
        // å¤„ç†å“åº”
    } catch (IOException e) {
        e.printStackTrace();
    }
}).start();
```

### é”™è¯¯å¤„ç†

ç½‘ç»œè¯·æ±‚å¯èƒ½å› å„ç§åŸå› å¤±è´¥ï¼Œåº”å¦¥å–„å¤„ç†é”™è¯¯æƒ…å†µï¼š

```java
call.enqueue(new Callback<List<Repo>>() {
    @Override
    public void onResponse(Call<List<Repo>> call, Response<List<Repo>> response) {
        if (response.isSuccessful()) {
            // å¤„ç†æˆåŠŸå“åº”
        } else {
            // å¤„ç†HTTPé”™è¯¯
            int code = response.code();
            String message = response.message();
        }
    }

    @Override
    public void onFailure(Call<List<Repo>> call, Throwable t) {
        // å¤„ç†ç½‘ç»œé”™è¯¯
        if (t instanceof IOException) {
            // ç½‘ç»œé”™è¯¯
        } else {
            // å…¶ä»–é”™è¯¯
        }
    }
});
```

### è¶…æ—¶è®¾ç½®

åˆç†è®¾ç½®è¿æ¥è¶…æ—¶å’Œè¯»å–è¶…æ—¶ï¼Œé¿å…è¯·æ±‚é•¿æ—¶é—´æŒ‚èµ·ï¼š

```java
OkHttpClient client = new OkHttpClient.Builder()
    .connectTimeout(10, TimeUnit.SECONDS)
    .readTimeout(30, TimeUnit.SECONDS)
    .writeTimeout(30, TimeUnit.SECONDS)
    .build();
```

### ç¼“å­˜ç­–ç•¥

åˆç†ä½¿ç”¨ç¼“å­˜å¯ä»¥å‡å°‘ç½‘ç»œè¯·æ±‚ï¼Œæé«˜åº”ç”¨æ€§èƒ½ï¼š

```java
@Headers("Cache-Control: public, max-age=640000")
@GET("api/data")
Call<Data> getData();
```

## ç»“è¯­

Androidç½‘ç»œç¼–ç¨‹æ˜¯æ„å»ºç°ä»£åº”ç”¨çš„æ ¸å¿ƒæŠ€èƒ½ä¹‹ä¸€ã€‚ä»ä¼ ç»Ÿçš„HttpURLConnectionåˆ°ç°ä»£çš„OkHttpå’ŒRetrofitï¼Œæˆ‘ä»¬è§è¯äº†ç½‘ç»œè¯·æ±‚æ–¹å¼çš„ä¸æ–­æ¼”è¿›ã€‚

::: right
"ç½‘ç»œæ˜¯åº”ç”¨çš„è¡€è„‰ï¼Œè€Œä¼˜ç§€çš„ç½‘ç»œç¼–ç¨‹åˆ™æ˜¯åº”ç”¨çš„å¼ºå¥å¿ƒè„ã€‚"
:::

é€šè¿‡æœ¬æ–‡çš„å­¦ä¹ ï¼Œä½ åº”è¯¥å·²ç»æŒæ¡äº†Androidç½‘ç»œç¼–ç¨‹çš„åŸºç¡€çŸ¥è¯†å’Œæœ€ä½³å®è·µã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œè¿˜éœ€è¦æ ¹æ®å…·ä½“éœ€æ±‚é€‰æ‹©åˆé€‚çš„ç½‘ç»œè¯·æ±‚åº“å’Œç­–ç•¥ï¼Œä¸æ–­ä¼˜åŒ–å’Œæ”¹è¿›ã€‚

æœªæ¥ï¼Œéšç€Jetpack Composeçš„æ™®åŠï¼Œç½‘ç»œç¼–ç¨‹å¯èƒ½ä¼šè¿æ¥æ–°çš„å˜é©ï¼Œä½†æ ¸å¿ƒåŸç†å’Œæœ€ä½³å®è·µå°†ä¿æŒä¸å˜ã€‚å¸Œæœ›æœ¬æ–‡èƒ½ä¸ºä½ Androidç½‘ç»œç¼–ç¨‹ä¹‹æ—…æ‰“ä¸‹åšå®çš„åŸºç¡€ï¼

> è®°ä½ï¼Œä¼˜ç§€çš„ç½‘ç»œç¼–ç¨‹ä¸ä»…å…³ä¹æŠ€æœ¯ï¼Œæ›´å…³ä¹ç”¨æˆ·ä½“éªŒã€‚åœ¨ç½‘ç»œä¸ç¨³å®šçš„æƒ…å†µä¸‹ï¼Œä¼˜é›…åœ°é™çº§å¤„ç†ï¼Œç»™ç”¨æˆ·å¸¦æ¥æµç•…çš„ä½“éªŒï¼Œè¿™æ‰æ˜¯ç½‘ç»œç¼–ç¨‹çš„æœ€é«˜å¢ƒç•Œã€‚