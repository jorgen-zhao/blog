(window.webpackJsonp=window.webpackJsonp||[]).push([[544],{897:function(s,a,t){"use strict";t.r(a);var n=t(15),e=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),a("p",[s._v("在构建现代分布式系统时，我们常常面临如何确保数据一致性、系统可追溯性和性能优化的挑战。传统的CRUD(创建、读取、更新、删除)模型虽然简单直观，但在复杂业务场景下往往显得力不从心。事件溯源(Event Sourcing)与CQRS(Command Query Responsibility Segregation)模式为解决这些问题提供了强大的架构思路，而消息队列则是实现这两种模式的关键组件。")]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),a("p",[s._v("事件溯源与CQRS不是银弹，它们增加了系统的复杂性，但在需要高可靠性、审计能力和业务洞察力的场景中，它们的价值不可估量。")])]),s._v(" "),a("h2",{attrs:{id:"_1-事件溯源基础"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-事件溯源基础"}},[s._v("#")]),s._v(" 1. 事件溯源基础")]),s._v(" "),a("h3",{attrs:{id:"_1-1-什么是事件溯源"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-什么是事件溯源"}},[s._v("#")]),s._v(" 1.1 什么是事件溯源？")]),s._v(" "),a("p",[s._v("事件溯源是一种将应用状态变更表示为一系列不可变事件的架构模式。与传统的数据库模型不同，事件溯源不直接存储当前状态，而是存储导致状态变化的一系列事件。")]),s._v(" "),a("div",{staticClass:"language-mermaid line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-mermaid"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("graph")]),s._v(" LR\n    A"),a("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[用户操作]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" B"),a("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[生成事件]")]),s._v("\n    B "),a("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" C"),a("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[存储事件]")]),s._v("\n    C "),a("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" D"),a("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[更新状态]")]),s._v("\n    D "),a("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" E"),a("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[通过事件重建状态]")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h3",{attrs:{id:"_1-2-事件溯源的优势"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-事件溯源的优势"}},[s._v("#")]),s._v(" 1.2 事件溯源的优势")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("完整的审计轨迹")]),s._v("：所有状态变更都被记录为事件，提供完整的历史记录。")]),s._v(" "),a("li",[a("strong",[s._v("时间旅行能力")]),s._v("：可以重放任意时间点的事件，重建历史状态。")]),s._v(" "),a("li",[a("strong",[s._v("业务洞察力")]),s._v("：事件数据提供了丰富的业务洞察，便于分析和决策。")]),s._v(" "),a("li",[a("strong",[s._v("松耦合")]),s._v("：业务逻辑与存储实现分离，提高系统的灵活性。")])]),s._v(" "),a("h3",{attrs:{id:"_1-3-事件溯源的挑战"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-事件溯源的挑战"}},[s._v("#")]),s._v(" 1.3 事件溯源的挑战")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("查询复杂性")]),s._v("：获取当前状态需要重放所有事件，可能影响性能。")]),s._v(" "),a("li",[a("strong",[s._v("事件版本控制")]),s._v("：随着业务发展，事件结构可能需要演进。")]),s._v(" "),a("li",[a("strong",[s._v("数据一致性")]),s._v("：确保事件处理的幂等性和一致性变得更为复杂。")])]),s._v(" "),a("h2",{attrs:{id:"_2-cqrs模式详解"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-cqrs模式详解"}},[s._v("#")]),s._v(" 2. CQRS模式详解")]),s._v(" "),a("h3",{attrs:{id:"_2-1-cqrs的核心思想"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-cqrs的核心思想"}},[s._v("#")]),s._v(" 2.1 CQRS的核心思想")]),s._v(" "),a("p",[s._v("CQRS模式将系统的读写操作分离为两个不同的模型：")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("命令模型(Command Model)")]),s._v("：处理写操作，负责业务逻辑和状态变更。")]),s._v(" "),a("li",[a("strong",[s._v("查询模型(Query Model)")]),s._v("：处理读操作，专注于数据检索和展示。")])]),s._v(" "),a("div",{staticClass:"language-mermaid line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-mermaid"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("graph")]),s._v(" TB\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("subgraph")]),s._v(" 客户端\n        A"),a("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[客户端请求]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n    \n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("subgraph")]),s._v(" 命令端\n        B"),a("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[命令处理器]")]),s._v("\n        C"),a("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[领域模型]")]),s._v("\n        D"),a("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[事件存储]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n    \n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("subgraph")]),s._v(" 查询端\n        E"),a("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[查询处理器]")]),s._v("\n        F"),a("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[读取数据库]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n    \n    A "),a("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" B\n    A "),a("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" E\n    B "),a("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" C\n    C "),a("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" D\n    D "),a("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" E\n    E "),a("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" F\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("h3",{attrs:{id:"_2-2-cqrs的优势"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-cqrs的优势"}},[s._v("#")]),s._v(" 2.2 CQRS的优势")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("性能优化")]),s._v("：可以为读写操作分别优化，无需考虑折中。")]),s._v(" "),a("li",[a("strong",[s._v("安全性")]),s._v("：可以限制不同用户对命令端和查询端的访问权限。")]),s._v(" "),a("li",[a("strong",[s._v("可扩展性")]),s._v("：可以根据负载情况独立扩展命令端和查询端。")]),s._v(" "),a("li",[a("strong",[s._v("关注点分离")]),s._v("：使开发团队能够专注于特定领域的开发。")])]),s._v(" "),a("h3",{attrs:{id:"_2-3-cqrs的适用场景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-cqrs的适用场景"}},[s._v("#")]),s._v(" 2.3 CQRS的适用场景")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("读写比例不平衡")]),s._v("的系统")]),s._v(" "),a("li",[a("strong",[s._v("复杂领域模型")]),s._v("的应用")]),s._v(" "),a("li",[a("strong",[s._v("需要高性能读取")]),s._v("的场景")]),s._v(" "),a("li",[a("strong",[s._v("业务规则复杂且频繁变化")]),s._v("的系统")])]),s._v(" "),a("h2",{attrs:{id:"_3-消息队列在事件溯源与cqrs中的作用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-消息队列在事件溯源与cqrs中的作用"}},[s._v("#")]),s._v(" 3. 消息队列在事件溯源与CQRS中的作用")]),s._v(" "),a("h3",{attrs:{id:"_3-1-事件发布与订阅"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-事件发布与订阅"}},[s._v("#")]),s._v(" 3.1 事件发布与订阅")]),s._v(" "),a("p",[s._v("在事件溯源架构中，消息队列充当事件总线(Event Bus)的角色：")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 事件发布示例")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("OrderService")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("EventStore")]),s._v(" eventStore"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MessageQueue")]),s._v(" messageQueue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    \n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("placeOrder")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Order")]),s._v(" order"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 验证订单")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("validateOrder")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("order"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        \n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 创建事件")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("OrderPlacedEvent")]),s._v(" event "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("OrderPlacedEvent")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("order"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        \n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 存储事件")]),s._v("\n        eventStore"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("save")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("event"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        \n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 发布事件到消息队列")]),s._v("\n        messageQueue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("publish")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"order-events"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" event"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("h3",{attrs:{id:"_3-2-事件处理与投影"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-事件处理与投影"}},[s._v("#")]),s._v(" 3.2 事件处理与投影")]),s._v(" "),a("p",[s._v("消息队列使得事件处理可以异步进行，支持复杂的投影逻辑：")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 事件处理器示例")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("OrderProjectionHandler")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("OrderReadRepository")]),s._v(" readRepository"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    \n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Subscribe")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"order-events"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("handleOrderPlaced")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("OrderPlacedEvent")]),s._v(" event"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 更新读取模型")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("OrderReadModel")]),s._v(" readModel "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("OrderReadModel")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n            event"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getOrderId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            event"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getCustomerId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            event"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getItems")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"PLACED"')]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        readRepository"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("save")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("readModel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    \n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Subscribe")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"order-events"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("handleOrderPaid")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("OrderPaidEvent")]),s._v(" event"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 更新订单状态")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("OrderReadModel")]),s._v(" readModel "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" readRepository"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("findById")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("event"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getOrderId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        readModel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("setStatus")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"PAID"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        readRepository"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("save")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("readModel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br")])]),a("h3",{attrs:{id:"_3-3-最终一致性保证"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-最终一致性保证"}},[s._v("#")]),s._v(" 3.3 最终一致性保证")]),s._v(" "),a("p",[s._v("消息队列是实现最终一致性的关键组件：")]),s._v(" "),a("div",{staticClass:"language-mermaid line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-mermaid"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("sequenceDiagram")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("participant")]),s._v(" Client as 客户端\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("participant")]),s._v(" Command as 命令端\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("participant")]),s._v(" Queue as 消息队列\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("participant")]),s._v(" Query as 查询端\n    \n    Client"),a("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("->>")]),s._v("Command"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" 提交订单\n    Command"),a("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("->>")]),s._v("Queue"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" 发布OrderPlaced事件\n    Queue"),a("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("->>")]),s._v("Query"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" 异步传递事件\n    Query"),a("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("->>")]),s._v("Query"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" 更新读取模型\n    Query"),a("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e>")]),s._v("Client"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" 返回订单信息\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("h2",{attrs:{id:"_4-实现事件溯源与cqrs的最佳实践"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-实现事件溯源与cqrs的最佳实践"}},[s._v("#")]),s._v(" 4. 实现事件溯源与CQRS的最佳实践")]),s._v(" "),a("h3",{attrs:{id:"_4-1-事件设计原则"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-事件设计原则"}},[s._v("#")]),s._v(" 4.1 事件设计原则")]),s._v(" "),a("ol",[a("li",[a("strong",[s._v("事件应该描述事实")]),s._v('：使用过去时态命名事件，如"OrderPlaced"而非"PlaceOrder"。')]),s._v(" "),a("li",[a("strong",[s._v("事件应该包含足够信息")]),s._v("：事件应该包含重建状态所需的所有数据。")]),s._v(" "),a("li",[a("strong",[s._v("事件应该是不可变的")]),s._v("：一旦创建，事件不应被修改。")]),s._v(" "),a("li",[a("strong",[s._v("事件应该是幂等的")]),s._v("：多次处理同一事件不应导致状态变化。")])]),s._v(" "),a("h3",{attrs:{id:"_4-2-版本控制策略"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-版本控制策略"}},[s._v("#")]),s._v(" 4.2 版本控制策略")]),s._v(" "),a("p",[s._v("随着业务发展，事件结构可能需要演进：")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 使用接口定义事件基类")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("interface")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DomainEvent")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getEventType")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Instant")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getTimestamp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 版本1的事件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("OrderPlacedV1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("implements")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DomainEvent")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// V1字段")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 版本2的事件，添加新字段")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("OrderPlacedV2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("implements")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DomainEvent")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 包含V1所有字段")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 添加新字段")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 事件处理器需要处理多个版本")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Subscribe")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"order-events"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("handleOrderPlaced")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DomainEvent")]),s._v(" event"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("event "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("instanceof")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("OrderPlacedV1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 处理V1版本")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("event "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("instanceof")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("OrderPlacedV2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 处理V2版本")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br")])]),a("h3",{attrs:{id:"_4-3-消息队列选型考虑"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-消息队列选型考虑"}},[s._v("#")]),s._v(" 4.3 消息队列选型考虑")]),s._v(" "),a("p",[s._v("在选择消息队列实现事件溯源与CQRS时，应考虑以下因素：")]),s._v(" "),a("ol",[a("li",[a("strong",[s._v("持久性保证")]),s._v("：确保事件不会丢失。")]),s._v(" "),a("li",[a("strong",[s._v("至少一次传递")]),s._v("：避免事件丢失，但需要处理重复消息。")]),s._v(" "),a("li",[a("strong",[s._v("顺序保证")]),s._v("：某些场景下需要确保事件按顺序处理。")]),s._v(" "),a("li",[a("strong",[s._v("分区能力")]),s._v("：支持事件分区和并行处理。")]),s._v(" "),a("li",[a("strong",[s._v("死信队列")]),s._v("：处理无法正常处理的事件。")])]),s._v(" "),a("h2",{attrs:{id:"_5-案例分析-电商订单系统"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-案例分析-电商订单系统"}},[s._v("#")]),s._v(" 5. 案例分析：电商订单系统")]),s._v(" "),a("h3",{attrs:{id:"_5-1-系统架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-系统架构"}},[s._v("#")]),s._v(" 5.1 系统架构")]),s._v(" "),a("div",{staticClass:"language-mermaid line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-mermaid"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("graph")]),s._v(" TB\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("subgraph")]),s._v(" 用户界面\n        UI"),a("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[Web/Mobile UI]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n    \n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("subgraph")]),s._v(" API网关\n        API"),a("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[API网关]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n    \n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("subgraph")]),s._v(" 命令端\n        OrderCmd"),a("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[订单命令处理器]")]),s._v("\n        PaymentCmd"),a("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[支付命令处理器]")]),s._v("\n        InventoryCmd"),a("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[库存命令处理器]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n    \n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("subgraph")]),s._v(" 事件存储\n        ES"),a("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[事件存储]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n    \n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("subgraph")]),s._v(" 消息队列\n        MQ"),a("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[消息队列]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n    \n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("subgraph")]),s._v(" 查询端\n        OrderQuery"),a("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[订单查询处理器]")]),s._v("\n        PaymentQuery"),a("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[支付查询处理器]")]),s._v("\n        Analytics"),a("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[分析服务]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n    \n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("subgraph")]),s._v(" 读取数据库\n        RD"),a("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[读取数据库]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n    \n    UI "),a("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" API\n    API "),a("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" OrderCmd\n    API "),a("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" PaymentCmd\n    OrderCmd "),a("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" ES\n    PaymentCmd "),a("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" ES\n    InventoryCmd "),a("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" ES\n    ES "),a("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" MQ\n    MQ "),a("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" OrderQuery\n    MQ "),a("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" PaymentQuery\n    MQ "),a("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" Analytics\n    OrderQuery "),a("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" RD\n    PaymentQuery "),a("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" RD\n    Analytics "),a("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" RD\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br")])]),a("h3",{attrs:{id:"_5-2-关键事件流"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-关键事件流"}},[s._v("#")]),s._v(" 5.2 关键事件流")]),s._v(" "),a("ol",[a("li",[a("p",[a("strong",[s._v("订单创建流程")]),s._v("：")]),s._v(" "),a("ul",[a("li",[s._v("用户提交订单")]),s._v(" "),a("li",[s._v("OrderCmd处理器创建OrderPlaced事件")]),s._v(" "),a("li",[s._v("事件存储并发布到消息队列")]),s._v(" "),a("li",[s._v("OrderQuery处理器更新读取模型")]),s._v(" "),a("li",[s._v("InventoryCmd处理器处理库存扣减")])])]),s._v(" "),a("li",[a("p",[a("strong",[s._v("支付处理流程")]),s._v("：")]),s._v(" "),a("ul",[a("li",[s._v("用户发起支付")]),s._v(" "),a("li",[s._v("PaymentCmd处理器创建PaymentInitiated事件")]),s._v(" "),a("li",[s._v("支付网关处理支付")]),s._v(" "),a("li",[s._v("支付成功后发布PaymentCompleted事件")]),s._v(" "),a("li",[s._v("相关处理器更新状态")])])])]),s._v(" "),a("h3",{attrs:{id:"_5-3-性能优化策略"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-性能优化策略"}},[s._v("#")]),s._v(" 5.3 性能优化策略")]),s._v(" "),a("ol",[a("li",[a("strong",[s._v("事件批处理")]),s._v("：将多个事件合并处理，减少数据库操作。")]),s._v(" "),a("li",[a("strong",[s._v("缓存策略")]),s._v("：对热点查询数据使用缓存。")]),s._v(" "),a("li",[a("strong",[s._v("读写分离")]),s._v("：使用不同的数据库实例处理读写操作。")]),s._v(" "),a("li",[a("strong",[s._v("异步投影")]),s._v("：将投影操作异步执行，不影响主流程。")])]),s._v(" "),a("h2",{attrs:{id:"_6-结语"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-结语"}},[s._v("#")]),s._v(" 6. 结语")]),s._v(" "),a("p",[s._v("事件溯源与CQRS模式结合消息队列，为构建高可追溯性、高性能的分布式系统提供了强大的架构思路。虽然实现这些模式会增加系统复杂性，但它们带来的业务价值和技术优势使其在许多场景下成为理想选择。")]),s._v(" "),a("p",[s._v("在实施过程中，我们需要根据具体业务需求权衡利弊，选择合适的事件粒度、队列策略和一致性保证机制。随着系统演进，持续优化和重构也是必不可少的。")]),s._v(" "),a("blockquote",[a("p",[s._v('"事件溯源不是关于存储数据，而是关于存储变化。CQRS不是关于分离读写，而是关于为不同目的优化系统。"')])]),s._v(" "),a("p",[s._v("通过合理运用这些架构模式，我们可以构建更加健壮、可维护且具有业务洞察力的系统，为企业的数字化转型提供坚实的技术基础。")]),s._v(" "),a("hr"),s._v(" "),a("p",[a("em",[s._v("本文为Jorgen的技术博客原创内容，如需转载请注明出处。")])])])}),[],!1,null,null,null);a.default=e.exports}}]);