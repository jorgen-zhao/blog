(window.webpackJsonp=window.webpackJsonp||[]).push([[434],{786:function(v,_,t){"use strict";t.r(_);var a=t(15),r=Object(a.a)({},(function(){var v=this,_=v._self._c;return _("ContentSlotsDistributor",{attrs:{"slot-key":v.$parent.slotKey}},[_("h2",{attrs:{id:"前言"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[v._v("#")]),v._v(" 前言")]),v._v(" "),_("p",[v._v("在分布式系统的世界里，一致性是一个永恒的话题。我们之前已经了解了CAP定理和BASE理论，知道了分布式系统需要在一致性、可用性和分区容错性之间做出权衡。但是，理论归理论，在实际的分布式系统中，我们究竟是如何实现一致性的呢？")]),v._v(" "),_("p",[v._v("今天，我们就来深入探讨分布式系统中两个最重要的一致性协议：Paxos和Raft。这两个协议不仅是学术研究的热点，也是许多实际分布式系统的基础。")]),v._v(" "),_("div",{staticClass:"custom-block tip"},[_("p",{staticClass:"custom-block-title"},[v._v("提示")]),v._v(" "),_("p",[v._v("一致性协议是分布式系统的核心，理解它们对于构建可靠的分布式系统至关重要。")])]),v._v(" "),_("h2",{attrs:{id:"一致性的挑战"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#一致性的挑战"}},[v._v("#")]),v._v(" 一致性的挑战")]),v._v(" "),_("p",[v._v("在单机系统中，数据一致性相对容易实现。但在分布式系统中，由于网络延迟、节点故障、消息丢失等因素，实现一致性变得异常复杂。")]),v._v(" "),_("p",[v._v("假设我们有一个简单的场景：在多个节点上维护一个共享的计数器。当某个节点收到增加计数器的请求时，它需要确保所有节点都同意这个增加操作，并且最终所有节点的计数值都相同。")]),v._v(" "),_("p",[v._v("这看似简单，但在实际系统中会遇到各种问题：")]),v._v(" "),_("ul",[_("li",[v._v("节点之间可能无法通信（网络分区）")]),v._v(" "),_("li",[v._v("节点可能随时崩溃")]),v._v(" "),_("li",[v._v("消息可能延迟或丢失")]),v._v(" "),_("li",[v._v("多个节点可能同时收到冲突的请求")])]),v._v(" "),_("p",[v._v("为了解决这些问题，科学家们提出了各种一致性协议，其中Paxos和Raft是最具代表性的两个。")]),v._v(" "),_("h2",{attrs:{id:"paxos协议"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#paxos协议"}},[v._v("#")]),v._v(" Paxos协议")]),v._v(" "),_("p",[v._v("Paxos协议由Leslie Lamport于1990年提出，是第一个被证明的正确性可以得到保证的一致性协议。尽管Paxos在理论上很完美，但在实际应用中却因其复杂性和难以理解而备受争议。")]),v._v(" "),_("h3",{attrs:{id:"paxos的角色"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#paxos的角色"}},[v._v("#")]),v._v(" Paxos的角色")]),v._v(" "),_("p",[v._v("Paxos协议中有三种角色：")]),v._v(" "),_("ol",[_("li",[_("strong",[v._v("Proposer（提议者）")]),v._v("：提出提案（包括值和编号）")]),v._v(" "),_("li",[_("strong",[v._v("Acceptor（接受者）")]),v._v("：接受或拒绝提案")]),v._v(" "),_("li",[_("strong",[v._v("Learner（学习者）")]),v._v("：学习被接受的提案")])]),v._v(" "),_("h3",{attrs:{id:"paxos的两个阶段"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#paxos的两个阶段"}},[v._v("#")]),v._v(" Paxos的两个阶段")]),v._v(" "),_("p",[v._v("Paxos协议主要分为两个阶段：")]),v._v(" "),_("h4",{attrs:{id:"第一阶段-准备阶段-prepare"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#第一阶段-准备阶段-prepare"}},[v._v("#")]),v._v(" 第一阶段：准备阶段（Prepare）")]),v._v(" "),_("ol",[_("li",[v._v("Proposer选择一个提案编号n，向大多数Acceptor发送prepare(n)消息")]),v._v(" "),_("li",[v._v("Acceptor收到prepare(n)消息后：\n"),_("ul",[_("li",[v._v("如果n大于它已经响应过的任何提案编号，则回复promise(n)，承诺不再接受编号小于n的提案")]),v._v(" "),_("li",[v._v("同时，如果它已经接受过某个编号小于n的提案，则将该提案的信息一并发送")])])])]),v._v(" "),_("h4",{attrs:{id:"第二阶段-接受阶段-accept"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#第二阶段-接受阶段-accept"}},[v._v("#")]),v._v(" 第二阶段：接受阶段（Accept）")]),v._v(" "),_("ol",[_("li",[v._v("如果Proposer收到大多数Acceptor的promise(n)响应，就可以发送accept(n, v)消息\n"),_("ul",[_("li",[v._v("v可以是它自己的值，或者是某个Acceptor在promise中返回的值")])])]),v._v(" "),_("li",[v._v("Acceptor收到accept(n, v)消息后：\n"),_("ul",[_("li",[v._v("如果n是它承诺接受的最大的编号之一，则接受该提案并回复accepted(n, v)")])])]),v._v(" "),_("li",[v._v("如果Proposer收到大多数Acceptor的accepted(n, v)响应，则提案v被选定为值")])]),v._v(" "),_("h3",{attrs:{id:"paxos的局限性"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#paxos的局限性"}},[v._v("#")]),v._v(" Paxos的局限性")]),v._v(" "),_("p",[v._v("尽管Paxos在理论上很完美，但它存在一些明显的局限性：")]),v._v(" "),_("ul",[_("li",[_("strong",[v._v("难以理解")]),v._v("：Paxos的描述非常抽象，实现起来也很复杂")]),v._v(" "),_("li",[_("strong",[v._v("活锁问题")]),v._v("：多个Proposer可能同时提出提案，导致系统无法推进")]),v._v(" "),_("li",[_("strong",[v._v("缺乏实际应用")]),v._v("：虽然学术界广泛研究，但实际系统中很少直接使用Paxos")])]),v._v(" "),_("h2",{attrs:{id:"raft算法"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#raft算法"}},[v._v("#")]),v._v(" Raft算法")]),v._v(" "),_("p",[v._v("为了解决Paxos的复杂性问题，Diego Ongaro和John Ousterhout在2013年提出了Raft算法。Raft的设计目标是提供一种更易于理解和实现的一致性协议。")]),v._v(" "),_("h3",{attrs:{id:"raft的核心思想"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#raft的核心思想"}},[v._v("#")]),v._v(" Raft的核心思想")]),v._v(" "),_("p",[v._v("Raft将一致性问题分解为几个相对独立的子问题：")]),v._v(" "),_("ol",[_("li",[_("strong",[v._v("领导人选举")]),v._v("：在集群中选举一个领导人")]),v._v(" "),_("li",[_("strong",[v._v("日志复制")]),v._v("：领导人将日志复制到其他节点")]),v._v(" "),_("li",[_("strong",[v._v("安全性")]),v._v("：确保在任何情况下系统状态的一致性")])]),v._v(" "),_("h3",{attrs:{id:"raft的角色"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#raft的角色"}},[v._v("#")]),v._v(" Raft的角色")]),v._v(" "),_("p",[v._v("Raft中有三种角色：")]),v._v(" "),_("ol",[_("li",[_("strong",[v._v("Leader（领导者）")]),v._v("：处理所有客户端请求，负责日志复制")]),v._v(" "),_("li",[_("strong",[v._v("Follower（跟随者）")]),v._v("：被动接收来自领导人的日志，不处理客户端请求")]),v._v(" "),_("li",[_("strong",[v._v("Candidate（候选人）")]),v._v("：在领导人选举中，跟随者可以转变为候选人")])]),v._v(" "),_("h3",{attrs:{id:"领导人选举"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#领导人选举"}},[v._v("#")]),v._v(" 领导人选举")]),v._v(" "),_("p",[v._v("Raft的领导人选举过程如下：")]),v._v(" "),_("ol",[_("li",[v._v("系统初始时，所有节点都是Follower")]),v._v(" "),_("li",[v._v("如果一个Follower在一定时间内没有收到领导人的心跳，它会转变为Candidate")]),v._v(" "),_("li",[v._v("Candidate向其他节点发送RequestVote请求")]),v._v(" "),_("li",[v._v("其他节点根据Candidate的日志情况决定是否投票")]),v._v(" "),_("li",[v._v("如果Candidate获得大多数投票，它就成为新的Leader")]),v._v(" "),_("li",[v._v("如果多个Candidate同时存在，可能会导致再次选举，直到选出Leader")])]),v._v(" "),_("h3",{attrs:{id:"日志复制"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#日志复制"}},[v._v("#")]),v._v(" 日志复制")]),v._v(" "),_("p",[v._v("一旦Leader被选出，它就开始处理客户端请求并复制日志：")]),v._v(" "),_("ol",[_("li",[v._v("Leader将客户端请求作为新的条目添加到自己的日志中")]),v._v(" "),_("li",[v._v("Leader将该条目通过AppendEntries RPC发送到所有Follower")]),v._v(" "),_("li",[v._v("Follower收到条目后，将其添加到自己的日志中并回复")]),v._v(" "),_("li",[v._v('当Leader收到大多数Follower的确认后，该条目就被认为是"已提交"的')]),v._v(" "),_("li",[v._v("Leader通知所有Follower哪些条目已被提交，Follower将这些条目应用到自己的状态机中")])]),v._v(" "),_("h3",{attrs:{id:"安全性保证"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#安全性保证"}},[v._v("#")]),v._v(" 安全性保证")]),v._v(" "),_("p",[v._v("Raft通过以下机制确保系统的安全性：")]),v._v(" "),_("ul",[_("li",[_("strong",[v._v("选举限制")]),v._v("：只有包含所有已提交日志的节点才能成为Leader")]),v._v(" "),_("li",[_("strong",[v._v("日志匹配")]),v._v("：如果两个日志包含相同的索引和任期号，那么它们前面的所有日志也相同")]),v._v(" "),_("li",[_("strong",[v._v("领导人完全性")]),v._v("：Leader永远不会覆盖或删除自己的日志")])]),v._v(" "),_("h2",{attrs:{id:"paxos与raft的比较"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#paxos与raft的比较"}},[v._v("#")]),v._v(" Paxos与Raft的比较")]),v._v(" "),_("table",[_("thead",[_("tr",[_("th",[v._v("特性")]),v._v(" "),_("th",[v._v("Paxos")]),v._v(" "),_("th",[v._v("Raft")])])]),v._v(" "),_("tbody",[_("tr",[_("td",[v._v("设计目标")]),v._v(" "),_("td",[v._v("理论正确性")]),v._v(" "),_("td",[v._v("可理解性和可实现性")])]),v._v(" "),_("tr",[_("td",[v._v("复杂度")]),v._v(" "),_("td",[v._v("高，难以理解")]),v._v(" "),_("td",[v._v("低，结构清晰")])]),v._v(" "),_("tr",[_("td",[v._v("角色")]),v._v(" "),_("td",[v._v("Proposer, Acceptor, Learner")]),v._v(" "),_("td",[v._v("Leader, Follower, Candidate")])]),v._v(" "),_("tr",[_("td",[v._v("领导人选举")]),v._v(" "),_("td",[v._v("不明确，需要额外实现")]),v._v(" "),_("td",[v._v("明确的选举机制")])]),v._v(" "),_("tr",[_("td",[v._v("实际应用")]),v._v(" "),_("td",[v._v("很少直接使用")]),v._v(" "),_("td",[v._v("被许多系统采用（如etcd, Consul）")])]),v._v(" "),_("tr",[_("td",[v._v("性能")]),v._v(" "),_("td",[v._v("相对较低")]),v._v(" "),_("td",[v._v("通过优化可以达到较高性能")])])])]),v._v(" "),_("h2",{attrs:{id:"实际应用中的选择"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#实际应用中的选择"}},[v._v("#")]),v._v(" 实际应用中的选择")]),v._v(" "),_("p",[v._v("在选择一致性协议时，我们需要考虑以下几个因素：")]),v._v(" "),_("ol",[_("li",[_("strong",[v._v("可理解性")]),v._v("：Raft由于其清晰的结构和明确的流程，更容易被团队理解和实现")]),v._v(" "),_("li",[_("strong",[v._v("性能需求")]),v._v("：对于高性能要求的场景，可能需要考虑优化后的Paxos变种")]),v._v(" "),_("li",[_("strong",[v._v("生态系统")]),v._v("：Raft有更多的开源实现和工具支持")]),v._v(" "),_("li",[_("strong",[v._v("特殊需求")]),v._v("：某些特殊场景可能需要Paxos的灵活性")])]),v._v(" "),_("p",[v._v("目前，大多数新系统都倾向于选择Raft或其变种，如etcd、Consul、TiDB等都使用了Raft作为一致性协议。")]),v._v(" "),_("h2",{attrs:{id:"结语"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#结语"}},[v._v("#")]),v._v(" 结语")]),v._v(" "),_("p",[v._v("分布式一致性协议是构建可靠分布式系统的基石。Paxos作为理论的先驱，为一致性研究奠定了基础；而Raft则以其清晰的设计和良好的可理解性，在实际系统中得到了广泛应用。")]),v._v(" "),_("p",[v._v("理解这些协议不仅有助于我们更好地使用现有的分布式系统，也能为我们在设计和实现自己的分布式系统时提供宝贵的参考。")]),v._v(" "),_("blockquote",[_("p",[v._v("在分布式系统的世界里，没有银弹，只有不断权衡和选择。选择合适的一致性协议，是构建可靠系统的第一步。")])]),v._v(" "),_("div",{staticClass:"custom-block right"},[_("p",[v._v("— Jorgen")])])])}),[],!1,null,null,null);_.default=r.exports}}]);