(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{360:function(e,s,t){"use strict";t.r(s);var a=t(14),n=Object(a.a)({},(function(){var e=this,s=e._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h2",{attrs:{id:"背景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#背景"}},[e._v("#")]),e._v(" 背景")]),e._v(" "),s("p",[e._v("当后台服务器判断出现了报警信息，需要主动推送到客户端【web、小程序】，然后客户端接收到通知之后，向服务器端进行查询")]),e._v(" "),s("h2",{attrs:{id:"技术选型"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#技术选型"}},[e._v("#")]),e._v(" 技术选型")]),e._v(" "),s("blockquote",[s("p",[s("code",[e._v("Netty")]),e._v(" + "),s("code",[e._v("webSocket")]),e._v(" + "),s("code",[e._v("protobuf")])])]),e._v(" "),s("ul",[s("li",[e._v("Netty：作为高性能网络框架，一般将用于网络对接时框架首选")]),e._v(" "),s("li",[e._v("websocket：服务器端向客户端通信，目前浏览器方案【PC、小程序】的不二之选")]),e._v(" "),s("li",[e._v("protobuf：Google开源的传输协议，可降低传输带宽，相比使用字符串传输，也可起到数据加密的作用")]),e._v(" "),s("li",[e._v("Nginx："),s("a",{attrs:{href:"https://www.cnblogs.com/ybyqjzl/p/10350732.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("Nginx代理websocket长链接"),s("OutboundLink")],1)])]),e._v(" "),s("h2",{attrs:{id:"功能设计"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#功能设计"}},[e._v("#")]),e._v(" 功能设计")]),e._v(" "),s("ol",[s("li",[e._v("客户端通过"),s("code",[e._v("websocket")]),e._v("方式连接服务器端，主动发送token进行校验。目前初步校验：当前用户是否是成功登录用户")]),e._v(" "),s("li",[e._v("推送执行的场景\n"),s("ul",[s("li",[e._v("报警产生时")]),e._v(" "),s("li",[e._v("报警状态变化【未处理】")])])]),e._v(" "),s("li",[e._v("推送对象\n"),s("ul",[s("li",[e._v("imei — group — username，获取设备报警需要推送的用户")]),e._v(" "),s("li",[e._v("client connect server，将经过校验的用户放入缓存")])])]),e._v(" "),s("li",[e._v("推送流程\n"),s("ul",[s("li",[e._v("设备报警状态变更，判断该"),s("code",[e._v("设备")]),e._v("需要推送给那些"),s("code",[e._v("用户")])]),e._v(" "),s("li",[e._v("判断通过websocket"),s("code",[e._v("连接的用户")]),e._v("有多少，进行"),s("code",[e._v("推送")])])])])]),e._v(" "),s("h2",{attrs:{id:"功能实现"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#功能实现"}},[e._v("#")]),e._v(" 功能实现")]),e._v(" "),s("ol",[s("li",[e._v("通过设备查询该设备所属分组 groupId")]),e._v(" "),s("li",[e._v("判断当前系统有多少用户已经连接 username — tokenId")]),e._v(" "),s("li",[e._v("通过"),s("code",[e._v("admin:user_groupIds")]),e._v(" 判断连接的用户，有多少需要推送【groupId 是否包含】")])]),e._v(" "),s("h2",{attrs:{id:"nginx配置websocket代理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nginx配置websocket代理"}},[e._v("#")]),e._v(" Nginx配置websocket代理")]),e._v(" "),s("ol",[s("li",[e._v("编辑"),s("code",[e._v("nginx.conf")]),e._v("，在http区域内一定要添加下面配置：")])]),e._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[e._v("map "),s("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$http_upgrade")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$connection_upgrade")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    default upgrade"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("''")]),e._v(" close"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br")])]),s("ol",{attrs:{start:"2"}},[s("li",[s("p",[e._v("map指令的作用：\n该作用主要是根据客户端请求中"),s("code",[e._v("$http_upgrade")]),e._v(" 的值，来构造改变"),s("code",[e._v("$connection_upgrade")]),e._v("的值，即根据变量"),s("code",[e._v("$http_upgrade")]),e._v("的值创建的变量"),s("code",[e._v("$connection_upgrade")]),e._v("，创建的规则就是"),s("code",[e._v("{}")]),e._v("里面的东西。其中的规则没有做匹配，因此使用默认的，即 "),s("code",[e._v("$connection_upgrade")]),e._v(" 的值会一直是 "),s("code",[e._v("upgrade")]),e._v("。然后果 "),s("code",[e._v("$http_upgrade")]),e._v("为空字符串的话，那值会是 "),s("code",[e._v("close")]),e._v("。")])]),e._v(" "),s("li",[s("p",[e._v("编辑vhosts下虚拟主机的配置文件，在location匹配配置中添加如下内容：")])])]),e._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[e._v("proxy_http_version "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1.1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\nproxy_set_header Upgrade "),s("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$http_upgrade")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\nproxy_set_header Connection "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Upgrade"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br")])]),s("p",[e._v("示例如下：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('upstream socket.kevin.com {\n    hash $remote_addr consistent;\n    server 192.168.1.168:9088;\n}\n\n location / {\n            proxy_pass http://socket.kevin.com/;\n            proxy_set_header Host $host:$server_port;\n            proxy_http_version 1.1;\n            proxy_set_header Upgrade $http_upgrade;\n            proxy_set_header Connection "upgrade";\n        }\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br")])]),s("ol",{attrs:{start:"4"}},[s("li",[e._v("可能会出现跨域问题，server区块填写以下跨域配置即可")])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v(" add_header Access-Control-Allow-Origin *;\n add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';\n add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';\n if ($request_method = 'OPTIONS') {        return 204;    }\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br")])])])}),[],!1,null,null,null);s.default=n.exports}}]);