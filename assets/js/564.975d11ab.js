(window.webpackJsonp=window.webpackJsonp||[]).push([[564],{916:function(s,t,a){"use strict";a.r(t);var n=a(15),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"前言"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),t("p",[s._v("在分布式系统中，消息队列扮演着至关重要的角色，它不仅能够解耦系统组件，还能提高系统的弹性和可扩展性。然而，消息队列的核心价值在于提供"),t("strong",[s._v("可靠的消息传递服务")]),s._v("。如果消息丢失、重复或乱序，可能会导致严重的业务问题。")]),s._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),t("p",[s._v('"在分布式系统中，没有什么是绝对的可靠，只有不同程度的可靠性保障。"')])]),s._v(" "),t("p",[s._v("本文将深入探讨消息队列的可靠性机制，分析如何确保消息不丢失、不重复、不乱序，以及在实际应用中如何平衡性能与可靠性。")]),s._v(" "),t("h2",{attrs:{id:"消息不可靠的三种场景"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#消息不可靠的三种场景"}},[s._v("#")]),s._v(" 消息不可靠的三种场景")]),s._v(" "),t("p",[s._v("在讨论如何保证可靠性之前，我们先来看看消息不可靠的三种典型场景：")]),s._v(" "),t("h3",{attrs:{id:"_1-消息丢失"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-消息丢失"}},[s._v("#")]),s._v(" 1. 消息丢失")]),s._v(" "),t("p",[s._v("消息丢失可能发生在以下几个环节：")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("生产者发送时丢失")]),s._v("：生产者将消息发送到消息队列的过程中，由于网络问题或系统故障导致消息未成功发送。")]),s._v(" "),t("li",[t("strong",[s._v("消息队列存储时丢失")]),s._v("：消息队列在存储消息时，由于磁盘故障、系统崩溃等原因导致消息数据丢失。")]),s._v(" "),t("li",[t("strong",[s._v("消费者消费时丢失")]),s._v("：消费者从消息队列获取消息后，在处理过程中发生异常，消息已出队但未被成功处理。")])]),s._v(" "),t("h3",{attrs:{id:"_2-消息重复"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-消息重复"}},[s._v("#")]),s._v(" 2. 消息重复")]),s._v(" "),t("p",[s._v("消息重复通常发生在以下场景：")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("生产者重试")]),s._v("：生产者发送消息后未收到确认，超时后重试，导致消息重复。")]),s._v(" "),t("li",[t("strong",[s._v("消费者处理失败")]),s._v("：消费者处理消息失败，消息可能重新入队，导致重复消费。")]),s._v(" "),t("li",[t("strong",[s._v("网络分区")]),s._v("：在网络分区恢复后，消息可能被重复投递。")])]),s._v(" "),t("h3",{attrs:{id:"_3-消息乱序"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-消息乱序"}},[s._v("#")]),s._v(" 3. 消息乱序")]),s._v(" "),t("p",[s._v("消息乱序主要发生在以下情况：")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("分区/队列内的乱序")]),s._v("：在单分区/队列内，由于并发处理或网络延迟，消息的发送和消费顺序不一致。")]),s._v(" "),t("li",[t("strong",[s._v("分区/队列间的乱序")]),s._v("：在多分区/队列的场景下，不同分区的消息处理速度不同，导致全局消息顺序混乱。")])]),s._v(" "),t("h2",{attrs:{id:"确保消息不丢失的机制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#确保消息不丢失的机制"}},[s._v("#")]),s._v(" 确保消息不丢失的机制")]),s._v(" "),t("h3",{attrs:{id:"_1-生产者确认机制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-生产者确认机制"}},[s._v("#")]),s._v(" 1. 生产者确认机制")]),s._v(" "),t("p",[s._v("生产者确认机制是防止消息在生产端丢失的第一道防线：")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 以RabbitMQ为例，开启生产者确认")]),s._v("\nchannel"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("confirmSelect")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nchannel"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("addConfirmListener")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ConfirmListener")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("handleAck")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),s._v(" deliveryTag"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("boolean")]),s._v(" multiple"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 消息成功投递到队列")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("handleNack")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),s._v(" deliveryTag"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("boolean")]),s._v(" multiple"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 消息投递失败，需要重试")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("div",{staticClass:"custom-block theorem"},[t("p",{staticClass:"title"},[s._v("THEOREM")]),t("p",[s._v("生产者确认机制的核心思想是：消息队列在成功接收并持久化消息后，向生产者发送确认信号，只有收到确认后，生产者才认为消息发送成功。")])]),t("h3",{attrs:{id:"_2-消息持久化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-消息持久化"}},[s._v("#")]),s._v(" 2. 消息持久化")]),s._v(" "),t("p",[s._v("消息持久化是防止消息在队列中丢失的关键措施：")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("持久化存储")]),s._v("：将消息写入磁盘而非内存，即使系统崩溃也能恢复。")]),s._v(" "),t("li",[t("strong",[s._v("副本机制")]),s._v("：通过多副本复制，防止单点故障导致数据丢失。")])]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("消息队列")]),s._v(" "),t("th",[s._v("持久化方式")]),s._v(" "),t("th",[s._v("副本机制")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("RabbitMQ")]),s._v(" "),t("td",[s._v("持久化交换机和队列")]),s._v(" "),t("td",[s._v("镜像队列")])]),s._v(" "),t("tr",[t("td",[s._v("Kafka")]),s._v(" "),t("td",[s._v("分区副本机制")]),s._v(" "),t("td",[s._v("Leader-Follower副本")])]),s._v(" "),t("tr",[t("td",[s._v("RocketMQ")]),s._v(" "),t("td",[s._v("消息落盘")]),s._v(" "),t("td",[s._v("主从同步")])])])]),s._v(" "),t("h3",{attrs:{id:"_3-消费者幂等性"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-消费者幂等性"}},[s._v("#")]),s._v(" 3. 消费者幂等性")]),s._v(" "),t("p",[s._v("消费者幂等性是防止消息在消费端丢失的最后防线：")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 使用数据库唯一键防止重复处理")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("processOrder")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Message")]),s._v(" message"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 尝试插入处理记录，如果已存在则跳过")]),s._v("\n        processingLogRepository"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("insert")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("message"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        \n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 实际业务处理逻辑")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DuplicateKeyException")]),s._v(" e"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 记录已处理，跳过")]),s._v("\n        log"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("info")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Message already processed: {}"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" message"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),t("p",[s._v("实现消费者幂等性的常见方法：")]),s._v(" "),t("ol",[t("li",[s._v("使用数据库唯一约束")]),s._v(" "),t("li",[s._v("使用Redis记录已处理的消息ID")]),s._v(" "),t("li",[s._v("在消息中包含版本号，通过乐观锁机制防止重复处理")])])]),s._v(" "),t("h2",{attrs:{id:"确保消息不重复的机制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#确保消息不重复的机制"}},[s._v("#")]),s._v(" 确保消息不重复的机制")]),s._v(" "),t("h3",{attrs:{id:"_1-唯一id去重"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-唯一id去重"}},[s._v("#")]),s._v(" 1. 唯一ID去重")]),s._v(" "),t("p",[s._v("为每条消息生成唯一ID，在消费端进行去重处理：")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 使用雪花算法生成唯一消息ID")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" messageId "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SnowflakeIdWorker")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("generateId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 消费端去重处理")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("redisTemplate"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("hasKey")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"processed_messages:"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" messageId"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 处理消息")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("processMessage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("message"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 记录已处理的消息ID")]),s._v("\n    redisTemplate"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("opsForValue")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"processed_messages:"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" messageId"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("TimeUnit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("HOURS")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("h3",{attrs:{id:"_2-事务消息"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-事务消息"}},[s._v("#")]),s._v(" 2. 事务消息")]),s._v(" "),t("p",[s._v('通过事务消息确保消息的"Exactly-Once"语义：')]),s._v(" "),t("ol",[t("li",[t("p",[t("strong",[s._v("本地事务与消息发送的一致性")]),s._v("：")]),s._v(" "),t("ul",[t("li",[s._v("执行本地事务")]),s._v(" "),t("li",[s._v("发送消息到消息队列")]),s._v(" "),t("li",[s._v("只有本地事务执行成功，消息才会被发送")])])]),s._v(" "),t("li",[t("p",[t("strong",[s._v("事务状态回查")]),s._v("：")]),s._v(" "),t("ul",[t("li",[s._v("如果消息发送失败，消息队列会定期回查事务状态")]),s._v(" "),t("li",[s._v("根据回查结果决定是否重新发送消息")])])])]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 伪代码：本地事务与消息发送的一致性")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("executeTransactionWithMessage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 1. 执行本地事务")]),s._v("\n        localTransactionService"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("execute")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        \n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 2. 发送消息")]),s._v("\n        messageQueue"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("send")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("transactionMessage"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        \n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 3. 记录事务状态")]),s._v("\n        transactionLogRepository"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("markAsSuccess")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("transactionId"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Exception")]),s._v(" e"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 事务失败，记录状态")]),s._v("\n        transactionLogRepository"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("markAsFailed")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("transactionId"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("h2",{attrs:{id:"确保消息不乱序的机制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#确保消息不乱序的机制"}},[s._v("#")]),s._v(" 确保消息不乱序的机制")]),s._v(" "),t("h3",{attrs:{id:"_1-单分区-单队列消费"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-单分区-单队列消费"}},[s._v("#")]),s._v(" 1. 单分区/单队列消费")]),s._v(" "),t("p",[s._v("最简单的保证顺序的方式是使用单分区或单队列：")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 创建单分区主题")]),s._v("\nadminClient"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("createTopics")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Collections")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("singletonList")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("NewTopic")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"order-topic"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("short")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("div",{staticClass:"custom-block right"},[t("p",[s._v('"单分区/单队列是最简单但也是最低效的顺序保证方式。"')])]),s._v(" "),t("h3",{attrs:{id:"_2-消息分组与序列号"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-消息分组与序列号"}},[s._v("#")]),s._v(" 2. 消息分组与序列号")]),s._v(" "),t("p",[s._v("通过消息分组和序列号保证相关消息的顺序：")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 消息分组处理")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("processMessageWithGrouping")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Message")]),s._v(" message"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" groupKey "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" message"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getGroupKey")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" sequence "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" message"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getSequence")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 使用分布式锁保证同组消息顺序处理")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("synchronized")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getLock")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("groupKey"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 检查序列号是否连续")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sequence "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getNextExpectedSequence")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("groupKey"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("processMessage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("message"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("updateNextExpectedSequence")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("groupKey"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" sequence "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 序列号不连续，暂存消息")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("bufferMessage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("message"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("h3",{attrs:{id:"_3-全局顺序与局部顺序"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-全局顺序与局部顺序"}},[s._v("#")]),s._v(" 3. 全局顺序与局部顺序")]),s._v(" "),t("p",[s._v("在实际应用中，我们通常不需要全局顺序，只需要局部顺序：")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("顺序类型")]),s._v(" "),t("th",[s._v("适用场景")]),s._v(" "),t("th",[s._v("实现方式")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("全局顺序")]),s._v(" "),t("td",[s._v("需要严格顺序的业务")]),s._v(" "),t("td",[s._v("单分区/单队列")])]),s._v(" "),t("tr",[t("td",[s._v("局部顺序")]),s._v(" "),t("td",[s._v("相关消息需要顺序")]),s._v(" "),t("td",[s._v("消息分组+序列号")])]),s._v(" "),t("tr",[t("td",[s._v("无顺序")]),s._v(" "),t("td",[s._v("无顺序要求的业务")]),s._v(" "),t("td",[s._v("多分区并行处理")])])])]),s._v(" "),t("h2",{attrs:{id:"可靠性与性能的平衡"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#可靠性与性能的平衡"}},[s._v("#")]),s._v(" 可靠性与性能的平衡")]),s._v(" "),t("p",[s._v("在实现消息队列可靠性机制时，我们需要考虑可靠性与性能之间的平衡：")]),s._v(" "),t("h3",{attrs:{id:"_1-可靠性级别"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-可靠性级别"}},[s._v("#")]),s._v(" 1. 可靠性级别")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("可靠性级别")]),s._v(" "),t("th",[s._v("描述")]),s._v(" "),t("th",[s._v("性能影响")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("At-Least-Once")]),s._v(" "),t("td",[s._v("至少一次，可能重复")]),s._v(" "),t("td",[s._v("中等")])]),s._v(" "),t("tr",[t("td",[s._v("Exactly-Once")]),s._v(" "),t("td",[s._v("精确一次，不重复不丢失")]),s._v(" "),t("td",[s._v("高")])]),s._v(" "),t("tr",[t("td",[s._v("At-Most-Once")]),s._v(" "),t("td",[s._v("最多一次，可能丢失")]),s._v(" "),t("td",[s._v("低")])])])]),s._v(" "),t("h3",{attrs:{id:"_2-性能优化策略"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-性能优化策略"}},[s._v("#")]),s._v(" 2. 性能优化策略")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("批量处理")]),s._v("：批量发送和消费消息，减少网络开销")]),s._v(" "),t("li",[t("strong",[s._v("异步确认")]),s._v("：异步处理消息确认，提高吞吐量")]),s._v(" "),t("li",[t("strong",[s._v("本地缓存")]),s._v("：在本地缓存消息，减少对消息队列的访问")]),s._v(" "),t("li",[t("strong",[s._v("分级存储")]),s._v("：将热点数据和冷数据分开存储")])]),s._v(" "),t("h2",{attrs:{id:"结语"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#结语"}},[s._v("#")]),s._v(" 结语")]),s._v(" "),t("p",[s._v("消息队列的可靠性是分布式系统设计中不可忽视的重要环节。通过合理运用生产者确认、消息持久化、消费者幂等性等机制，我们可以构建出高可靠性的消息传递系统。")]),s._v(" "),t("p",[s._v("在实际应用中，我们需要根据业务需求选择合适的可靠性级别，并在可靠性与性能之间做出权衡。记住，没有放之四海而皆准的解决方案，只有最适合当前业务场景的架构设计。")]),s._v(" "),t("blockquote",[t("p",[s._v('"可靠性不是一蹴而就的，而是在系统设计、实现和运维的每一个环节中不断完善的。"')])]),s._v(" "),t("p",[s._v("希望本文能帮助你更好地理解和实现消息队列的可靠性机制。如果你有任何问题或建议，欢迎在评论区交流讨论！")]),s._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),t("p",[s._v("推荐阅读：")]),s._v(" "),t("ol",[t("li",[s._v("《深入理解分布式系统中的消息队列》")]),s._v(" "),t("li",[s._v("《Kafka权威指南》")]),s._v(" "),t("li",[s._v("《RocketMQ技术内幕》")])])])])}),[],!1,null,null,null);t.default=e.exports}}]);