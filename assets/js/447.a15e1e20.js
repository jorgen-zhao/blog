(window.webpackJsonp=window.webpackJsonp||[]).push([[447],{800:function(_,v,t){"use strict";t.r(v);var a=t(15),s=Object(a.a)({},(function(){var _=this,v=_._self._c;return v("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[v("h2",{attrs:{id:"前言"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[_._v("#")]),_._v(" 前言")]),_._v(" "),v("p",[_._v("在分布式系统中，我们常常面临一个核心挑战：如何保证跨多个服务或数据库的数据一致性。当我们讨论分布式一致性时，很多人会立即想到Paxos、Raft或ZAB这类一致性协议。这些协议确实解决了副本间的数据一致性问题，但它们并不能完全解决分布式系统中的所有一致性问题。")]),_._v(" "),v("p",[_._v("特别是在实际业务场景中，我们经常需要处理跨多个独立数据源的事务操作。例如，一个电商订单创建流程可能涉及库存扣减、订单创建、优惠券使用等多个独立的数据操作。如何保证这些操作要么全部成功，要么全部失败？这就是分布式事务要解决的问题。")]),_._v(" "),v("div",{staticClass:"custom-block tip"},[v("p",{staticClass:"custom-block-title"},[_._v("提示")]),_._v(" "),v("p",[_._v("分布式事务是指事务的参与者、资源服务器、事务管理器等分别位于不同的分布式节点之上的事务。它需要保证这些节点间的数据一致性和操作的原子性。")])]),_._v(" "),v("h2",{attrs:{id:"分布式事务的挑战"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#分布式事务的挑战"}},[_._v("#")]),_._v(" 分布式事务的挑战")]),_._v(" "),v("p",[_._v("与单机事务相比，分布式事务面临更多挑战：")]),_._v(" "),v("ol",[v("li",[v("strong",[_._v("网络问题")]),_._v("：节点间通信可能失败、延迟或重复")]),_._v(" "),v("li",[v("strong",[_._v("节点故障")]),_._v("：部分节点可能宕机或网络分区")]),_._v(" "),v("li",[v("strong",[_._v("时钟漂移")]),_._v("：不同节点的时钟可能不完全同步")]),_._v(" "),v("li",[v("strong",[_._v("性能瓶颈")]),_._v("：协调多个节点会增加系统延迟")]),_._v(" "),v("li",[v("strong",[_._v("复杂度增加")]),_._v("：系统架构变得更加复杂，难以调试和维护")])]),_._v(" "),v("h2",{attrs:{id:"分布式事务解决方案"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#分布式事务解决方案"}},[_._v("#")]),_._v(" 分布式事务解决方案")]),_._v(" "),v("p",[_._v("目前业界主要有以下几种分布式事务解决方案：")]),_._v(" "),v("h3",{attrs:{id:"_1-两阶段提交-2pc"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_1-两阶段提交-2pc"}},[_._v("#")]),_._v(" 1. 两阶段提交(2PC)")]),_._v(" "),v("p",[_._v("2PC是最经典的分布式事务协议，分为准备阶段和提交阶段。")]),_._v(" "),v("h4",{attrs:{id:"准备阶段"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#准备阶段"}},[_._v("#")]),_._v(" 准备阶段")]),_._v(" "),v("ol",[v("li",[_._v("事务协调者向所有参与者发送准备请求")]),_._v(" "),v("li",[_._v("参与者执行事务操作，但不提交，并将undo和redo日志写入持久化存储")]),_._v(" "),v("li",[_._v("参与者向协调者反馈是否可以提交")])]),_._v(" "),v("h4",{attrs:{id:"提交阶段"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#提交阶段"}},[_._v("#")]),_._v(" 提交阶段")]),_._v(" "),v("ul",[v("li",[_._v("如果所有参与者都反馈可以提交：\n"),v("ol",[v("li",[_._v("协调者向所有参与者发送提交命令")]),_._v(" "),v("li",[_._v("参与者提交事务并释放资源")]),_._v(" "),v("li",[_._v("参与者向协调者反馈提交结果")])])]),_._v(" "),v("li",[_._v("如果有参与者反馈不能提交或超时：\n"),v("ol",[v("li",[_._v("协调者向所有参与者发送回滚命令")]),_._v(" "),v("li",[_._v("参与者执行回滚操作并释放资源")]),_._v(" "),v("li",[_._v("参与者向协调者反馈回滚结果")])])])]),_._v(" "),v("p",[v("strong",[_._v("优点")]),_._v("：")]),_._v(" "),v("ul",[v("li",[_._v("实现简单，原理清晰")]),_._v(" "),v("li",[_._v("能够严格保证事务的ACID特性")])]),_._v(" "),v("p",[v("strong",[_._v("缺点")]),_._v("：")]),_._v(" "),v("ul",[v("li",[_._v("同步阻塞问题：在准备阶段后，参与者会锁定资源")]),_._v(" "),v("li",[_._v("单点故障问题：协调者宕机可能导致系统阻塞")]),_._v(" "),v("li",[_._v("数据不一致风险：如果协调者在提交阶段后宕机，部分参与者可能提交，部分可能回滚")])]),_._v(" "),v("h3",{attrs:{id:"_2-三阶段提交-3pc"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_2-三阶段提交-3pc"}},[_._v("#")]),_._v(" 2. 三阶段提交(3PC)")]),_._v(" "),v("p",[_._v("3PC是2PC的改进版本，通过引入预提交阶段来减少同步阻塞问题。")]),_._v(" "),v("ol",[v("li",[v("strong",[_._v("CanCommit阶段")]),_._v("：协调者询问参与者是否可以提交")]),_._v(" "),v("li",[v("strong",[_._v("PreCommit阶段")]),_._v("：协调者根据反馈决定是否进入预提交")]),_._v(" "),v("li",[v("strong",[_._v("DoCommit阶段")]),_._v("：与2PC的提交阶段类似")])]),_._v(" "),v("p",[v("strong",[_._v("优点")]),_._v("：")]),_._v(" "),v("ul",[v("li",[_._v("减少了同步阻塞的可能性")]),_._v(" "),v("li",[_._v("单点问题影响较小")])]),_._v(" "),v("p",[v("strong",[_._v("缺点")]),_._v("：")]),_._v(" "),v("ul",[v("li",[_._v("性能较差，增加了一轮通信")]),_._v(" "),v("li",[_._v("仍然存在数据不一致的可能性")])]),_._v(" "),v("h3",{attrs:{id:"_3-tcc模式"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_3-tcc模式"}},[_._v("#")]),_._v(" 3. TCC模式")]),_._v(" "),v("p",[_._v("TCC(Try-Confirm-Cancel)是一种补偿性事务模式，将一个大事务拆分为三个小操作：")]),_._v(" "),v("ol",[v("li",[v("strong",[_._v("Try阶段")]),_._v("：尝试执行业务操作，预留资源")]),_._v(" "),v("li",[v("strong",[_._v("Confirm阶段")]),_._v("：确认执行业务操作，执行真正的业务逻辑")]),_._v(" "),v("li",[v("strong",[_._v("Cancel阶段")]),_._v("：取消执行业务操作，释放预留的资源")])]),_._v(" "),v("p",[v("strong",[_._v("示例")]),_._v("：转账场景")]),_._v(" "),v("ul",[v("li",[_._v("Try：冻结账户A和账户B的资金")]),_._v(" "),v("li",[_._v("Confirm：从账户A扣除资金，添加到账户B")]),_._v(" "),v("li",[_._v("Cancel：解冻账户A和账户B的资金")])]),_._v(" "),v("p",[v("strong",[_._v("优点")]),_._v("：")]),_._v(" "),v("ul",[v("li",[_._v("最终一致性，性能较好")]),_._v(" "),v("li",[_._v("可以适应长事务场景")])]),_._v(" "),v("p",[v("strong",[_._v("缺点")]),_._v("：")]),_._v(" "),v("ul",[v("li",[_._v("业务侵入性强，需要业务逻辑支持")]),_._v(" "),v("li",[_._v("确认和取消操作需要幂等性设计")]),_._v(" "),v("li",[_._v("开发成本高")])]),_._v(" "),v("h3",{attrs:{id:"_4-saga模式"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_4-saga模式"}},[_._v("#")]),_._v(" 4. Saga模式")]),_._v(" "),v("p",[_._v("Saga模式将长事务拆分为多个本地事务，每个本地事务都有一个对应的补偿事务。")]),_._v(" "),v("p",[_._v("有两种实现方式：")]),_._v(" "),v("ol",[v("li",[v("strong",[_._v("协调式Saga")]),_._v("：由协调者按照顺序调用本地事务，如果某个事务失败，则按相反顺序调用补偿事务")]),_._v(" "),v("li",[v("strong",[_._v("事件式Saga")]),_._v("：通过事件驱动，每个本地事务完成后发布事件，触发下一个事务")])]),_._v(" "),v("p",[v("strong",[_._v("优点")]),_._v("：")]),_._v(" "),v("ul",[v("li",[_._v("最终一致性，性能较好")]),_._v(" "),v("li",[_._v("业务侵入性相对较低")])]),_._v(" "),v("p",[v("strong",[_._v("缺点")]),_._v("：")]),_._v(" "),v("ul",[v("li",[_._v("不保证隔离性")]),_._v(" "),v("li",[_._v("补偿逻辑设计复杂")]),_._v(" "),v("li",[_._v("可能出现脏回滚问题")])]),_._v(" "),v("h3",{attrs:{id:"_5-本地消息表方案"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_5-本地消息表方案"}},[_._v("#")]),_._v(" 5. 本地消息表方案")]),_._v(" "),v("p",[_._v("本地消息表方案基于本地事务+消息队列实现分布式事务：")]),_._v(" "),v("ol",[v("li",[_._v("在本地数据库中创建消息表")]),_._v(" "),v("li",[_._v("业务操作和消息记录在同一个本地事务中完成")]),_._v(" "),v("li",[_._v("通过定时任务将消息发送到消息队列")]),_._v(" "),v("li",[_._v("消费者消费消息并执行相应操作")]),_._v(" "),v("li",[_._v("消费完成后更新消息状态")])]),_._v(" "),v("p",[v("strong",[_._v("优点")]),_._v("：")]),_._v(" "),v("ul",[v("li",[_._v("实现相对简单")]),_._v(" "),v("li",[_._v("性能较好，系统解耦")])]),_._v(" "),v("p",[v("strong",[_._v("缺点")]),_._v("：")]),_._v(" "),v("ul",[v("li",[_._v("不保证强一致性")]),_._v(" "),v("li",[_._v("需要额外实现消息状态管理")])]),_._v(" "),v("h2",{attrs:{id:"实际应用场景选择"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#实际应用场景选择"}},[_._v("#")]),_._v(" 实际应用场景选择")]),_._v(" "),v("p",[_._v("不同的分布式事务解决方案适用于不同的场景：")]),_._v(" "),v("table",[v("thead",[v("tr",[v("th",[_._v("方案")]),_._v(" "),v("th",[_._v("一致性")]),_._v(" "),v("th",[_._v("性能")]),_._v(" "),v("th",[_._v("开发复杂度")]),_._v(" "),v("th",[_._v("适用场景")])])]),_._v(" "),v("tbody",[v("tr",[v("td",[_._v("2PC")]),_._v(" "),v("td",[_._v("强一致性")]),_._v(" "),v("td",[_._v("低")]),_._v(" "),v("td",[_._v("中")]),_._v(" "),v("td",[_._v("对一致性要求高，性能要求低的场景")])]),_._v(" "),v("tr",[v("td",[_._v("TCC")]),_._v(" "),v("td",[_._v("最终一致性")]),_._v(" "),v("td",[_._v("中")]),_._v(" "),v("td",[_._v("高")]),_._v(" "),v("td",[_._v("一致性要求较高，业务逻辑可拆分的场景")])]),_._v(" "),v("tr",[v("td",[_._v("Saga")]),_._v(" "),v("td",[_._v("最终一致性")]),_._v(" "),v("td",[_._v("高")]),_._v(" "),v("td",[_._v("中")]),_._v(" "),v("td",[_._v("业务流程长，对性能要求高的场景")])]),_._v(" "),v("tr",[v("td",[_._v("本地消息表")]),_._v(" "),v("td",[_._v("最终一致性")]),_._v(" "),v("td",[_._v("高")]),_._v(" "),v("td",[_._v("低")]),_._v(" "),v("td",[_._v("可接受短暂不一致，追求高吞吐量的场景")])])])]),_._v(" "),v("h2",{attrs:{id:"结语"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#结语"}},[_._v("#")]),_._v(" 结语")]),_._v(" "),v("p",[_._v("分布式事务是分布式系统中不可避免的话题，没有一种方案能够完美解决所有问题。在实际应用中，我们需要根据业务需求、性能要求和系统架构选择合适的解决方案。")]),_._v(" "),v("p",[_._v("随着微服务架构的普及，分布式事务的重要性日益凸显。理解各种分布式事务方案的原理和优缺点，有助于我们在系统设计时做出更合理的决策。")]),_._v(" "),v("blockquote",[v("p",[_._v("最终，技术选型没有绝对的对错，只有是否适合。在分布式系统设计中，我们需要在一致性、可用性和分区容错性之间找到平衡点。")])]),_._v(" "),v("div",{staticClass:"custom-block right"},[v("p",[_._v("— Jorgen")])])])}),[],!1,null,null,null);v.default=s.exports}}]);