(window.webpackJsonp=window.webpackJsonp||[]).push([[439],{790:function(s,n,a){"use strict";a.r(n);var e=a(15),t=Object(e.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('\n## 前言\n\n在分布式系统中，如何确保多个节点对某个数据达成一致是一个核心问题。CAP定理告诉我们，在分布式系统中，一致性(Consistency)、可用性(Availability)和分区容错性(Partition tolerance)三者不可兼得。而BASE理论则提出了基本可用、软状态和最终一致性的折中方案。\n\n那么，在实际的分布式系统中，我们是如何实现一致性的呢？这就需要借助分布式一致性算法。本文将深入探讨两种经典的一致性算法：Paxos和Raft，解析它们的工作原理、优缺点以及实际应用。\n\n::: tip\n"在分布式系统中，没有银弹，只有根据具体场景选择合适的解决方案。"\n:::\n\n## 分布式一致性的挑战\n\n在单机系统中，数据一致性相对容易实现，因为所有操作都在同一内存空间中完成。但在分布式系统中，情况变得复杂得多：\n\n1. **节点故障**：网络中的任何节点都可能随时发生故障。\n2. **网络分区**：节点之间的网络连接可能中断，导致系统被分割成多个无法通信的分区。\n3. **消息延迟或丢失**：网络中的消息可能因为各种原因延迟或丢失。\n4. **消息乱序**：网络中的消息可能不按发送顺序到达。\n\n这些挑战使得在分布式系统中实现一致性变得异常困难。为了解决这些问题，研究者们提出了多种一致性算法，其中Paxos和Raft是最具代表性的两种。\n\n## Paxos算法\n\nPaxos算法是由Leslie Lamport在1990年提出的一种基于消息传递的一致性算法。它被认为是分布式系统领域最重要的算法之一，但由于其复杂性和难以理解，也被称为"算法中最难理解的一种"。\n\n### Paxos的角色与参与者\n\nPaxos算法中有三种角色：\n\n1. **Proposer（提议者）**：提出提案（包含值和编号）。\n2. **Acceptor（接受者）**：对提案进行投票，决定是否接受。\n3. **Learner（学习者）**：学习已被选定的值。\n\n在实际系统中，一个节点可以同时扮演多个角色。\n\n### Paxos算法流程\n\nPaxos算法主要分为两个阶段：准备阶段（Prepare）和接受阶段（Accept）。\n\n#### 准备阶段（Prepare）\n\n1. Proposer选择一个唯一的提案编号n，向大多数Acceptor发送Prepare(n)请求。\n2. Acceptor收到Prepare(n)请求后：\n   - 如果n大于它已经响应过的任何提案的编号，则回复Promise(n)，并承诺不再接受编号小于n的提案。\n   - 如果Acceptor之前已经接受过某个提案，则将该提案的编号和值一并发送给Proposer。\n\n#### 接受阶段（Accept）\n\n1. 如果Proposer收到大多数Acceptor的Promise(n)响应，且没有Acceptor已经接受过任何提案，则可以自由选择一个值v，向这些Acceptor发送Accept(n, v)请求。\n2. 如果Proposer在Promise响应中收到了某个已接受的值v\'，则必须选择v\'作为提案的值，发送Accept(n, v\')请求。\n3. Acceptor收到Accept(n, v)请求后：\n   - 如果n是它承诺接受的最大的提案编号，则接受该提案，并回复Accepted(n, v)。\n   - 否则，忽略该请求。\n\n4. 当Proposer收到大多数Acceptor的Accepted(n, v)响应后，可以认为提案(n, v)已经被选定，并将v通知给所有Learner。\n\n### Paxos算法的变种\n\n由于原始Paxos算法的复杂性，后来出现了多种变种和改进：\n\n1. **Multi-Paxos**：通过选举一个领导者(Leader)来减少Prepare阶段的通信开销。\n2. **Fast-Paxos**：优化了普通情况下Paxos的性能。\n3. **Flexible Paxos**：允许提案者选择任意多数的Acceptor集合。\n\n### Paxos算法的优缺点\n\n**优点**：\n- 理论上正确性得到了严格证明。\n- 能够保证在任意多数节点正常工作的情况下，系统依然可以达成一致。\n\n**缺点**：\n- 算法复杂，难以理解和实现。\n- 在实践中，性能可能不理想，尤其是在网络分区或节点故障的情况下。\n- 缺乏实际的工程实现指导。\n\n## Raft算法\n\n为了解决Paxos算法难以理解和实现的问题，Diego Ongaro和John Ousterhout在2013年提出了Raft算法。Raft算法的设计目标是提供一种更易于理解和实现的一致性算法。\n\n### Raft的核心思想\n\nRaft算法将一致性问题分解为几个相对独立的部分：\n1. **领导人选举**：确保在任何时刻，集群中最多只有一个领导人。\n2. **日志复制**：领导人将客户端的日志条目复制到集群中的其他节点。\n3. **安全性**：确保在任何情况下，系统状态的一致性都不会被破坏。\n\n### Raft的角色与状态\n\nRaft中有三种角色：\n1. **Leader（领导者）**：处理所有的客户端请求，并将日志条目复制到其他节点。\n2. **Follower（跟随者）**：被动接收来自领导人和候选人的请求，不处理客户端请求。\n3. **Candidate（候选人）**：在领导人选举过程中，由跟随者转变而来。\n\n节点在这三种角色之间转换，具体取决于当前的网络状况和节点状态。\n\n### Raft算法流程\n\n#### 领导人选举\n\n1. 初始时，所有节点都是Follower状态。\n2. 如果一个Follower在一定时间内（称为选举超时）没有收到领导人的心跳消息，它会转变为Candidate状态，并开始选举。\n3. Candidate向其他节点发送RequestVote RPC请求，请求它们投票给自己。\n4. 其他节点在收到RequestVote请求后：\n   - 如果该节点还没有投票，或者已经投票给了当前Candidate，并且Candidate的日志至少和自己的一样新，则投票给该Candidate。\n   - 否则，拒绝投票。\n5. 如果Candidate收到了大多数节点的投票，它转变为Leader状态，并向其他节点发送心跳消息。\n6. 如果有多个Candidate同时开始选举，可能会导致选票分散，没有Candidate能获得大多数投票。这时，所有Candidate会在随机的选举超时后重新开始选举。\n\n#### 日志复制\n\n1. Leader接收到客户端的写请求后，将操作作为一个新的日志条目添加到自己的日志中。\n2. Leader将该日志条目并行地复制到所有Follower节点。\n3. 当日志条目被大多数节点（包括Leader）持久化后，Leader将该日志条目应用到自己的状态机中，并向客户端返回结果。\n4. Leader定期向Follower发送心跳消息，其中包含了最新的日志索引和任期号。\n5. Follower收到心跳消息后，如果有未提交的日志条目，会将其应用到自己的状态机中。\n\n#### 安全性\n\nRaft算法通过以下机制保证安全性：\n1. **选举限制**：只有拥有最新日志的节点才能成为Leader。\n2. **提交规则**：Leader只有在将日志条目复制到大多数节点后，才能将其标记为已提交。\n3. **日志匹配**：Leader在向Follower发送日志条目时，会确保Follower的日志与自己匹配。\n\n### Raft算法的优缺点\n\n**优点**：\n- 算法设计清晰，易于理解和实现。\n- 强领导人模型简化了系统设计和实现。\n- 提供了完整的工程实现指导。\n\n**缺点**：\n- 性能可能不如某些优化后的Paxos实现。\n- 在某些极端情况下（如频繁的网络分区），性能可能会下降。\n\n## Paxos与Raft的比较\n\n| 特性 | Paxos | Raft |\n|------|-------|------|\n| 算法复杂度 | 高，难以理解和实现 | 低，易于理解和实现 |\n| 性能 | 在某些场景下可能更优 | 通常性能良好，但可能不如优化后的Paxos |\n| 工程实现 | 缺乏实际指导 | 提供了完整的实现指南 |\n| 强领导人 | 不一定有强领导人 | 有明确的强领导人 |\n| 容错能力 | 在多数节点正常工作的情况下可以工作 | 在多数节点正常工作的情况下可以工作 |\n\n## 实际应用\n\n### Paxos的应用\n\n1. **Google Chubby**：Google的锁服务，基于Paxos算法实现。\n2. **Google Spanner**：Google的全球分布式数据库，使用Paxos实现跨数据中心的一致性。\n3. **ZooKeeper**：虽然ZooKeeper使用的是ZAB协议，但其设计思想受到了Paxos的影响。\n\n### Raft的应用\n\n1. **etcd**：CoreOS开发的分布式键值存储系统，被Kubernetes用作后端存储。\n2. **Consul**：HashiCorp开发的分布式服务发现和配置工具。\n3. **TiDB**：PingCAP开发的分布式关系型数据库，使用Raft实现分布式事务。\n4. **CockroachDB**：基于Raft的分布式SQL数据库。\n\n## 个人建议\n\n在选择分布式一致性算法时，应根据具体的应用场景和需求进行权衡：\n\n1. 如果系统对一致性要求极高，且可以容忍一定的性能损失，可以考虑使用Paxos或其变种。\n2. 如果系统需要易于理解和实现，且对性能有一定要求，Raft是一个更好的选择。\n3. 对于大多数分布式系统，使用成熟的实现（如etcd、ZooKeeper等）比自己实现一致性算法更为明智，因为这些实现已经经过了充分的测试和优化。\n\n## 结语\n\n分布式一致性算法是分布式系统的基石，Paxos和Raft作为两种最具代表性的一致性算法，各有优缺点。Paxos虽然复杂，但在某些场景下可能提供更好的性能；而Raft则以其清晰的设计和易于实现的特点，在实际工程中得到了广泛应用。\n\n理解这些一致性算法的工作原理，不仅有助于我们更好地设计和实现分布式系统，也能让我们在面对分布式系统问题时，能够更准确地定位和解决问题。在未来的分布式系统设计中，一致性算法将继续扮演重要角色，而我们也期待看到更多高效、可靠的一致性算法的出现。\n\n> "在分布式系统中，没有银弹，只有根据具体场景选择合适的解决方案。"')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br"),n("span",{staticClass:"line-number"},[s._v("79")]),n("br"),n("span",{staticClass:"line-number"},[s._v("80")]),n("br"),n("span",{staticClass:"line-number"},[s._v("81")]),n("br"),n("span",{staticClass:"line-number"},[s._v("82")]),n("br"),n("span",{staticClass:"line-number"},[s._v("83")]),n("br"),n("span",{staticClass:"line-number"},[s._v("84")]),n("br"),n("span",{staticClass:"line-number"},[s._v("85")]),n("br"),n("span",{staticClass:"line-number"},[s._v("86")]),n("br"),n("span",{staticClass:"line-number"},[s._v("87")]),n("br"),n("span",{staticClass:"line-number"},[s._v("88")]),n("br"),n("span",{staticClass:"line-number"},[s._v("89")]),n("br"),n("span",{staticClass:"line-number"},[s._v("90")]),n("br"),n("span",{staticClass:"line-number"},[s._v("91")]),n("br"),n("span",{staticClass:"line-number"},[s._v("92")]),n("br"),n("span",{staticClass:"line-number"},[s._v("93")]),n("br"),n("span",{staticClass:"line-number"},[s._v("94")]),n("br"),n("span",{staticClass:"line-number"},[s._v("95")]),n("br"),n("span",{staticClass:"line-number"},[s._v("96")]),n("br"),n("span",{staticClass:"line-number"},[s._v("97")]),n("br"),n("span",{staticClass:"line-number"},[s._v("98")]),n("br"),n("span",{staticClass:"line-number"},[s._v("99")]),n("br"),n("span",{staticClass:"line-number"},[s._v("100")]),n("br"),n("span",{staticClass:"line-number"},[s._v("101")]),n("br"),n("span",{staticClass:"line-number"},[s._v("102")]),n("br"),n("span",{staticClass:"line-number"},[s._v("103")]),n("br"),n("span",{staticClass:"line-number"},[s._v("104")]),n("br"),n("span",{staticClass:"line-number"},[s._v("105")]),n("br"),n("span",{staticClass:"line-number"},[s._v("106")]),n("br"),n("span",{staticClass:"line-number"},[s._v("107")]),n("br"),n("span",{staticClass:"line-number"},[s._v("108")]),n("br"),n("span",{staticClass:"line-number"},[s._v("109")]),n("br"),n("span",{staticClass:"line-number"},[s._v("110")]),n("br"),n("span",{staticClass:"line-number"},[s._v("111")]),n("br"),n("span",{staticClass:"line-number"},[s._v("112")]),n("br"),n("span",{staticClass:"line-number"},[s._v("113")]),n("br"),n("span",{staticClass:"line-number"},[s._v("114")]),n("br"),n("span",{staticClass:"line-number"},[s._v("115")]),n("br"),n("span",{staticClass:"line-number"},[s._v("116")]),n("br"),n("span",{staticClass:"line-number"},[s._v("117")]),n("br"),n("span",{staticClass:"line-number"},[s._v("118")]),n("br"),n("span",{staticClass:"line-number"},[s._v("119")]),n("br"),n("span",{staticClass:"line-number"},[s._v("120")]),n("br"),n("span",{staticClass:"line-number"},[s._v("121")]),n("br"),n("span",{staticClass:"line-number"},[s._v("122")]),n("br"),n("span",{staticClass:"line-number"},[s._v("123")]),n("br"),n("span",{staticClass:"line-number"},[s._v("124")]),n("br"),n("span",{staticClass:"line-number"},[s._v("125")]),n("br"),n("span",{staticClass:"line-number"},[s._v("126")]),n("br"),n("span",{staticClass:"line-number"},[s._v("127")]),n("br"),n("span",{staticClass:"line-number"},[s._v("128")]),n("br"),n("span",{staticClass:"line-number"},[s._v("129")]),n("br"),n("span",{staticClass:"line-number"},[s._v("130")]),n("br"),n("span",{staticClass:"line-number"},[s._v("131")]),n("br"),n("span",{staticClass:"line-number"},[s._v("132")]),n("br"),n("span",{staticClass:"line-number"},[s._v("133")]),n("br"),n("span",{staticClass:"line-number"},[s._v("134")]),n("br"),n("span",{staticClass:"line-number"},[s._v("135")]),n("br"),n("span",{staticClass:"line-number"},[s._v("136")]),n("br"),n("span",{staticClass:"line-number"},[s._v("137")]),n("br"),n("span",{staticClass:"line-number"},[s._v("138")]),n("br"),n("span",{staticClass:"line-number"},[s._v("139")]),n("br"),n("span",{staticClass:"line-number"},[s._v("140")]),n("br"),n("span",{staticClass:"line-number"},[s._v("141")]),n("br"),n("span",{staticClass:"line-number"},[s._v("142")]),n("br"),n("span",{staticClass:"line-number"},[s._v("143")]),n("br"),n("span",{staticClass:"line-number"},[s._v("144")]),n("br"),n("span",{staticClass:"line-number"},[s._v("145")]),n("br"),n("span",{staticClass:"line-number"},[s._v("146")]),n("br"),n("span",{staticClass:"line-number"},[s._v("147")]),n("br"),n("span",{staticClass:"line-number"},[s._v("148")]),n("br"),n("span",{staticClass:"line-number"},[s._v("149")]),n("br"),n("span",{staticClass:"line-number"},[s._v("150")]),n("br"),n("span",{staticClass:"line-number"},[s._v("151")]),n("br"),n("span",{staticClass:"line-number"},[s._v("152")]),n("br"),n("span",{staticClass:"line-number"},[s._v("153")]),n("br"),n("span",{staticClass:"line-number"},[s._v("154")]),n("br"),n("span",{staticClass:"line-number"},[s._v("155")]),n("br"),n("span",{staticClass:"line-number"},[s._v("156")]),n("br"),n("span",{staticClass:"line-number"},[s._v("157")]),n("br"),n("span",{staticClass:"line-number"},[s._v("158")]),n("br"),n("span",{staticClass:"line-number"},[s._v("159")]),n("br"),n("span",{staticClass:"line-number"},[s._v("160")]),n("br"),n("span",{staticClass:"line-number"},[s._v("161")]),n("br"),n("span",{staticClass:"line-number"},[s._v("162")]),n("br"),n("span",{staticClass:"line-number"},[s._v("163")]),n("br"),n("span",{staticClass:"line-number"},[s._v("164")]),n("br"),n("span",{staticClass:"line-number"},[s._v("165")]),n("br"),n("span",{staticClass:"line-number"},[s._v("166")]),n("br"),n("span",{staticClass:"line-number"},[s._v("167")]),n("br"),n("span",{staticClass:"line-number"},[s._v("168")]),n("br"),n("span",{staticClass:"line-number"},[s._v("169")]),n("br"),n("span",{staticClass:"line-number"},[s._v("170")]),n("br"),n("span",{staticClass:"line-number"},[s._v("171")]),n("br"),n("span",{staticClass:"line-number"},[s._v("172")]),n("br"),n("span",{staticClass:"line-number"},[s._v("173")]),n("br"),n("span",{staticClass:"line-number"},[s._v("174")]),n("br")])])])}),[],!1,null,null,null);n.default=t.exports}}]);