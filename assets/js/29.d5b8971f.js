(window.webpackJsonp=window.webpackJsonp||[]).push([[29],{374:function(s,n,a){"use strict";a.r(n);var e=a(14),t=Object(e.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("ul",[n("li",[n("strong",[s._v("协议要“前瞻性设计”，避免未来修改的代价过高。")])]),s._v(" "),n("li",[n("strong",[s._v("安全第一，传输的数据必须加密且可验证。")])]),s._v(" "),n("li",[n("strong",[s._v("保持协议的“简洁性”与“可读性”之间的平衡。")])])]),s._v(" "),n("h2",{attrs:{id:"📖-背景介绍"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#📖-背景介绍"}},[s._v("#")]),s._v(" 📖 背景介绍")]),s._v(" "),n("p",[s._v("物联网（IoT）设备之间的通信需要一个"),n("strong",[s._v("可靠、高效、可扩展")]),s._v("的协议，来保证设备可以正确理解彼此的数据。想象一下，如果不同品牌的智能家居设备都用自己的语言沟通，那场面会有多混乱？😵")]),s._v(" "),n("p",[s._v("一个好的协议能解决：")]),s._v(" "),n("ul",[n("li",[s._v("设备之间的互操作性 🏠🔗💡")]),s._v(" "),n("li",[s._v("数据传输的安全性 🔐")]),s._v(" "),n("li",[s._v("低功耗、低延迟的优化 ⚡")])]),s._v(" "),n("p",[s._v("所以，在物联网项目中，协议设计至关重要！那么，"),n("strong",[s._v("好的协议设计有哪些特征呢？")])]),s._v(" "),n("hr"),s._v(" "),n("h3",{attrs:{id:"🛠-最初构思"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#🛠-最初构思"}},[s._v("#")]),s._v(" 🛠 最初构思")]),s._v(" "),n("p",[s._v("在 IoT 场景下，我们需要的协议应具备以下特性：")]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("简洁性")]),s._v("：传输的数据尽量精简，减少带宽消耗。")]),s._v(" "),n("li",[n("strong",[s._v("扩展性")]),s._v("：协议要支持未来功能的拓展，而不会破坏现有功能。")]),s._v(" "),n("li",[n("strong",[s._v("安全性")]),s._v("：防止中间人攻击、篡改等安全风险。")]),s._v(" "),n("li",[n("strong",[s._v("兼容性")]),s._v("：确保不同版本、不同厂商的设备能互相通信。")])]),s._v(" "),n("blockquote",[n("p",[n("strong",[s._v("🎯 目标")]),s._v("：设计一个既通用又高效的协议！")])]),s._v(" "),n("hr"),s._v(" "),n("h3",{attrs:{id:"🔍-协议分析-ble-消息协议"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#🔍-协议分析-ble-消息协议"}},[s._v("#")]),s._v(" 🔍 协议分析 BLE 消息协议")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('syntax = "proto3";\n\npackage xxx.proto.xxx.ble;\n\n// BLE消息\nmessage BleMessage {\n    // 消息类型\n    uint32 type = 1;\n\n    // 消息内容\n    bytes body = 2;\n}\n\n// BLE消息类型\nenum BleMessageType {\n    // 未知消息\n    BLE_MESSAGE_TYPE_UNKNOWN = 0;\n\n    // BLE认证AEAD消息（AuthAead）\n    BLE_MESSAGE_TYPE_AUTH_AEAD = 1;\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('syntax = "proto3";\n\npackage xxx.proto.xxx.auth;\n\n// 认证状态\nenum AuthState {\n    // 未知状态\n    AUTH_STATE_UNKNOWN = 0;\n\n    // 认证请求\n    AUTH_STATE_REQUEST = 1;\n\n    // 认证请求（使用快速认证）\n    AUTH_STATE_REQUEST_TICKET = 2;\n\n    // 认证成功\n    AUTH_STATE_OK = 3;\n\n    // 认证失败\n    AUTH_STATE_FAILED = 4;\n}\n\n// 认证消息类型\nenum AuthMessageType {\n    // 未知消息\n    AUTH_MESSAGE_TYPE_UNKNOWN = 0;\n\n    // APP对Robot认证，请求消息\n    AUTH_MESSAGE_TYPE_APP_ROBOT_REQUEST = 1;\n\n    // APP对ROBOT认证，响应消息\n    AUTH_MESSAGE_TYPE_APP_ROBOT_RESPONSE = 2;\n}\n\n// 认证消息，编码后被AEAD作为msg加密存储于AuthAead的enc中\nmessage AuthMessage {\n    // 认证状态\n    AuthState state = 1;\n\n    // 会话票据，用于快速认证\n    optional bytes session_ticket = 2;\n\n    // 认证消息类型\n    uint32 type = 3;\n\n    // 认证消息体，根据type解码\n    bytes body = 4;\n}\n\n// 关联数据（明文编码）\nmessage AssociatedData {\n    // 顺序号\n    uint32 seq = 1;\n\n    // 时间戳\n    uint64 timestamp = 2;\n\n    // 协议版本\n    uint32 version = 3;\n}\n\n// 认证AEAD\nmessage AuthAead {\n    // 关联数据\n    AssociatedData ad = 1;\n\n    // 关联数据编码数据\n    bytes ad_bytes = 2;\n\n    // nonce随机数\n    bytes nonce = 3;\n\n    // 密文\n    bytes enc = 4;\n\n    // MAC\n    bytes mac = 5;\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('syntax = "proto3";\n\npackage xxx.proto.xxx.auth;\n\n// 位置\nmessage PointLla {\n    float long = 1;\n    float lat = 2;\n    float alt = 3;\n}\n\n// APP对robot认证，请求消息\nmessage AppRobotAuthRequestMessage {\n    // 设备Id\n    string device_id = 1;\n\n    // 软件版本\n    string app_version = 2;\n\n    // 位置\n    PointLla app_lla = 3;\n\n    // 用户Id\n    string user_id = 4;\n\n    // robot sn\n    string robot_sn = 5;\n}\n\n// Robot对App认证，响应消息\nmessage AppRobotAuthResponseMessage {\n    // 响应的认证请求seq值\n    uint32 ack_seq = 1;\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br")])]),n("p",[s._v("这个协议设计主要用于 "),n("code",[s._v("BLE（Bluetooth Low Energy）")]),s._v("通信，涉及认证（"),n("code",[s._v("Authentication")]),s._v("）和消息传递，包含以下核心部分：")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("BleMessage")]),s._v("：通用 "),n("code",[s._v("BLE")]),s._v(" 消息结构，定义消息类型和内容。")]),s._v(" "),n("li",[n("code",[s._v("AuthMessage")]),s._v(" 和 "),n("code",[s._v("AuthAead")]),s._v("：认证相关消息，支持 "),n("code",[s._v("AEAD（Authenticated Encryption with Associated Data）")]),s._v("加密，提供认证状态、会话票据和加密数据。")]),s._v(" "),n("li",[n("code",[s._v("AppRobotAuthRequestMessage")]),s._v(" 和 "),n("code",[s._v("AppRobotAuthResponseMessage")]),s._v("：具体的认证请求和响应消息，用于 "),n("code",[s._v("APP")]),s._v("(地面站)对 "),n("code",[s._v("Robot")]),s._v("（机器人）的认证。\n设计目标是实现安全的、低功耗的认证协议，适用于资源受限的 "),n("code",[s._v("BLE")]),s._v(" 环境。")])]),s._v(" "),n("h3",{attrs:{id:"🚀-设计亮点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#🚀-设计亮点"}},[s._v("#")]),s._v(" 🚀 设计亮点")]),s._v(" "),n("ol",[n("li",[n("p",[s._v("模块化设计：\n协议分为多个独立的消息类型（"),n("code",[s._v("BleMessage")]),s._v("、"),n("code",[s._v("AuthMessage")]),s._v("、"),n("code",[s._v("AuthAead")]),s._v(" 等），层次清晰，便于扩展和维护。\n使用枚举（"),n("code",[s._v("BleMessageType")]),s._v("、"),n("code",[s._v("AuthState")]),s._v("、"),n("code",[s._v("AuthMessageType")]),s._v("）定义状态和类型，具有良好的可读性和类型安全性。")])]),s._v(" "),n("li",[n("p",[s._v("支持 "),n("code",[s._v("AEAD")]),s._v(" 加密：\n"),n("code",[s._v("AuthAead")]),s._v(" 消息包含 "),n("code",[s._v("nonce")]),s._v("（随机数）、"),n("code",[s._v("enc")]),s._v("（密文）、"),n("code",[s._v("mac")]),s._v("（消息认证码）和 "),n("code",[s._v("ad")]),s._v("（关联数据），采用 "),n("code",[s._v("AEAD")]),s._v(" 加密方案，确保安全性。\n关联数据（"),n("code",[s._v("AssociatedData")]),s._v("）包含 "),n("code",[s._v("seq")]),s._v("（顺序号）、"),n("code",[s._v("timestamp")]),s._v("（时间戳）和 "),n("code",[s._v("version")]),s._v("（协议版本），可以防止重放攻击和版本不匹配问题。")])]),s._v(" "),n("li",[n("p",[s._v("灵活性：\n"),n("code",[s._v("BleMessage")]),s._v(" 和 "),n("code",[s._v("AuthMessage")]),s._v(" 使用 "),n("code",[s._v("bytes")]),s._v(" 类型的 "),n("code",[s._v("body")]),s._v(" 字段，允许根据 "),n("code",[s._v("type")]),s._v(" 动态解码具体内容，具有较好的扩展性。\n"),n("code",[s._v("session_ticket")]),s._v(" 字段（在 "),n("code",[s._v("AuthMessage")]),s._v(" 中）支持快速认证，适合需要频繁认证的场景。\n具体认证消息：\n"),n("code",[s._v("AppRobotAuthRequestMessage")]),s._v(" 包含设备 ID、软件版本、位置信息等，提供了足够的上下文用于认证决策。\n"),n("code",[s._v("AppRobotAuthResponseMessage")]),s._v(" 使用 "),n("code",[s._v("ack_seq")]),s._v(" 回应请求的顺序号，便于请求-响应匹配。")])]),s._v(" "),n("li",[n("p",[s._v("轻量化：\n"),n("code",[s._v("Protobuf")]),s._v(" 本身是二进制序列化格式，相较于 JSON 或 XML，数据体积更小，非常适合 BLE 的带宽受限环境。")])])]),s._v(" "),n("hr"),s._v(" "),n("h3",{attrs:{id:"🏗-实施-遇到的挑战"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#🏗-实施-遇到的挑战"}},[s._v("#")]),s._v(" 🏗 实施 & 遇到的挑战")]),s._v(" "),n("p",[s._v("在设计协议的过程中，我们遇到了一些挑战：")]),s._v(" "),n("ol",[n("li",[n("p",[n("strong",[s._v("如何保证向后兼容性？")])]),s._v(" "),n("ul",[n("li",[s._v("方案：使用 "),n("code",[s._v("optional")]),s._v(" 字段，避免破坏旧版解析。")])])]),s._v(" "),n("li",[n("p",[n("strong",[s._v("如何保证消息的安全性？")])]),s._v(" "),n("ul",[n("li",[s._v("方案：引入 "),n("code",[s._v("AEAD")]),s._v("（认证加密）机制，确保消息完整性。")])])]),s._v(" "),n("li",[n("p",[n("strong",[s._v("如何降低带宽消耗？")])]),s._v(" "),n("ul",[n("li",[s._v("方案：\n"),n("ul",[n("li",[s._v("使用 "),n("code",[s._v("enum")]),s._v(" 代替字符串，减少数据传输量。")]),s._v(" "),n("li",[s._v("合理设计数据结构，避免冗余字段。")])])])])])]),s._v(" "),n("hr"),s._v(" "),n("h2",{attrs:{id:"🎭-结尾"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#🎭-结尾"}},[s._v("#")]),s._v(" 🎭 结尾")]),s._v(" "),n("p",[s._v("协议设计就像编写一首交响乐 🎵，需要"),n("strong",[s._v("优雅的结构")]),s._v("、"),n("strong",[s._v("和谐的组合")]),s._v("，更重要的是要让所有乐器（设备）都能顺畅地演奏出相同的旋律。")]),s._v(" "),n("blockquote",[n("p",[n("strong",[s._v("“复杂的系统，往往起源于一个简单、优雅的设计。”")]),s._v("——Alan Kay")])]),s._v(" "),n("p",[s._v("协议设计是一个不断打磨的过程，但只要遵循 "),n("strong",[s._v("“简洁、扩展、安全”")]),s._v(" 的原则，就能打造出稳定可靠的物联网通信框架！🚀")])])}),[],!1,null,null,null);n.default=t.exports}}]);